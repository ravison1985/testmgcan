<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG F&O Stocks Dashboard - Weekly Analysis</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N0J406PHQN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-N0J406PHQN');
    </script>
    
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
    <!-- Cache busting for immediate CSS changes -->
    <style>
        /* RVOL Table Styling */
        .rvol-table-container {
            font-size: 0.65rem;
            color: #ffffff;
        }
        
        /* Progress Bar Style Scrollers for RVOL Tables */
        .card-body::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        .card-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        
        .card-body::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #17a2b8 0%, #138496 100%);
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .card-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #20c997 0%, #17a085 100%);
        }
        
        /* For different RVOL categories - different colored scrollers */
        .rvol-table-container::-webkit-scrollbar {
            width: 3px;
        }
        
        .rvol-table-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }
        
        .rvol-table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #ffc107 0%, #e0a800 100%);
            border-radius: 2px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .rvol-stock-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 6px;
            margin-bottom: 2px;
            border-radius: 4px;
            background: rgba(40, 45, 50, 0.6);
            border-left: 3px solid;
            transition: background 0.2s ease;
        }
        
        .rvol-stock-row:hover {
            background: rgba(60, 65, 70, 0.8);
        }
        
        .rvol-symbol {
            font-weight: bold;
            color: #17a2b8;
            cursor: pointer;
            min-width: 50px;
        }
        
        .rvol-data {
            display: flex;
            gap: 4px;
            font-size: 0.55rem;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .rvol-data {
                font-size: 0.5rem;
                gap: 3px;
            }
            
            .rvol-symbol {
                font-size: 0.6rem;
                min-width: 35px;
            }
            
            .rvol-stock-row {
                padding: 2px 4px;
                margin-bottom: 1px;
            }
        }
        
        .rvol-value {
            color: #ffc107;
            font-weight: bold;
        }
        
        .rvol-change-positive {
            color: #28a745;
        }
        
        .rvol-change-negative {
            color: #dc3545;
        }
        
        .rvol-from-open-positive {
            color: #28a745;
        }
        
        .rvol-from-open-negative {
            color: #dc3545;
        }
        
        /* Cache bust: {{ range(1000, 9999) | random }} */

        /* Rolling number animation - professional and subtle */
        .rolling-number {
            transition: all 0.3s ease-out;
            display: inline-block;
        }
        
        .rolling-number.updating {
            transform: translateY(-2px);
        }

        .price-pulse {
            animation: pulsePriceChange 0.6s ease-in-out;
        }

        @keyframes flashGreen {
            0% { 
                background-color: rgba(40, 167, 69, 0.8); 
                transform: scale(1.05); 
                box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
            }
            50% { 
                background-color: rgba(40, 167, 69, 0.4); 
            }
            100% { 
                background-color: transparent; 
                transform: scale(1);
                box-shadow: none;
            }
        }

        @keyframes flashRed {
            0% { 
                background-color: rgba(220, 53, 69, 0.8); 
                transform: scale(1.05); 
                box-shadow: 0 0 15px rgba(220, 53, 69, 0.5);
            }
            50% { 
                background-color: rgba(220, 53, 69, 0.4); 
            }
            100% { 
                background-color: transparent; 
                transform: scale(1);
                box-shadow: none;
            }
        }

        @keyframes pulsePriceChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        /* Smooth transition for all price elements */
        .price-cell {
            transition: all 0.3s ease;
            border-radius: 4px;
            padding: 0.3rem;
        }
    </style>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .level-broken {
            background-color: rgba(220, 53, 69, 0.1) !important;
            color: var(--bs-danger) !important;
            font-weight: bold;
        }
        
        .level-active {
            background-color: rgba(25, 135, 84, 0.1);
            color: var(--bs-success);
        }
        
        /* Immediate Support/Resistance Flash Animation */
        .immediate-level {
            position: relative;
        }
        
        .immediate-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-right: 5px;
            transition: all 0.3s ease;
        }
        
        .immediate-tag.highlight {
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
        }
        
        .resistance-tag {
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
        }
        
        .support-tag {
            background-color: rgba(25, 135, 84, 0.8);
            color: white;
        }
        

        .range-green {
            background-color: #28a745 !important;
            border-radius: 6px !important;
        }

        .range-red {
            background-color: #dc3545 !important;
            border-radius: 6px !important;
        }

        .range-yellow {
            background-color: #ffc107 !important;
            color: #000 !important;
            border-radius: 6px !important;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Mobile-First Responsive Typography */
        body {
            font-size: 0.8rem !important;
        }

        /* Headers */
        h1 { font-size: 1.1rem !important; }
        h2 { font-size: 1rem !important; }
        h3 { font-size: 0.95rem !important; }
        h4 { font-size: 0.9rem !important; }
        h5 { font-size: 0.85rem !important; }
        h6 { font-size: 0.8rem !important; }

        /* Navigation */
        .navbar-brand { font-size: 0.9rem !important; }
        .navbar-brand > div > div:first-child { font-size: 0.95rem !important; }
        .navbar-brand > div > div:last-child { font-size: 0.7rem !important; }
        .navbar-text { font-size: 0.75rem !important; }
        .nav-link { font-size: 0.75rem !important; }

        /* Tables */
        .table { font-size: 0.7rem !important; }
        .table th { 
            font-size: 0.65rem !important; 
            padding: 0.3rem !important;
            line-height: 1.2 !important;
        }
        .table td { 
            font-size: 0.7rem !important; 
            padding: 0.3rem !important;
            line-height: 1.2 !important;
        }

        /* Buttons */
        .btn { 
            font-size: 0.7rem !important; 
            padding: 0.25rem 0.5rem !important;
        }
        .btn-sm { 
            font-size: 0.65rem !important; 
            padding: 0.2rem 0.4rem !important;
        }
        .btn-lg { 
            font-size: 0.8rem !important; 
            padding: 0.4rem 0.8rem !important;
        }

        /* Cards */
        .card-body { 
            padding: 0.5rem !important; 
            font-size: 0.75rem !important;
        }
        .card-header { 
            font-size: 0.8rem !important; 
            padding: 0.4rem 0.8rem !important;
        }
        .card-title { font-size: 0.85rem !important; }

        /* Market Summary */
        .glow-card .card-body h5 { 
            font-size: 0.8rem !important; 
            margin-bottom: 0.2rem !important;
        }
        .glow-card .card-body small { 
            font-size: 0.65rem !important; 
        }

        /* Tabs */
        .nav-pills .nav-link { 
            font-size: 0.7rem !important; 
            padding: 0.3rem 0.6rem !important;
        }

        /* Form elements */
        .form-control { 
            font-size: 0.75rem !important; 
            padding: 0.25rem 0.5rem !important;
        }
        .form-label { font-size: 0.75rem !important; }







        /* Adjust main content top margin to account for INDEX bar */
        .main-content {
            margin-top: 60px;
        }
        
        
        

        /* Alerts and badges */
        .alert { 
            font-size: 0.75rem !important; 
            padding: 0.5rem !important;
        }
        .badge { font-size: 0.65rem !important; }

        /* Immediate tags */
        .immediate-tag {
            font-size: 0.6rem !important;
            padding: 1px 4px !important;
        }

        /* Range columns */
        .range-green, .range-red, .range-yellow {
            font-size: 0.65rem !important;
            padding: 0.15rem 0.3rem !important;
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .table { font-size: 0.65rem !important; }
            .table th { 
                font-size: 0.6rem !important; 
                padding: 0.2rem !important;
            }
            .table td { 
                font-size: 0.65rem !important; 
                padding: 0.2rem !important;
            }
            .btn { 
                font-size: 0.65rem !important; 
                padding: 0.2rem 0.4rem !important;
            }
            .glow-card .card-body h5 { font-size: 0.75rem !important; }
            .glow-card .card-body small { font-size: 0.6rem !important; }
            .navbar-brand > div > div:first-child { font-size: 0.85rem !important; }
            .navbar-brand > div > div:last-child { font-size: 0.65rem !important; }
            
            /* Price Action Cards - 2x2 Grid with Vertical Scroll */
            .price-action-scroll-container {
                height: 400px; /* Fixed height for 2x2 grid */
                overflow-y: auto;
                overflow-x: hidden;
                /* Hide scrollbars for cleaner look */
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            
            .price-action-scroll-container::-webkit-scrollbar {
                display: none;  /* Safari and Chrome */
            }
            
            .price-action-card {
                margin-bottom: 0.5rem;
            }
            
            /* Market Overview Cards - 3x3 Grid with Vertical Scroll */
            .market-overview-scroll-container {
                height: 350px; /* Fixed height for 3x3 grid */
                overflow-y: auto;
                overflow-x: hidden;
                /* Hide scrollbars for cleaner look */
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            
            .market-overview-scroll-container::-webkit-scrollbar {
                display: none;  /* Safari and Chrome */
            }
        }

        /* Desktop Market Overview - Two Row Layout (11 cards per row) */
        @media (min-width: 992px) {
            .market-overview-scroll-container {
                height: auto !important; /* Remove fixed height for desktop */
                overflow: visible !important; /* Remove scroll for desktop */
                display: flex !important;
                flex-wrap: wrap !important; /* Allow wrapping to 2 rows */
                gap: 0.2rem !important;
                align-content: flex-start !important;
            }
            
            .market-overview-scroll-container > div {
                flex: 0 0 calc(8.8% - 0.1rem) !important; /* Precisely 11 cards per row with gaps */
                min-width: calc(8.8% - 0.1rem) !important;
                max-width: calc(8.8% - 0.1rem) !important;
            }
        }
        
        /* Special styling for INDIAVIX card */
        .index-card[data-index-symbol="NSE:INDIAVIX-INDEX"] .card {
            background: linear-gradient(135deg, #1a365d 0%, #2d4a72 50%, #1e40af 100%) !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2) !important;
        }
        
        .index-card[data-index-symbol="NSE:INDIAVIX-INDEX"] .card:hover {
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
        }

        /* Navigation Bar Styling */
        .navbar-logo {
            height: 35px; 
            width: 35px;
        }
        
        .navbar-title {
            font-size: 0.9rem; 
            font-weight: bold; 
            line-height: 1.1;
            color: #4da6ff !important;
        }
        
        .navbar-subtitle {
            font-size: 0.7rem; 
            opacity: 0.9; 
            line-height: 1;
            color: #66b3ff !important;
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .navbar-logo {
                height: 28px; 
                width: 28px;
            }
            
            .navbar-title {
                font-size: 0.8rem !important;
            }
            
            .navbar-subtitle {
                font-size: 0.65rem !important;
            }
            
            .navbar-brand {
                margin-right: 0 !important;
            }
        }

        /* Ultra small devices */
        @media (max-width: 576px) {
            body { font-size: 0.75rem !important; }
            .table { font-size: 0.6rem !important; }
            .table th, .table td { 
                font-size: 0.55rem !important; 
                padding: 0.15rem !important;
            }
            .btn { 
                font-size: 0.6rem !important; 
                padding: 0.15rem 0.3rem !important;
            }
            .immediate-tag { font-size: 0.55rem !important; }
            .range-green, .range-red, .range-yellow { 
                font-size: 0.6rem !important; 
                padding: 0.1rem 0.2rem !important;
            }
            
            .navbar-logo {
                height: 25px; 
                width: 25px;
            }
            
            .navbar-title {
                font-size: 0.75rem !important;
            }
            
            .navbar-subtitle {
                font-size: 0.6rem !important;
            }
            
            .navbar {
                padding-top: 0.25rem !important;
                padding-bottom: 0.25rem !important;
            }
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 25%, #2a2d3e 50%, #1a1f2e 75%, #0f1419 100%); min-height: 100vh;" class="text-white">
    <!-- High/Low Alert Container -->
    <div id="alertContainer" class="alert-container">
        <!-- Dynamic alerts will be inserted here -->
    </div>
    
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-1">
        <div class="container d-flex align-items-center">
            <a class="navbar-brand d-flex align-items-center flex-grow-0" href="#" style="margin-right: 0;">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="MG Logo" class="navbar-logo">
                <div class="ms-2">
                    <div class="navbar-title">MG F&O Stocks Dashboard - Weekly Analysis</div>
                    <div class="navbar-subtitle">Be your own analyst. | Weekly OHLC Data</div>
                </div>
            </a>
            
            <div class="ms-auto d-flex align-items-center">
                <!-- Dashboard Toggle Buttons -->
                <div class="btn-group me-3" role="group" aria-label="Dashboard Type">
                    <a href="/dashboard" class="btn btn-outline-secondary btn-sm">Daily</a>
                    <a href="/weekly-dashboard" class="btn btn-primary btn-sm">Weekly</a>
                </div>
                <span class="text-primary me-3" id="globalTimestamp">--:--:--</span>
                {% if is_admin %}
                <button class="btn btn-sm btn-outline-info me-2 d-flex align-items-center" id="fetchHistoricalBtnNav">
                    <i class="fas fa-database me-1"></i>Historical
                </button>
                <div class="btn-group me-2" role="group">
                    <button class="btn btn-sm btn-outline-warning d-flex align-items-center" id="stopStreamingBtn">
                        <i class="fas fa-stop me-1"></i>Stop Stream
                    </button>
                    <button class="btn btn-sm btn-outline-success d-flex align-items-center" id="startStreamingBtn">
                        <i class="fas fa-play me-1"></i>Start Stream
                    </button>
                </div>
                {% endif %}
                <button class="btn btn-sm btn-outline-warning me-2 d-flex align-items-center" onclick="toggleAlerts()" title="Toggle Alerts" id="alertToggleBtn">
                    <i class="fas fa-bell"></i>
                </button>
                {% if current_user.is_admin() %}
                <button class="btn btn-sm btn-outline-info me-2 d-flex align-items-center" onclick="showBreakLevelsAlert()" title="LTP Break Analysis">
                    <i class="fas fa-chart-line me-1"></i>Breaks
                </button>
                {% endif %}
                <button class="btn btn-sm btn-outline-primary me-2 d-flex align-items-center" id="userManualBtn" data-bs-toggle="modal" data-bs-target="#userManualModal" title="User Manual">
                    <i class="fas fa-book"></i>
                </button>
                <a class="nav-link p-2 d-flex align-items-center" href="{{ url_for('logout') }}" title="Logout">
                    <i class="fas fa-sign-out-alt" style="font-size: 1rem;"></i>
                </a>
            </div>
        </div>
    </nav>




    <!-- Main Layout -->
    <div class="d-flex" style="min-height: calc(100vh - 70px);">
        <!-- Main Dashboard Content -->
        <div class="flex-grow-1">
            <div class="container-fluid mt-4 main-content">
                <!-- Dashboard Content Column -->
                <div class="dashboard-column">




        <!-- INDEX Cards Row with Market Summary Styling -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card glow-card" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #343a40 0%, #212529 100%) !important; padding: 2px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">Market Overview</div>
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <div class="btn-group" role="group" style="font-size: 0.65rem;">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="window.scrollTo(0,0)" style="padding: 1px 4px;">
                                        <i class="fas fa-home" style="font-size: 0.6rem;"></i>
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="scrollToTable('niftyTable')" style="padding: 1px 4px; font-size: 0.55rem;">
                                        F&O
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="scrollToTable('camarillaTable')" style="padding: 1px 4px; font-size: 0.55rem;">
                                        Camarilla
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="scrollToTable('cprTable')" style="padding: 1px 4px; font-size: 0.55rem;">
                                        CPR
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="scrollToTable('fibonacciTable')" style="padding: 1px 4px; font-size: 0.55rem;">
                                        Fibonacci
                                    </button>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" id="toggleIndexCards" style="font-size: 0.75rem; padding: 2px 6px;">
                                    <i class="fas fa-eye" id="indexToggleIcon"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-2" id="indexCardsContainer">
                        <div class="row g-1 market-overview-scroll-container">
                            <!-- NIFTY 50 -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTY50-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY 50</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- SENSEX -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="BSE:SENSEX-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">SENSEX</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- BANK NIFTY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYBANK-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">BANK NIFTY</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY IT -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYIT-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY IT</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- FINNIFTY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:FINNIFTY-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">FINNIFTY</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- MIDCAP NIFTY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:MIDCPNIFTY-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">MIDCAP SELECT</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY NEXT 50 -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYNXT50-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NEXT 50</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY FMCG -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYFMCG-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY FMCG</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY PHARMA -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYPHARMA-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY PHARMA</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY AUTO -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYAUTO-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY AUTO</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY METAL -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYMETAL-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY METAL</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY REALTY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYREALTY-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY REALTY</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY PSE -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYPSE-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY PSE</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY PVT BANK -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYPVTBANK-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">PVT BANK</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY MEDIA -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYMEDIA-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY MEDIA</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY INFRA -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYINFRA-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY INFRA</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY ENERGY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYENERGY-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY ENERGY</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY COMMODITIES -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYCOMMODITIES-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">COMMODITIES</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY CPSE -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYCPSE-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY CPSE</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY MIDCAP 50 -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYMIDCAP50-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">MIDCAP 50</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY SMALLCAP 100 -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYSMLCAP100-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">SMALLCAP 100</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- INDIA VIX -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:INDIAVIX-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">INDIA VIX</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Summary Cards with Glowing Effects -->
        <style>
            .glow-card {
                background: rgba(20, 25, 35, 0.9) !important;
                backdrop-filter: blur(10px);
                border: 2px solid transparent;
                border-radius: 12px;
                position: relative;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            .glow-card::before {
                content: '';
                position: absolute;
                top: -2px;
                left: -2px;
                right: -2px;
                bottom: -2px;
                border-radius: 12px;
                padding: 2px;
                background: linear-gradient(45deg, var(--glow-color), transparent, var(--glow-color));
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: exclude;
                mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                mask-composite: exclude;
                z-index: -1;
            }
            .glow-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(var(--glow-rgb), 0.3);
            }
            .glow-success { --glow-color: #28a745; --glow-rgb: 40, 167, 69; }
            .glow-danger { --glow-color: #dc3545; --glow-rgb: 220, 53, 69; }
            .glow-info { --glow-color: #17a2b8; --glow-rgb: 23, 162, 184; }
            .glow-warning { --glow-color: #ffc107; --glow-rgb: 255, 193, 7; }
            .glow-primary { --glow-color: #007bff; --glow-rgb: 0, 123, 255; }
            .glow-secondary { --glow-color: #6c757d; --glow-rgb: 108, 117, 125; }
            .glow-dark { --glow-color: #343a40; --glow-rgb: 52, 58, 64; }
            
            /* Custom column for 5 cards on mobile, 7 equal cards on desktop */
            .col-1_5 {
                flex: 0 0 20%;
                max-width: 20%;
            }
            
            @media (min-width: 992px) {
                .col-lg-1_7 {
                    flex: 0 0 14.2857%;
                    max-width: 14.2857%;
                }
                .col-lg-1_5 {
                    flex: 0 0 12.5%;
                    max-width: 12.5%;
                }
            }
        </style>
        
        <!-- Market Statistics Progress Bars -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card glow-card" style="background: rgba(20, 25, 35, 0.9) !important;">
                    <div class="card-body py-2">
                        <div class="row g-1">
                            <!-- Gainers Bar -->
                            <div class="col-3 col-lg-1_5">
                                <div class="text-center">
                                    <h6 class="mb-1 text-success fw-bold" id="gainersBarCount" style="font-size: 0.65rem;">26</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 52%" id="gainersBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Gainers</small>
                                </div>
                            </div>
                            
                            <!-- Losers Bar -->
                            <div class="col-3 col-lg-1_5">
                                <div class="text-center">
                                    <h6 class="mb-1 text-danger fw-bold" id="losersBarCount" style="font-size: 0.65rem;">24</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: 48%" id="losersBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Losers</small>
                                </div>
                            </div>
                            
                            <!-- Recovery Bar -->
                            <div class="col-3 col-lg-1_5">
                                <div class="text-center">
                                    <h6 class="mb-1 text-info fw-bold" id="recoveryBarCount" style="font-size: 0.65rem;">6</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 12%" id="recoveryBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Recovery</small>
                                </div>
                            </div>
                            
                            <!-- Declining Bar -->
                            <div class="col-3 col-lg-1_5">
                                <div class="text-center">
                                    <h6 class="mb-1 text-warning fw-bold" id="decliningBarCount" style="font-size: 0.65rem;">10</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 20%" id="decliningBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Declining</small>
                                </div>
                            </div>
                            
                            <!-- Turn+ Stocks Bar -->
                            <div class="col-3 col-lg-1_5">
                                <div class="text-center">
                                    <h6 class="mb-1 text-success fw-bold" id="turnPositiveBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="turnPositiveBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Turn+</small>
                                </div>
                            </div>
                            
                            <!-- Turn- Stocks Bar -->
                            <div class="col-3 col-lg-1_5">
                                <div class="text-center">
                                    <h6 class="mb-1 text-danger fw-bold" id="turnNegativeBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="turnNegativeBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Turn-</small>
                                </div>
                            </div>
                            
                            <!-- O=H Stocks Bar -->
                            <div class="col-3 col-lg-1_5">
                                <div class="text-center">
                                    <h6 class="mb-1 text-warning fw-bold" id="openHighBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="openHighBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">O=H</small>
                                </div>
                            </div>
                            
                            <!-- O=L Stocks Bar -->
                            <div class="col-3 col-lg-1_5">
                                <div class="text-center">
                                    <h6 class="mb-1 text-info fw-bold" id="openLowBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="openLowBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">O=L</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RVOL Pie Charts - 4 Charts in Single Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card glow-card" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #343a40 0%, #212529 100%) !important; padding: 8px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start text-warning fw-bold" style="font-size: 0.75rem;">RVOL (5-Day)  Volume Distribution Analysis</div>
                            <button class="btn btn-sm btn-outline-secondary" id="toggleRvolChart" style="font-size: 0.75rem; padding: 2px 6px;">
                                <i class="fas fa-eye" id="rvolChartToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2" id="rvolChartContainer">
                        <!-- 4 RVOL Tables - 2 per row -->
                        <div class="row g-2">
                            <div class="col-6 col-md-3">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-danger" style="font-size: 0.75rem;">>3x</h6>
                                        <small class="text-center d-block text-muted" style="font-size: 0.65rem;" id="above3xCount">0 stocks</small>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px; overflow-y: auto;">
                                        <div id="rvolTable1" class="rvol-table-container"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-warning" style="font-size: 0.75rem;">3x-2x</h6>
                                        <small class="text-center d-block text-muted" style="font-size: 0.65rem;" id="range3x2xCount">0 stocks</small>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px; overflow-y: auto;">
                                        <div id="rvolTable2" class="rvol-table-container"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-success" style="font-size: 0.75rem;">2x-1x</h6>
                                        <small class="text-center d-block text-muted" style="font-size: 0.65rem;" id="range2x1xCount">0 stocks</small>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px; overflow-y: auto;">
                                        <div id="rvolTable3" class="rvol-table-container"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-info" style="font-size: 0.75rem;"><1x</h6>
                                        <small class="text-center d-block text-muted" style="font-size: 0.65rem;" id="below1xCount">0 stocks</small>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px; overflow-y: auto;">
                                        <div id="rvolTable4" class="rvol-table-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        
        <!-- All 9 Summary Cards in Single Row -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card glow-card" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #343a40 0%, #212529 100%) !important; padding: 2px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">F&O Stocks Summary</div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleFOSummary()" id="foToggleBtn" style="font-size: 0.75rem; padding: 2px 6px;">
                                <i class="fas fa-eye" id="foToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2" id="foSummaryBody">
                        <div class="row g-1">
                            <!-- Market Movement Cards -->
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-success">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-success" id="gainersCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Gainers</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-danger">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-danger" id="losersCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Losers</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-info">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-info" id="recoveryCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Recovery</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-warning">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-warning" id="decliningCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Declining</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Market Analytics Cards -->
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-primary">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-primary" id="gapUpCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Gap Up</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-secondary">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-secondary" id="gapDownCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Gap Down</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-success">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-success" id="turnPositiveCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Turn+</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-danger">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-danger" id="turnNegativeCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Turn-</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1" id="avgPercentageCard">
                                <div class="card glow-card glow-success">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-success" id="avgPercentage" style="font-size: 0.9rem;">0.00%</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Avg %</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-warning">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-warning" id="openHighCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">O=H</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-info">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-info" id="openLowCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">O=L</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-2 col-lg-1">
                                <div class="card glow-card glow-info text-white">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold" id="volumeCount" style="font-size: 0.9rem;">0M</h6>
                                            <small style="font-size: 0.7rem;">Volume</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Analysis Charts - 4 Bar Charts in Single Row -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card glow-card" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #343a40 0%, #212529 100%) !important; padding: 8px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">Index Analysis Charts</div>
                            <button class="btn btn-sm btn-outline-secondary" id="toggleIndexCharts" style="font-size: 0.75rem; padding: 2px 6px;">
                                <i class="fas fa-eye" id="indexChartsToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2" id="indexChartsContainer">
                        <div class="row g-2">
                            <!-- Chart 1: % Change -->
                            <div class="col-md-3 col-6">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: 220px;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-warning" style="font-size: 0.7rem;">% Change</h6>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px;">
                                        <canvas id="indexChangeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <!-- Chart 2: % From Open -->
                            <div class="col-md-3 col-6">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: 220px;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-info" style="font-size: 0.7rem;">% From Open</h6>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px;">
                                        <canvas id="indexOpenChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <!-- Chart 3: % From High -->
                            <div class="col-md-3 col-6">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: 220px;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-success" style="font-size: 0.7rem;">% From High</h6>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px;">
                                        <canvas id="indexHighChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <!-- Chart 4: % From Low -->
                            <div class="col-md-3 col-6">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: 220px;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-danger" style="font-size: 0.7rem;">% From Low</h6>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px;">
                                        <canvas id="indexLowChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10 Cards of Price Action -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card glow-card" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #343a40 0%, #212529 100%) !important; padding: 2px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">10 Cards of Price Action</div>
                            <button class="btn btn-sm btn-outline-secondary" id="togglePriceActionCards" style="font-size: 0.75rem; padding: 2px 6px;">
                                <i class="fas fa-eye" id="priceActionToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2" id="priceActionCardsContainer">
                        <!-- Stock Category Sections - Horizontal Scroll on Mobile -->
                        <div class="row mb-3 g-1 price-action-scroll-container">
            <!-- Top 5 Gainers -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-success text-white">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-success"><i class="fas fa-arrow-up me-1"></i>TOP 5 GAINERS</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topGainersList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Losers -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-danger text-white">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-danger"><i class="fas fa-arrow-down me-1"></i>TOP 5 LOSERS</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topLosersList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Doublers -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-info text-white">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-info"><i class="fas fa-chart-line me-1"></i>INTRADAY RECOVERIES</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topRecoveriesList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Gap Up -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-primary text-white">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-primary"><i class="fas fa-level-up-alt me-1"></i>TOP 5 GAP UP</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topGapUpList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Gap Down -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-secondary text-white">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-secondary"><i class="fas fa-level-down-alt me-1"></i>TOP 5 GAP DOWN</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topGapDownList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intraday Fall -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-danger text-white">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-danger"><i class="fas fa-chart-line-down me-1"></i>INTRADAY FALL</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topFallList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Ranges -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-warning text-white">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-warning"><i class="fas fa-fire me-1"></i>TOP 5 HIGH VOLATILE</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topRangesList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Less Volatile -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-light text-white" style="background: rgba(108, 117, 125, 0.3) !important;">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-light"><i class="fas fa-dove me-1"></i>TOP 5 LESS VOLATILE</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topLessVolatileList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Turn Positive -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-success text-white">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-success"><i class="fas fa-arrow-trend-up me-1"></i>TOP 5 TURN POSITIVE</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topTurnPositiveList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 5 Turn Negative -->
            <div class="col-6 col-xl px-1 price-action-card" style="margin-bottom: 0.25rem; min-width: 180px;">
                <div class="card glow-card glow-danger text-white">
                    <div class="card-header bg-transparent border-0 py-1">
                        <h6 class="mb-0 text-center text-danger"><i class="fas fa-arrow-trend-down me-1"></i>TOP 5 TURN NEGATIVE</h6>
                    </div>
                    <div class="card-body p-1">
                        <div class="list-group list-group-flush bg-transparent" id="topTurnNegativeList">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>





        <!-- My Watchlist Section -->
        <div class="card mb-4" id="watchlistSection">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #212529 0%, #000000 100%) !important;">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 text-white fw-bold">
                        <i class="fas fa-star me-2"></i>
                        My Analyse Stocks Watchlist
                    </h5>
                    <span class="badge bg-secondary ms-2" id="watchlistCount">0</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <!-- Control Buttons -->
                    <button class="btn btn-sm btn-outline-light" onclick="refreshWatchlist()" title="Refresh Watchlist">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light ms-1" onclick="toggleTable('watchlistTableBody', 'watchlistToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="watchlistToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th style="width: 150px;">Selection Method</th>
                                <th class="text-center" style="width: 70px;">
                                    <i class="fas fa-trash" title="Remove"></i>
                                </th>
                                <th class="text-center" style="width: 120px;">Virtual Trade</th>
                                <th class="text-center" style="width: 100px;">Position</th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">Live LTP ()</th>
                                <th class="text-end">Invest Amt</th>
                                <th class="text-end">Profit/Loss</th>
                                <th class="text-end">% Change</th>
                            </tr>
                        </thead>
                        <tbody id="watchlistTableBody">
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-star fa-3x mb-3 d-block"></i>
                                        <h5>No Stocks in Watchlist</h5>
                                        <p>Add stocks to your watchlist by clicking the star button on any stock</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- F&O Stocks Live Data Title -->
        <h5 class="mb-3">
            <i class="fas fa-table me-2"></i>
            F&O Stocks Live Data
        </h5>
        
        <!-- Stock Data Table -->
        <div class="card" id="niftyTable">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="window.scrollTo(0,0)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="btn btn-primary btn-sm px-2 py-1" onclick="scrollToTable('niftyTable')">
                            F&O
                        </button>
                        <button class="btn btn-outline-success btn-sm px-2 py-1" onclick="scrollToTable('camarillaTable')">
                            Camarilla
                        </button>
                        <button class="btn btn-outline-warning btn-sm px-2 py-1" onclick="scrollToTable('cprTable')">
                            CPR
                        </button>
                        <button class="btn btn-outline-info btn-sm px-2 py-1" onclick="scrollToTable('fibonacciTable')">
                            Fibonacci
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                        <i class="fas fa-refresh"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleTable('stockTableBody', 'niftyToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="niftyToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th class="text-center" style="width: 70px;">
                                    <i class="fas fa-star" title="Watchlist"></i>
                                </th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">High ()</th>
                                <th class="text-end">Low ()</th>
                                <th class="text-end">Change ()</th>
                                <th class="text-end">Change (%)</th>
                                <th class="text-end">% Open</th>
                                <th class="text-end">% High</th>
                                <th class="text-end">% Low</th>
                                <th class="text-end">% Range</th>
                                <th class="text-end">Prev Close ()</th>
                                <th class="text-end">Volume</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <tr>
                                <td colspan="13" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-chart-line fa-3x mb-3 d-block"></i>
                                        <h5>No Data Available</h5>
                                        <p>Connect to WebSocket to start receiving live market data</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Camarilla Pivot Levels Section -->
        <div class="mb-2 mt-4">
            <h6 class="text-white d-flex align-items-center" style="margin-bottom: 8px; padding-left: 4px;"><i class="fas fa-chart-area me-2"></i>Camarilla Pivot Levels</h6>
        </div>
        <div class="card mt-0" id="camarillaTable">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="window.scrollTo(0,0)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm px-2 py-1" onclick="scrollToTable('niftyTable')">
                            F&O
                        </button>
                        <button class="btn btn-success btn-sm px-2 py-1" onclick="scrollToTable('camarillaTable')">
                            Camarilla
                        </button>
                        <button class="btn btn-outline-warning btn-sm px-2 py-1" onclick="scrollToTable('cprTable')">
                            CPR
                        </button>
                        <button class="btn btn-outline-info btn-sm px-2 py-1" onclick="scrollToTable('fibonacciTable')">
                            Fibonacci
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    {% if current_user.is_admin() %}
                    <button class="btn btn-sm btn-success" id="calculateCamarillaBtn">
                        <i class="fas fa-calculator"></i>
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-primary ms-2" id="refreshCamarillaBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleTable('camarillaTableBody', 'camarillaToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="camarillaToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th>Range</th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">Pivot</th>
                                <th class="text-end">R5</th>
                                <th class="text-end">R4</th>
                                <th class="text-end">R3</th>
                                <th class="text-end">R2</th>
                                <th class="text-end">R1</th>
                                <th class="text-end">S1</th>
                                <th class="text-end">S2</th>
                                <th class="text-end">S3</th>
                                <th class="text-end">S4</th>
                                <th class="text-end">S5</th>

                            </tr>
                        </thead>
                        <tbody id="camarillaTableBody">
                            <tr>
                                <td colspan="15" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-calculator fa-3x mb-3 d-block"></i>
                                        <h5>No Camarilla Data Available</h5>
                                        <p>Click "Calc Levels" to generate Camarilla pivot levels for all stocks</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- CPR Pivot Levels Table -->
        <div class="mb-2 mt-4">
            <h6 class="text-white d-flex align-items-center" style="margin-bottom: 8px; padding-left: 4px;"><i class="fas fa-crosshairs me-2"></i>CPR (Central Pivot Range) Analysis <small class="text-muted ms-2" style="font-size: 0.75rem;">*N=Narrow, *W=Wide</small></h6>
        </div>
        <div class="card mt-0" id="cprTable">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="window.scrollTo(0,0)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm px-2 py-1" onclick="scrollToTable('niftyTable')">
                            F&O
                        </button>
                        <button class="btn btn-outline-success btn-sm px-2 py-1" onclick="scrollToTable('camarillaTable')">
                            Camarilla
                        </button>
                        <button class="btn btn-warning btn-sm px-2 py-1" onclick="scrollToTable('cprTable')">
                            CPR
                        </button>
                        <button class="btn btn-outline-info btn-sm px-2 py-1" onclick="scrollToTable('fibonacciTable')">
                            Fibonacci
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    {% if current_user.is_admin() %}
                    <button class="btn btn-sm btn-warning" id="calculateCprBtn">
                        <i class="fas fa-calculator"></i>
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-primary ms-2" id="refreshCprBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleTable('cprTableBody', 'cprToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="cprToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th>Range</th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">R3</th>
                                <th class="text-end">R2</th>
                                <th class="text-end">R1</th>
                                <th class="text-end">TC (Top Central)</th>
                                <th class="text-end">PP (Pivot)</th>
                                <th class="text-end">BC (Bottom Central)</th>
                                <th class="text-end">S1</th>
                                <th class="text-end">S2</th>
                                <th class="text-end">S3</th>
                                <th class="text-end">CPR Width</th>

                            </tr>
                        </thead>
                        <tbody id="cprTableBody">
                            <tr>
                                <td colspan="14" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-crosshairs fa-3x mb-3 d-block"></i>
                                        <h5>No CPR Data Available</h5>
                                        <p>Click "Calc CPR Levels" to generate Central Pivot Range levels for all stocks</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Fibonacci Pivot Levels Table -->
        <div class="mb-2 mt-4">
            <h6 class="text-white d-flex align-items-center" style="margin-bottom: 8px; padding-left: 4px;"><i class="fas fa-chart-area me-2"></i>Fibonacci Pivot Analysis</h6>
        </div>
        <div class="card mt-0" id="fibonacciTable">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="window.scrollTo(0,0)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm px-2 py-1" onclick="scrollToTable('niftyTable')">
                            F&O
                        </button>
                        <button class="btn btn-outline-success btn-sm px-2 py-1" onclick="scrollToTable('camarillaTable')">
                            Camarilla
                        </button>
                        <button class="btn btn-outline-warning btn-sm px-2 py-1" onclick="scrollToTable('cprTable')">
                            CPR
                        </button>
                        <button class="btn btn-info btn-sm px-2 py-1" onclick="scrollToTable('fibonacciTable')">
                            Fibonacci
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    {% if current_user.is_admin() %}
                    <button class="btn btn-sm btn-info" id="calculateFibBtn">
                        <i class="fas fa-calculator"></i>
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-primary ms-2" id="refreshFibBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleTable('fibTableBody', 'fibToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="fibToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th>Range</th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">PP (Pivot)</th>
                                <th class="text-end">R3 (161.8%)</th>
                                <th class="text-end">R2 (123.6%)</th>
                                <th class="text-end">R1 (61.8%)</th>
                                <th class="text-end">S1 (61.8%)</th>
                                <th class="text-end">S2 (123.6%)</th>
                                <th class="text-end">S3 (161.8%)</th>
                                <th class="text-end">38.2% Level</th>
                                <th class="text-end">50% Level</th>

                            </tr>
                        </thead>
                        <tbody id="fibTableBody">
                            <tr>
                                <td colspan="13" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-chart-area fa-3x mb-3 d-block"></i>
                                        <h5>No Fibonacci Data Available</h5>
                                        <p>Click "Calc Fibonacci Levels" to generate Fibonacci pivot levels for all stocks</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if is_admin %}
        <!-- Historical Data Section -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Historical Data Management
                </h5>
                <div class="d-flex align-items-center">
                    <select id="resolutionSelect" class="form-select form-select-sm me-2" style="width: auto;">
                        <option value="1D">Daily</option>
                        <option value="60">1 Hour</option>
                        <option value="15">15 Min</option>
                        <option value="5">5 Min</option>
                        <option value="1">1 Min</option>
                    </select>
                    <button class="btn btn-sm btn-primary" id="fetchAllHistoricalBtn">
                        <i class="fas fa-download me-2"></i>
                        Fetch All Symbols
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Fetch Status</h6>
                        <div id="fetchStatus" class="alert alert-info" style="display: none;"></div>
                        <div id="fetchProgress" class="progress" style="display: none;">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Recent Fetch Logs</h6>
                        <div id="fetchLogs" style="max-height: 200px; overflow-y: auto;">
                            <p class="text-muted">No logs available</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>


                </div> <!-- Close dashboard-column -->
            </div> <!-- Close container-fluid -->
        </div> <!-- Close flex-grow-1 main content -->
    </div> <!-- Close d-flex layout -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/table-sorter.js') }}"></script>
    <script>
        // LTP Break Alert Window Function
        async function showBreakLevelsAlert() {
            try {
                // Fetch pre-calculated break levels from API
                const response = await fetch('/api/ltp-break-levels');
                const data = await response.json();
                
                if (data.status === 'success') {
                    const ltpBreakData = Object.values(data.levels);
                    
                    // Sort by most significant breaks first
                    ltpBreakData.sort((a, b) => {
                        if (b.break_count !== a.break_count) {
                            return b.break_count - a.break_count;
                        }
                        return (b.ltp || 0) - (a.ltp || 0);
                    });
                    
                    // Create alert content with only two signals
                    let alertContent = '<div style="height: 300px; overflow-y: auto; font-family: monospace; background: #212529; color: white; padding: 15px; border-radius: 8px;">';
                    alertContent += '<h5 style="color: #17a2b8; margin-bottom: 15px; text-align: center;"><i class="fas fa-chart-line"></i> Break Signals</h5>';
                    
                    if (ltpBreakData.length === 0) {
                        alertContent += '<p style="text-align: center; color: #6c757d;">No break signals available</p>';
                    } else {
                        alertContent += '<table style="width: 100%; border-collapse: collapse; font-size: 14px; background: #2c3034;">';
                        alertContent += '<thead><tr style="background-color: #343a40; color: #17a2b8;">';
                        alertContent += '<th style="padding: 12px; border: 1px solid #495057; text-align: center; width: 40%;">Symbol</th>';
                        alertContent += '<th style="padding: 12px; border: 1px solid #495057; text-align: center; width: 60%;">Break Signal</th>';
                        alertContent += '</tr></thead><tbody>';
                        
                        ltpBreakData.forEach(item => {
                            const breakText = item.breaks && item.breaks.length > 0 ? item.breaks.join(', ') : 'None';
                            const breakColor = item.breaks && item.breaks.length > 0 ? 
                                (item.breaks.some(b => b.includes('H')) ? '#28a745' : '#dc3545') : '#6c757d';
                            
                            alertContent += '<tr style="border-bottom: 1px solid #495057;">';
                            alertContent += `<td style="padding: 10px; border: 1px solid #495057; color: #17a2b8; font-weight: bold; text-align: center; font-size: 16px;">${item.symbol}</td>`;
                            alertContent += `<td style="padding: 10px; border: 1px solid #495057; color: ${breakColor}; text-align: center; font-weight: bold; font-size: 14px;">${breakText}</td>`;
                            alertContent += '</tr>';
                        });
                        
                        alertContent += '</tbody></table>';
                    }
                    
                    alertContent += '</div>';
                    
                    // Create custom alert modal
                    const alertModal = document.createElement('div');
                    alertModal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    `;
                    
                    const alertBox = document.createElement('div');
                    alertBox.style.cssText = `
                        background: #212529;
                        border-radius: 12px;
                        width: 500px;
                        height: 400px;
                        position: relative;
                        border: 2px solid #17a2b8;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    `;
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.innerHTML = '&times;';
                    closeBtn.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 15px;
                        background: transparent;
                        border: none;
                        color: #dc3545;
                        font-size: 24px;
                        cursor: pointer;
                        z-index: 10001;
                        padding: 5px;
                        border-radius: 50%;
                        width: 35px;
                        height: 35px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    
                    closeBtn.onclick = () => {
                        document.body.removeChild(alertModal);
                    };
                    
                    // Close on background click
                    alertModal.onclick = (e) => {
                        if (e.target === alertModal) {
                            document.body.removeChild(alertModal);
                        }
                    };
                    
                    alertBox.innerHTML = alertContent;
                    alertBox.appendChild(closeBtn);
                    alertModal.appendChild(alertBox);
                    document.body.appendChild(alertModal);
                    
                } else {
                    alert('Error loading break data: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading LTP break data:', error);
                alert('Failed to load break levels data');
            }
        }
        
        // Global state for alerts with persistent storage
        let alertsVisible = localStorage.getItem('alertsVisible') !== 'false'; // Default to true
        
        // Alert Toggle Function
        function toggleAlerts() {
            const alertContainer = document.getElementById('alertContainer');
            const button = document.getElementById('alertToggleBtn');
            
            if (!alertContainer) {
                console.error(' Alert container not found!');
                return;
            }
            
            // Toggle state
            alertsVisible = !alertsVisible;
            localStorage.setItem('alertsVisible', alertsVisible.toString());
            
            if (alertsVisible) {
                // Show alerts
                alertContainer.classList.add('show');
                
                if (button) {
                    button.classList.add('active');
                    button.style.backgroundColor = '#ffc107';
                    button.style.color = 'black';
                }
                
                console.log(' ALERTS SHOWN');
            } else {
                // Hide alerts
                alertContainer.classList.remove('show');
                
                if (button) {
                    button.classList.remove('active');
                    button.style.backgroundColor = '';
                    button.style.color = '';
                }
                
                console.log(' ALERTS HIDDEN');
            }
        }
        
        // Initialize alert visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            const alertContainer = document.getElementById('alertContainer');
            const button = document.getElementById('alertToggleBtn');
            
            if (alertContainer && alertsVisible) {
                alertContainer.classList.add('show');
                if (button) {
                    button.classList.add('active');
                    button.style.backgroundColor = '#ffc107';
                    button.style.color = 'black';
                }
            }
        });
        





    </script>
    <script>
        // Robust fetch utility with timeout, retries, and proper error handling
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            const delays = [500, 1000, 2000]; // Exponential backoff: 0.5s, 1s, 2s
            let lastError;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
                
                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    // Check if response is ok and content type is JSON
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Server returned non-JSON response');
                    }
                    
                    return response;
                    
                } catch (error) {
                    clearTimeout(timeoutId);
                    lastError = error;
                    
                    // Log meaningful error info
                    console.error(`Fetch attempt ${attempt + 1}/${maxRetries} failed for ${url}:`, {
                        message: error.message,
                        name: error.name,
                        stack: error.stack
                    });
                    
                    // Don't retry if it's a user abort or final attempt
                    if (error.name === 'AbortError' && attempt < maxRetries - 1) {
                        console.warn(`Request to ${url} timed out, retrying in ${delays[attempt]}ms...`);
                    } else if (attempt >= maxRetries - 1) {
                        break; // Final attempt failed
                    }
                    
                    // Wait before retrying (exponential backoff)
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delays[attempt]));
                    }
                }
            }
            
            // All attempts failed, throw the last error with context
            throw new Error(`Failed to fetch ${url} after ${maxRetries} attempts: ${lastError.message}`);
        }

        class Dashboard {
            constructor() {
                this.eventSource = null;
                this.stockData = {};
                // Initialize global window stockData for enhanced alerts
                window.stockData = {};
                this.isConnected = false;
                // Cache for CPR data to avoid multiple API calls for index cards
                this.cprDataCache = {};
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkWebSocketStatus();
                this.updateGlobalTimestamp();
                
                // Auto-start WebSocket connection only for admin users
                {% if is_admin %}
                setTimeout(() => this.connectWebSocket(), 2000); // Admin starts WebSocket after 2 seconds
                {% endif %}
                {% if is_admin %}
                this.loadFetchLogs(); // Load historical data logs on initialization (admin only)
                {% endif %}
                
                // All authenticated users can view technical analysis data calculated by admin
                this.loadCamarillaData(); // Load Camarilla data on initialization
                this.loadCprData(); // Load CPR data on initialization
                this.loadFibonacciData(); // Load Fibonacci data on initialization
                
                // CPR data caching removed - badges no longer needed
                
                // Start EventSource for live data streaming (original working method)
                this.startLiveDataPolling();
                this.refreshData(); // Load initial data
                
                setInterval(() => this.updateGlobalTimestamp(), 1000);
                
                // Immediate status check for users
                setTimeout(() => this.checkWebSocketStatus(), 1000); // Check status after 1 second
                setInterval(() => this.checkWebSocketStatus(), 3000); // Check status every 3 seconds for faster response
                
                // Initialize market statistics bars
                this.initializePercentageBars();
                
                // Load cached index data on startup
                this.loadCachedDataForAllIndexes();
            }

            initializePercentageBars() {
                console.log('Initializing market statistics bars...');
                
                // Delay initial update to ensure table is loaded
                setTimeout(() => {
                    // Performance: Removed hot-path logging
                    this.updateMarketStatsBars();
                }, 2000);
            }

            updateMarketStatsBars() {
                // Performance: Removed hot-path logging
                
                // Get counts from existing F&O summary cards  
                const gainersCount = document.getElementById('gainersCount')?.textContent || '0';
                const losersCount = document.getElementById('losersCount')?.textContent || '0';
                const recoveryCount = document.getElementById('recoveryCount')?.textContent || '0';
                const decliningCount = document.getElementById('decliningCount')?.textContent || '0';
                const turnPositiveCount = document.getElementById('turnPositiveCount')?.textContent || '0';
                const turnNegativeCount = document.getElementById('turnNegativeCount')?.textContent || '0';
                
                // Get individual O=H and O=L counts from separate cards
                const openHighCount = document.getElementById('openHighCount')?.textContent || '0';
                const openLowCount = document.getElementById('openLowCount')?.textContent || '0';
                
                // Get total stocks count
                const total = parseInt(document.getElementById('symbolCount')?.textContent || '50');
                
                // Update the progress bars using existing counts
                this.updateProgressBarFromCount('gainers', parseInt(gainersCount), total);
                this.updateProgressBarFromCount('losers', parseInt(losersCount), total);
                this.updateProgressBarFromCount('recovery', parseInt(recoveryCount), total);
                this.updateProgressBarFromCount('declining', parseInt(decliningCount), total);
                this.updateProgressBarFromCount('turnPositive', parseInt(turnPositiveCount), total);
                this.updateProgressBarFromCount('turnNegative', parseInt(turnNegativeCount), total);
                this.updateProgressBarFromCount('openHigh', parseInt(openHighCount), total);
                this.updateProgressBarFromCount('openLow', parseInt(openLowCount), total);
                
                // Performance: Removed hot-path logging - was impacting update speed
            }

            updateProgressBarFromCount(type, count, total) {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                
                const countElement = document.getElementById(`${type}BarCount`);
                const barElement = document.getElementById(`${type}Bar`);
                
                if (countElement) {
                    countElement.textContent = count;
                }
                
                if (barElement) {
                    barElement.style.width = percentage + '%';
                }
            }

            // Refresh functions for manual data reload
            async refreshCamarillaData() {
                const btn = document.getElementById('refreshCamarillaBtn');
                const originalText = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
                    
                    await this.loadCamarillaData();
                    this.showAlert('success', 'Camarilla data refreshed successfully');
                } catch (error) {
                    console.error('Error refreshing Camarilla data:', error);
                    this.showAlert('danger', 'Error refreshing Camarilla data');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async refreshCprData() {
                const btn = document.getElementById('refreshCprBtn');
                const originalText = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
                    
                    await this.loadCprData();
                    this.showAlert('success', 'CPR data refreshed successfully');
                } catch (error) {
                    console.error('Error refreshing CPR data:', error);
                    this.showAlert('danger', 'Error refreshing CPR data');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async refreshFibonacciData() {
                const btn = document.getElementById('refreshFibBtn');
                const originalText = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
                    
                    await this.loadFibonacciData();
                    this.showAlert('success', 'Fibonacci data refreshed successfully');
                } catch (error) {
                    console.error('Error refreshing Fibonacci data:', error);
                    this.showAlert('danger', 'Error refreshing Fibonacci data');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            bindEvents() {
                // Update the connect button to be historical data fetch
                // Removed connectBtn reference as button doesn't exist
                // Auto-connecting on page load - no manual connect button needed
                
                {
                    // Handle historical button if connect button doesn't exist
                    const historicalBtn = document.getElementById('fetchHistoricalBtn');
                    if (historicalBtn) {
                        historicalBtn.addEventListener('click', () => {
                            this.fetchHistoricalData();
                        });
                    }
                }

                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshData();
                });

                const fetchHistoricalBtnNav = document.getElementById('fetchHistoricalBtnNav');
                if (fetchHistoricalBtnNav) {
                    fetchHistoricalBtnNav.addEventListener('click', () => {
                        this.fetchHistoricalData();
                    });
                }

                // Admin streaming control buttons
                const stopStreamingBtn = document.getElementById('stopStreamingBtn');
                if (stopStreamingBtn) {
                    stopStreamingBtn.addEventListener('click', () => {
                        this.stopStreaming();
                    });
                }

                const startStreamingBtn = document.getElementById('startStreamingBtn');
                if (startStreamingBtn) {
                    startStreamingBtn.addEventListener('click', () => {
                        this.startStreaming();
                    });
                }

                // Legacy support for existing historical buttons if they exist
                const fetchHistoricalBtn = document.getElementById('fetchHistoricalBtn');
                if (fetchHistoricalBtn) {
                    fetchHistoricalBtn.addEventListener('click', () => {
                        this.fetchHistoricalData();
                    });
                }

                const fetchAllHistoricalBtn = document.getElementById('fetchAllHistoricalBtn');
                if (fetchAllHistoricalBtn) {
                    fetchAllHistoricalBtn.addEventListener('click', () => {
                        this.fetchAllHistoricalData();
                    });
                }

                const calculateCamarillaBtn = document.getElementById('calculateCamarillaBtn');
                if (calculateCamarillaBtn) {
                    calculateCamarillaBtn.addEventListener('click', () => {
                        this.calculateCamarillaLevels();
                    });
                }

                const calculateCprBtn = document.getElementById('calculateCprBtn');
                if (calculateCprBtn) {
                    calculateCprBtn.addEventListener('click', () => {
                        this.calculateCprLevels();
                    });
                }

                const calculateFibBtn = document.getElementById('calculateFibBtn');
                if (calculateFibBtn) {
                    calculateFibBtn.addEventListener('click', () => {
                        this.calculateFibonacciLevels();
                    });
                }

                // Add refresh button event handlers
                const refreshCamarillaBtn = document.getElementById('refreshCamarillaBtn');
                if (refreshCamarillaBtn) {
                    refreshCamarillaBtn.addEventListener('click', () => {
                        this.refreshCamarillaData();
                    });
                }

                const refreshCprBtn = document.getElementById('refreshCprBtn');
                if (refreshCprBtn) {
                    refreshCprBtn.addEventListener('click', () => {
                        this.refreshCprData();
                    });
                }

                const refreshFibBtn = document.getElementById('refreshFibBtn');
                if (refreshFibBtn) {
                    refreshFibBtn.addEventListener('click', () => {
                        this.refreshFibonacciData();
                    });
                }
            }

            async connectWebSocket() {
                try {
                    const response = await fetch('/start_websocket');
                    const result = await response.json();

                    if (result.status === 'success') {
                        this.showAlert('success', 'Connected to live market data');
                        this.startLiveDataPolling();
                        // WebSocket connected
                    } else {
                        this.showAlert('danger', `Connection failed: ${result.message}`);
                    }
                } catch (error) {
                    this.showAlert('danger', `Connection error: ${error.message}`);
                }
            }

            startLiveDataPolling() {
                // Initialize batching variables
                this.pendingUpdates = new Set();
                this.lastDOMUpdate = 0;
                
                this.pollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch('/api/weekly/data');
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const result = await response.json();
                        
                        if (result && result.data && typeof result.data === 'object') {
                            // Process stock data with batching
                            Object.values(result.data).forEach(data => {
                                if (data && data.symbol) {
                                    this.updateStockData(data);
                                    // Also update window.stockData for enhanced alerts
                                    window.stockData[data.full_symbol] = data;
                                    this.pendingUpdates.add(data.full_symbol);
                                }
                            });
                            
                            // Process real-time alerts from the stream
                            if (result.alerts && window.alertSystem) {
                                window.alertSystem.processAlertsFromStream(result.alerts);
                            }
                            
                            // Throttled DOM updates - only every 150ms max for faster UI
                            const now = Date.now();
                            if (now - this.lastDOMUpdate >= 150) {
                                this.batchedDOMUpdate();
                                this.lastDOMUpdate = now;
                            }
                        }
                        
                        // Check WebSocket status separately (less frequent)
                        if (Date.now() - (this.lastStatusCheck || 0) >= 10000) {
                            this.checkWebSocketStatus();
                            this.lastStatusCheck = Date.now();
                        }
                        
                    } catch (error) {
                        // Only log error if it's not a typical network error
                        if (error.message && !error.message.includes('NetworkError')) {
                            console.error('Polling error:', error.message);
                        }
                        this.updateConnectionStatus({ status: 'error', is_connected: false });
                    }
                }, 30000); // Low-frequency polling for weekly data (30 seconds)
            }
            
            batchedDOMUpdate() {
                if (this.pendingUpdates.size === 0) return;
                
                // Efficiently update only changed elements
                this.renderStockTable();
                this.updateMarketStatsBars();
                
                // Update technical analysis tables for pending symbols only
                this.pendingUpdates.forEach(symbol => {
                    const data = this.stockData[symbol];
                    if (data) {
                        this.updateCamarillaLTP(data);
                        if (this.updateCprLTP) this.updateCprLTP(data);
                        if (this.updateFibonacciLTP) this.updateFibonacciLTP(data);
                    }
                });
                
                // Clear pending updates
                this.pendingUpdates.clear();
            }
            
            stopLiveDataPolling() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                    this.pollingInterval = null;
                }
            }

            updateStockData(data) {
                if (!data || !data.full_symbol) {
                    return;
                }
                
                // Track previous price for animation
                const previousData = this.stockData[data.full_symbol];
                const previousPrice = previousData ? parseFloat(previousData.ltp) : null;
                const currentPrice = parseFloat(data.ltp);
                
                
                this.stockData[data.full_symbol] = data;
                // Also update window.stockData for enhanced alerts
                window.stockData[data.full_symbol] = data;
                
                // Simple rolling number animation for price changes
                if (previousPrice && currentPrice && !isNaN(previousPrice) && !isNaN(currentPrice) && Math.abs(previousPrice - currentPrice) > 0.001) {
                    this.rollNumber(data.symbol || data.full_symbol);
                }
                
                // Update INDEX SUMMARY cards if this is an INDEX symbol (immediate update for critical info)
                if (data.full_symbol && data.full_symbol.includes('-INDEX')) {
                    this.updateIndexCards(data);
                }
                
                // Note: DOM table updates are now batched in batchedDOMUpdate()
                // Only update symbol count immediately for user feedback
                const symbolCountEl = document.getElementById('symbolCount');
                if (symbolCountEl) symbolCountEl.textContent = Object.keys(this.stockData).length;
            }

            // Simple rolling number animation
            rollNumber(symbol) {
                const symbolCode = symbol.replace('NSE:', '').replace('-EQ', '').replace('-INDEX', '');
                
                // Find F&O table row
                const rows = document.querySelectorAll('#stockTableBody tr');
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const symbolCell = row.querySelector('td:first-child a');
                    if (symbolCell && symbolCell.textContent.trim() === symbolCode) {
                        const priceCell = row.querySelector('td:nth-child(3)');
                        if (priceCell) {
                            this.applyRollingAnimation(priceCell);
                        }
                        break;
                    }
                }
            }
            
            // Rolling animation for index cards
            rollNumberIndex(priceElement) {
                if (priceElement) {
                    this.applyRollingAnimation(priceElement);
                }
            }
            
            // Clean rolling animation
            applyRollingAnimation(element) {
                element.classList.add('rolling-number', 'updating');
                setTimeout(() => {
                    element.classList.remove('updating');
                }, 300);
            }

            // Index cache management
            cacheIndexData(symbol, data) {
                try {
                    const cacheKey = `index_cache_${symbol}`;
                    const cachedData = {
                        symbol: symbol,
                        data: data,
                        timestamp: Date.now(),
                        cached: true
                    };
                    localStorage.setItem(cacheKey, JSON.stringify(cachedData));
                } catch (e) {
                    console.warn('Failed to cache index data:', e);
                }
            }

            getCachedIndexData(symbol, maxAgeMinutes = 30) {
                try {
                    const cacheKey = `index_cache_${symbol}`;
                    const cached = localStorage.getItem(cacheKey);
                    if (!cached) return null;

                    const cachedData = JSON.parse(cached);
                    const ageMinutes = (Date.now() - cachedData.timestamp) / (1000 * 60);
                    
                    if (ageMinutes <= maxAgeMinutes) {
                        return cachedData.data;
                    } else {
                        // Remove expired cache
                        localStorage.removeItem(cacheKey);
                        return null;
                    }
                } catch (e) {
                    console.warn('Failed to retrieve cached index data:', e);
                    return null;
                }
            }

            loadCachedDataForAllIndexes() {
                // Load cached data for all index cards on page load
                document.querySelectorAll('[data-index-symbol]').forEach(indexCard => {
                    const symbol = indexCard.getAttribute('data-index-symbol');
                    const cachedData = this.getCachedIndexData(symbol);
                    if (cachedData) {
                        this.updateIndexCardDisplay(indexCard, cachedData, true);
                    }
                });
            }

            updateIndexCards(data) {
                // Find INDEX card with matching symbol
                const indexCard = document.querySelector(`[data-index-symbol="${data.full_symbol}"]`);
                
                if (indexCard) {
                    if (data.ltp) {
                        // Cache valid data for future use
                        this.cacheIndexData(data.full_symbol, data);
                        this.updateIndexCardDisplay(indexCard, data, false);
                        
                        // Update AI market comment based on index analysis
                        this.updateAIMarketComment();
                    } else {
                        // Try to use cached data as fallback
                        const cachedData = this.getCachedIndexData(data.full_symbol);
                        if (cachedData) {
                            console.log(`Using cached data for ${data.full_symbol}`);
                            this.updateIndexCardDisplay(indexCard, cachedData, true);
                        }
                    }
                }
            }

            updateIndexCardDisplay(indexCard, data, isCache) {
                if (indexCard && data.ltp) {
                    const priceEl = indexCard.querySelector('.index-price');
                    const changeEl = indexCard.querySelector('.index-change');
                    const ohlcEl = indexCard.querySelector('.index-ohlc');
                    
                    if (priceEl) {
                        // Get previous price for animation
                        const currentPriceText = priceEl.textContent;
                        let previousPrice = null;
                        
                        if (currentPriceText && currentPriceText !== '') {
                            // Parse the current displayed price (remove commas)
                            previousPrice = parseFloat(currentPriceText.replace(/,/g, ''));
                        }
                        
                        const currentPrice = parseFloat(data.ltp);
                        
                        // Simple rolling number for index price changes
                        if (!isCache && previousPrice && previousPrice !== currentPrice) {
                            this.rollNumberIndex(priceEl);
                        }
                        
                        const priceText = currentPrice.toLocaleString('en-IN', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                        
                        priceEl.textContent = priceText;
                    }
                    
                    // Update %Open percentage (change from open to current LTP)
                    const openPercentEl = indexCard.querySelector('.index-open-percent');
                    if (openPercentEl && data.open_price && data.ltp) {
                        const open = parseFloat(data.open_price);
                        const ltp = parseFloat(data.ltp);
                        
                        const openPercent = ((ltp - open) / open) * 100;
                        const openPercentFormatted = openPercent.toFixed(1);
                        
                        openPercentEl.textContent = `%O:${openPercent >= 0 ? '+' : ''}${openPercentFormatted}`;
                        
                        // Color the %Open based on positive/negative
                        if (openPercent > 0) {
                            openPercentEl.style.color = '#28a745'; // Green
                        } else if (openPercent < 0) {
                            openPercentEl.style.color = '#dc3545'; // Red
                        } else {
                            openPercentEl.style.color = '#ffffff'; // White for neutral
                        }
                    }
                    
                    if (changeEl) {
                        // Try to get change data from various possible fields
                        let change = null;
                        let changePercent = null;
                        
                        // Check for change data in different field names
                        if (data.ch !== undefined && data.chp !== undefined) {
                            change = parseFloat(data.ch);
                            changePercent = parseFloat(data.chp);
                        } else if (data.change !== undefined && data.change_percent !== undefined) {
                            change = parseFloat(data.change);
                            changePercent = parseFloat(data.change_percent);
                        } else if (data.ltp && data.prev_close_price) {
                            // Calculate change if we have current and previous prices
                            const currentPrice = parseFloat(data.ltp);
                            const prevPrice = parseFloat(data.prev_close_price);
                            change = currentPrice - prevPrice;
                            changePercent = (change / prevPrice) * 100;
                        }
                        
                        if (change !== null && changePercent !== null && !isNaN(change) && !isNaN(changePercent)) {
                            const sign = change >= 0 ? '+' : '';
                            changeEl.textContent = `${sign}${change.toFixed(2)} (${sign}${changePercent.toFixed(2)}%)`;
                            
                            // Update color and glow effect based on change
                            indexCard.className = indexCard.className.replace(/glow-(success|danger|secondary)/, '');
                            if (change > 0) {
                                indexCard.classList.add('glow-success');
                                changeEl.className = 'index-change text-success';
                                priceEl.className = 'index-price h6 mb-0 text-success';
                            } else if (change < 0) {
                                indexCard.classList.add('glow-danger'); 
                                changeEl.className = 'index-change text-danger';
                                priceEl.className = 'index-price h6 mb-0 text-danger';
                            } else {
                                indexCard.classList.add('glow-secondary');
                                changeEl.className = 'index-change text-white';
                                priceEl.className = 'index-price h6 mb-0 text-white';
                            }
                        } else {
                            // If no change data available, keep the card neutral
                            indexCard.className = indexCard.className.replace(/glow-(success|danger|secondary)/, '');
                            indexCard.classList.add('glow-secondary');
                            changeEl.className = 'index-change text-white';
                            priceEl.className = 'index-price h6 mb-0 text-white';
                        }
                    }
                    
                    // Add O=H/O=L pattern tags and CPR range tags to index cards
                    this.updateIndexTags(indexCard, data);
                }
            }

            updateIndexTags(indexCard, data) {
                // Create or update tags container
                let tagsEl = indexCard.querySelector('.index-tags');
                if (!tagsEl) {
                    tagsEl = document.createElement('div');
                    tagsEl.className = 'index-tags d-flex justify-content-center flex-wrap gap-1 mt-1';
                    const cardBody = indexCard.querySelector('.card-body');
                    if (cardBody) {
                        cardBody.appendChild(tagsEl);
                    }
                }
                
                let tagsHtml = '';
                
                // Defensive checks for field name variations
                const open = this.getFieldValue(data, ['open_price', 'open']);
                const high = this.getFieldValue(data, ['high_price', 'high']);
                const low = this.getFieldValue(data, ['low_price', 'low']);
                const ltp = data.ltp;
                
                // O=H/O=L pattern tags (same logic as F&O stock table)
                if (open && high && low && ltp) {
                    const openVal = parseFloat(open);
                    const highVal = parseFloat(high);
                    const lowVal = parseFloat(low);
                    
                    const isOpenHigh = Math.abs(openVal - highVal) <= (highVal * 0.001); // 0.1% tolerance
                    const isOpenLow = Math.abs(openVal - lowVal) <= (lowVal * 0.001); // 0.1% tolerance
                    
                    if (isOpenHigh) {
                        tagsHtml += '<span class="badge bg-primary" style="font-size: 0.3rem; padding: 1px 3px;">O=H</span>';
                    } else if (isOpenLow) {
                        tagsHtml += '<span class="badge bg-warning" style="font-size: 0.3rem; padding: 1px 3px;">O=L</span>';
                    }
                }
                
                // CPR badges removed for cleaner display
                
                tagsEl.innerHTML = tagsHtml;
            }

            // CPR tag function removed - badges no longer displayed

            // Helper function to get field value with fallback names
            getFieldValue(data, fieldNames) {
                for (const fieldName of fieldNames) {
                    if (data[fieldName] !== undefined && data[fieldName] !== null) {
                        return data[fieldName];
                    }
                }
                return null;
            }

            // AI Market Comment Generator based on Index Analysis
            updateAIMarketComment() {
                try {
                    const mainIndices = [
                        'NSE:NIFTY50-INDEX',
                        'NSE:NIFTYBANK-INDEX', 
                        'NSE:FINNIFTY-INDEX',
                        'BSE:SENSEX-INDEX'
                    ];

                    const indexData = [];
                    let validDataCount = 0;

                    // Collect data for main 4 indices
                    mainIndices.forEach(symbol => {
                        const cachedData = this.getCachedIndexData(symbol);
                        if (cachedData) {
                            // Try to get percentage change with robust extraction
                            let changePercent = cachedData.change_percent ?? cachedData.ch_per ?? cachedData.chp;
                            
                            // If no direct percentage field, calculate from available data
                            if (changePercent === undefined || changePercent === null) {
                                if (cachedData.ltp && cachedData.prev_close_price) {
                                    const ltp = Number(cachedData.ltp);
                                    const prevClose = Number(cachedData.prev_close_price);
                                    if (Number.isFinite(ltp) && Number.isFinite(prevClose) && prevClose > 0) {
                                        changePercent = ((ltp - prevClose) / prevClose) * 100;
                                    }
                                } else if (cachedData.ltp && cachedData.open_price) {
                                    const ltp = Number(cachedData.ltp);
                                    const open = Number(cachedData.open_price);
                                    if (Number.isFinite(ltp) && Number.isFinite(open) && open > 0) {
                                        changePercent = ((ltp - open) / open) * 100;
                                    }
                                }
                            }
                            
                            // Ensure we have a valid numeric value (including 0)
                            const numericChange = Number(changePercent);
                            if (Number.isFinite(numericChange)) {
                                indexData.push({
                                    symbol: symbol,
                                    change: numericChange
                                });
                                validDataCount++;
                            }
                        }
                    });

                    // AI comment functionality removed per user request
                } catch (error) {
                    console.error('Error in market overview update:', error);
                }
            }
            
            // CPR data caching and badge functions removed for cleaner display

            updateCamarillaLTP(data) {
                // Update LTP in Camarilla table if symbol exists
                const symbol = data.symbol;
                const ltp = data.ltp;
                
                if (symbol && ltp) {
                    const ltpCell = document.querySelector(`#camarillaTableBody tr[data-symbol="${symbol}"] .ltp-value`);
                    if (ltpCell) {
                        const row = ltpCell.closest('tr');
                        
                        // Get previous close from change percentage calculation
                        const changePercent = data.change_percent || data.chp;
                        let prevClose = null;
                        
                        if (changePercent !== undefined && changePercent !== 0) {
                            prevClose = ltp / (1 + (changePercent / 100));
                        }
                        
                        // Apply color based on change percentage
                        const colorClass = this.getLtpColorClass(ltp, prevClose);
                        ltpCell.className = `text-end ltp-value ${colorClass}`;
                        ltpCell.textContent = `${ltp.toFixed(2)}`;
                        
                        // Update Range column and S/R tags with real-time calculation
                        if (row && row.cells[1]) {
                            // Extract Camarilla levels from data attributes (robust parsing)
                            const camarillaItem = {
                                pivot: parseFloat(row.cells[3]?.getAttribute('data-value') || '0'),
                                r5: parseFloat(row.cells[4]?.getAttribute('data-value') || '0'),
                                r4: parseFloat(row.cells[5]?.getAttribute('data-value') || '0'),
                                r3: parseFloat(row.cells[6]?.getAttribute('data-value') || '0'),
                                r2: parseFloat(row.cells[7]?.getAttribute('data-value') || '0'),
                                r1: parseFloat(row.cells[8]?.getAttribute('data-value') || '0'),
                                s1: parseFloat(row.cells[9]?.getAttribute('data-value') || '0'),
                                s2: parseFloat(row.cells[10]?.getAttribute('data-value') || '0'),
                                s3: parseFloat(row.cells[11]?.getAttribute('data-value') || '0'),
                                s4: parseFloat(row.cells[12]?.getAttribute('data-value') || '0'),
                                s5: parseFloat(row.cells[13]?.getAttribute('data-value') || '0'),
                                prev_close: prevClose
                            };
                            
                            // Update range column with real-time calculation
                            row.cells[1].innerHTML = this.getCamarillaRange(ltp, camarillaItem);
                            
                            // Recalculate immediate support/resistance levels
                            const levels = [
                                { name: 'R5', value: camarillaItem.r5 },
                                { name: 'R4', value: camarillaItem.r4 },
                                { name: 'R3', value: camarillaItem.r3 },
                                { name: 'R2', value: camarillaItem.r2 },
                                { name: 'R1', value: camarillaItem.r1 },
                                { name: 'S1', value: camarillaItem.s1 },
                                { name: 'S2', value: camarillaItem.s2 },
                                { name: 'S3', value: camarillaItem.s3 },
                                { name: 'S4', value: camarillaItem.s4 },
                                { name: 'S5', value: camarillaItem.s5 }
                            ];
                            
                            const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);
                            
                            // Update all level columns with new S/R indicators
                            const levelCells = [
                                { cell: row.cells[3], level: 'Pivot', value: camarillaItem.pivot },
                                { cell: row.cells[4], level: 'R5', value: camarillaItem.r5 },
                                { cell: row.cells[5], level: 'R4', value: camarillaItem.r4 },
                                { cell: row.cells[6], level: 'R3', value: camarillaItem.r3 },
                                { cell: row.cells[7], level: 'R2', value: camarillaItem.r2 },
                                { cell: row.cells[8], level: 'R1', value: camarillaItem.r1 },
                                { cell: row.cells[9], level: 'S1', value: camarillaItem.s1 },
                                { cell: row.cells[10], level: 'S2', value: camarillaItem.s2 },
                                { cell: row.cells[11], level: 'S3', value: camarillaItem.s3 },
                                { cell: row.cells[12], level: 'S4', value: camarillaItem.s4 },
                                { cell: row.cells[13], level: 'S5', value: camarillaItem.s5 }
                            ];
                            
                            levelCells.forEach(({ cell, level, value }) => {
                                if (cell) {
                                    const srTag = this.getImmediateLevelTag(level, immediateResistance, immediateSupport);
                                    cell.innerHTML = `${srTag}${value.toFixed(2)}`;
                                }
                            });
                        }
                        
                        // Update break status indicators
                        this.updateBreakStatus(symbol, ltp);
                    }
                }
            }
            
            formatPrice(price) {
                if (price === null || price === undefined) return '-';
                return parseFloat(price).toFixed(2);
            }

            updateBreakStatus(symbol, ltp) {
                // Find the row for this symbol
                const row = document.querySelector(`#camarillaTableBody tr[data-symbol="${symbol}"]`);
                if (!row) return;
                
                // Determine current break level (same logic as in renderCamarillaTable)
                let breakLevel = 'None';
                
                // Apply color coding to all levels based on level type
                row.querySelectorAll('.level-value').forEach(cell => {
                    const levelAttr = cell.getAttribute('data-level');
                    const colorClass = this.getLevelColorClass(levelAttr);
                    cell.className = `text-end level-value ${colorClass}`;
                });
            }

            updateConnectionStatus(status) {
                const indicator = document.getElementById('connectionIndicator');
                const statusText = document.getElementById('connectionStatus');
                // Removed connectBtn reference as button doesn't exist

                this.isConnected = status.is_connected;

                if (indicator) {
                    if (status.is_connected) {
                        indicator.className = 'fas fa-circle text-success';
                        if (statusText) statusText.textContent = 'Connected';
                        // Auto-connected successfully
                        const marketStatusEl = document.getElementById('marketStatus');
                        if (marketStatusEl) marketStatusEl.textContent = 'Live';
                    } else if (status.status === 'connecting') {
                        indicator.className = 'fas fa-circle text-warning';
                        if (statusText) statusText.textContent = 'Connecting...';
                    } else if (status.status === 'error') {
                        indicator.className = 'fas fa-circle text-danger';
                        if (statusText) statusText.textContent = 'Error';
                        // Connection error
                    } else {
                        indicator.className = 'fas fa-circle text-danger';
                        if (statusText) statusText.textContent = 'Disconnected';
                        // Disconnected
                    }
                }

                const symbolCountEl = document.getElementById('symbolCount');
                if (symbolCountEl) symbolCountEl.textContent = status.symbol_count || 0;
            }

            renderStockTable() {
                const tbody = document.getElementById('stockTableBody');
                
                if (Object.keys(this.stockData).length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="13" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-chart-line fa-3x mb-3 d-block"></i>
                                    <h5>No Data Available</h5>
                                    <p>Connect to WebSocket to start receiving live market data</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Use data in the order received from backend (already properly ordered)
                const sortedData = Object.values(this.stockData);

                tbody.innerHTML = sortedData.map(stock => {
                    const changeClass = stock.change >= 0 ? 'text-success' : 'text-danger';
                    const changeIcon = stock.change >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                    const statusIcon = this.isDataFresh(stock.timestamp) ? 
                        '<i class="fas fa-circle text-success" title="Live"></i>' : 
                        '<i class="fas fa-circle text-warning" title="Stale"></i>';

                    // Use real OHLC values from stock data
                    const high = stock.high_price || 0;
                    const low = stock.low_price || 0; 
                    const open = stock.open_price || 0;
                    const ltp = stock.ltp;
                    
                    const percentOpen = (open && ltp) ? ((ltp - open) / open * 100) : 0;
                    const percentHigh = (high && ltp) ? ((ltp - high) / high * 100) : 0;
                    const percentLow = (low && ltp) ? ((ltp - low) / low * 100) : 0;
                    const percentRange = (high && low && low > 0) ? ((high - low) / low * 100) : 0;

                    // Color classes for percentage columns
                    const openClass = percentOpen >= 0 ? 'text-success' : 'text-danger';
                    const highClass = percentHigh >= 0 ? 'text-success' : 'text-danger';
                    const lowClass = percentLow >= 0 ? 'text-success' : 'text-danger';

                    // Check for O=H and O=L patterns with color badges (consistent logic)
                    const isOpenHigh = Math.abs(open - high) <= (high * 0.001); // 0.1% tolerance
                    const isOpenLow = Math.abs(open - low) <= (low * 0.001); // 0.1% tolerance
                    
                    let patternBadge = '';
                    if (isOpenHigh) {
                        patternBadge = ' <span class="text-primary ms-1" style="font-size: 0.7em;">O=H</span>';
                    } else if (isOpenLow) {
                        patternBadge = ' <span class="text-warning ms-1" style="font-size: 0.7em;">O=L</span>';
                    }
                    
                    // Extract symbol for TradingView URL (like technical analysis tables)
                    const symbolCode = stock.symbol.replace('NSE:', '').replace('-EQ', '');
                    const chartSymbol = `NSE:${symbolCode}`;
                    const chartUrl = `https://in.tradingview.com/chart/?symbol=${chartSymbol}`;
                    
                    return `
                        <tr>
                            <td class="fw-bold">
                                <a href="${chartUrl}" target="_blank" class="text-decoration-none text-white symbol-link" 
                                   style="transition: color 0.2s ease;"
                                   onmouseover="this.style.color='#007bff'" 
                                   onmouseout="this.style.color='white'" title="Open Chart">
                                    ${symbolCode}
                                </a>
                                ${patternBadge}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-warning watchlist-btn" 
                                        onclick="toggleWatchlist('${symbolCode}', '${stock.symbol}')" 
                                        data-symbol="${symbolCode}" 
                                        data-full-symbol="${stock.symbol}"
                                        title="Add to Watchlist"
                                        style="padding: 2px 6px; font-size: 0.7rem;">
                                    <i class="fas fa-star"></i>
                                </button>
                            </td>
                            <td class="fw-bold price-cell">${this.formatNumber(stock.ltp)}</td>
                            <td class="text-end">${this.formatNumber(stock.high_price || 0)}</td>
                            <td class="text-end">${this.formatNumber(stock.low_price || 0)}</td>
                            <td class="${changeClass}">
                                <i class="${changeIcon} me-1"></i>
                                ${this.formatNumber(stock.change)}
                            </td>
                            <td class="${changeClass} fw-bold">
                                ${this.formatNumber(stock.change_percent)}%
                            </td>
                            <td class="text-end ${openClass}">${this.formatNumber(percentOpen)}%</td>
                            <td class="text-end ${highClass}">${this.formatNumber(percentHigh)}%</td>
                            <td class="text-end ${lowClass}">${this.formatNumber(percentLow)}%</td>
                            <td class="text-end text-info">${this.formatNumber(percentRange)}%</td>
                            <td>${this.formatNumber(stock.prev_close_price || 0)}</td>
                            <td>${this.formatVolume(stock.volume)}</td>
                        </tr>
                    `;
                }).join('');
                
                // Update market summary cards with live data
                this.updateMarketSummary(sortedData);
                
                // Update watchlist if it exists and has data
                const watchlistCount = document.getElementById('watchlistCount');
                if (watchlistCount && parseInt(watchlistCount.textContent) > 0) {
                    // Throttled watchlist refresh to prevent frequent re-renders
                    if (!window.watchlistUpdateTimer) {
                        window.watchlistUpdateTimer = setTimeout(() => {
                            refreshWatchlistDisplay();
                            window.watchlistUpdateTimer = null;
                        }, 2000); // Update every 2 seconds max
                    }
                }
                
                
                // Update category sections
                this.updateCategorySections(sortedData);
            }

            formatNumber(num) {
                if (num === 0) return '0.00';
                return parseFloat(num).toFixed(2);
            }

            // Generate chart link for symbol
            generateChartLink(symbol, displayText) {
                // Create TradingView URL for floating browser
                const cleanSymbol = symbol.replace('NSE:', '').replace('-EQ', '');
                const chartSymbol = `NSE:${cleanSymbol}`;
                const chartUrl = `https://in.tradingview.com/chart/?symbol=${chartSymbol}`;
                
                return `<a href="${chartUrl}" target="_blank" rel="noopener noreferrer" 
                          class="text-decoration-none fw-bold symbol-link" 
                          style="color: inherit; transition: all 0.2s ease;"
                          onmouseover="this.style.textDecoration='underline'; this.style.color='#58a6ff'"
                          onmouseout="this.style.textDecoration='none'; this.style.color='inherit'"
                          data-chart-url="${chartUrl}"
                          data-symbol="${displayText}"
                          title="Click to view ${displayText} chart">
                    <i class="fas fa-chart-line me-1" style="font-size: 0.7rem;"></i>${displayText}
                </a>`;
            }

            // Generate chart link for INDEX symbols
            generateIndexChartLink(indexSymbol) {
                // Convert INDEX symbol to TradingView format
                let chartSymbol = indexSymbol.replace('NSE:', '').replace('BSE:', '').replace('-INDEX', '');
                
                // Handle BSE symbols separately
                if (indexSymbol.startsWith('BSE:')) {
                    const bseSymbolMap = {
                        'SENSEX': 'SENSEX'
                    };
                    chartSymbol = bseSymbolMap[chartSymbol] || chartSymbol;
                    return `https://in.tradingview.com/chart/?symbol=BSE:${chartSymbol}`;
                }
                
                // Handle NSE INDEX symbols - correct mappings
                const symbolMap = {
                    'NIFTY50': 'NIFTY',
                    'NIFTYBANK': 'BANKNIFTY',
                    'NIFTYIT': 'CNXIT',
                    'FINNIFTY': 'FINNIFTY',
                    'MIDCPNIFTY': 'MIDCPNIFTY',
                    'NIFTYNEXT50': 'NIFTYNXT50',
                    'NIFTYAUTO': 'CNXAUTO',
                    'NIFTYPHARMA': 'CNXPHARMA',
                    'NIFTYREALTY': 'CNXREALTY',
                    'NIFTYMETAL': 'CNXMETAL',
                    'NIFTYFMCG': 'CNXFMCG',
                    'NIFTYENERGY': 'CNXENERGY',
                    'NIFTYPVTBANK': 'NIFTYPVTBANK',
                    'NIFTYPSUBANK': 'NIFTYPSUBANK',
                    'NIFTYCOMMODITIES': 'NIFTYCOMMODITIES',
                    'NIFTYMEDIA': 'CNXMEDIA',
                    'NIFTYINFRA': 'CNXINFRA',
                    'NIFTYPSE': 'CNXPSE',
                    'NIFTYCPSE': 'CNXCPSE',
                    'NIFTYMIDCAP50': 'NIFTYMIDCAP50',
                    'NIFTYSMLCAP100': 'NIFTYSMLCAP100'
                };
                
                chartSymbol = symbolMap[chartSymbol] || chartSymbol;
                return `https://in.tradingview.com/chart/?symbol=NSE:${chartSymbol}`;
            }

            // Generate clickable symbol link for market summary cards
            generateClickableSymbol(symbol, displayText, extraClasses = '', extraStyles = '') {
                const cleanSymbol = symbol.replace('NSE:', '').replace('-EQ', '');
                const chartSymbol = `NSE:${cleanSymbol}`;
                const chartUrl = `https://in.tradingview.com/chart/?symbol=${chartSymbol}`;
                
                return `<span class="symbol-clickable ${extraClasses}" 
                              style="cursor: pointer; transition: color 0.2s ease; ${extraStyles}"
                              data-chart-url="${chartUrl}"
                              data-symbol="${cleanSymbol}"
                              title="Click to view ${cleanSymbol} chart"
                              onmouseover="this.style.color='#58a6ff'"
                              onmouseout="this.style.color=''"
                              onclick="window.open('${chartUrl}', '_blank', 'noopener')">${displayText}</span>`;
            }

            // Generate legacy TradingView chart link for INDEX symbols (if needed)
            generateLegacyIndexChartLink(indexSymbol) {
                // Convert INDEX symbol to TradingView format
                let chartSymbol = indexSymbol.replace('NSE:', '').replace('-INDEX', '');
                
                // Handle special cases for TradingView INDEX symbols
                const symbolMap = {
                    'NIFTY50': 'NIFTY',
                    'NIFTYBANK': 'BANKNIFTY',
                    'NIFTYIT': 'CNXIT',
                    'FINNIFTY': 'FINNIFTY',
                    'MIDCPNIFTY': 'CNXMIDCAP',
                    'NIFTYNXT50': 'NIFTYNXT50',
                    'NIFTYFMCG': 'CNXFMCG',
                    'NIFTYPHARMA': 'CNXPHARMA',
                    'NIFTYAUTO': 'CNXAUTO',
                    'NIFTYMETAL': 'CNXMETAL',
                    'NIFTYREALTY': 'CNXREALTY',
                    'NIFTYPSE': 'CNXPSE',
                    'NIFTYPVTBANK': 'NIFTYPVTBANK',
                    'NIFTYMEDIA': 'CNXMEDIA',
                    'NIFTYINFRA': 'CNXINFRA',
                    'NIFTYENERGY': 'CNXENERGY',
                    'NIFTYCOMMODITIES': 'CNXCOMMODITIES',
                    'NIFTYCPSE': 'NIFTYCPSE',
                    'NIFTYMIDCAP50': 'CNXMIDCAP',
                    'NIFTYSMLCAP100': 'CNXSMLCAP'
                };
                
                chartSymbol = symbolMap[chartSymbol] || chartSymbol;
                const chartUrl = `https://in.tradingview.com/chart/?symbol=NSE:${chartSymbol}`;
                
                return chartUrl;
            }

            // Check for O=H/O=L pattern
            getPatternIndicator(stock) {
                if (!stock.ltp || !stock.open_price || !stock.high_price || !stock.low_price) {
                    return '';
                }
                
                const openEqualsHigh = Math.abs(stock.open_price - stock.high_price) <= (stock.high_price * 0.001); // 0.1% tolerance
                const openEqualsLow = Math.abs(stock.open_price - stock.low_price) <= (stock.low_price * 0.001);
                
                if (openEqualsHigh) {
                    return ' <span class="text-warning ms-1" style="font-size: 0.6em;">O=H</span>';
                } else if (openEqualsLow) {
                    return ' <span class="text-info ms-1" style="font-size: 0.6em;">O=L</span>';
                }
                
                return '';
            }

            formatVolume(num) {
                if (num === 0) return '0';
                if (Math.abs(num) >= 10000000) {
                    return (num / 10000000).toFixed(2) + 'Cr';
                }
                if (Math.abs(num) >= 100000) {
                    return (num / 100000).toFixed(2) + 'L';
                }
                if (Math.abs(num) >= 1000) {
                    return (num / 1000).toFixed(2) + 'K';
                }
                return num.toLocaleString();
            }

            isDataFresh(timestamp) {
                return timestamp && (Date.now() / 1000 - timestamp) < 60; // Fresh if less than 1 minute old
            }


            updateGlobalTimestamp() {
                const now = new Date();
                const timestamp = now.toLocaleTimeString();
                const globalTimestamp = document.getElementById('globalTimestamp');
                if (globalTimestamp) {
                    globalTimestamp.textContent = timestamp;
                }
            }

            async checkWebSocketStatus() {
                try {
                    const response = await fetch('/websocket_status');
                    const status = await response.json();
                    this.updateConnectionStatus(status);
                    
                    // Additional debug logging for status issues
                    console.log('WebSocket status checked:', status);
                } catch (error) {
                    console.error('Error checking WebSocket status:', error);
                    // Set indicator to red on error
                    const indicator = document.getElementById('connectionIndicator');
                    if (indicator) indicator.className = 'fas fa-circle text-danger';
                }
            }

            async refreshData() {
                try {
                    const response = await fetch('/stock_data');
                    const result = await response.json();
                    
                    if (result && result.data && typeof result.data === 'object') {
                        // Clear existing data
                        this.stockData = {};
                        window.stockData = {};
                        
                        // Process stock data
                        if (result.data && typeof result.data === 'object') {
                            Object.values(result.data).forEach(data => {
                                if (data && data.symbol) {
                                    this.stockData[data.full_symbol] = data;
                // Also update window.stockData for enhanced alerts
                window.stockData[data.full_symbol] = data;
                                }
                            });
                        }
                        
                        // Update the table and counters
                        this.renderStockTable();
                        
                        // Update market statistics bars when stock table is updated
                        setTimeout(() => this.updateMarketStatsBars(), 100);
                        const symbolCountEl = document.getElementById('symbolCount');
                if (symbolCountEl) symbolCountEl.textContent = Object.keys(this.stockData).length;
                    }
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    // Show empty table on error
                    this.renderEmptyTable();
                }
            }

            renderEmptyTable() {
                const tbody = document.getElementById('stockTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-chart-line fa-3x mb-3 d-block"></i>
                                <h5>No Live Data Available</h5>
                                <p>Waiting for WebSocket connection...</p>
                            </div>
                        </td>
                    </tr>
                `;
            }

            async fetchHistoricalData() {
                const resolutionSelect = document.getElementById('resolutionSelect');
                const resolution = resolutionSelect ? resolutionSelect.value : '1D';
                const btn = document.getElementById('fetchHistoricalBtnNav') || document.getElementById('fetchHistoricalBtn');
                const originalText = btn ? btn.innerHTML : 'Historical';
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Fetching...';
                    
                    // Suppress progress alert messages during historical data fetch
                    const originalShowAlert = this.showAlert;
                    this.showAlert = () => {};
                    
                    this.showProgress(0);
                    
                    let startIndex = 0;
                    let totalProcessed = 0;
                    let totalSymbols = 0;
                    let allResults = {};
                    
                    while (true) {
                        const response = await fetch('/historical/fetch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                resolution: resolution,
                                days_back: 30,
                                start_index: startIndex
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.status !== 'success') {
                            // Restore alerts to show error message
                            this.showAlert = originalShowAlert;
                            this.showAlert('danger', 'Error: ' + result.message);
                            break;
                        }
                        
                        // Handle case where data already exists
                        const missing_count = result.missing_symbols_count || result.missing_symbols || 0;
                        if (missing_count === 0) {
                            // Restore alerts to show final message
                            this.showAlert = originalShowAlert;
                            this.showAlert('success', result.message || 'All symbols already have historical data');
                            break;
                        }
                        
                        // Accumulate results
                        Object.assign(allResults, result.results || {});
                        totalProcessed = result.total_processed || 0;
                        totalSymbols = result.missing_symbols || 0;
                        
                        // Update progress and show individual symbol status
                        if (missing_count > 0) {
                            const progressPercent = Math.round((totalProcessed / missing_count) * 100);
                            this.showProgress(progressPercent);
                            
                            // Show completion status for current batch symbols
                            if (result.current_symbols) {
                                for (const symbol of result.current_symbols) {
                                    this.showAlert('success', `Completed ${symbol}`, false);
                                }
                            }
                            
                            // Show fetching status for next batch symbols (better timing)
                            if (result.next_batch_symbols) {
                                for (const symbol of result.next_batch_symbols) {
                                    this.showAlert('info', `Fetching ${symbol}...`, false);
                                }
                            }
                            
                            this.showAlert('info', `Processing symbols: ${totalProcessed}/${missing_count} (${progressPercent}%)`);
                        }
                        
                        // Check if more symbols to process
                        if (!result.next_start_index) {
                            // All done!
                            this.showAlert('success', `Historical data fetch completed! Processed ${Object.keys(allResults).length} symbols`);
                            this.showProgress(100);
                            break;
                        }
                        
                        startIndex = result.next_start_index;
                        
                        // Small delay between batches to prevent overwhelming the server
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    this.loadFetchLogs();
                    
                } catch (error) {
                    this.showAlert('danger', 'Error fetching historical data: ' + error.message);
                } finally {
                    // Restore original showAlert function
                    if (typeof originalShowAlert !== 'undefined') {
                        this.showAlert = originalShowAlert;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                    setTimeout(() => this.hideProgress(), 3000);
                }
            }

            async stopStreaming() {
                const btn = document.getElementById('stopStreamingBtn');
                const originalText = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Stopping...';
                    
                    const response = await fetch('/admin/stop-streaming', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.showAlert('success', result.message);
                        // Update connection status
                        const indicator = document.getElementById('connectionIndicator');
                        const status = document.getElementById('connectionStatus');
                        if (indicator) indicator.className = 'fas fa-circle text-danger';
                        if (status) status.textContent = 'Disconnected';
                    } else {
                        this.showAlert('danger', 'Error: ' + result.message);
                    }
                } catch (error) {
                    this.showAlert('danger', 'Error stopping stream: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async startStreaming() {
                const btn = document.getElementById('startStreamingBtn');
                const originalText = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Starting...';
                    
                    const response = await fetch('/admin/start-streaming', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.showAlert('success', result.message);
                        // Update connection status
                        const indicator = document.getElementById('connectionIndicator');
                        const status = document.getElementById('connectionStatus');
                        if (indicator) indicator.className = 'fas fa-circle text-success';
                        if (status) status.textContent = 'Connected';
                    } else {
                        this.showAlert('danger', 'Error: ' + result.message);
                    }
                } catch (error) {
                    this.showAlert('danger', 'Error starting stream: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async fetchAllHistoricalData() {
                const resolutionSelect = document.getElementById('resolutionSelect');
                const resolution = resolutionSelect ? resolutionSelect.value : '1D';
                const btn = document.getElementById('fetchAllHistoricalBtn');
                const originalText = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Fetching...';
                    
                    this.showAlert('info', 'Fetching historical data for all F&O symbols...');
                    this.showProgress(0);
                    
                    let startIndex = 0;
                    let totalProcessed = 0;
                    let totalSymbols = 0;
                    let allResults = {};
                    
                    while (true) {
                        const response = await fetch('/historical/fetch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                resolution: resolution,
                                days_back: 30,
                                start_index: startIndex
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.status !== 'success') {
                            this.showAlert('danger', 'Error: ' + result.message);
                            break;
                        }
                        
                        // Accumulate results
                        Object.assign(allResults, result.results || {});
                        totalProcessed = result.total_processed || 0;
                        totalSymbols = result.missing_symbols || 0;
                        
                        // Update progress and show individual symbol status
                        const missing_count = result.missing_symbols_count || result.missing_symbols || 0;
                        if (missing_count > 0) {
                            const progressPercent = Math.round((totalProcessed / missing_count) * 100);
                            this.showProgress(progressPercent);
                            
                            // Show completion status for current batch symbols
                            if (result.current_symbols) {
                                for (const symbol of result.current_symbols) {
                                    this.showAlert('success', `Completed ${symbol}`, false);
                                }
                            }
                            
                            // Show fetching status for next batch symbols (better timing)
                            if (result.next_batch_symbols) {
                                for (const symbol of result.next_batch_symbols) {
                                    this.showAlert('info', `Fetching ${symbol}...`, false);
                                }
                            }
                            
                            this.showAlert('info', `Processing symbols: ${totalProcessed}/${missing_count} (${progressPercent}%)`);
                        }
                        
                        // Check if more symbols to process
                        if (!result.next_start_index) {
                            // All done!
                            this.showAlert('success', `Historical data fetch completed! Processed ${Object.keys(allResults).length} symbols`);
                            this.showProgress(100);
                            break;
                        }
                        
                        startIndex = result.next_start_index;
                        
                        // Small delay between batches to prevent overwhelming the server
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    this.loadFetchLogs();
                    
                } catch (error) {
                    this.showAlert('danger', 'Error fetching historical data: ' + error.message);
                } finally {
                    // Restore original showAlert function
                    if (typeof originalShowAlert !== 'undefined') {
                        this.showAlert = originalShowAlert;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                    setTimeout(() => this.hideProgress(), 3000);
                }
            }

            async loadFetchLogs() {
                try {
                    const response = await fetch('/historical/logs');
                    
                    if (!response.ok) {
                        console.warn(`Historical logs endpoint returned ${response.status}, skipping historical data display`);
                        return;
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.warn('Historical logs response is not JSON, skipping historical data display');
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (result.status === 'success' && result.logs.length > 0) {
                        const logsHtml = result.logs.map(log => {
                            const statusClass = log.status === 'success' ? 'text-success' : 
                                              log.status === 'error' ? 'text-danger' : 'text-warning';
                            const time = new Date(log.created_at).toLocaleTimeString();
                            return `
                                <div class="small mb-1">
                                    <span class="${statusClass}">
                                        <i class="fas fa-${log.status === 'success' ? 'check' : log.status === 'error' ? 'times' : 'clock'} me-1"></i>
                                        ${log.symbol} (${log.resolution})
                                    </span>
                                    <span class="text-muted">${time}</span>
                                    ${log.records_fetched ? `<span class="badge bg-secondary">${log.records_fetched} records</span>` : ''}
                                </div>
                            `;
                        }).join('');
                        
                        document.getElementById('fetchLogs').innerHTML = logsHtml;
                    }
                } catch (error) {
                    console.error('Error loading fetch logs:', error);
                }
            }

            async calculateCamarillaLevels() {
                const btn = document.getElementById('calculateCamarillaBtn');
                const originalText = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                    
                    const response = await fetch('/camarilla/calculate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.showAlert('success', result.message);
                        await this.loadCamarillaData();
                    } else {
                        this.showAlert('danger', 'Error: ' + result.message);
                    }
                } catch (error) {
                    this.showAlert('danger', 'Error calculating Camarilla levels: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async loadCamarillaData() {
                try {
                    const response = await fetch('/camarilla/data');
                    
                    // Check if response is ok and content type is JSON
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Server returned non-JSON response');
                    }
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        this.renderCamarillaTable(result.data);
                    } else {
                        console.error('Camarilla data error:', result.message);
                    }
                } catch (error) {
                    console.error('Error loading Camarilla data:', error);
                }
            }

            renderCamarillaTable(data) {
                const tbody = document.getElementById('camarillaTableBody');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="14" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-calculator fa-3x mb-3 d-block"></i>
                                    <h5>No Camarilla Data Available</h5>
                                    <p>Click "Calc Levels" to generate Camarilla pivot levels for all stocks</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const rows = data.map(item => {
                    const breakLevelClass = this.getBreakLevelClass(item.break_level);
                    const trendClass = this.getTrendClass(item.trend_direction);
                    const symbol = item.symbol.replace('NSE:', '');
                    const chartLink = this.generateChartLink(item.symbol, symbol);
                    const ltp = item.current_ltp || 0;
                    
                    // Find immediate support and resistance levels
                    const levels = [
                        { name: 'R5', value: item.r5 },
                        { name: 'R4', value: item.r4 },
                        { name: 'R3', value: item.r3 },
                        { name: 'R2', value: item.r2 },
                        { name: 'R1', value: item.r1 },
                        { name: 'S1', value: item.s1 },
                        { name: 'S2', value: item.s2 },
                        { name: 'S3', value: item.s3 },
                        { name: 'S4', value: item.s4 },
                        { name: 'S5', value: item.s5 }
                    ];
                    
                    const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);
                    
                    return `
                        <tr data-symbol="${item.symbol}">
                            <td>${chartLink}</td>
                            <td>${this.getCamarillaRange(ltp, item)}</td>
                            <td class="text-end ltp-value ${this.getLtpColorClass(ltp, item.prev_close)}">${ltp.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('Pivot')}" data-level="Pivot" data-value="${item.pivot}">${this.getImmediateLevelTag('Pivot', immediateResistance, immediateSupport)}${item.pivot.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R5')}" data-level="R5" data-value="${item.r5}">${this.getImmediateLevelTag('R5', immediateResistance, immediateSupport)}${item.r5.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R4')}" data-level="R4" data-value="${item.r4}">${this.getImmediateLevelTag('R4', immediateResistance, immediateSupport)}${item.r4.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R3')}" data-level="R3" data-value="${item.r3}">${this.getImmediateLevelTag('R3', immediateResistance, immediateSupport)}${item.r3.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R2')}" data-level="R2" data-value="${item.r2}">${this.getImmediateLevelTag('R2', immediateResistance, immediateSupport)}${item.r2.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R1')}" data-level="R1" data-value="${item.r1}">${this.getImmediateLevelTag('R1', immediateResistance, immediateSupport)}${item.r1.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S1')}" data-level="S1" data-value="${item.s1}">${this.getImmediateLevelTag('S1', immediateResistance, immediateSupport)}${item.s1.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S2')}" data-level="S2" data-value="${item.s2}">${this.getImmediateLevelTag('S2', immediateResistance, immediateSupport)}${item.s2.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S3')}" data-level="S3" data-value="${item.s3}">${this.getImmediateLevelTag('S3', immediateResistance, immediateSupport)}${item.s3.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S4')}" data-level="S4" data-value="${item.s4}">${this.getImmediateLevelTag('S4', immediateResistance, immediateSupport)}${item.s4.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S5')}" data-level="S5" data-value="${item.s5}">${this.getImmediateLevelTag('S5', immediateResistance, immediateSupport)}${item.s5.toFixed(2)}</td>

                        </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = rows;
            }

            getBreakLevelClass(breakLevel) {
                if (!breakLevel || breakLevel === 'None') return 'bg-secondary';
                if (breakLevel.startsWith('H')) return 'bg-success';
                if (breakLevel.startsWith('L')) return 'bg-danger';
                return 'bg-secondary';
            }

            getTrendClass(trend) {
                switch(trend) {
                    case 'bullish': return 'bg-success';
                    case 'bearish': return 'bg-danger';
                    case 'sideways': return 'bg-warning';
                    default: return 'bg-secondary';
                }
            }

            // Helper function to get color class based on level type
            getLevelColorClass(levelName) {
                // All levels use gray color text
                return 'text-muted';
            }

            // Helper function to get LTP color class based on change percentage
            getLtpColorClass(currentLtp, prevClose) {
                if (!currentLtp || !prevClose || prevClose === 0) {
                    return 'text-white'; // Default color if data is missing
                }
                
                const changePercent = ((currentLtp - prevClose) / prevClose) * 100;
                
                if (changePercent > 0) {
                    return 'price-up'; // Green with glow for positive
                } else if (changePercent < 0) {
                    return 'price-down'; // Red with glow for negative
                } else {
                    return 'text-white'; // Default for zero change
                }
            }

            // Helper function to find immediate support and resistance levels
            findImmediateLevels(ltp, levels) {
                const numericLevels = levels.filter(l => l.value && !isNaN(l.value));
                
                let immediateResistance = null;
                let immediateSupport = null;
                let minResistanceDistance = Infinity;
                let minSupportDistance = Infinity;
                
                // Find closest resistance level above LTP and closest support level below LTP
                for (const level of numericLevels) {
                    if (level.value > ltp) {
                        const distance = level.value - ltp;
                        if (distance < minResistanceDistance) {
                            minResistanceDistance = distance;
                            immediateResistance = level;
                        }
                    } else if (level.value < ltp) {
                        const distance = ltp - level.value;
                        if (distance < minSupportDistance) {
                            minSupportDistance = distance;
                            immediateSupport = level;
                        }
                    }
                }
                
                return { immediateResistance, immediateSupport };
            }

            // Helper function to add immediate level tag
            getImmediateLevelTag(levelName, immediateResistance, immediateSupport) {
                if (immediateResistance && levelName === immediateResistance.name) {
                    return '<span class="immediate-tag resistance-tag">R</span>';
                } else if (immediateSupport && levelName === immediateSupport.name) {
                    return '<span class="immediate-tag support-tag">S</span>';
                }
                return '';
            }

            // Helper function to determine current trading range for Camarilla with color coding
            getCamarillaRange(ltp, item) {
                if (!item) return '<span class="badge bg-secondary">No Data</span>';
                
                // Use previous close as fallback if LTP is missing
                const currentPrice = ltp || item.prev_close || 0;
                if (!currentPrice) return '<span class="badge bg-secondary">No Price</span>';
                
                let range = '';
                let bgClass = '';
                
                // Use same logic pattern as Fibonacci - strict > comparisons throughout
                // This ensures range matches S&R tag logic perfectly
                if (currentPrice > item.r5) { 
                    range = 'Above R5'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r4) { 
                    range = 'R4-R5'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r3) { 
                    range = 'R3-R4'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r2) { 
                    range = 'R2-R3'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.r1) { 
                    range = 'R1-R2'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s1) { 
                    range = 'S1-R1'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s2) { 
                    range = 'S2-S1'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s3) { 
                    range = 'S3-S2'; 
                    bgClass = 'range-red'; 
                } else if (currentPrice > item.s4) { 
                    range = 'S4-S3'; 
                    bgClass = 'range-red'; 
                } else if (currentPrice > item.s5) { 
                    range = 'S5-S4'; 
                    bgClass = 'range-red'; 
                } else { 
                    range = 'Below S5'; 
                    bgClass = 'range-red'; 
                }
                
                const textColor = bgClass === 'range-yellow' ? 'text-dark' : 'text-white';
                const priceIndicator = ltp ? '' : '*';
                return `<span class="${bgClass} ${textColor} fw-bold px-2 py-1 rounded">${range}${priceIndicator}</span>`;
            }

            // Helper function to determine current trading range for CPR with color coding
            getCprRange(ltp, item) {
                if (!item) return '<span class="badge bg-secondary">No Data</span>';
                
                // Use previous close as fallback if LTP is missing
                const currentPrice = ltp || item.prev_close || 0;
                if (!currentPrice) return '<span class="badge bg-secondary">No Price</span>';
                
                let range = '';
                let bgClass = '';
                
                // Use same logic pattern as Fibonacci - strict > comparisons throughout
                // This ensures range matches S&R tag logic perfectly
                if (currentPrice > item.r3) { 
                    range = 'Above R3'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r2) { 
                    range = 'R2-R3'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r1) { 
                    range = 'R1-R2'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.tc) { 
                    range = 'TC-R1'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.pp) { 
                    range = 'PP-TC'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.bc) { 
                    range = 'BC-PP'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s1) { 
                    range = 'S1-BC'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s2) { 
                    range = 'S2-S1'; 
                    bgClass = 'range-red'; 
                } else if (currentPrice > item.s3) { 
                    range = 'S3-S2'; 
                    bgClass = 'range-red'; 
                } else { 
                    range = 'Below S3'; 
                    bgClass = 'range-red'; 
                }
                
                const textColor = bgClass === 'range-yellow' ? 'text-dark' : 'text-white';
                const priceIndicator = ltp ? '' : '*';
                return `<span class="${bgClass} ${textColor} fw-bold px-2 py-1 rounded">${range}${priceIndicator}</span>`;
            }

            // Helper function to determine current trading range for Fibonacci with color coding
            getFibonacciRange(ltp, item) {
                if (!item) return '<span class="badge bg-secondary">No Data</span>';
                
                // Use previous close as fallback if LTP is missing
                const currentPrice = ltp || item.prev_close || 0;
                if (!currentPrice) return '<span class="badge bg-secondary">No Price</span>';
                
                let range = '';
                let bgClass = '';
                
                if (currentPrice > item.r3_161) { 
                    range = 'Above R3'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r2_123) { 
                    range = 'R2-R3'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r1_61) { 
                    range = 'R1-R2'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.pp) { 
                    range = 'PP-R1'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s1_61) { 
                    range = 'S1-PP'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s2_123) { 
                    range = 'S2-S1'; 
                    bgClass = 'range-red'; 
                } else if (currentPrice > item.s3_161) { 
                    range = 'S3-S2'; 
                    bgClass = 'range-red'; 
                } else { 
                    range = 'Below S3'; 
                    bgClass = 'range-red'; 
                }
                
                const textColor = bgClass === 'range-yellow' ? 'text-dark' : 'text-white';
                const priceIndicator = ltp ? '' : '*';
                return `<span class="${bgClass} ${textColor} fw-bold px-2 py-1 rounded">${range}${priceIndicator}</span>`;
            }


            async calculateCprLevels() {
                const btn = document.getElementById('calculateCprBtn');
                const originalText = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                    
                    const response = await fetch('/calculate_cpr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.showAlert('success', `CPR levels calculated successfully for ${result.count} symbols!`);
                            this.renderCprTable(result.data);
                            const statusBadge = document.getElementById('cprStatusBadge');
                            if (statusBadge) statusBadge.textContent = new Date().toLocaleTimeString();
                        } else {
                            this.showAlert('danger', result.message || 'Error calculating CPR levels');
                        }
                    } else {
                        throw new Error('Server error');
                    }
                } catch (error) {
                    console.error('Error calculating CPR levels:', error);
                    this.showAlert('danger', 'Error calculating CPR levels. Please try again.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async loadCprData() {
                try {
                    const response = await fetchWithRetry('/get_cpr_data', {
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    if (result.success && result.data) {
                        this.renderCprTable(result.data);
                        if (result.data.length > 0) {
                            const statusBadge = document.getElementById('cprStatusBadge');
                            if (statusBadge) statusBadge.textContent = 'Loaded';
                        }
                    } else {
                        console.error('CPR data error:', result.message || 'Unknown server error');
                    }
                } catch (error) {
                    console.error('Error loading CPR data:', {
                        message: error.message,
                        url: '/get_cpr_data',
                        timestamp: new Date().toISOString()
                    });
                    // Graceful degradation - don't break the UI
                    const statusBadge = document.getElementById('cprStatusBadge');
                    if (statusBadge) {
                        statusBadge.textContent = 'Failed';
                        statusBadge.className = 'badge bg-warning';
                    }
                }
            }

            renderCprTable(data) {
                const tbody = document.getElementById('cprTableBody');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="14" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-crosshairs fa-3x mb-3 d-block"></i>
                                    <h5>No CPR Data Available</h5>
                                    <p>Click "Calc CPR Levels" to generate Central Pivot Range levels for all stocks</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const rows = data.map(item => {
                    const breakLevelClass = this.getBreakLevelClass(item.break_level);
                    const trendClass = this.getTrendClass(item.trend_direction);
                    const cprWidthPercent = ((item.tc - item.bc) / item.pp * 100).toFixed(2);
                    const cprWidthIndicator = cprWidthPercent < 0.3 ? 'N' : 'W';
                    const cprWidthColor = cprWidthPercent < 0.3 ? 'text-success' : 'text-warning';
                    const symbol = item.symbol.replace('NSE:', '');
                    const chartLink = this.generateChartLink(item.symbol, symbol);
                    const ltp = item.current_ltp || 0;
                    
                    // Find immediate support and resistance levels
                    const levels = [
                        { name: 'R3', value: item.r3 },
                        { name: 'R2', value: item.r2 },
                        { name: 'R1', value: item.r1 },
                        { name: 'TC', value: item.tc },
                        { name: 'BC', value: item.bc },
                        { name: 'S1', value: item.s1 },
                        { name: 'S2', value: item.s2 },
                        { name: 'S3', value: item.s3 }
                    ];
                    
                    const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);
                    
                    return `
                        <tr data-symbol="${item.symbol}">
                            <td>${chartLink}</td>
                            <td>${this.getCprRange(ltp, item)}</td>
                            <td class="text-end ltp-value ${this.getLtpColorClass(ltp, item.prev_close)}">${ltp.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R3')}" data-level="R3" data-value="${item.r3}">${this.getImmediateLevelTag('R3', immediateResistance, immediateSupport)}${item.r3.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R2')}" data-level="R2" data-value="${item.r2}">${this.getImmediateLevelTag('R2', immediateResistance, immediateSupport)}${item.r2.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R1')}" data-level="R1" data-value="${item.r1}">${this.getImmediateLevelTag('R1', immediateResistance, immediateSupport)}${item.r1.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('TC')}" data-level="TC" data-value="${item.tc}">${this.getImmediateLevelTag('TC', immediateResistance, immediateSupport)}${item.tc.toFixed(2)}</td>
                            <td class="text-end ${this.getLevelColorClass('PP')}">${item.pp.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('BC')}" data-level="BC" data-value="${item.bc}">${this.getImmediateLevelTag('BC', immediateResistance, immediateSupport)}${item.bc.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S1')}" data-level="S1" data-value="${item.s1}">${this.getImmediateLevelTag('S1', immediateResistance, immediateSupport)}${item.s1.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S2')}" data-level="S2" data-value="${item.s2}">${this.getImmediateLevelTag('S2', immediateResistance, immediateSupport)}${item.s2.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S3')}" data-level="S3" data-value="${item.s3}">${this.getImmediateLevelTag('S3', immediateResistance, immediateSupport)}${item.s3.toFixed(2)}</td>
                            <td class="text-end ${cprWidthColor}">${cprWidthIndicator}</td>

                        </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = rows;
            }

            async calculateFibonacciLevels() {
                const btn = document.getElementById('calculateFibBtn');
                const originalText = btn.innerHTML;
                
                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
                    
                    const response = await fetch('/calculate_fibonacci', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.showAlert('success', `Fibonacci levels calculated successfully for ${result.count} symbols!`);
                            this.renderFibonacciTable(result.data);
                            document.getElementById('fibStatusBadge').textContent = new Date().toLocaleTimeString();
                        } else {
                            this.showAlert('danger', result.message || 'Error calculating Fibonacci levels');
                        }
                    } else {
                        throw new Error('Server error');
                    }
                } catch (error) {
                    console.error('Error calculating Fibonacci levels:', error);
                    this.showAlert('danger', 'Error calculating Fibonacci levels. Please try again.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async loadFibonacciData() {
                try {
                    const response = await fetchWithRetry('/get_fibonacci_data', {
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    if (result.success && result.data) {
                        this.renderFibonacciTable(result.data);
                        if (result.data.length > 0) {
                            const statusBadge = document.getElementById('fibStatusBadge');
                            if (statusBadge) statusBadge.textContent = 'Loaded';
                        }
                    } else {
                        console.error('Fibonacci data error:', result.message || 'Unknown server error');
                    }
                } catch (error) {
                    console.error('Error loading Fibonacci data:', {
                        message: error.message,
                        url: '/get_fibonacci_data',
                        timestamp: new Date().toISOString()
                    });
                    // Graceful degradation - don't break the UI
                    const statusBadge = document.getElementById('fibStatusBadge');
                    if (statusBadge) {
                        statusBadge.textContent = 'Failed';
                        statusBadge.className = 'badge bg-warning';
                    }
                }
            }

            renderFibonacciTable(data) {
                const tbody = document.getElementById('fibTableBody');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="13" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-chart-area fa-3x mb-3 d-block"></i>
                                    <h5>No Fibonacci Data Available</h5>
                                    <p>Click "Calc Fibonacci Levels" to generate Fibonacci pivot levels for all stocks</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const rows = data.map(item => {
                    const breakLevelClass = this.getBreakLevelClass(item.break_level);
                    const trendClass = this.getTrendClass(item.trend_direction);
                    const symbol = item.symbol.replace('NSE:', '');
                    const chartLink = this.generateChartLink(item.symbol, symbol);
                    const ltp = item.current_ltp || 0;
                    
                    // Find immediate support and resistance levels
                    const levels = [
                        { name: 'R3', value: item.r3_161 },
                        { name: 'R2', value: item.r2_123 },
                        { name: 'R1', value: item.r1_61 },
                        { name: 'S1', value: item.s1_61 },
                        { name: 'S2', value: item.s2_123 },
                        { name: 'S3', value: item.s3_161 },
                        { name: '38%', value: item.level_38 },
                        { name: '50%', value: item.level_50 }
                    ];
                    
                    const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);
                    
                    return `
                        <tr data-symbol="${item.symbol}">
                            <td>${chartLink}</td>
                            <td>${this.getFibonacciRange(ltp, item)}</td>
                            <td class="text-end ltp-value ${this.getLtpColorClass(ltp, item.prev_close)}">${ltp.toFixed(2)}</td>
                            <td class="text-end ${this.getLevelColorClass('PP')}">${item.pp.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R3')}" data-level="R3" data-value="${item.r3_161}">${this.getImmediateLevelTag('R3', immediateResistance, immediateSupport)}${item.r3_161.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R2')}" data-level="R2" data-value="${item.r2_123}">${this.getImmediateLevelTag('R2', immediateResistance, immediateSupport)}${item.r2_123.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R1')}" data-level="R1" data-value="${item.r1_61}">${this.getImmediateLevelTag('R1', immediateResistance, immediateSupport)}${item.r1_61.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S1')}" data-level="S1" data-value="${item.s1_61}">${this.getImmediateLevelTag('S1', immediateResistance, immediateSupport)}${item.s1_61.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S2')}" data-level="S2" data-value="${item.s2_123}">${this.getImmediateLevelTag('S2', immediateResistance, immediateSupport)}${item.s2_123.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S3')}" data-level="S3" data-value="${item.s3_161}">${this.getImmediateLevelTag('S3', immediateResistance, immediateSupport)}${item.s3_161.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('38%')}" data-level="38%" data-value="${item.level_38}">${this.getImmediateLevelTag('38%', immediateResistance, immediateSupport)}${item.level_38.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('50%')}" data-level="50%" data-value="${item.level_50}">${this.getImmediateLevelTag('50%', immediateResistance, immediateSupport)}${item.level_50.toFixed(2)}</td>

                        </tr>
                    `;
                }).join('');
                
                tbody.innerHTML = rows;
            }

            // Normalize WebSocket symbol to match CPR database symbol format
            normalizeSymbolForCpr(websocketSymbol) {
                if (!websocketSymbol) return websocketSymbol;
                
                // Handle index symbols: NSE:NIFTY50-INDEX -> NIFTY50
                if (websocketSymbol.includes('-INDEX')) {
                    let normalized = websocketSymbol.replace('-INDEX', '');
                    normalized = normalized.replace('NSE:', '').replace('BSE:', '');
                    
                    // Special case: BSE:SENSEX-INDEX -> BSE:SENSEX (preserve BSE prefix)
                    if (websocketSymbol.startsWith('BSE:SENSEX')) {
                        return 'BSE:SENSEX';
                    }
                    
                    return normalized;
                }
                
                // Handle regular stocks: NSE:SBIN-EQ -> SBIN
                return websocketSymbol.replace('NSE:', '').replace('BSE:', '').replace('-EQ', '');
            }

            updateCprLTP(data) {
                // Update LTP in CPR table if symbol exists
                const websocketSymbol = data.symbol;
                const ltp = data.ltp;
                
                if (websocketSymbol && ltp) {
                    // Normalize symbol to match CPR database format
                    const normalizedSymbol = this.normalizeSymbolForCpr(websocketSymbol);
                    
                    // Try both the original symbol and normalized symbol for better matching
                    const ltpCell = document.querySelector(`#cprTableBody tr[data-symbol="${normalizedSymbol}"] .ltp-value`) ||
                                   document.querySelector(`#cprTableBody tr[data-symbol="${websocketSymbol}"] .ltp-value`);
                    
                    if (ltpCell) {
                        const row = ltpCell.closest('tr');
                        
                        // Get previous close from the database or calculate from change data
                        const changePercent = data.change_percent || data.chp;
                        let prevClose = null;
                        
                        if (changePercent !== undefined && changePercent !== 0) {
                            prevClose = ltp / (1 + (changePercent / 100));
                        }
                        
                        // Apply color based on change percentage
                        const colorClass = this.getLtpColorClass(ltp, prevClose);
                        ltpCell.className = `text-end ltp-value ${colorClass}`;
                        ltpCell.textContent = `${ltp.toFixed(2)}`;
                        
                        // Update Range column and S/R tags with real-time calculation
                        if (row && row.cells[1]) {
                            // Extract CPR levels from data attributes (robust parsing)
                            const cprItem = {
                                r3: parseFloat(row.cells[3]?.getAttribute('data-value') || '0'),
                                r2: parseFloat(row.cells[4]?.getAttribute('data-value') || '0'),
                                r1: parseFloat(row.cells[5]?.getAttribute('data-value') || '0'),
                                tc: parseFloat(row.cells[6]?.getAttribute('data-value') || '0'),
                                pp: parseFloat(row.cells[7]?.textContent.replace(/[RS]/g, '') || '0'), // PP doesn't have S/R tags
                                bc: parseFloat(row.cells[8]?.getAttribute('data-value') || '0'),
                                s1: parseFloat(row.cells[9]?.getAttribute('data-value') || '0'),
                                s2: parseFloat(row.cells[10]?.getAttribute('data-value') || '0'),
                                s3: parseFloat(row.cells[11]?.getAttribute('data-value') || '0'),
                                prev_close: prevClose
                            };
                            
                            // Update range column with real-time calculation
                            row.cells[1].innerHTML = this.getCprRange(ltp, cprItem);
                            
                            // Recalculate immediate support/resistance levels
                            const levels = [
                                { name: 'R3', value: cprItem.r3 },
                                { name: 'R2', value: cprItem.r2 },
                                { name: 'R1', value: cprItem.r1 },
                                { name: 'TC', value: cprItem.tc },
                                { name: 'BC', value: cprItem.bc },
                                { name: 'S1', value: cprItem.s1 },
                                { name: 'S2', value: cprItem.s2 },
                                { name: 'S3', value: cprItem.s3 }
                            ];
                            
                            const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);
                            
                            // Update all level columns with new S/R indicators
                            const levelCells = [
                                { cell: row.cells[3], level: 'R3', value: cprItem.r3 },
                                { cell: row.cells[4], level: 'R2', value: cprItem.r2 },
                                { cell: row.cells[5], level: 'R1', value: cprItem.r1 },
                                { cell: row.cells[6], level: 'TC', value: cprItem.tc },
                                { cell: row.cells[8], level: 'BC', value: cprItem.bc },
                                { cell: row.cells[9], level: 'S1', value: cprItem.s1 },
                                { cell: row.cells[10], level: 'S2', value: cprItem.s2 },
                                { cell: row.cells[11], level: 'S3', value: cprItem.s3 }
                            ];
                            
                            levelCells.forEach(({ cell, level, value }) => {
                                if (cell) {
                                    const srTag = this.getImmediateLevelTag(level, immediateResistance, immediateSupport);
                                    cell.innerHTML = `${srTag}${value.toFixed(2)}`;
                                }
                            });
                        }
                        
                        // Update break status indicators
                        if (row) {
                            this.updateCprBreakStatus(row, normalizedSymbol, ltp);
                        }
                    }
                }
            }

            updateFibonacciLTP(data) {
                // Update LTP in Fibonacci table if symbol exists
                const symbol = data.symbol;
                const ltp = data.ltp;
                
                if (symbol && ltp) {
                    const ltpCell = document.querySelector(`#fibTableBody tr[data-symbol="${symbol}"] .ltp-value`);
                    if (ltpCell) {
                        const row = ltpCell.closest('tr');
                        
                        // Get previous close from the database or calculate from change data
                        const changePercent = data.change_percent || data.chp;
                        let prevClose = null;
                        
                        if (changePercent !== undefined && changePercent !== 0) {
                            prevClose = ltp / (1 + (changePercent / 100));
                        }
                        
                        // Apply color based on change percentage
                        const colorClass = this.getLtpColorClass(ltp, prevClose);
                        ltpCell.className = `text-end ltp-value ${colorClass}`;
                        ltpCell.textContent = `${ltp.toFixed(2)}`;
                        
                        // Update Range column and S/R tags with real-time calculation
                        if (row && row.cells[1]) {
                            // Extract Fibonacci levels from data attributes (robust parsing)
                            const fibItem = {
                                r3_161: parseFloat(row.cells[4]?.getAttribute('data-value') || '0'),
                                r2_123: parseFloat(row.cells[5]?.getAttribute('data-value') || '0'),
                                r1_61: parseFloat(row.cells[6]?.getAttribute('data-value') || '0'),
                                s1_61: parseFloat(row.cells[7]?.getAttribute('data-value') || '0'),
                                s2_123: parseFloat(row.cells[8]?.getAttribute('data-value') || '0'),
                                s3_161: parseFloat(row.cells[9]?.getAttribute('data-value') || '0'),
                                level_38: parseFloat(row.cells[10]?.getAttribute('data-value') || '0'),
                                level_50: parseFloat(row.cells[11]?.getAttribute('data-value') || '0'),
                                pp: parseFloat(row.cells[3]?.textContent.replace(/[RS]/g, '') || '0'), // PP doesn't have S/R tags
                                prev_close: prevClose
                            };
                            
                            // Update range column with real-time calculation
                            row.cells[1].innerHTML = this.getFibonacciRange(ltp, fibItem);
                            
                            // Recalculate immediate support/resistance levels
                            const levels = [
                                { name: 'R3', value: fibItem.r3_161 },
                                { name: 'R2', value: fibItem.r2_123 },
                                { name: 'R1', value: fibItem.r1_61 },
                                { name: 'S1', value: fibItem.s1_61 },
                                { name: 'S2', value: fibItem.s2_123 },
                                { name: 'S3', value: fibItem.s3_161 },
                                { name: '38%', value: fibItem.level_38 },
                                { name: '50%', value: fibItem.level_50 }
                            ];
                            
                            const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);
                            
                            // Update all level columns with new S/R indicators
                            const levelCells = [
                                { cell: row.cells[4], level: 'R3', value: fibItem.r3_161 },
                                { cell: row.cells[5], level: 'R2', value: fibItem.r2_123 },
                                { cell: row.cells[6], level: 'R1', value: fibItem.r1_61 },
                                { cell: row.cells[7], level: 'S1', value: fibItem.s1_61 },
                                { cell: row.cells[8], level: 'S2', value: fibItem.s2_123 },
                                { cell: row.cells[9], level: 'S3', value: fibItem.s3_161 },
                                { cell: row.cells[10], level: '38%', value: fibItem.level_38 },
                                { cell: row.cells[11], level: '50%', value: fibItem.level_50 }
                            ];
                            
                            levelCells.forEach(({ cell, level, value }) => {
                                if (cell) {
                                    const srTag = this.getImmediateLevelTag(level, immediateResistance, immediateSupport);
                                    cell.innerHTML = `${srTag}${value.toFixed(2)}`;
                                }
                            });
                        }
                        
                        // Update break status indicators
                        if (row) {
                            this.updateFibonacciBreakStatus(row, symbol, ltp);
                        }
                    }
                }
            }

            updateCprBreakStatus(row, symbol, ltp) {
                // Get CPR levels from the row
                const levels = {
                    tc: parseFloat(row.querySelector('[data-level="TC"]')?.textContent.replace('', '') || '0'),
                    bc: parseFloat(row.querySelector('[data-level="BC"]')?.textContent.replace('', '') || '0'),
                    r1: parseFloat(row.querySelector('[data-level="R1"]')?.textContent.replace('', '') || '0'),
                    r2: parseFloat(row.querySelector('[data-level="R2"]')?.textContent.replace('', '') || '0'),
                    r3: parseFloat(row.querySelector('[data-level="R3"]')?.textContent.replace('', '') || '0'),
                    s1: parseFloat(row.querySelector('[data-level="S1"]')?.textContent.replace('', '') || '0'),
                    s2: parseFloat(row.querySelector('[data-level="S2"]')?.textContent.replace('', '') || '0'),
                    s3: parseFloat(row.querySelector('[data-level="S3"]')?.textContent.replace('', '') || '0')
                };

                // Determine break level and trend
                let breakLevel = 'None';
                let trend = 'sideways';
                let trendClass = 'bg-warning';

                if (ltp > levels.r3) {
                    breakLevel = 'R3';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.r2) {
                    breakLevel = 'R2';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.r1) {
                    breakLevel = 'R1';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.tc) {
                    breakLevel = 'TC';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp < levels.s3) {
                    breakLevel = 'S3';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.s2) {
                    breakLevel = 'S2';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.s1) {
                    breakLevel = 'S1';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.bc) {
                    breakLevel = 'BC';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                }
                
                // Apply color coding to all levels based on level type
                row.querySelectorAll('.level-value').forEach(cell => {
                    const levelAttr = cell.getAttribute('data-level');
                    const colorClass = this.getLevelColorClass(levelAttr);
                    cell.className = `text-end level-value ${colorClass}`;
                });

                // Update badges
                const breakBadge = row.querySelector('.badge');
                const trendBadge = row.querySelectorAll('.badge')[1];

                if (breakBadge) {
                    breakBadge.textContent = breakLevel;
                    breakBadge.className = `badge ${this.getBreakLevelClass(breakLevel)}`;
                }

                if (trendBadge) {
                    trendBadge.textContent = trend.charAt(0).toUpperCase() + trend.slice(1);
                    trendBadge.className = `badge ${trendClass}`;
                }
            }

            updateFibonacciBreakStatus(row, symbol, ltp) {
                // Get Fibonacci levels from the row
                const levels = {
                    r3: parseFloat(row.querySelector('[data-level="R3"]')?.textContent.replace('', '') || '0'),
                    r2: parseFloat(row.querySelector('[data-level="R2"]')?.textContent.replace('', '') || '0'),
                    r1: parseFloat(row.querySelector('[data-level="R1"]')?.textContent.replace('', '') || '0'),
                    s1: parseFloat(row.querySelector('[data-level="S1"]')?.textContent.replace('', '') || '0'),
                    s2: parseFloat(row.querySelector('[data-level="S2"]')?.textContent.replace('', '') || '0'),
                    s3: parseFloat(row.querySelector('[data-level="S3"]')?.textContent.replace('', '') || '0')
                };

                // Determine break level and trend
                let breakLevel = 'None';
                let trend = 'sideways';
                let trendClass = 'bg-warning';

                if (ltp > levels.r3) {
                    breakLevel = 'R3';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.r2) {
                    breakLevel = 'R2';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.r1) {
                    breakLevel = 'R1';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp < levels.s3) {
                    breakLevel = 'S3';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.s2) {
                    breakLevel = 'S2';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.s1) {
                    breakLevel = 'S1';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                }
                
                // Apply color coding to all levels based on level type
                row.querySelectorAll('.level-value').forEach(cell => {
                    const levelAttr = cell.getAttribute('data-level');
                    const colorClass = this.getLevelColorClass(levelAttr);
                    cell.className = `text-end level-value ${colorClass}`;
                });

                // Update badges
                const breakBadge = row.querySelector('.badge');
                const trendBadge = row.querySelectorAll('.badge')[1];

                if (breakBadge) {
                    breakBadge.textContent = breakLevel;
                    breakBadge.className = `badge ${this.getBreakLevelClass(breakLevel)}`;
                }

                if (trendBadge) {
                    trendBadge.textContent = trend.charAt(0).toUpperCase() + trend.slice(1);
                    trendBadge.className = `badge ${trendClass}`;
                }
            }

            showProgress(percent) {
                const progressDiv = document.getElementById('fetchProgress');
                const progressBar = progressDiv.querySelector('.progress-bar');
                progressDiv.style.display = 'block';
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
            }

            hideProgress() {
                document.getElementById('fetchProgress').style.display = 'none';
            }

            showAlert(type, message, autoHide = true) {
                const alertContainer = document.getElementById('alertContainer');
                
                // If alert container doesn't exist (alert system removed), just log to console
                if (!alertContainer) {
                    console.log(`Alert [${type}]: ${message}`);
                    return;
                }
                
                const alertId = 'alert_' + Date.now();
                
                const alertHtml = `
                    <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <i class="fas fa-${this.getAlertIcon(type)} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                alertContainer.insertAdjacentHTML('beforeend', alertHtml);
                
                if (autoHide) {
                    setTimeout(() => {
                        const alertElement = document.getElementById(alertId);
                        if (alertElement) {
                            alertElement.remove();
                        }
                    }, 5000);
                }
            }

            getAlertIcon(type) {
                const icons = {
                    'success': 'check-circle',
                    'danger': 'exclamation-triangle',
                    'warning': 'exclamation-circle',
                    'info': 'info-circle'
                };
                return icons[type] || 'info-circle';
            }

            updateCategorySections(stocks) {
                // Include only stocks (NO index symbols) with valid LTP and change data
                const validStocks = stocks.filter(stock => 
                    stock.ltp && 
                    stock.change_percent !== undefined &&
                    stock.full_symbol && 
                    !stock.full_symbol.includes('-INDEX')
                );

                // Top 5 Gainers (highest positive change %)
                const topGainers = validStocks
                    .filter(stock => stock.change_percent > 0)
                    .sort((a, b) => b.change_percent - a.change_percent)
                    .slice(0, 5);

                // Top 5 Losers (highest negative change %)
                const topLosers = validStocks
                    .filter(stock => stock.change_percent < 0)
                    .sort((a, b) => a.change_percent - b.change_percent)
                    .slice(0, 5);

                // Top 5 Intraday Recoveries (stocks that hit low 1% below prev close AND recovered back to prev close level)
                const topRecoveries = validStocks
                    .filter(stock => {
                        if (!stock.low_price || !stock.prev_close_price || !stock.ltp || stock.prev_close_price <= 0) return false;
                        // Must hit low 1% below prev close AND recovered back to prev close level
                        const hitLowBelowPrevClose = stock.low_price <= (stock.prev_close_price * 0.99);
                        const recoveredToPrevClose = stock.ltp >= stock.prev_close_price;
                        return hitLowBelowPrevClose && recoveredToPrevClose;
                    })
                    .map(stock => ({
                        ...stock,
                        gainFromLow: stock.low_price ? ((stock.ltp - stock.low_price) / stock.low_price) * 100 : 0
                    }))
                    .sort((a, b) => b.gainFromLow - a.gainFromLow)
                    .slice(0, 5);

                // Top 5 Intraday Fall (stocks that hit high 1% above prev close AND fallen back to prev close level)
                const topFall = validStocks
                    .filter(stock => {
                        if (!stock.high_price || !stock.prev_close_price || !stock.ltp || stock.prev_close_price <= 0) return false;
                        // Must hit high 1% above prev close AND fallen back to prev close level
                        const hitHighAbovePrevClose = stock.high_price >= (stock.prev_close_price * 1.01);
                        const fallenToPrevClose = stock.ltp <= stock.prev_close_price;
                        return hitHighAbovePrevClose && fallenToPrevClose;
                    })
                    .map(stock => ({
                        ...stock,
                        fallFromHigh: stock.high_price ? ((stock.high_price - stock.ltp) / stock.high_price) * 100 : 0
                    }))
                    .sort((a, b) => b.fallFromHigh - a.fallFromHigh)
                    .slice(0, 5);

                // Top 5 Gap Up (open significantly higher than prev close)
                const topGapUp = validStocks
                    .map(stock => ({
                        ...stock,
                        gapPercent: stock.prev_close_price && stock.open_price ? 
                            ((stock.open_price - stock.prev_close_price) / stock.prev_close_price) * 100 : 0
                    }))
                    .filter(stock => stock.gapPercent > 0)
                    .sort((a, b) => b.gapPercent - a.gapPercent)
                    .slice(0, 5);

                // Top 5 Gap Down (open significantly lower than prev close)
                const topGapDown = validStocks
                    .map(stock => ({
                        ...stock,
                        gapPercent: stock.prev_close_price && stock.open_price ? 
                            ((stock.open_price - stock.prev_close_price) / stock.prev_close_price) * 100 : 0
                    }))
                    .filter(stock => stock.gapPercent < 0)
                    .sort((a, b) => a.gapPercent - b.gapPercent)
                    .slice(0, 5);

                // Top 5 High Volatile (highest high-low range % with change %)
                const topHighVolatile = validStocks
                    .map(stock => ({
                        ...stock,
                        rangePercent: stock.high_price && stock.low_price ? 
                            ((stock.high_price - stock.low_price) / stock.low_price) * 100 : 0
                    }))
                    .filter(stock => stock.rangePercent > 1) // Only stocks with range > 1%
                    .sort((a, b) => b.rangePercent - a.rangePercent)
                    .slice(0, 5);

                // Top 5 Less Volatile (lowest range % with change %)
                const topLessVolatile = validStocks
                    .map(stock => ({
                        ...stock,
                        rangePercent: stock.high_price && stock.low_price ? 
                            ((stock.high_price - stock.low_price) / stock.low_price) * 100 : 0
                    }))
                    .filter(stock => stock.rangePercent > 0 && stock.rangePercent < 1) // Only stocks with range < 1%
                    .sort((a, b) => a.rangePercent - b.rangePercent)
                    .slice(0, 5);

                // Update the UI with compact list style
                this.populateCategoryList('topGainersList', topGainers, 'change_percent', '%', 'success');
                this.populateCategoryList('topLosersList', topLosers, 'change_percent', '%', 'danger');
                this.populateCategoryList('topRecoveriesList', topRecoveries, 'gainFromLow', '%', 'info');
                this.populateCategoryList('topFallList', topFall, 'fallFromHigh', '%', 'danger');
                this.populateCategoryList('topGapUpList', topGapUp, 'gapPercent', '%', 'primary');
                this.populateCategoryList('topGapDownList', topGapDown, 'gapPercent', '%', 'secondary');
                this.populateCategoryList('topRangesList', topHighVolatile, 'change_percent', '%', 'warning');
                this.populateCategoryList('topLessVolatileList', topLessVolatile, 'change_percent', '%', 'light');
                
                // Top 5 Turn Positive (opened negative but now trading positive)
                const topTurnPositive = validStocks
                    .filter(stock => {
                        if (!stock.open_price || !stock.prev_close_price || !stock.ltp) return false;
                        const openVsPrev = stock.open_price - stock.prev_close_price;
                        const ltpVsPrev = stock.ltp - stock.prev_close_price;
                        return openVsPrev < 0 && ltpVsPrev > 0; // opened negative, now positive
                    })
                    .map(stock => ({
                        ...stock,
                        turnMagnitude: stock.change_percent || 0
                    }))
                    .sort((a, b) => b.turnMagnitude - a.turnMagnitude) // highest positive change first
                    .slice(0, 5);

                // Top 5 Turn Negative (opened positive but now trading negative) 
                const topTurnNegative = validStocks
                    .filter(stock => {
                        if (!stock.open_price || !stock.prev_close_price || !stock.ltp) return false;
                        const openVsPrev = stock.open_price - stock.prev_close_price;
                        const ltpVsPrev = stock.ltp - stock.prev_close_price;
                        return openVsPrev > 0 && ltpVsPrev < 0; // opened positive, now negative
                    })
                    .map(stock => ({
                        ...stock,
                        turnMagnitude: Math.abs(stock.change_percent || 0)
                    }))
                    .sort((a, b) => b.turnMagnitude - a.turnMagnitude) // highest negative magnitude first
                    .slice(0, 5);
                
                this.populateCategoryList('topTurnPositiveList', topTurnPositive, 'change_percent', '%', 'success');
                this.populateCategoryList('topTurnNegativeList', topTurnNegative, 'change_percent', '%', 'danger');
            }

            populateCategoryList(elementId, stocks, valueField, suffix, colorClass) {
                const element = document.getElementById(elementId);
                if (!element || !stocks.length) {
                    if (element) {
                        element.innerHTML = '<div class="text-center text-muted py-2" style="font-size: 0.8em;">No data</div>';
                    }
                    return;
                }

                element.innerHTML = stocks.map((stock, index) => {
                    const value = stock[valueField];
                    const isPositive = value >= 0;
                    
                    // Text color logic matching reference design
                    let textClass = '';
                    if (elementId.includes('Gainers') || elementId.includes('GapUp') || elementId.includes('TurnPositive')) {
                        textClass = 'text-success';
                    } else if (elementId.includes('Losers') || elementId.includes('GapDown') || elementId.includes('Fall') || elementId.includes('TurnNegative')) {
                        textClass = 'text-danger';
                    } else if (elementId.includes('Recoveries')) {
                        textClass = 'text-info';
                    } else if (elementId.includes('Declining')) {
                        textClass = 'text-warning';
                    } else if (elementId.includes('Ranges')) {
                        // For High Volatile (Ranges), color based on sign: green for positive, red for negative
                        textClass = isPositive ? 'text-success' : 'text-danger';
                    } else if (elementId.includes('LessVolatile')) {
                        // For Less Volatile, color based on sign: green for positive, red for negative
                        textClass = isPositive ? 'text-success' : 'text-danger';
                    } else {
                        textClass = 'text-secondary';
                    }

                    const symbol = stock.symbol.replace('NSE:', '');
                    const formattedValue = isPositive ? `+${this.formatNumber(value)}` : this.formatNumber(value);
                    
                    // Generate chart link and pattern indicator
                    const chartLink = this.generateChartLink(stock.symbol, symbol);
                    const patternIndicator = this.getPatternIndicator(stock);

                    return `
                        <div class="d-flex justify-content-between align-items-center py-1 px-2 border-bottom border-dark" style="font-size: 0.85em;">
                            <div class="d-flex align-items-center">
                                <span class="text-info fw-bold" style="cursor: pointer;" onclick="window.open('https://in.tradingview.com/chart/?symbol=NSE:${symbol}', '_blank')">${symbol}</span>${patternIndicator}
                                <small class="text-muted ms-2">${this.formatNumber(stock.ltp)}</small>
                            </div>
                            <span class="fw-bold ${textClass}" style="font-size: 0.95em;">${formattedValue}${suffix}</span>
                        </div>
                    `;
                }).join('');
            }

            updateMarketSummary(stocks) {
                // Filter out INDEX symbols from market summary calculations
                const nonIndexStocks = stocks ? stocks.filter(stock => !stock.full_symbol || !stock.full_symbol.includes('-INDEX')) : [];
                
                // If no data, set everything to 0 and return
                if (!nonIndexStocks || nonIndexStocks.length === 0) {
                    // Update all counters with 0 values - safely
                    const gainersCountEl = document.getElementById('gainersCount');
                    const losersCountEl = document.getElementById('losersCount');
                    const recoveryCountEl = document.getElementById('recoveryCount');
                    const decliningCountEl = document.getElementById('decliningCount');
                    
                    if (gainersCountEl) gainersCountEl.textContent = 0;
                    if (losersCountEl) losersCountEl.textContent = 0;
                    if (recoveryCountEl) recoveryCountEl.textContent = 0;
                    if (decliningCountEl) decliningCountEl.textContent = 0;
                    const gapUpCountEl = document.getElementById('gapUpCount');
                    const gapDownCountEl = document.getElementById('gapDownCount');
                    const turnPositiveCountEl = document.getElementById('turnPositiveCount');
                    const turnNegativeCountEl = document.getElementById('turnNegativeCount');
                    const avgPercentageEl = document.getElementById('avgPercentage');
                    const volumeCountEl = document.getElementById('volumeCount');
                    
                    if (gapUpCountEl) gapUpCountEl.textContent = 0;
                    if (gapDownCountEl) gapDownCountEl.textContent = 0;
                    if (turnPositiveCountEl) turnPositiveCountEl.textContent = 0;
                    if (turnNegativeCountEl) turnNegativeCountEl.textContent = 0;
                    if (avgPercentageEl) avgPercentageEl.textContent = '0.00%';
                    const patternCountEl = document.getElementById('patternCount');
                    if (patternCountEl) patternCountEl.textContent = '0/0';
                    if (volumeCountEl) volumeCountEl.textContent = '0M';
                    
                    // Reset progress bars
                    const gainersBarEl = document.getElementById('gainersBar');
                    const losersBarEl = document.getElementById('losersBar');
                    const recoveryBarEl = document.getElementById('recoveryBar');
                    const decliningBarEl = document.getElementById('decliningBar');
                    
                    if (gainersBarEl) gainersBarEl.style.width = '0%';
                    if (losersBarEl) losersBarEl.style.width = '0%';
                    if (recoveryBarEl) recoveryBarEl.style.width = '0%';
                    if (decliningBarEl) decliningBarEl.style.width = '0%';
                    
                    // Reset bar counts
                    const gainersBarCountEl = document.getElementById('gainersBarCount');
                    const losersBarCountEl = document.getElementById('losersBarCount');
                    const recoveryBarCountEl = document.getElementById('recoveryBarCount');
                    const decliningBarCountEl = document.getElementById('decliningBarCount');
                    
                    if (gainersBarCountEl) gainersBarCountEl.textContent = 0;
                    if (losersBarCountEl) losersBarCountEl.textContent = 0;
                    if (recoveryBarCountEl) recoveryBarCountEl.textContent = 0;
                    if (decliningBarCountEl) decliningBarCountEl.textContent = 0;
                    
                    // Set neutral card styles
                    const gainersCardEl = document.getElementById('gainersCount');
                    const losersCardEl = document.getElementById('losersCount');
                    const avgCardEl = document.getElementById('avgPercentage');
                    
                    const gainersCard = gainersCardEl ? gainersCardEl.closest('.card') : null;
                    const losersCard = losersCardEl ? losersCardEl.closest('.card') : null;
                    const avgCard = avgCardEl ? avgCardEl.closest('.card') : null;
                    
                    if (gainersCard) gainersCard.className = 'card glow-card glow-secondary text-white';
                    if (losersCard) losersCard.className = 'card glow-card glow-secondary text-white';
                    if (avgCard) avgCard.className = 'card glow-card glow-secondary';
                    if (avgCardEl) avgCardEl.className = 'mb-0 me-2 fw-bold text-secondary';
                    
                    return;
                }
                
                let gainers = 0, losers = 0, recovery = 0, declining = 0;
                let gapUp = 0, gapDown = 0, turnPositive = 0, turnNegative = 0;
                let totalChange = 0, totalVolume = 0;
                let oEqualH = 0, oEqualL = 0;
                
                // Enhanced volume calculation with better data handling
                let validVolumeStocks = 0;
                let zeroVolumeStocks = 0;
                
                nonIndexStocks.forEach(stock => {
                    const change = stock.change_percent || 0;
                    
                    // Robust volume parsing - handle different data types
                    let volume = 0;
                    if (stock.volume !== undefined && stock.volume !== null) {
                        // Convert to number and ensure it's positive
                        volume = Math.max(0, parseInt(stock.volume) || 0);
                    }
                    
                    // Debug volume data
                    if (volume > 0) {
                        validVolumeStocks++;
                    } else {
                        zeroVolumeStocks++;
                    }
                    
                    // Count gainers and losers
                    if (change > 0) gainers++;
                    else if (change < 0) losers++;
                    
                    // Count recovery and declining using correct logic based on previous day's close
                    // INTRADAY RECOVERY: stocks that hit low 1% below prev close AND recovered back to prev close level
                    if (stock.low_price && stock.prev_close_price && stock.ltp && stock.prev_close_price > 0) {
                        const isRecovery = (stock.low_price <= stock.prev_close_price * 0.99) && (stock.ltp >= stock.prev_close_price);
                        if (isRecovery) recovery++;
                    }
                    
                    // INTRADAY FALL: stocks that hit high 1% above prev close AND fallen back to prev close level
                    if (stock.high_price && stock.prev_close_price && stock.ltp && stock.prev_close_price > 0) {
                        const isFall = (stock.high_price >= stock.prev_close_price * 1.01) && (stock.ltp <= stock.prev_close_price);
                        if (isFall) declining++;
                    }
                    
                    // Count gap up/down based on opening vs previous close (constant throughout day)
                    if (stock.open_price && stock.prev_close_price) {
                        const gapPercent = ((stock.open_price - stock.prev_close_price) / stock.prev_close_price) * 100;
                        if (gapPercent > 0.5) gapUp++;
                        else if (gapPercent < -0.5) gapDown++;
                    }
                    
                    // Count Turn+ and Turn- 
                    if (stock.open_price && stock.prev_close_price && stock.ltp) {
                        const openVsPrev = stock.open_price - stock.prev_close_price;
                        const ltpVsPrev = stock.ltp - stock.prev_close_price;
                        
                        // Turn+: opened negative but now trading positive
                        if (openVsPrev < 0 && ltpVsPrev > 0) {
                            turnPositive++;
                        }
                        // Turn-: opened positive but now trading negative
                        if (openVsPrev > 0 && ltpVsPrev < 0) {
                            turnNegative++;
                        }
                    }
                    
                    // Add to totals with type safety
                    totalChange += (typeof change === 'number' ? change : 0);
                    totalVolume += (typeof volume === 'number' && volume > 0 ? volume : 0);
                    
                    // Correct O=H/O=L pattern counting
                    if (stock.open_price && stock.high_price && stock.low_price) {
                        const isOpenHigh = Math.abs(stock.open_price - stock.high_price) <= (stock.high_price * 0.001);
                        const isOpenLow = Math.abs(stock.open_price - stock.low_price) <= (stock.low_price * 0.001);
                        
                        if (isOpenHigh) oEqualH++;
                        if (isOpenLow) oEqualL++;
                    }
                });
                
                // Update the cards with logic-based colors
                const gainersCountEl = document.getElementById('gainersCount');
                if (gainersCountEl) gainersCountEl.textContent = gainers;
                const gainersCard = gainersCountEl ? gainersCountEl.closest('.card') : null;
                if (gainersCard) gainersCard.className = gainers > losers ? 'card glow-card glow-success text-white' : 'card glow-card glow-secondary text-white';
                
                const losersCountEl = document.getElementById('losersCount');
                if (losersCountEl) losersCountEl.textContent = losers;
                const losersCard = losersCountEl ? losersCountEl.closest('.card') : null;
                if (losersCard) losersCard.className = losers > gainers ? 'card glow-card glow-danger text-white' : 'card glow-card glow-secondary text-white';
                
                const updateSafely = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };
                
                updateSafely('recoveryCount', recovery);
                updateSafely('decliningCount', declining);
                updateSafely('gapUpCount', gapUp);
                updateSafely('gapDownCount', gapDown);
                updateSafely('turnPositiveCount', turnPositive);
                updateSafely('turnNegativeCount', turnNegative);
                updateSafely('openHighCount', oEqualH);
                updateSafely('openLowCount', oEqualL);
                
                // Update bar charts
                const total = stocks.length;
                updateSafely('gainersBarCount', gainers);
                updateSafely('losersBarCount', losers);
                updateSafely('recoveryBarCount', recovery);
                updateSafely('decliningBarCount', declining);
                updateSafely('turnPositiveBarCount', turnPositive);
                updateSafely('turnNegativeBarCount', turnNegative);
                updateSafely('openHighBarCount', oEqualH);
                updateSafely('openLowBarCount', oEqualL);
                
                // Update progress bars with percentages
                const updateBarSafely = (id, percentage) => {
                    const el = document.getElementById(id);
                    if (el) el.style.width = `${percentage}%`;
                };
                
                updateBarSafely('gainersBar', Math.round((gainers / total) * 100));
                updateBarSafely('losersBar', Math.round((losers / total) * 100));
                updateBarSafely('recoveryBar', Math.round((recovery / total) * 100));
                updateBarSafely('decliningBar', Math.round((declining / total) * 100));
                updateBarSafely('turnPositiveBar', Math.round((turnPositive / total) * 100));
                updateBarSafely('turnNegativeBar', Math.round((turnNegative / total) * 100));
                updateBarSafely('openHighBar', Math.round((oEqualH / total) * 100));
                updateBarSafely('openLowBar', Math.round((oEqualL / total) * 100));
                
                // Calculate and display averages with color logic
                const avgPercent = (totalChange / stocks.length).toFixed(2);
                const avgElement = document.getElementById('avgPercentage');
                if (avgElement) avgElement.textContent = avgPercent + '%';
                const avgCard = avgElement ? avgElement.closest('.card') : null;
                const isPositive = parseFloat(avgPercent) >= 0;
                if (avgCard) avgCard.className = isPositive ? 'card glow-card glow-success' : 'card glow-card glow-danger';
                if (avgElement) avgElement.className = isPositive ? 'mb-0 me-2 fw-bold text-success' : 'mb-0 me-2 fw-bold text-danger';
                
                // Pattern ratio
                const patternCountEl2 = document.getElementById('patternCount');
                if (patternCountEl2) patternCountEl2.textContent = `${oEqualH}/${oEqualL}`;
                
                // Calculate volume in millions with fallback
                const volumeInM = totalVolume > 0 ? Math.round(totalVolume / 1000000) : 0;
                
                // Debug: Log volume calculation details (only if we have data)
                if (nonIndexStocks.length > 0) {
                    console.log(`F&O Volume Debug: Total stocks: ${nonIndexStocks.length}, Valid volume: ${validVolumeStocks}, Zero volume: ${zeroVolumeStocks}`);
                    console.log(`Total volume raw: ${totalVolume}, Total volume in millions: ${volumeInM}M`);
                }
                
                // Update volume display
                updateSafely('volumeCount', volumeInM + 'M');
            }

            getPercentClass(basePrice, currentPrice) {
                if (!basePrice || !currentPrice) return 'text-muted';
                const percent = ((currentPrice - basePrice) / basePrice) * 100;
                return percent >= 0 ? 'text-success' : 'text-danger';
            }

            formatPercent(basePrice, currentPrice) {
                if (!basePrice || !currentPrice) return '0.00';
                const percent = ((currentPrice - basePrice) / basePrice) * 100;
                return this.formatNumber(percent);
            }

            showLoading(show) {
                // Loading modal removed as requested
            }
            
            async loadInitialData() {
                try {
                    console.log('Loading initial data from historical records...');
                    const response = await fetch('/api/weekly/initial-data');
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.data.length > 0) {
                        console.log(`Loaded ${data.data.length} stocks from historical data`);
                        
                        // Update the main table with historical data
                        this.updateMainTable(data.data);
                        
                        // Update market summary with historical data
                        this.updateMarketSummary(data.data);
                        
                        // Store this as initial data for comparison
                        this.initialDataLoaded = true;
                        
                        // Show a notification that historical data is loaded
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
                        notification.style.cssText = 'top: 20px; right: 20px; z-index: 2000; max-width: 400px;';
                        notification.innerHTML = `
                            <i class="fas fa-info-circle me-2"></i>
                            Previous day data loaded. Live data will update automatically when market opens.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(notification);
                        
                        // Auto-remove notification after 5 seconds
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 5000);
                        
                    } else {
                        console.log('No initial data available from historical records');
                    }
                } catch (error) {
                    console.error('Error loading initial data:', error);
                }
            }
            
            getCleanSymbol(fullSymbol) {
                if (!fullSymbol) return '';
                return fullSymbol.replace('NSE:', '').replace('-EQ', '');
            }
            
            
        }

        // Initialize dashboard when page loads - make it global for sidebar access
        let dashboard;
        let leftSidebarOpen = false;
        
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new Dashboard();
            
            // INDEX Cards Hide/Show functionality
            const toggleBtn = document.getElementById('toggleIndexCards');
            const indexContainer = document.getElementById('indexCardsContainer');
            const toggleIcon = document.getElementById('indexToggleIcon');
            
            if (toggleBtn && indexContainer && toggleIcon) {
                toggleBtn.addEventListener('click', function() {
                    if (indexContainer.style.display === 'none') {
                        indexContainer.style.display = 'block';
                        toggleIcon.className = 'fas fa-eye';
                    } else {
                        indexContainer.style.display = 'none';
                        toggleIcon.className = 'fas fa-eye-slash';
                    }
                });
            }
            
            // Price Action Cards Hide/Show functionality
            const priceActionToggleBtn = document.getElementById('togglePriceActionCards');
            const priceActionContainer = document.getElementById('priceActionCardsContainer');
            const priceActionToggleIcon = document.getElementById('priceActionToggleIcon');
            
            if (priceActionToggleBtn && priceActionContainer && priceActionToggleIcon) {
                priceActionToggleBtn.addEventListener('click', function() {
                    if (priceActionContainer.style.display === 'none') {
                        priceActionContainer.style.display = 'block';
                        priceActionToggleIcon.className = 'fas fa-eye';
                    } else {
                        priceActionContainer.style.display = 'none';
                        priceActionToggleIcon.className = 'fas fa-eye-slash';
                    }
                });
            }
            
            // Add click event listeners to all index cards - open directly in new windows
            document.querySelectorAll('.index-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    const indexSymbol = this.getAttribute('data-index-symbol');
                    if (indexSymbol) {
                        const chartUrl = dashboard.generateIndexChartLink(indexSymbol);
                        window.open(chartUrl, '_blank', 'noopener');
                    }
                });
            });

            // Add delegated click listener for chart links
            document.addEventListener('click', function(e) {
                if (e.target.closest('.chart-link')) {
                    e.preventDefault();
                    const link = e.target.closest('.chart-link');
                    const chartUrl = link.getAttribute('data-chart-url') || link.getAttribute('href');
                    const symbolName = link.getAttribute('data-symbol') || 'Chart';
                    
                    // Try floating browser first, fallback to new tab
                    if (window.floatingBrowser && chartUrl) {
                        window.floatingBrowser.openChart(chartUrl, symbolName);
                    } else if (chartUrl) {
                        window.open(chartUrl, '_blank', 'noopener');
                    }
                }
            });
            
            // Load initial data first, then start live updates
            console.log(' INIT: Starting dashboard initialization');
            dashboard.loadInitialData().then(() => {
                console.log(' INIT: Initial data loaded, now loading watchlist');
                // Load user's watchlist after initial data is loaded
                loadUserWatchlistData();
            }).catch(error => {
                console.error(' INIT ERROR: Failed to load initial data:', error);
            });
        });
        

        function toggleFOSummary() {
            const summaryBody = document.getElementById('foSummaryBody');
            const toggleIcon = document.getElementById('foToggleIcon');
            
            if (summaryBody.style.display === 'none') {
                summaryBody.style.display = 'block';
                toggleIcon.className = 'fas fa-eye';
            } else {
                summaryBody.style.display = 'none';
                toggleIcon.className = 'fas fa-eye-slash';
            }
        }

        function toggleTable(tableBodyId, iconId) {
            const tableBody = document.getElementById(tableBodyId);
            const toggleIcon = document.getElementById(iconId);
            
            if (tableBody.style.display === 'none') {
                tableBody.style.display = '';
                toggleIcon.className = 'fas fa-eye';
            } else {
                tableBody.style.display = 'none';
                toggleIcon.className = 'fas fa-eye-slash';
            }
        }

        // Watchlist Management Functions
        let userWatchlist = new Set();

        async function toggleWatchlist(symbol, fullSymbol) {
            try {
                const button = document.querySelector(`[data-symbol="${symbol}"]`);
                const isCurrentlyInWatchlist = userWatchlist.has(symbol);
                
                // Show loading state
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;
                
                const url = isCurrentlyInWatchlist ? '/api/watchlist/remove' : '/api/watchlist/add';
                let requestBody;
                
                if (isCurrentlyInWatchlist) {
                    requestBody = { symbol: symbol };
                } else {
                    // Get current LTP from live data when adding - try multiple sources
                    let currentLtp = null;
                    
                    // Try to get from global stockData first
                    if (window.stockData && window.stockData[fullSymbol]) {
                        currentLtp = window.stockData[fullSymbol].ltp;
                    }
                    
                    // If not found, try to get from the table row directly
                    if (!currentLtp) {
                        const row = document.querySelector(`tr[data-symbol="${symbol}"]`);
                        if (row) {
                            const ltpCell = row.querySelector('.ltp-value');
                            if (ltpCell && ltpCell.textContent !== '--') {
                                const ltpText = ltpCell.textContent.replace('', '').replace(/,/g, '');
                                currentLtp = parseFloat(ltpText);
                            }
                        }
                    }
                    
                    // Defensive guard against NaN
                    if (isNaN(currentLtp)) {
                        currentLtp = null;
                    }
                    
                    // Log for debugging
                    console.log(`Adding ${symbol} to watchlist with LTP: ${currentLtp}`);
                    
                    requestBody = { 
                        symbol: symbol, 
                        full_symbol: fullSymbol,
                        current_ltp: currentLtp
                        // No default investment amount - user must set manually
                    };
                }
                
                const response = await fetch(url, {
                    method: isCurrentlyInWatchlist ? 'DELETE' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    if (isCurrentlyInWatchlist) {
                        userWatchlist.delete(symbol);
                        updateWatchlistButton(symbol, false);
                    } else {
                        userWatchlist.add(symbol);
                        updateWatchlistButton(symbol, true);
                        // Immediately refresh watchlist display to show new stock
                        console.log(' Refreshing watchlist after adding:', symbol);
                        await loadUserWatchlistData(); // Use the correct function name
                    }
                    
                    // Show success message briefly
                    showTemporaryMessage(
                        isCurrentlyInWatchlist ? 
                        `${symbol} removed from watchlist` : 
                        `${symbol} added to watchlist`,
                        'success'
                    );
                } else {
                    // Reset button on error
                    button.innerHTML = originalHtml;
                    button.disabled = false;
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Watchlist error:', error);
                showTemporaryMessage('Network error. Please try again.', 'error');
                // Reset button on error
                const button = document.querySelector(`[data-symbol="${symbol}"]`);
                if (button) {
                    button.innerHTML = '<i class="fas fa-star"></i>';
                    button.disabled = false;
                }
            }
        }

        function updateWatchlistButton(symbol, isInWatchlist) {
            const button = document.querySelector(`[data-symbol="${symbol}"]`);
            if (button) {
                button.disabled = false;
                if (isInWatchlist) {
                    button.innerHTML = '<i class="fas fa-star"></i>';
                    button.className = 'btn btn-sm btn-warning watchlist-btn';
                    button.title = 'Remove from Watchlist';
                } else {
                    button.innerHTML = '<i class="far fa-star"></i>';
                    button.className = 'btn btn-sm btn-outline-warning watchlist-btn';
                    button.title = 'Add to Watchlist';
                }
            }
        }

        async function loadUserWatchlist() {
            try {
                const response = await fetch('/api/watchlist');
                const result = await response.json();
                
                if (result.status === 'success') {
                    userWatchlist.clear();
                    result.watchlist.forEach(item => {
                        userWatchlist.add(item.symbol);
                        updateWatchlistButton(item.symbol, true);
                    });
                    
                    // Update watchlist count and render table
                    updateWatchlistCount(result.watchlist.length);
                    renderWatchlistTable(result.watchlist);
                }
            } catch (error) {
                console.error('Failed to load watchlist:', error);
            }
        }

        async function refreshWatchlist() {
            const button = document.querySelector('[onclick="refreshWatchlist()"]');
            const originalHtml = button.innerHTML;
            
            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;
                
                await loadUserWatchlist();
                
                // Show success message
                showTemporaryMessage('Watchlist refreshed', 'success');
            } catch (error) {
                showTemporaryMessage('Failed to refresh watchlist', 'error');
            } finally {
                button.innerHTML = originalHtml;
                button.disabled = false;
            }
        }

        function updateWatchlistCount(count) {
            const countElement = document.getElementById('watchlistCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        function renderWatchlistTable(watchlistItems) {
            console.log(' RENDER WATCHLIST: Starting to render watchlist table with', watchlistItems?.length || 0, 'items');
            const tbody = document.getElementById('watchlistTableBody');
            
            if (!watchlistItems || watchlistItems.length === 0) {
                console.log(' RENDER WATCHLIST: No items to render');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-star fa-3x mb-3 d-block"></i>
                                <h5>No Stocks in Watchlist</h5>
                                <p>Add stocks to your watchlist by clicking the star button on any stock</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            console.log(' RENDER WATCHLIST: Rendering', watchlistItems.length, 'watchlist items');
            tbody.innerHTML = watchlistItems.map(item => {
                console.log(' RENDER WATCHLIST: Processing item:', item.symbol);
                // Get live stock data if available - try multiple formats
                let liveData = null;
                if (window.stockData) {
                    // Try full_symbol first
                    liveData = window.stockData[item.full_symbol];
                    // If not found, try looking for the symbol with NSE: prefix
                    if (!liveData && !item.full_symbol.startsWith('NSE:')) {
                        liveData = window.stockData[`NSE:${item.symbol}-EQ`];
                    }
                    // Try just the symbol
                    if (!liveData) {
                        liveData = window.stockData[item.symbol];
                    }
                }
                
                // Get values
                const addedLtp = parseFloat(item.added_ltp) || 0;
                const liveLtp = liveData ? parseFloat(liveData.ltp) || 0 : 0;
                const investmentAmount = item.investment_amount ? parseInt(item.investment_amount) : null;
                const positionType = item.position_type || null;
                
                // Calculate percentage change from added LTP to live LTP
                let percentChange = 0;
                let gainLoss = 0;
                let changeClass = 'text-muted';
                let changeIcon = '';
                
                if (addedLtp > 0 && liveLtp > 0 && investmentAmount && positionType) {
                    percentChange = ((liveLtp - addedLtp) / addedLtp) * 100;
                    
                    // Calculate actual gain/loss based on investment amount
                    const shares = investmentAmount / addedLtp;
                    gainLoss = (liveLtp - addedLtp) * shares;
                    
                    // Reverse gain/loss for Short positions
                    if (positionType === 'Short') {
                        gainLoss = -gainLoss;
                        percentChange = -percentChange;
                    }
                    
                    changeClass = gainLoss >= 0 ? 'text-success' : 'text-danger';
                    changeIcon = gainLoss >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                }
                
                // Virtual Trade amount button options
                const investmentOptions = [25000, 50000, 100000, 200000];
                const investmentButtons = `
                    <div class="btn-group btn-group-sm" role="group" style="font-size: 0.65rem;">
                        ${investmentOptions.map(amount => `
                            <button type="button" 
                                    class="btn ${amount === investmentAmount ? 'btn-primary' : (investmentAmount ? 'btn-outline-primary' : 'btn-outline-warning')}"
                                    onclick="updateInvestmentAmount('${item.symbol}', ${amount})"
                                    style="padding: 2px 6px; font-size: 0.6rem; border-width: 1px;">
                                ${amount >= 100000 ? (amount/100000) + 'L' : (amount/1000) + 'k'}
                            </button>
                        `).join('')}
                    </div>
                    ${!investmentAmount ? '<small class="text-warning d-block" style="font-size: 0.6rem;"> Set amount</small>' : ''}
                `;
                
                // Position type toggle buttons
                const positionButtons = `
                    <div class="btn-group btn-group-sm" role="group" style="font-size: 0.7rem;">
                        <button type="button" 
                                class="btn ${positionType === 'Long' ? 'btn-success' : (positionType ? 'btn-outline-success' : 'btn-outline-warning')}"
                                onclick="updatePositionType('${item.symbol}', 'Long')"
                                style="padding: 2px 8px; font-size: 0.65rem; border-width: 1px;">
                            Long
                        </button>
                        <button type="button" 
                                class="btn ${positionType === 'Short' ? 'btn-danger' : (positionType ? 'btn-outline-danger' : 'btn-outline-warning')}"
                                onclick="updatePositionType('${item.symbol}', 'Short')"
                                style="padding: 2px 8px; font-size: 0.65rem; border-width: 1px;">
                            Short
                        </button>
                    </div>
                    ${!positionType ? '<small class="text-warning d-block" style="font-size: 0.6rem;"> Set position</small>' : ''}
                `;
                
                
                // Create chart URL
                const chartSymbol = `NSE:${item.symbol}`;
                const chartUrl = `https://in.tradingview.com/chart/?symbol=${chartSymbol}`;
                
                return `
                    <tr>
                        <td class="fw-bold">
                            <a href="${chartUrl}" target="_blank" class="text-decoration-none text-white symbol-link" 
                               style="transition: color 0.2s ease;"
                               onmouseover="this.style.color='#007bff'" 
                               onmouseout="this.style.color='white'" title="Open Chart">
                                ${item.symbol}
                            </a>
                            ${positionType ? `<span class="badge ${positionType === 'Long' ? 'bg-success' : 'bg-danger'} ms-1" style="font-size: 0.6rem;">
                                ${positionType}
                            </span>` : '<span class="badge bg-warning text-dark ms-1" style="font-size: 0.6rem;"> SET</span>'}
                        </td>
                        <td>
                            <select class="form-select form-select-sm" 
                                    onchange="updateSelectionMethod('${item.symbol}', this.value)"
                                    style="font-size: 0.7rem; padding: 2px 6px;">
                                <option value="">-- Select Method --</option>
                                <option value="Price Action" ${item.selection_method === 'Price Action' ? 'selected' : ''}>1. 10cards of Price action</option>
                                <option value="Camarilla" ${item.selection_method === 'Camarilla' ? 'selected' : ''}>2. Camarilla Levels</option>
                                <option value="CPR" ${item.selection_method === 'CPR' ? 'selected' : ''}>3. CPR Levels</option>
                                <option value="Fibonacci" ${item.selection_method === 'Fibonacci' ? 'selected' : ''}>4. Fibonacci Levels</option>
                                <option value="RVOL" ${item.selection_method === 'RVOL' ? 'selected' : ''}>5. RVOL</option>
                                <option value="Sector Top" ${item.selection_method === 'Sector Top' ? 'selected' : ''}>6. Sector Top from Index Charts</option>
                            </select>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="removeFromWatchlist('${item.symbol}')" 
                                    title="Remove from Watchlist"
                                    style="padding: 2px 6px; font-size: 0.7rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        <td class="text-center">
                            ${investmentButtons}
                        </td>
                        <td class="text-center">
                            ${positionButtons}
                        </td>
                        <td class="text-end">${addedLtp > 0 ? dashboard.formatNumber(addedLtp) : '--'}</td>
                        <td class="text-end fw-bold">${liveLtp > 0 ? dashboard.formatNumber(liveLtp) : '--'}</td>
                        <td class="text-end fw-bold" style="color: ${investmentAmount ? '#00e5ff' : '#ffc107'};">
                            ${investmentAmount ? '' + dashboard.formatNumber(investmentAmount) : ' SET AMT'}
                        </td>
                        <td class="${changeClass} text-end fw-bold">
                            ${addedLtp > 0 && liveLtp > 0 && investmentAmount && positionType ? `<i class="${changeIcon} me-1"></i>${dashboard.formatNumber(Math.abs(gainLoss))}` : (investmentAmount && positionType ? '--' : ' SET')}
                        </td>
                        <td class="${changeClass} text-end fw-bold">
                            ${addedLtp > 0 && liveLtp > 0 && investmentAmount && positionType ? `<i class="${changeIcon} me-1"></i>${dashboard.formatNumber(percentChange)}%` : (investmentAmount && positionType ? '--' : ' SET')}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function removeFromWatchlist(symbol) {
            if (!confirm(`Remove ${symbol} from your watchlist?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/watchlist/remove', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    userWatchlist.delete(symbol);
                    updateWatchlistButton(symbol, false);
                    showTemporaryMessage(`${symbol} removed from watchlist`, 'success');
                    
                    // Refresh the watchlist display
                    loadUserWatchlist();
                    updateInvestmentSummary(currentWatchlistData);
                } else {
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Remove from watchlist error:', error);
                showTemporaryMessage('Network error. Please try again.', 'error');
            }
        }

        // Store current watchlist data for quick refresh
        let currentWatchlistData = [];

        async function refreshWatchlistDisplay() {
            if (currentWatchlistData && currentWatchlistData.length > 0) {
                renderWatchlistTable(currentWatchlistData);
                updateInvestmentSummary(currentWatchlistData);
            }
        }

        // Update loadUserWatchlist to store the data
        async function loadUserWatchlistData() {
            try {
                console.log(' LOAD WATCHLIST: Starting to load user watchlist data');
                const response = await fetch('/api/watchlist');
                console.log(' LOAD WATCHLIST: Fetch response status:', response.status);
                const result = await response.json();
                console.log(' LOAD WATCHLIST: API result:', result);
                
                if (result.status === 'success') {
                    currentWatchlistData = result.watchlist;
                    userWatchlist.clear();
                    result.watchlist.forEach(item => {
                        userWatchlist.add(item.symbol);
                        updateWatchlistButton(item.symbol, true);
                    });
                    
                    // Update watchlist count and render table
                    updateWatchlistCount(result.watchlist.length);
                    renderWatchlistTable(result.watchlist);
                    updateInvestmentSummary(result.watchlist);
                }
            } catch (error) {
                console.error('Failed to load watchlist:', error);
            }
        }

        async function updateInvestmentAmount(symbol, newAmount) {
            try {
                console.log(`Updating investment amount for ${symbol} to ${newAmount}`);
                console.log('Current watchlist data:', currentWatchlistData);
                
                // Check if currentWatchlistData is available
                if (!currentWatchlistData || currentWatchlistData.length === 0) {
                    console.log('No watchlist data available, reloading...');
                    await loadUserWatchlistData();
                }
                
                // Find and style the clicked button
                const clickedButton = document.querySelector(`[onclick*="updateInvestmentAmount('${symbol}', ${newAmount})"]`);
                if (clickedButton) {
                    // Change to bright orange/gold locked color
                    clickedButton.className = 'btn btn-warning';
                    clickedButton.style.cssText = 'padding: 2px 6px; font-size: 0.6rem; border-width: 2px; background-color: #ff8c00 !important; border-color: #ff8c00 !important; color: white !important; opacity: 0.8 !important;';
                    clickedButton.disabled = true;
                    clickedButton.innerHTML = ' ' + clickedButton.innerHTML;
                }
                
                // Lock all other investment buttons for this symbol
                const buttonGroup = document.querySelector(`[onclick*="updateInvestmentAmount('${symbol}'"]`);
                if (buttonGroup && buttonGroup.parentElement) {
                    const allButtons = buttonGroup.parentElement.querySelectorAll('button');
                    allButtons.forEach(btn => {
                        if (btn !== clickedButton) {
                            btn.disabled = true;
                            btn.style.opacity = '0.4';
                        }
                    });
                }
                
                const response = await fetch('/api/watchlist/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        investment_amount: parseInt(newAmount)
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Update investment response:', result);
                
                if (result.status === 'success') {
                    // Update the stored data
                    const itemIndex = currentWatchlistData.findIndex(item => item.symbol === symbol);
                    if (itemIndex !== -1) {
                        currentWatchlistData[itemIndex].investment_amount = parseInt(newAmount);
                    }
                    
                    // Re-render the table to update gain/loss calculations
                    renderWatchlistTable(currentWatchlistData);
                    updateInvestmentSummary(currentWatchlistData);
                    
                    showTemporaryMessage(`Virtual Trade updated: ${symbol} (${parseInt(newAmount) >= 100000 ? (parseInt(newAmount)/100000) + 'L' : (parseInt(newAmount)/1000) + 'k'})`, 'success');
                } else {
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                    // Note: Button state will be reset by table re-render
                }
            } catch (error) {
                console.error('Update investment amount error:', error);
                showTemporaryMessage('Failed to update investment amount. Please try again.', 'error');
                
                // Note: Button state will be reset by table re-render
            } finally {
                // Keep buttons locked - do not re-enable them
                console.log('Investment amount update completed - buttons remain locked');
            }
        }

        async function updatePositionType(symbol, newPositionType) {
            try {
                console.log(`Updating position type for ${symbol} to ${newPositionType}`);
                console.log('Current watchlist data:', currentWatchlistData);
                
                // Check if currentWatchlistData is available
                if (!currentWatchlistData || currentWatchlistData.length === 0) {
                    console.log('No watchlist data available, reloading...');
                    await loadUserWatchlistData();
                }
                
                // Find and style the clicked button
                const clickedButton = document.querySelector(`[onclick*="updatePositionType('${symbol}', '${newPositionType}')"]`);
                if (clickedButton) {
                    // Change to bright purple locked color
                    const lockColor = newPositionType === 'Long' ? '#8b00ff' : '#dc143c'; // Purple for Long, Crimson for Short
                    clickedButton.className = 'btn';
                    clickedButton.style.cssText = `padding: 2px 8px; font-size: 0.65rem; border-width: 2px; background-color: ${lockColor} !important; border-color: ${lockColor} !important; color: white !important; opacity: 0.9 !important;`;
                    clickedButton.disabled = true;
                    clickedButton.innerHTML = ' ' + newPositionType;
                }
                
                // Lock all other position buttons for this symbol
                const buttonGroup = document.querySelector(`[onclick*="updatePositionType('${symbol}'"]`);
                if (buttonGroup && buttonGroup.parentElement) {
                    const allButtons = buttonGroup.parentElement.querySelectorAll('button');
                    allButtons.forEach(btn => {
                        if (btn !== clickedButton) {
                            btn.disabled = true;
                            btn.style.opacity = '0.4';
                        }
                    });
                }
                
                const response = await fetch('/api/watchlist/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        position_type: newPositionType
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Update position type response:', result);
                
                if (result.status === 'success') {
                    // Update the stored data
                    const itemIndex = currentWatchlistData.findIndex(item => item.symbol === symbol);
                    if (itemIndex !== -1) {
                        currentWatchlistData[itemIndex].position_type = newPositionType;
                    }
                    
                    // Re-render the table to update gain/loss calculations
                    renderWatchlistTable(currentWatchlistData);
                    updateInvestmentSummary(currentWatchlistData);
                    
                    showTemporaryMessage(`Position updated: ${symbol} (${newPositionType})`, 'success');
                } else {
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                    // Reset dropdown to previous value
                    if (dropdown) {
                        dropdown.value = currentWatchlistData.find(item => item.symbol === symbol)?.position_type || 'Long';
                    }
                }
            } catch (error) {
                console.error('Update position type error:', error);
                showTemporaryMessage('Failed to update position type. Please try again.', 'error');
                
                // Note: Button state will be reset by table re-render
            } finally {
                // Keep buttons locked - do not re-enable them  
                console.log('Position type update completed - buttons remain locked');
            }
        }

        async function updateSelectionMethod(symbol, newSelectionMethod) {
            try {
                console.log(` UPDATE SELECTION: Updating selection method for ${symbol} to ${newSelectionMethod}`);
                console.log(' Current watchlist data:', currentWatchlistData);
                
                // Check if currentWatchlistData is available
                if (!currentWatchlistData || currentWatchlistData.length === 0) {
                    console.log(' No watchlist data available, reloading...');
                    await loadUserWatchlistData();
                }
                
                const response = await fetch('/api/watchlist/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        selection_method: newSelectionMethod
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Update selection method response:', result);
                
                if (result.status === 'success') {
                    // Update the stored data
                    const itemIndex = currentWatchlistData.findIndex(item => item.symbol === symbol);
                    if (itemIndex !== -1) {
                        currentWatchlistData[itemIndex].selection_method = newSelectionMethod;
                    }
                    
                    showTemporaryMessage(`Selection method updated: ${symbol} (${newSelectionMethod || 'Not set'})`, 'success');
                } else {
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                    // Reset dropdown to previous value
                    const dropdown = document.querySelector(`select[onchange*="updateSelectionMethod('${symbol}'"]`);
                    if (dropdown) {
                        dropdown.value = currentWatchlistData.find(item => item.symbol === symbol)?.selection_method || '';
                    }
                }
            } catch (error) {
                console.error('Update selection method error:', error);
                showTemporaryMessage('Failed to update selection method. Please try again.', 'error');
                
                // Reset dropdown to previous value on error
                const dropdown = document.querySelector(`select[onchange*="updateSelectionMethod('${symbol}'"]`);
                if (dropdown) {
                    dropdown.value = currentWatchlistData.find(item => item.symbol === symbol)?.selection_method || '';
                }
            }
        }

        function showTemporaryMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            messageDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
            messageDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(messageDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        function updateInvestmentSummary(watchlistData) {
            // Summary section removed - no longer displaying investment summary
            return;
        }





        function clearAllAlerts() {
            // Clear all alert containers
            document.getElementById('topMovers').innerHTML = '<div class="loading-placeholder"><i class="fas fa-check-circle"></i> No alerts</div>';
            document.getElementById('hotAlerts').innerHTML = '<div class="loading-placeholder"><i class="fas fa-check-circle"></i> No alerts</div>';
            document.getElementById('volumeSurge').innerHTML = '<div class="loading-placeholder"><i class="fas fa-check-circle"></i> No alerts</div>';
            document.getElementById('activityFeed').innerHTML = '<div class="loading-placeholder"><i class="fas fa-check-circle"></i> Feed cleared</div>';
            
            // Reset counters
            updateAlertBadge(0);
            updateStatCounts(0, 0, 0, 0);
        }

        function exportAlerts() {
            const alerts = [];
            const alertItems = document.querySelectorAll('.alert-item-enhanced');
            
            alertItems.forEach(item => {
                alerts.push({
                    text: item.textContent,
                    type: item.className.includes('gain') ? 'gain' : item.className.includes('loss') ? 'loss' : 'info',
                    timestamp: new Date().toISOString()
                });
            });
            
            const blob = new Blob([JSON.stringify(alerts, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `market-alerts-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function refreshAllAlerts() {
            if (!window.stockData) {
                console.log('refreshAllAlerts: No window.stockData available');
                return;
            }
            
            const stocks = Object.values(window.stockData);
            console.log('refreshAllAlerts: Processing', stocks.length, 'stocks');
            
            if (stocks.length === 0) {
                console.log('refreshAllAlerts: No stocks in data');
                return;
            }
            
            updateTopMovers(stocks);
            updateHotAlerts(stocks);
            updateVolumeSurge(stocks);
            updateActivityFeed(stocks);
            updateMarketPulse(stocks);
            
            console.log('refreshAllAlerts: Updated all alert sections');
        }

        function updateStatCounts(gainers, losers, active, alerts) {
            const updateStat = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            
            updateStat('gainersCount', gainers);
            updateStat('losersCount', losers);
            updateStat('activeCount', active);
            updateStat('alertsCount', alerts);
        }

        // Advanced Alert Calculation Functions
        function calculateMomentumScore(stock) {
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;
            const priceVelocity = Math.abs(changePercent);
            const volumeNormalized = Math.min(volume / 10000000, 1); // Normalize to 0-1
            
            // Momentum score: combines price movement with volume
            return (priceVelocity * 0.7) + (volumeNormalized * 100 * 0.3);
        }

        function detectPricePattern(stock) {
            const open = stock.open_price || 0;
            const close = stock.ltp || 0;
            const high = stock.high_price || 0;
            const low = stock.low_price || 0;
            const prevClose = stock.prev_close_price || 0;
            
            if (!open || !close || !high || !low || !prevClose) return 'unknown';
            
            // Gap analysis
            const gapPercent = ((open - prevClose) / prevClose) * 100;
            const bodyPercent = ((close - open) / open) * 100;
            
            if (gapPercent > 2) return 'gap_up';
            if (gapPercent < -2) return 'gap_down';
            if (Math.abs(bodyPercent) > 3) return bodyPercent > 0 ? 'strong_bullish' : 'strong_bearish';
            if (close > high * 0.98) return 'near_high';
            if (close < low * 1.02) return 'near_low';
            
            return 'consolidation';
        }

        function calculateRSI(stock, period = 14) {
            // Simplified RSI calculation using current price action
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;
            
            // Approximate RSI based on current momentum and volume
            let rsi = 50; // Neutral starting point
            
            if (changePercent > 0) {
                rsi += Math.min(changePercent * 2, 30);
            } else {
                rsi += Math.max(changePercent * 2, -30);
            }
            
            // Volume influence
            if (volume > 5000000) rsi += changePercent > 0 ? 5 : -5;
            
            return Math.max(0, Math.min(100, rsi));
        }

        function isVolumeSpike(stock) {
            const volume = stock.vol_traded_today || 0;
            const avgVolume = 2000000; // Approximate average for NIFTY 50 stocks
            
            return volume > avgVolume * 2; // 2x average volume
        }

        function detectBreakoutPattern(stock) {
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;
            const rsi = calculateRSI(stock);
            
            // Strong breakout: high price movement + high volume + RSI confirmation
            if (Math.abs(changePercent) > 3 && volume > 3000000) {
                if (changePercent > 0 && rsi > 60) return 'bullish_breakout';
                if (changePercent < 0 && rsi < 40) return 'bearish_breakout';
            }
            
            // Volume breakout without extreme price movement
            if (isVolumeSpike(stock) && Math.abs(changePercent) > 1) {
                return 'volume_breakout';
            }
            
            return null;
        }

        function updateTopMovers(stocks) {
            const container = document.getElementById('topMovers');
            if (!container) return;
            
            // Calculate momentum scores and filter significant moves
            const stocksWithMomentum = stocks.map(stock => ({
                ...stock,
                momentumScore: calculateMomentumScore(stock),
                pattern: detectPricePattern(stock),
                rsi: calculateRSI(stock)
            })).filter(stock => 
                Math.abs(stock.change_percent || 0) > 0.5 || // At least 0.5% movement
                stock.momentumScore > 2 // Or high momentum score
            );
            
            // Sort by momentum score
            const sorted = stocksWithMomentum.sort((a, b) => b.momentumScore - a.momentumScore);
            const topMovers = sorted.slice(0, 6);
            
            const html = topMovers.map(stock => {
                const changePercent = stock.change_percent || 0;
                const isGain = changePercent >= 0;
                const symbol = stock.symbol ? stock.symbol.replace('NSE:', '').replace('-EQ', '') : 'Unknown';
                const momentumIcon = stock.momentumScore > 5 ? '' : stock.momentumScore > 3 ? '' : '';
                const patternText = getPatternDisplayText(stock.pattern);
                
                return `
                    <div class="alert-item-enhanced ${isGain ? 'gain' : 'loss'}" data-momentum="${stock.momentumScore.toFixed(1)}">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">${symbol} ${momentumIcon}</span>
                            <span class="${isGain ? 'text-success' : 'text-danger'}">${changePercent.toFixed(2)}%</span>
                        </div>
                        <div class="d-flex justify-content-between small opacity-75">
                            <span>${(stock.ltp || 0).toFixed(2)}</span>
                            <span class="text-warning">${patternText}</span>
                        </div>
                        <div class="small opacity-50">Momentum: ${stock.momentumScore.toFixed(1)} | RSI: ${stock.rsi.toFixed(0)}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html || '<div class="loading-placeholder">No significant movers</div>';
            const countEl = document.getElementById('moversCount');
            if (countEl) countEl.textContent = topMovers.length;
        }

        function getPatternDisplayText(pattern) {
            const patterns = {
                'gap_up': 'Gap Up',
                'gap_down': 'Gap Down', 
                'strong_bullish': 'Strong Bull',
                'strong_bearish': 'Strong Bear',
                'near_high': 'Near High',
                'near_low': 'Near Low',
                'consolidation': 'Range',
                'unknown': 'N/A'
            };
            return patterns[pattern] || 'N/A';
        }

        function updateHotAlerts(stocks) {
            const container = document.getElementById('hotAlerts');
            if (!container) return;
            
            // Advanced hot alert detection
            const hotStocks = stocks.filter(stock => {
                const changePercent = Math.abs(stock.change_percent || 0);
                const volume = stock.vol_traded_today || 0;
                const breakout = detectBreakoutPattern(stock);
                const rsi = calculateRSI(stock);
                
                // Multiple criteria for hot alerts
                return (
                    changePercent >= 2 || // Significant price movement
                    breakout !== null || // Technical breakout
                    isVolumeSpike(stock) || // Volume spike
                    rsi > 80 || rsi < 20 // Extreme RSI levels
                );
            }).map(stock => ({
                ...stock,
                breakout: detectBreakoutPattern(stock),
                alertReason: getAlertReason(stock),
                urgency: calculateUrgency(stock)
            })).sort((a, b) => b.urgency - a.urgency).slice(0, 6);
            
            const html = hotStocks.map(stock => {
                const changePercent = stock.change_percent || 0;
                const isGain = changePercent >= 0;
                const symbol = stock.symbol ? stock.symbol.replace('NSE:', '').replace('-EQ', '') : 'Unknown';
                const urgencyIcon = getUrgencyIcon(stock.urgency);
                
                return `
                    <div class="alert-item-enhanced breakout" data-urgency="${stock.urgency}">
                        <div class="d-flex justify-content-between align-items-center">
                            ${dashboard.generateClickableSymbol(stock.symbol, `${symbol} ${urgencyIcon}`, 'fw-bold')}
                            <span class="${isGain ? 'text-success' : 'text-danger'}">${Math.abs(changePercent).toFixed(2)}%</span>
                        </div>
                        <div class="small text-warning">${stock.alertReason}</div>
                        <div class="small opacity-50">Vol: ${((stock.vol_traded_today || 0) / 1000000).toFixed(1)}M | RSI: ${calculateRSI(stock).toFixed(0)}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html || '<div class="loading-placeholder">No hot alerts detected</div>';
            const countEl = document.getElementById('hotAlertsCount');
            if (countEl) countEl.textContent = hotStocks.length;
        }

        function getAlertReason(stock) {
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;
            const breakout = detectBreakoutPattern(stock);
            const rsi = calculateRSI(stock);
            
            if (breakout === 'bullish_breakout') return 'Bullish Breakout';
            if (breakout === 'bearish_breakout') return 'Bearish Breakout';
            if (breakout === 'volume_breakout') return 'Volume Breakout';
            if (Math.abs(changePercent) > 4) return 'Extreme Move';
            if (isVolumeSpike(stock)) return 'Volume Spike';
            if (rsi > 80) return 'Overbought (RSI 80+)';
            if (rsi < 20) return 'Oversold (RSI 20-)';
            if (Math.abs(changePercent) > 2) return 'Strong Movement';
            
            return 'Market Alert';
        }

        function calculateUrgency(stock) {
            const changePercent = Math.abs(stock.change_percent || 0);
            const volume = stock.vol_traded_today || 0;
            const rsi = calculateRSI(stock);
            const breakout = detectBreakoutPattern(stock);
            
            let urgency = 0;
            
            // Price movement factor
            urgency += changePercent * 10;
            
            // Volume factor
            if (isVolumeSpike(stock)) urgency += 20;
            
            // RSI extreme levels
            if (rsi > 80 || rsi < 20) urgency += 15;
            
            // Breakout patterns
            if (breakout === 'bullish_breakout' || breakout === 'bearish_breakout') urgency += 25;
            if (breakout === 'volume_breakout') urgency += 15;
            
            // Pattern recognition
            const pattern = detectPricePattern(stock);
            if (pattern === 'gap_up' || pattern === 'gap_down') urgency += 10;
            
            return Math.min(100, urgency);
        }

        function getUrgencyIcon(urgency) {
            if (urgency > 70) return '';
            if (urgency > 50) return '';
            if (urgency > 30) return '';
            return '';
        }

        function updateVolumeSurge(stocks) {
            const container = document.getElementById('volumeSurge');
            if (!container) return;
            
            // Advanced volume analysis
            const volumeAlerts = stocks.map(stock => {
                const volume = stock.vol_traded_today || 0;
                const changePercent = stock.change_percent || 0;
                const avgVolume = estimateAverageVolume(stock);
                const volumeRatio = avgVolume > 0 ? volume / avgVolume : 0;
                
                return {
                    ...stock,
                    volumeRatio,
                    volumeScore: calculateVolumeScore(stock, volumeRatio),
                    volumePattern: analyzeVolumePattern(stock, volumeRatio)
                };
            }).filter(stock => 
                stock.volumeRatio > 1.5 || // 1.5x average volume
                stock.volumeScore > 30 || // High volume score
                (stock.vol_traded_today || 0) > 5000000 // Absolute high volume
            ).sort((a, b) => b.volumeScore - a.volumeScore).slice(0, 6);
            
            const html = volumeAlerts.map(stock => {
                const volume = stock.vol_traded_today || 0;
                const symbol = stock.symbol ? stock.symbol.replace('NSE:', '').replace('-EQ', '') : 'Unknown';
                const changePercent = stock.change_percent || 0;
                const volumeIcon = getVolumeIcon(stock.volumeRatio);
                
                return `
                    <div class="alert-item-enhanced volume" data-volume-ratio="${stock.volumeRatio.toFixed(1)}">
                        <div class="d-flex justify-content-between align-items-center">
                            ${dashboard.generateClickableSymbol(stock.symbol, `${symbol} ${volumeIcon}`, 'fw-bold')}
                            <span class="text-info">${(volume / 1000000).toFixed(1)}M</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="${changePercent >= 0 ? 'text-success' : 'text-danger'}">${changePercent.toFixed(2)}%</span>
                            <span class="text-warning">${stock.volumePattern}</span>
                        </div>
                        <div class="small opacity-50">${stock.volumeRatio.toFixed(1)}x Avg Vol | Score: ${stock.volumeScore.toFixed(0)}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html || '<div class="loading-placeholder">No volume surges detected</div>';
            const countEl = document.getElementById('volumeSurgeCount');
            if (countEl) countEl.textContent = volumeAlerts.length;
        }

        function estimateAverageVolume(stock) {
            // Estimate based on market cap and typical trading patterns
            const price = stock.ltp || 1;
            const currentVolume = stock.vol_traded_today || 0;
            
            // Base estimate on price range (rough approximation)
            if (price > 5000) return 500000; // High-priced stocks
            if (price > 1000) return 2000000; // Mid-priced stocks
            if (price > 100) return 5000000; // Low-priced stocks
            return 10000000; // Very low-priced stocks
        }

        function calculateVolumeScore(stock, volumeRatio) {
            const changePercent = Math.abs(stock.change_percent || 0);
            const volume = stock.vol_traded_today || 0;
            
            let score = 0;
            
            // Volume ratio contribution
            score += Math.min(volumeRatio * 20, 50);
            
            // Price movement contribution
            score += changePercent * 5;
            
            // Absolute volume contribution
            score += Math.min((volume / 1000000) * 2, 30);
            
            // Pattern bonus
            if (changePercent > 2 && volumeRatio > 2) score += 20;
            
            return Math.min(100, score);
        }

        function analyzeVolumePattern(stock, volumeRatio) {
            const changePercent = stock.change_percent || 0;
            
            if (volumeRatio > 5) return 'Massive Surge';
            if (volumeRatio > 3) return 'High Surge';
            if (volumeRatio > 2) return 'Volume Spike';
            if (volumeRatio > 1.5 && Math.abs(changePercent) > 2) return 'Active Trading';
            if (volumeRatio > 1.5) return 'Above Average';
            
            return 'Normal Activity';
        }

        function getVolumeIcon(volumeRatio) {
            if (volumeRatio > 5) return '';
            if (volumeRatio > 3) return '';
            if (volumeRatio > 2) return '';
            return '';
        }

        function updateActivityFeed(stocks) {
            const container = document.getElementById('activityFeed');
            if (!container) return;
            
            // Calculate activity scores and prioritize meaningful moves
            const activeStocks = stocks.map(stock => {
                const changePercent = stock.change_percent || 0;
                const volume = stock.vol_traded_today || 0;
                const activityScore = calculateActivityScore(stock);
                
                return {
                    ...stock,
                    activityScore,
                    activityType: getActivityType(stock),
                    timestamp: Date.now()
                };
            }).filter(stock => 
                stock.activityScore > 10 || // Meaningful activity
                Math.abs(stock.change_percent || 0) > 0.3 // At least 0.3% movement
            ).sort((a, b) => b.activityScore - a.activityScore).slice(0, 10);
            
            const html = activeStocks.map(stock => {
                const changePercent = stock.change_percent || 0;
                const isGain = changePercent >= 0;
                const symbol = stock.symbol ? stock.symbol.replace('NSE:', '').replace('-EQ', '') : 'Unknown';
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                const activityIcon = getActivityIcon(stock.activityType);
                
                return `
                    <div class="alert-item-enhanced ${isGain ? 'gain' : 'loss'}" style="margin-bottom: 3px; padding: 6px;">
                        <div class="d-flex justify-content-between align-items-center">
                            ${dashboard.generateClickableSymbol(stock.symbol, `${symbol} ${activityIcon}`, '', 'font-size: 0.75rem; font-weight: 600;')}
                            <span class="${isGain ? 'text-success' : 'text-danger'}" style="font-size: 0.7rem;">${changePercent.toFixed(2)}%</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-warning" style="font-size: 0.65rem;">${stock.activityType}</span>
                            <span class="opacity-50" style="font-size: 0.75rem;">${time}</span>
                        </div>
                        <div class="small opacity-30" style="font-size: 0.55rem;">Score: ${stock.activityScore.toFixed(0)} | Vol: ${((stock.vol_traded_today || 0) / 1000000).toFixed(1)}M</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html || '<div class="loading-placeholder" style="padding: 10px; text-align: center;">No significant activity</div>';
            const countEl = document.getElementById('feedCount');
            if (countEl) countEl.textContent = activeStocks.length;
        }

        function calculateActivityScore(stock) {
            const changePercent = Math.abs(stock.change_percent || 0);
            const volume = stock.vol_traded_today || 0;
            const momentum = calculateMomentumScore(stock);
            const rsi = calculateRSI(stock);
            
            let score = 0;
            
            // Price movement contribution (0-40 points)
            score += changePercent * 15;
            
            // Volume contribution (0-30 points)
            score += Math.min((volume / 1000000) * 3, 30);
            
            // Momentum contribution (0-20 points)
            score += Math.min(momentum * 2, 20);
            
            // RSI extreme levels (0-15 points)
            if (rsi > 75 || rsi < 25) score += 15;
            else if (rsi > 65 || rsi < 35) score += 10;
            
            // Pattern recognition bonus (0-10 points)
            const pattern = detectPricePattern(stock);
            if (pattern === 'gap_up' || pattern === 'gap_down') score += 10;
            else if (pattern === 'strong_bullish' || pattern === 'strong_bearish') score += 8;
            
            // Volume spike bonus (0-15 points)
            if (isVolumeSpike(stock)) score += 15;
            
            return Math.min(100, score);
        }

        function getActivityType(stock) {
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;
            const breakout = detectBreakoutPattern(stock);
            const pattern = detectPricePattern(stock);
            const rsi = calculateRSI(stock);
            
            // Priority order for activity types
            if (breakout === 'bullish_breakout') return 'Bull Breakout';
            if (breakout === 'bearish_breakout') return 'Bear Breakout';
            if (breakout === 'volume_breakout') return 'Vol Breakout';
            if (pattern === 'gap_up') return 'Gap Up';
            if (pattern === 'gap_down') return 'Gap Down';
            if (Math.abs(changePercent) > 3) return 'Big Move';
            if (isVolumeSpike(stock)) return 'Vol Surge';
            if (rsi > 80) return 'Overbought';
            if (rsi < 20) return 'Oversold';
            if (pattern === 'strong_bullish') return 'Strong Bull';
            if (pattern === 'strong_bearish') return 'Strong Bear';
            if (Math.abs(changePercent) > 1.5) return 'Active';
            if (volume > 3000000) return 'High Vol';
            
            return 'Moving';
        }

        function getActivityIcon(activityType) {
            const icons = {
                'Bull Breakout': '',
                'Bear Breakout': '',
                'Vol Breakout': '',
                'Gap Up': '',
                'Gap Down': '',
                'Big Move': '',
                'Vol Surge': '',
                'Overbought': '',
                'Oversold': '',
                'Strong Bull': '',
                'Strong Bear': '',
                'Active': '',
                'High Vol': '',
                'Moving': ''
            };
            return icons[activityType] || '';
        }

        function updateMarketPulse(stocks = []) {
            if (!stocks.length) return;
            
            // Advanced market sentiment analysis
            const marketMetrics = calculateMarketMetrics(stocks);
            
            const updatePulseValue = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            
            updatePulseValue('bullishMomentum', marketMetrics.bullishMomentum + '%');
            updatePulseValue('bearishMomentum', marketMetrics.bearishMomentum + '%');
            updatePulseValue('volumeSpike', marketMetrics.volumeSpikes);
            updatePulseValue('marketActivity', marketMetrics.activityIndex + '%');
            
            // Update alert badge with sophisticated counting
            const totalAlerts = marketMetrics.significantAlerts;
            updateAlertBadge(totalAlerts);
            updateStatCounts(
                marketMetrics.strongGainers, 
                marketMetrics.strongLosers, 
                marketMetrics.activeStocks, 
                totalAlerts
            );
        }

        function calculateMarketMetrics(stocks) {
            let strongGainers = 0, strongLosers = 0, volumeSpikes = 0;
            let totalMomentum = 0, totalVolume = 0, activeStocks = 0;
            let bullishStrength = 0, bearishStrength = 0;
            
            stocks.forEach(stock => {
                const changePercent = stock.change_percent || 0;
                const volume = stock.vol_traded_today || 0;
                const momentum = calculateMomentumScore(stock);
                const rsi = calculateRSI(stock);
                
                // Count significant moves
                if (changePercent > 1) {
                    strongGainers++;
                    bullishStrength += changePercent * (volume / 1000000);
                }
                if (changePercent < -1) {
                    strongLosers++;
                    bearishStrength += Math.abs(changePercent) * (volume / 1000000);
                }
                
                // Volume analysis
                if (isVolumeSpike(stock)) volumeSpikes++;
                
                // Activity measurement
                if (Math.abs(changePercent) > 0.5 || volume > 1000000) activeStocks++;
                
                totalMomentum += momentum;
                totalVolume += volume;
            });
            
            const total = stocks.length;
            const bullishMomentum = total > 0 ? Math.round((strongGainers / total) * 100) : 0;
            const bearishMomentum = total > 0 ? Math.round((strongLosers / total) * 100) : 0;
            const activityIndex = total > 0 ? Math.round((activeStocks / total) * 100) : 0;
            
            // Calculate significant alerts using multiple criteria
            const breakoutStocks = stocks.filter(s => detectBreakoutPattern(s) !== null).length;
            const extremeRSI = stocks.filter(s => {
                const rsi = calculateRSI(s);
                return rsi > 80 || rsi < 20;
            }).length;
            const significantAlerts = strongGainers + strongLosers + volumeSpikes + breakoutStocks + extremeRSI;
            
            return {
                bullishMomentum,
                bearishMomentum,
                volumeSpikes,
                activityIndex,
                strongGainers,
                strongLosers,
                activeStocks,
                significantAlerts,
                marketSentiment: bullishStrength > bearishStrength ? 'bullish' : 'bearish',
                sentimentStrength: Math.abs(bullishStrength - bearishStrength)
            };
        }

    </script>
    
    <!-- Add global scroll function -->
    <script>
        function scrollToTable(tableId) {
            const element = document.getElementById(tableId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    </script>

    <!-- Index Analysis Charts JavaScript -->
    <script>
        // Chart variables
        let indexChangeChart = null;
        let indexOpenChart = null;
        let indexHighChart = null;
        let indexLowChart = null;
        
        // Chart configuration
        const chartConfig = {
            type: 'bar',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#ffffff',
                            font: {
                                size: 9
                            },
                            maxRotation: 45
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    y: {
                        ticks: {
                            color: '#ffffff',
                            font: {
                                size: 9
                            },
                            callback: function(value) {
                                return value.toFixed(1) + '%';
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        };

        // Initialize charts when page loads
        function initializeIndexCharts() {
            try {
                // Chart 1: % Change
                const changeCtx = document.getElementById('indexChangeChart');
                if (changeCtx) {
                    indexChangeChart = new Chart(changeCtx, {
                        ...chartConfig,
                        data: {
                            labels: ['Loading...'],
                            datasets: [{
                                data: [0],
                                backgroundColor: ['rgba(128, 128, 128, 0.5)'],
                                borderColor: ['rgba(128, 128, 128, 0.8)'],
                                borderWidth: 1
                            }]
                        }
                    });
                }

                // Chart 2: % From Open
                const openCtx = document.getElementById('indexOpenChart');
                if (openCtx) {
                    indexOpenChart = new Chart(openCtx, {
                        ...chartConfig,
                        data: {
                            labels: ['Loading...'],
                            datasets: [{
                                data: [0],
                                backgroundColor: ['rgba(128, 128, 128, 0.5)'],
                                borderColor: ['rgba(128, 128, 128, 0.8)'],
                                borderWidth: 1
                            }]
                        }
                    });
                }

                // Chart 3: % From High
                const highCtx = document.getElementById('indexHighChart');
                if (highCtx) {
                    indexHighChart = new Chart(highCtx, {
                        ...chartConfig,
                        data: {
                            labels: ['Loading...'],
                            datasets: [{
                                data: [0],
                                backgroundColor: ['rgba(128, 128, 128, 0.5)'],
                                borderColor: ['rgba(128, 128, 128, 0.8)'],
                                borderWidth: 1
                            }]
                        }
                    });
                }

                // Chart 4: % From Low
                const lowCtx = document.getElementById('indexLowChart');
                if (lowCtx) {
                    indexLowChart = new Chart(lowCtx, {
                        ...chartConfig,
                        data: {
                            labels: ['Loading...'],
                            datasets: [{
                                data: [0],
                                backgroundColor: ['rgba(128, 128, 128, 0.5)'],
                                borderColor: ['rgba(128, 128, 128, 0.8)'],
                                borderWidth: 1
                            }]
                        }
                    });
                }

                console.log('Index analysis charts initialized successfully');
                
                // Load initial data after a short delay
                setTimeout(updateIndexCharts, 2000);
                
            } catch (error) {
                console.error('Error initializing index charts:', error);
            }
        }

        // Update charts with current index data
        function updateIndexCharts() {
            try {
                // Get data from all index symbols, not just visible cards
                const indexSymbols = [
                    "NSE:NIFTY50-INDEX", "BSE:SENSEX-INDEX", "NSE:NIFTYBANK-INDEX",
                    "NSE:NIFTYIT-INDEX", "NSE:FINNIFTY-INDEX", "NSE:MIDCPNIFTY-INDEX",
                    "NSE:NIFTYNXT50-INDEX", "NSE:NIFTYFMCG-INDEX", "NSE:NIFTYPHARMA-INDEX",
                    "NSE:NIFTYAUTO-INDEX", "NSE:NIFTYMETAL-INDEX", "NSE:NIFTYREALTY-INDEX",
                    "NSE:NIFTYPSE-INDEX", "NSE:NIFTYPVTBANK-INDEX", "NSE:NIFTYMEDIA-INDEX",
                    "NSE:NIFTYINFRA-INDEX", "NSE:NIFTYENERGY-INDEX", "NSE:NIFTYCOMMODITIES-INDEX",
                    "NSE:NIFTYCPSE-INDEX", "NSE:NIFTYMIDCAP50-INDEX", "NSE:NIFTYSMLCAP100-INDEX"
                ];

                const labels = [];
                const changeData = [];
                const openData = [];
                const highData = [];
                const lowData = [];

                // Try to get data from both index cards and WebSocket data
                indexSymbols.forEach(symbol => {
                    // First try to get from index cards
                    const card = document.querySelector(`[data-index-symbol="${symbol}"]`);
                    let stockData = null;
                    let name = '';
                    let currentPrice = 0;
                    let changePercent = 0;
                    let openPercent = 0;

                    if (card) {
                        const nameEl = card.querySelector('.index-name');
                        const priceEl = card.querySelector('.index-price');
                        const changeEl = card.querySelector('.index-change');
                        const openPercentEl = card.querySelector('.index-open-percent');

                        if (nameEl && priceEl && changeEl) {
                            name = nameEl.textContent.trim();
                            const priceText = priceEl.textContent.trim();
                            const changeText = changeEl.textContent.trim();
                            const openPercentText = openPercentEl ? openPercentEl.textContent.trim() : '%O:--';

                            currentPrice = parseFloat(priceText.replace(/[^\d.-]/g, ''));
                            
                            const changeMatch = changeText.match(/([-+]?\d+\.?\d*)%/);
                            changePercent = changeMatch ? parseFloat(changeMatch[1]) : 0;

                            const openMatch = openPercentText.match(/%O:([-+]?\d+\.?\d*)/);
                            openPercent = openMatch ? parseFloat(openMatch[1]) : 0;
                        }
                    }

                    // Try to get more detailed data from WebSocket
                    stockData = getIndexStockData(symbol);
                    
                    if (stockData && stockData.ltp > 0) {
                        currentPrice = stockData.ltp;
                        changePercent = stockData.change_percent || 0;
                        
                        // Calculate % from open
                        if (stockData.open_price > 0) {
                            openPercent = ((currentPrice - stockData.open_price) / stockData.open_price) * 100;
                        }
                    }

                    // Get display name
                    if (!name && symbol) {
                        name = symbol.replace('NSE:', '').replace('BSE:', '').replace('-INDEX', '').replace('NIFTY', '');
                        if (name === '50') name = 'NIFTY 50';
                        if (name === 'SENSEX') name = 'SENSEX';
                    }

                    // Only include if we have valid data
                    if (currentPrice > 0 && name && name !== '--') {
                        labels.push(name);
                        changeData.push(changePercent);
                        openData.push(openPercent);
                        
                        // Calculate proper % from high and % from low
                        let fromHigh = 0;
                        let fromLow = 0;
                        
                        if (stockData && stockData.high_price > 0 && stockData.low_price > 0) {
                            // % from high = ((current - high) / high) * 100 (usually negative)
                            fromHigh = ((currentPrice - stockData.high_price) / stockData.high_price) * 100;
                            // % from low = ((current - low) / low) * 100 (usually positive)
                            fromLow = ((currentPrice - stockData.low_price) / stockData.low_price) * 100;
                        } else {
                            // Fallback: calculate based on change percent (rough approximation)
                            fromHigh = changePercent <= 0 ? changePercent : changePercent - 2; // Assume high is above current
                            fromLow = changePercent >= 0 ? changePercent : changePercent + 2; // Assume low is below current
                        }
                        
                        highData.push(fromHigh);
                        lowData.push(fromLow);
                    }
                });

                // Update all charts
                if (indexChangeChart && labels.length > 0) {
                    indexChangeChart.data.labels = labels;
                    indexChangeChart.data.datasets[0].data = changeData;
                    indexChangeChart.data.datasets[0].backgroundColor = changeData.map(value => 
                        value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
                    );
                    indexChangeChart.data.datasets[0].borderColor = changeData.map(value => 
                        value >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'
                    );
                    indexChangeChart.update('none');
                }

                if (indexOpenChart && labels.length > 0) {
                    indexOpenChart.data.labels = labels;
                    indexOpenChart.data.datasets[0].data = openData;
                    indexOpenChart.data.datasets[0].backgroundColor = openData.map(value => 
                        value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
                    );
                    indexOpenChart.data.datasets[0].borderColor = openData.map(value => 
                        value >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'
                    );
                    indexOpenChart.update('none');
                }

                if (indexHighChart && labels.length > 0) {
                    indexHighChart.data.labels = labels;
                    indexHighChart.data.datasets[0].data = highData;
                    indexHighChart.data.datasets[0].backgroundColor = highData.map(() => 'rgba(220, 53, 69, 0.8)');
                    indexHighChart.data.datasets[0].borderColor = highData.map(() => 'rgba(220, 53, 69, 1)');
                    indexHighChart.update('none');
                }

                if (indexLowChart && labels.length > 0) {
                    indexLowChart.data.labels = labels;
                    indexLowChart.data.datasets[0].data = lowData;
                    indexLowChart.data.datasets[0].backgroundColor = lowData.map(() => 'rgba(25, 135, 84, 0.8)');
                    indexLowChart.data.datasets[0].borderColor = lowData.map(() => 'rgba(25, 135, 84, 1)');
                    indexLowChart.update('none');
                }

            } catch (error) {
                console.error('Error updating index charts:', error);
            }
        }

        // Get stock data for index symbols
        function getIndexStockData(symbol) {
            // Try to get data from the global stockData variable if available
            if (window.stockData && symbol) {
                return window.stockData[symbol];
            }
            return null;
        }

        // Toggle charts visibility
        function toggleIndexCharts() {
            const container = document.getElementById('indexChartsContainer');
            const icon = document.getElementById('indexChartsToggleIcon');
            
            if (container && icon) {
                const isVisible = container.style.display !== 'none';
                container.style.display = isVisible ? 'none' : 'block';
                icon.className = isVisible ? 'fas fa-eye-slash' : 'fas fa-eye';
            }
        }

        // Initialize charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for other scripts to load
            setTimeout(initializeIndexCharts, 1000);
            
            // Add toggle functionality
            const toggleBtn = document.getElementById('toggleIndexCharts');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleIndexCharts);
            }
        });

        // Update charts when stock data updates (hook into existing update functions)
        const originalUpdateIndexCards = window.updateIndexCards;
        if (originalUpdateIndexCards) {
            window.updateIndexCards = function(...args) {
                originalUpdateIndexCards.apply(this, args);
                // Update charts after index cards are updated
                setTimeout(updateIndexCharts, 100);
            };
        }

        // Fallback: Update charts every 5 seconds
        setInterval(updateIndexCharts, 10000); // Reduced frequency from 5s to 10s
    </script>

        </div>
    </div>
    <!-- End Main Container -->

    <!-- Create Alert Modal -->
    <div class="modal fade" id="createAlertModal" tabindex="-1" aria-labelledby="createAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="createAlertModalLabel">
                        <i class="fas fa-bell me-2"></i>Create New Alert
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createAlertForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="alertType" class="form-label">Alert Type</label>
                                <select class="form-select bg-dark text-light border-secondary" id="alertType" required>
                                    <option value="">Select Alert Type</option>
                                    <option value="price_action">Price Action Alert</option>
                                    <option value="index_analysis">Index Analysis Alert</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="alertCategory" class="form-label">Category</label>
                                <select class="form-select bg-dark text-light border-secondary" id="alertCategory" required>
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="alertTitle" class="form-label">Alert Title</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="alertTitle" required>
                            </div>
                            <div class="col-md-6 mb-3" id="symbolGroup" style="display: none;">
                                <label for="alertSymbol" class="form-label">Symbol (Optional)</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="alertSymbol" placeholder="e.g., RELIANCE">
                            </div>
                        </div>
                        
                        <div class="row" id="thresholdGroup" style="display: none;">
                            <div class="col-md-6 mb-3">
                                <label for="thresholdValue" class="form-label">Threshold Value (%)</label>
                                <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="thresholdValue">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="condition" class="form-label">Condition</label>
                                <select class="form-select bg-dark text-light border-secondary" id="condition">
                                    <option value="above">Above</option>
                                    <option value="below">Below</option>
                                    <option value="equals">Equals</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="alertMessage" class="form-label">Alert Message</label>
                            <textarea class="form-control bg-dark text-light border-secondary" id="alertMessage" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isActive" checked>
                            <label class="form-check-label" for="isActive">
                                Active Alert
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveAlertBtn">
                        <i class="fas fa-save me-1"></i>Save Alert
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Browser Modal -->
    <div class="modal fade" id="floatingBrowserModal" tabindex="-1" aria-labelledby="floatingBrowserModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="floatingBrowserModalLabel">
                        <i class="fas fa-chart-line me-2"></i>Chart Browser
                    </h5>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" id="refreshChart">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div class="position-relative" style="height: 80vh;">
                        <div class="loading-overlay position-absolute w-100 h-100 d-flex align-items-center justify-content-center bg-dark" id="chartLoadingOverlay" style="z-index: 1000;">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #58a6ff;"></i>
                                <div class="mt-3">Loading chart...</div>
                            </div>
                        </div>
                        <div id="tradingview-widget-container" class="w-100 h-100"></div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <small class="text-muted me-auto">
                        <i class="fas fa-info-circle me-1"></i>
                        Powered by TradingView - Real-time market data
                    </small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Manual Modal -->
    <div class="modal fade" id="userManualModal" tabindex="-1" aria-labelledby="userManualModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="userManualModalLabel">
                        <i class="fas fa-book me-2 text-primary"></i>User Manual - MG F&O Dashboard
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="accordion" id="userManualAccordion">
                        <!-- Getting Started -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="gettingStartedHeading">
                                <button class="accordion-button bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#gettingStarted" aria-expanded="true" aria-controls="gettingStarted">
                                    <i class="fas fa-rocket me-2 text-success"></i>Getting Started
                                </button>
                            </h2>
                            <div id="gettingStarted" class="accordion-collapse collapse show" aria-labelledby="gettingStartedHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <h6 class="text-info mb-3">Welcome to MG F&O Stocks Dashboard!</h6>
                                    <p>This professional data analytical dashboard provides real-time market analysis for F&O (Futures & Options) stocks with advanced technical indicators.</p>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-check text-success me-2"></i>Real-time streaming data for 200+ F&O stocks</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Advanced technical analysis (RVOL, Camarilla, CPR, Fibonacci)</li>
                                        <li><i class="fas fa-check text-success me-2"></i>One-click TradingView chart integration</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Mobile-responsive design</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Overview -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="dashboardOverviewHeading">
                                <button class="accordion-button collapsed bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#dashboardOverview" aria-expanded="false" aria-controls="dashboardOverview">
                                    <i class="fas fa-chart-bar me-2 text-warning"></i>Dashboard Overview
                                </button>
                            </h2>
                            <div id="dashboardOverview" class="accordion-collapse collapse" aria-labelledby="dashboardOverviewHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <h6 class="text-info mb-3">Main Components:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-warning">Market Overview</h6>
                                            <p class="small">Real-time index data including NIFTY, BANKNIFTY, and FINNIFTY with live price updates.</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-warning">Price Action Analysis</h6>
                                            <p class="small">Live stock data with percentage changes, volume analysis, and price movements.</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-warning">RVOL Analysis</h6>
                                            <p class="small">Relative Volume analysis categorized by volume levels: Super High (>5x), High (2-5x), Normal (1-2x), Low (<1x).</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-warning">Technical Indicators</h6>
                                            <p class="small">Advanced calculations including Camarilla Pivot Points, CPR (Central Pivot Range), and Fibonacci Retracements.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Analysis -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="technicalAnalysisHeading">
                                <button class="accordion-button collapsed bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#technicalAnalysis" aria-expanded="false" aria-controls="technicalAnalysis">
                                    <i class="fas fa-chart-line me-2 text-info"></i>Technical Analysis Features
                                </button>
                            </h2>
                            <div id="technicalAnalysis" class="accordion-collapse collapse" aria-labelledby="technicalAnalysisHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <div class="mb-4">
                                        <h6 class="text-info"> Camarilla Pivot Points</h6>
                                        <p class="small">Advanced pivot calculation system providing 5 resistance (R1-R5) and 5 support (S1-S5) levels based on previous day's high, low, and close.</p>
                                        <ul class="small">
                                            <li><strong>R5/S5:</strong> Extreme levels for breakout trading</li>
                                            <li><strong>R3/S3:</strong> Primary reversal levels</li>
                                            <li><strong>R1/S1:</strong> Intraday support/resistance</li>
                                        </ul>
                                    </div>
                                    <div class="mb-4">
                                        <h6 class="text-info"> CPR (Central Pivot Range)</h6>
                                        <p class="small">Determines market sentiment based on the relationship between Pivot Point (PP), Bottom Central Pivot (BC), and Top Central Pivot (TC).</p>
                                        <ul class="small">
                                            <li><strong>Narrow CPR:</strong> Strong trending day expected</li>
                                            <li><strong>Wide CPR:</strong> Sideways movement likely</li>
                                        </ul>
                                    </div>
                                    <div class="mb-4">
                                        <h6 class="text-info"> Fibonacci Retracements</h6>
                                        <p class="small">Key retracement levels (23.6%, 38.2%, 50%, 61.8%, 78.6%) calculated from recent swing high and low to identify potential reversal zones.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- How to Use -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="howToUseHeading">
                                <button class="accordion-button collapsed bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#howToUse" aria-expanded="false" aria-controls="howToUse">
                                    <i class="fas fa-mouse-pointer me-2 text-success"></i>How to Use the Dashboard
                                </button>
                            </h2>
                            <div id="howToUse" class="accordion-collapse collapse" aria-labelledby="howToUseHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <div class="mb-3">
                                        <h6 class="text-warning"> Viewing Stock Data</h6>
                                        <ul class="small">
                                            <li>Click on any stock symbol to view detailed TradingView chart</li>
                                            <li>Tables are sortable - click column headers to sort</li>
                                            <li>Use search filters to find specific stocks</li>
                                            <li>Color-coded values indicate positive (green) or negative (red) changes</li>
                                        </ul>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="text-warning"> RVOL Analysis</h6>
                                        <ul class="small">
                                            <li><strong>Super High RVOL (>5x):</strong> Exceptional volume activity</li>
                                            <li><strong>High RVOL (2-5x):</strong> Above-normal volume</li>
                                            <li><strong>Normal RVOL (1-2x):</strong> Typical volume range</li>
                                            <li><strong>Low RVOL (<1x):</strong> Below-average volume</li>
                                        </ul>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="text-warning"> Quick Actions</h6>
                                        <ul class="small">
                                            <li>Connection status indicator shows real-time data connectivity</li>
                                            <li>Timestamp displays last data update time</li>
                                            <li>Auto-refresh ensures latest market data</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Support -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="supportHeading">
                                <button class="accordion-button collapsed bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#support" aria-expanded="false" aria-controls="support">
                                    <i class="fas fa-life-ring me-2 text-danger"></i>Support & Contact
                                </button>
                            </h2>
                            <div id="support" class="accordion-collapse collapse" aria-labelledby="supportHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <div class="text-center">
                                        <h6 class="text-info mb-3">Need Help?</h6>
                                        <p class="mb-3">Our support team is here to assist you with any questions or technical issues.</p>
                                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                                            <a href="mailto:marketguldasta@gmail.com" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-envelope me-1"></i>Email Support
                                            </a>
                                            <a href="tel:+919049536966" class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-phone me-1"></i>Call Support
                                            </a>
                                            <a href="https://wa.me/919049536966" target="_blank" class="btn btn-outline-success btn-sm">
                                                <i class="fab fa-whatsapp me-1"></i>WhatsApp
                                            </a>
                                        </div>
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>Support Hours: 9:00 AM - 6:00 PM (IST)
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <div class="me-auto">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Version 2.0 - Professional Data Analytical Dashboard
                        </small>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check me-1"></i>Got it!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- RVOL Chart JavaScript -->
    <script>
        // RVOL Chart functionality
        let rvolChartData = [];
        let rvolChartVisible = true;
        let rvol50ChartInstance = null;

        // Toggle RVOL Chart visibility
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggleRvolChart');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const container = document.getElementById('rvolChartContainer');
                    const icon = document.getElementById('rvolChartToggleIcon');
                    
                    if (rvolChartVisible) {
                        container.style.display = 'none';
                        icon.className = 'fas fa-eye-slash';
                        rvolChartVisible = false;
                    } else {
                        container.style.display = 'block';
                        icon.className = 'fas fa-eye';
                        rvolChartVisible = true;
                        if (rvolChartData.length === 0) {
                            loadRvolChartData();
                        }
                    }
                });
            }
        });

        function loadRvolChartData() {
            // Remove loading/error states as they've been removed from HTML
            
            fetch('/api/rvol-data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        rvolChartData = data.data;
                        renderRvolPieCharts(rvolChartData);
                    } else {
                        console.error('RVOL data error:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading RVOL data:', error);
                });
        }

        // Add throttling to prevent performance issues
        let rvolUpdateTimeout = null;
        
        // Helper function to get stock data from main table for RVOL percentage calculations
        function getStockDataFromMainTable(symbol) {
            // Access the live stock data from the main dashboard
            if (window.dashboard && window.dashboard.lastStockData) {
                const stockData = window.dashboard.lastStockData;
                
                // Find stock by symbol (try different symbol formats)
                let foundStock = stockData.find(stock => 
                    stock.symbol === symbol || 
                    stock.symbol === symbol.replace('NSE:', '') ||
                    stock.symbol === symbol.replace('-EQ', '')
                );
                
                return foundStock || null;
            }
            
            return null;
        }
        
        function renderRvolPieCharts(data) {
            // Clear any existing timeout to prevent multiple rapid updates
            if (rvolUpdateTimeout) {
                clearTimeout(rvolUpdateTimeout);
            }
            
            // Throttle updates to prevent performance issues (reduced from 1000ms to 300ms)
            rvolUpdateTimeout = setTimeout(() => {
                // Filter and deduplicate stocks with valid RVOL data
                const stocksMap = new Map();
                data.forEach(stock => {
                    if (stock.rvol_ratio && stock.rvol_ratio > 0 && stock.current_volume > 0) {
                        const normalizedSymbol = stock.symbol.replace('NSE:', '').replace('-EQ', '').toUpperCase();
                        // Keep the latest data for each symbol
                        stocksMap.set(normalizedSymbol, stock);
                    }
                });
                
                const stocksWithRvol = Array.from(stocksMap.values());
                
                if (stocksWithRvol.length === 0) {
                    console.log('No stocks with valid RVOL data');
                    return;
                }
                
                // Categorize stocks by RVOL ratio with user-requested ranges (proper boundary handling)
                const volumeCategories = {
                    extreme: [],     // >3x
                    high: [],        // 3x-2x  
                    moderate: [],    // 2x-1x
                    low: []          // <1x
                };
                
                // Categorize with ordered else-if to prevent gaps/overlaps
                stocksWithRvol.forEach(stock => {
                    const rvol = stock.rvol_ratio;
                    if (rvol > 3) {
                        volumeCategories.extreme.push(stock);
                    } else if (rvol > 2) {  // 3 >= rvol > 2
                        volumeCategories.high.push(stock);
                    } else if (rvol >= 1) { // 2 >= rvol >= 1 (includes 1.0 in 2x-1x range)
                        volumeCategories.moderate.push(stock);
                    } else {                // rvol < 1
                        volumeCategories.low.push(stock);
                    }
                });
                
                // Update counters
                const extremeEl = document.getElementById('above3xCount');
                const highEl = document.getElementById('range3x2xCount');
                const moderateEl = document.getElementById('range2x1xCount');
                const lowEl = document.getElementById('below1xCount');
                
                // Update counters and log distribution for verification
                if (extremeEl) extremeEl.textContent = `${volumeCategories.extreme.length} stocks`;
                if (highEl) highEl.textContent = `${volumeCategories.high.length} stocks`;
                if (moderateEl) moderateEl.textContent = `${volumeCategories.moderate.length} stocks`;
                if (lowEl) lowEl.textContent = `${volumeCategories.low.length} stocks`;
                
                // Debug: Log RVOL distribution for verification
                console.log(`RVOL Distribution: >3x: ${volumeCategories.extreme.length}, 3x-2x: ${volumeCategories.high.length}, 2x-1x: ${volumeCategories.moderate.length}, <1x: ${volumeCategories.low.length}`);
                
                // Debug: Log first stock from each non-empty category
                if (volumeCategories.extreme.length > 0) console.log(`>3x sample:`, volumeCategories.extreme[0].symbol, volumeCategories.extreme[0].rvol_ratio);
                if (volumeCategories.high.length > 0) console.log(`3x-2x sample:`, volumeCategories.high[0].symbol, volumeCategories.high[0].rvol_ratio);
                if (volumeCategories.moderate.length > 0) console.log(`2x-1x sample:`, volumeCategories.moderate[0].symbol, volumeCategories.moderate[0].rvol_ratio);
                if (volumeCategories.low.length > 0) console.log(`<1x sample:`, volumeCategories.low[0].symbol, volumeCategories.low[0].rvol_ratio);
                
                // Create 4 separate RVOL tables
                createRvolTable('rvolTable1', volumeCategories.extreme, '#dc3545');
                createRvolTable('rvolTable2', volumeCategories.high, '#ffc107');
                createRvolTable('rvolTable3', volumeCategories.moderate, '#28a745');
                createRvolTable('rvolTable4', volumeCategories.low, '#17a2b8');
            }, 300); // 300ms throttle for faster live updates
        }

        function createRvolTable(tableId, stocks, primaryColor) {
            const tableContainer = document.getElementById(tableId);
            
            if (!tableContainer) return;
            
            if (!stocks || stocks.length === 0) {
                tableContainer.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 20px; font-size: 0.7rem;">
                        <i class="fas fa-chart-line"></i><br>
                        No stocks in this category
                    </div>
                `;
                return;
            }
            
            // Sort stocks by RVOL descending
            const sortedStocks = stocks.sort((a, b) => (b.rvol_ratio || 0) - (a.rvol_ratio || 0));
            
            let tableHTML = '';
            
            sortedStocks.forEach(stock => {
                const symbol = stock.symbol || 'N/A';
                const rvol = stock.rvol_ratio || 0;
                
                // No percentage calculations needed - removed per user request
                
                // Debug log for first item in each category
                if (sortedStocks.indexOf(stock) === 0) {
                    console.log(`RVOL Debug ${symbol}:`, {
                        rvol: rvol
                    });
                }
                
                // No color coding needed - removed percentage columns
                
                tableHTML += `
                    <div class="rvol-stock-row" style="border-left-color: ${primaryColor};">
                        <div class="rvol-symbol" onclick="window.open('https://in.tradingview.com/chart/?symbol=NSE:${symbol}', '_blank')">
                            ${symbol}
                        </div>
                        <div class="rvol-data">
                            <span class="rvol-value">${rvol.toFixed(1)}x</span>
                        </div>
                    </div>
                `;
            });
            
            tableContainer.innerHTML = tableHTML;
        }

        // Auto-load RVOL chart data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Delay loading by 3 seconds to let other data load first
            setTimeout(() => {
                if (rvolChartVisible) {
                    loadRvolChartData();
                }
            }, 3000);
            
            // Refresh RVOL data every 1 minute
            setInterval(() => {
                if (rvolChartVisible && rvolChartData.length > 0) {
                    loadRvolChartData();
                }
            }, 60000);
        });
    </script>

    <!-- Floating Browser JavaScript -->
    <script>
        class FloatingBrowser {
            constructor() {
                this.modal = new bootstrap.Modal(document.getElementById('floatingBrowserModal'));
                this.widgetContainer = document.getElementById('tradingview-widget-container');
                this.loadingOverlay = document.getElementById('chartLoadingOverlay');
                this.modalTitle = document.getElementById('floatingBrowserModalLabel');
                this.currentSymbol = '';
                this.init();
            }

            init() {
                // Refresh button functionality
                const refreshBtn = document.getElementById('refreshChart');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        this.refreshChart();
                    });
                }

                // Clear widget when modal closes
                const modalElement = document.getElementById('floatingBrowserModal');
                if (modalElement) {
                    modalElement.addEventListener('hidden.bs.modal', () => {
                        this.widgetContainer.innerHTML = '';
                        this.currentSymbol = '';
                    });
                }
            }

            openChart(chartUrl, symbolName = 'Chart') {
                // Extract symbol from TradingView URL
                const urlMatch = chartUrl.match(/symbol=([^&]+)/);
                const symbol = urlMatch ? urlMatch[1] : `NSE:${symbolName}`;
                
                this.currentSymbol = symbol;
                this.modalTitle.innerHTML = `<i class="fas fa-chart-line me-2"></i>${symbolName} Chart`;
                this.showLoading();
                this.modal.show();
                
                // Create TradingView widget
                this.loadTradingViewWidget(symbol);
            }

            loadTradingViewWidget(symbol) {
                // Clear previous widget
                this.widgetContainer.innerHTML = '';
                
                // Create widget script
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "autosize": true,
                    "symbol": symbol,
                    "timezone": "Asia/Kolkata",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "enable_publishing": false,
                    "withdateranges": true,
                    "range": "YTD",
                    "hide_side_toolbar": false,
                    "allow_symbol_change": true,
                    "save_image": false,
                    "calendar": false,
                    "support_host": "https://www.tradingview.com"
                });

                // Add the script to widget container
                this.widgetContainer.appendChild(script);
                
                // Hide loading after widget loads
                setTimeout(() => {
                    this.hideLoading();
                }, 3000);
            }

            refreshChart() {
                if (this.currentSymbol) {
                    this.showLoading();
                    this.loadTradingViewWidget(this.currentSymbol);
                }
            }

            showLoading() {
                this.loadingOverlay.style.display = 'flex';
            }

            hideLoading() {
                this.loadingOverlay.style.display = 'none';
            }
        }

        // Column header sorting functionality
        if (!window.TableHeaderSorter) {
        class TableHeaderSorter {
            constructor() {
                this.sortStates = {};
                this.initializeHeaders();
            }

            // Parse range text to key and rank for sorting/filtering (based on actual Range column formats)
            parseRangeToKeyAndRank(rangeText) {
                if (!rangeText || rangeText === '-' || rangeText.trim() === '') return { key: 'unknown', rank: 1 };
                
                // Clean text: remove HTML tags, extra spaces, and indicators like *
                const text = rangeText.replace(/<[^>]*>/g, '').replace(/\*/g, '').trim().toLowerCase();
                
                // Handle "No Data" or "No Price" cases
                if (text.includes('no data') || text.includes('no price')) return { key: 'no_data', rank: 1 };
                
                // Exact matches based on actual Range column output patterns
                
                // Camarilla patterns: "Above R5", "R4-R5", "R3-R4", etc.
                if (text === 'above r5') return { key: 'above_r5', rank: 100 };
                if (text === 'r4-r5') return { key: 'r4_to_r5', rank: 98 };
                if (text === 'r3-r4') return { key: 'r3_to_r4', rank: 96 };
                if (text === 'r2-r3') return { key: 'r2_to_r3', rank: 94 };
                if (text === 'r1-r2') return { key: 'r1_to_r2', rank: 92 };
                if (text === 's1-r1') return { key: 's1_to_r1', rank: 90 };
                if (text === 's2-s1') return { key: 's2_to_s1', rank: 88 };
                if (text === 's3-s2') return { key: 's3_to_s2', rank: 86 };
                if (text === 's4-s3') return { key: 's4_to_s3', rank: 84 };
                if (text === 's5-s4') return { key: 's5_to_s4', rank: 82 };
                if (text === 'below s5') return { key: 'below_s5', rank: 80 };
                
                // CPR patterns: "Above R3", "R2-R3", "R1-R2", "TC-R1", "PP-TC", "BC-PP", "S1-BC", etc.
                if (text === 'above r3') return { key: 'above_r3', rank: 78 };
                if (text === 'tc-r1') return { key: 'tc_to_r1', rank: 76 };
                if (text === 'pp-tc') return { key: 'pp_to_tc', rank: 74 };
                if (text === 'bc-pp') return { key: 'bc_to_pp', rank: 72 };
                if (text === 's1-bc') return { key: 's1_to_bc', rank: 70 };
                if (text === 'below s3') return { key: 'below_s3', rank: 68 };
                
                // Fibonacci patterns: "PP-R1", "S1-PP", etc.
                if (text === 'pp-r1') return { key: 'pp_to_r1', rank: 66 };
                if (text === 's1-pp') return { key: 's1_to_pp', rank: 64 };
                
                // Generic patterns using regex for variations and edge cases
                
                // Above patterns
                if (/^above\s+r5/i.test(text)) return { key: 'above_r5', rank: 100 };
                if (/^above\s+r4/i.test(text)) return { key: 'above_r4', rank: 97 };
                if (/^above\s+r3/i.test(text)) return { key: 'above_r3', rank: 78 };
                if (/^above\s+r2/i.test(text)) return { key: 'above_r2', rank: 95 };
                if (/^above\s+r1/i.test(text)) return { key: 'above_r1', rank: 93 };
                
                // Between level patterns (dash format: R4-R5, R3-R4, etc.)
                if (/r4\s*-\s*r5/i.test(text)) return { key: 'r4_to_r5', rank: 98 };
                if (/r3\s*-\s*r4/i.test(text)) return { key: 'r3_to_r4', rank: 96 };
                if (/r2\s*-\s*r3/i.test(text)) return { key: 'r2_to_r3', rank: 94 };
                if (/r1\s*-\s*r2/i.test(text)) return { key: 'r1_to_r2', rank: 92 };
                
                // Resistance to support transitions
                if (/s1\s*-\s*r1/i.test(text)) return { key: 's1_to_r1', rank: 90 };
                
                // Support level ranges
                if (/s2\s*-\s*s1/i.test(text)) return { key: 's2_to_s1', rank: 88 };
                if (/s3\s*-\s*s2/i.test(text)) return { key: 's3_to_s2', rank: 86 };
                if (/s4\s*-\s*s3/i.test(text)) return { key: 's4_to_s3', rank: 84 };
                if (/s5\s*-\s*s4/i.test(text)) return { key: 's5_to_s4', rank: 82 };
                
                // CPR specific patterns
                if (/tc\s*-\s*r1/i.test(text)) return { key: 'tc_to_r1', rank: 76 };
                if (/pp\s*-\s*tc/i.test(text)) return { key: 'pp_to_tc', rank: 74 };
                if (/bc\s*-\s*pp/i.test(text)) return { key: 'bc_to_pp', rank: 72 };
                if (/s1\s*-\s*bc/i.test(text)) return { key: 's1_to_bc', rank: 70 };
                
                // Fibonacci specific patterns
                if (/pp\s*-\s*r1/i.test(text)) return { key: 'pp_to_r1', rank: 66 };
                if (/s1\s*-\s*pp/i.test(text)) return { key: 's1_to_pp', rank: 64 };
                
                // Below patterns
                if (/^below\s+s5/i.test(text)) return { key: 'below_s5', rank: 80 };
                if (/^below\s+s4/i.test(text)) return { key: 'below_s4', rank: 83 };
                if (/^below\s+s3/i.test(text)) return { key: 'below_s3', rank: 68 };
                if (/^below\s+s2/i.test(text)) return { key: 'below_s2', rank: 87 };
                if (/^below\s+s1/i.test(text)) return { key: 'below_s1', rank: 89 };
                
                // Exact level matches (at specific levels)
                if (/\bat\s+r5\b|\br5\b/i.test(text)) return { key: 'at_r5', rank: 99 };
                if (/\bat\s+r4\b|\br4\b/i.test(text)) return { key: 'at_r4', rank: 97 };
                if (/\bat\s+r3\b|\br3\b/i.test(text)) return { key: 'at_r3', rank: 79 };
                if (/\bat\s+r2\b|\br2\b/i.test(text)) return { key: 'at_r2', rank: 95 };
                if (/\bat\s+r1\b|\br1\b/i.test(text)) return { key: 'at_r1', rank: 93 };
                if (/\bat\s+tc\b|\btc\b/i.test(text)) return { key: 'at_tc', rank: 77 };
                if (/\bat\s+pp\b|\bpp\b/i.test(text)) return { key: 'at_pp', rank: 75 };
                if (/\bat\s+bc\b|\bbc\b/i.test(text)) return { key: 'at_bc', rank: 73 };
                if (/\bat\s+s1\b|\bs1\b/i.test(text)) return { key: 'at_s1', rank: 71 };
                if (/\bat\s+s2\b|\bs2\b/i.test(text)) return { key: 'at_s2', rank: 87 };
                if (/\bat\s+s3\b|\bs3\b/i.test(text)) return { key: 'at_s3', rank: 69 };
                if (/\bat\s+s4\b|\bs4\b/i.test(text)) return { key: 'at_s4', rank: 83 };
                if (/\bat\s+s5\b|\bs5\b/i.test(text)) return { key: 'at_s5', rank: 81 };
                
                return { key: 'unknown', rank: 1 };
            }

            // Set range attributes on table row with consistent data attribute naming
            setRowRangeAttrs(row) {
                const rangeCell = row.querySelector('td:nth-child(2)'); // Range is 2nd column
                if (!rangeCell) return;
                
                const rangeText = rangeCell.textContent || rangeCell.innerText || '';
                const { key, rank } = this.parseRangeToKeyAndRank(rangeText);
                
                // Use consistent data attribute names
                row.setAttribute('data-range-key', key);
                row.setAttribute('data-range-rank', rank.toString());
                row.dataset.rangeKey = key;
                row.dataset.rangeRank = rank;
            }

            // Get available range categories for a table (with table-specific options)
            getRangeCategories(tableType) {
                const baseCategories = [
                    { key: 'all', label: 'All Ranges', rank: null },
                    { key: 'above_r3', label: 'Above R3+', rank: 90 },
                    { key: 'between_r1_r3', label: 'R1 to R3', rank: 80 },
                    { key: 'around_pivot', label: 'Around Pivot', rank: 50 },
                    { key: 'between_s1_pivot', label: 'S1 to Pivot', rank: 45 },
                    { key: 'below_s1', label: 'Below S1-', rank: 40 },
                    { key: 'unknown', label: 'Unknown/Other', rank: 1 }
                ];
                
                // Add Fibonacci-specific categories for fibonacci table
                if (tableType === 'fibonacci') {
                    return [
                        ...baseCategories.slice(0, 1), // Keep 'all'
                        { key: 'above_fib_61', label: 'Above 61.8%+', rank: 82 },
                        { key: 'between_fib_38_61', label: '38.2% to 61.8%', rank: 65 },
                        { key: 'around_pivot', label: 'Around Pivot', rank: 50 },
                        { key: 'below_fib_38', label: 'Below 38.2%-', rank: 58 },
                        ...baseCategories.slice(-1) // Keep 'unknown'
                    ];
                }
                
                // Add CPR-specific categories for cpr table
                if (tableType === 'cpr') {
                    return [
                        ...baseCategories.slice(0, 1), // Keep 'all'
                        { key: 'above_r2', label: 'Above R2+', rank: 86 },
                        { key: 'between_r1_r2', label: 'R1 to R2', rank: 83 },
                        { key: 'in_cpr', label: 'In CPR Zone', rank: 50 },
                        { key: 'between_s1_pivot', label: 'S1 to Pivot', rank: 46 },
                        { key: 'below_s2', label: 'Below S2-', rank: 32 },
                        ...baseCategories.slice(-1) // Keep 'unknown'
                    ];
                }
                
                return baseCategories;
            }

            // Apply filter and sort to table
            applyFilterAndSort(tableId) {
                const tbody = document.getElementById(tableId + 'Body');
                if (!tbody) return;
                
                const tableType = tableId.replace('Table', '').toLowerCase();
                const state = this.filterStates[tableType];
                if (!state) return;
                
                const rows = Array.from(tbody.querySelectorAll('tr'));
                
                // Set range attributes for all rows
                rows.forEach(row => this.setRowRangeAttrs(row));
                
                // Filter rows
                rows.forEach(row => {
                    const shouldShow = this.shouldShowRow(row, state.activeRange);
                    row.style.display = shouldShow ? '' : 'none';
                });
                
                // Sort if enabled
                if (state.sortEnabled) {
                    const visibleRows = rows.filter(row => row.style.display !== 'none');
                    visibleRows.sort((a, b) => {
                        const rankA = parseInt(a.dataset.rangeRank || '0');
                        const rankB = parseInt(b.dataset.rangeRank || '0');
                        
                        // Primary sort by range rank (descending - higher resistance first)
                        if (rankA !== rankB) {
                            return rankB - rankA;
                        }
                        
                        // Secondary sort by symbol (ascending alphabetical)
                        const symbolA = a.querySelector('td:first-child')?.textContent?.trim() || '';
                        const symbolB = b.querySelector('td:first-child')?.textContent?.trim() || '';
                        return symbolA.localeCompare(symbolB);
                    });
                    
                    // Reorder in DOM
                    visibleRows.forEach(row => tbody.appendChild(row));
                }
                
                this.saveState();
            }

            // Check if row should be shown based on filter
            shouldShowRow(row, activeRange) {
                if (activeRange === 'all') return true;
                
                const rowRangeKey = row.dataset.rangeKey;
                const rowRank = parseInt(row.dataset.rangeRank || '0');
                
                switch (activeRange) {
                    case 'above_r3':
                        return rowRank >= 90;
                    case 'between_r1_r3':
                        return rowRank >= 78 && rowRank < 90;
                    case 'around_pivot':
                        return rowRank >= 45 && rowRank <= 55;
                    case 'between_s1_pivot':
                        return rowRank >= 40 && rowRank < 50;
                    case 'below_s1':
                        return rowRank < 40;
                    default:
                        return rowRangeKey === activeRange;
                }
            }

            // Throttled apply function using requestAnimationFrame for better performance
            throttledApply(tableId) {
                if (this.throttleTimeouts[tableId]) {
                    cancelAnimationFrame(this.throttleTimeouts[tableId]);
                }
                
                this.throttleTimeouts[tableId] = requestAnimationFrame(() => {
                    // Add small delay to batch multiple updates
                    setTimeout(() => {
                        this.applyFilterAndSort(tableId);
                        delete this.throttleTimeouts[tableId];
                    }, 25); // Reduced from 50ms to 25ms for faster DOM updates
                });
            }

            // Update filter for a table
            setFilter(tableType, rangeKey) {
                if (this.filterStates[tableType]) {
                    this.filterStates[tableType].activeRange = rangeKey;
                    this.applyFilterAndSort(tableType + 'Table');
                    this.updateButtonState(tableType);
                }
            }

            // Toggle sort for a table
            toggleSort(tableType) {
                if (this.filterStates[tableType]) {
                    this.filterStates[tableType].sortEnabled = !this.filterStates[tableType].sortEnabled;
                    this.applyFilterAndSort(tableType + 'Table');
                    this.updateButtonState(tableType);
                }
            }

            // Update button visual state
            updateButtonState(tableType) {
                const button = document.getElementById(`${tableType}RangeFilterBtn`);
                const sortBtn = document.getElementById(`${tableType}RangeSortBtn`);
                
                if (button) {
                    const state = this.filterStates[tableType];
                    const isFiltered = state.activeRange !== 'all';
                    
                    button.className = `btn btn-sm ${isFiltered ? 'btn-warning' : 'btn-outline-warning'}`;
                    
                    // Update button text
                    const activeLabel = state.activeRange === 'all' ? 'Range' : 
                        this.getRangeCategories().find(cat => cat.key === state.activeRange)?.label || 'Filter';
                    button.innerHTML = `<i class="fas fa-filter me-1"></i>${activeLabel}`;
                }
                
                if (sortBtn) {
                    const state = this.filterStates[tableType];
                    sortBtn.className = `btn btn-sm ms-1 ${state.sortEnabled ? 'btn-info' : 'btn-outline-info'}`;
                }
            }

            // Save state to localStorage
            saveState() {
                try {
                    localStorage.setItem('rangeFilterStates', JSON.stringify(this.filterStates));
                } catch (e) {
                    console.warn('Failed to save range filter state:', e);
                }
            }

            // Load state from localStorage
            loadState() {
                try {
                    const saved = localStorage.getItem('rangeFilterStates');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.filterStates = { ...this.filterStates, ...parsed };
                    }
                } catch (e) {
                    console.warn('Failed to load range filter state:', e);
                }
            }

            // Initialize filter for a table type
            initializeTable(tableType) {
                this.updateButtonState(tableType);
                // Apply saved state
                this.throttledApply(tableType + 'Table');
            }
        }
        window.TableHeaderSorter = TableHeaderSorter;
        }

        // Initialize floating browser when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.floatingBrowser = new FloatingBrowser();
        });

        // High/Low Alert System - Now integrated with real-time websocket stream
        class AlertSystem {
            constructor() {
                this.alertContainer = document.getElementById('alertContainer');
                this.activeAlerts = new Set();
                this.alertQueue = [];
                this.isProcessing = false;
                console.log(' Alert System: Initializing for real-time websocket alerts...', this.alertContainer ? 'Found alert container' : 'Alert container NOT found');
                this.init();
            }

            init() {
                if (!this.alertContainer) {
                    console.error(' Alert System: Alert container not found! Cannot start alert system.');
                    return;
                }
                console.log(' Alert System: Ready to receive real-time alerts through websocket stream');
            }

            // Check if market is open (9:15 AM to 3:30 PM IST)
            isMarketOpen() {
                const now = new Date();
                const istTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
                const hours = istTime.getHours();
                const minutes = istTime.getMinutes();
                
                // Market opens at 9:15 AM and closes at 3:30 PM IST
                const marketOpen = 9 * 60 + 15; // 9:15 AM in minutes
                const marketClose = 15 * 60 + 30; // 3:30 PM in minutes
                const currentTime = hours * 60 + minutes;
                
                return currentTime >= marketOpen && currentTime <= marketClose;
            }

            // Process alerts from the main data stream (called by main data polling)
            processAlertsFromStream(alerts) {
                if (alerts && alerts.length > 0) {
                    console.log(' Alert System: Received', alerts.length, 'real-time alerts from stream');
                    
                    // Check if market is open before processing alerts
                    if (!this.isMarketOpen()) {
                        console.log(' Alert System: Market is closed, skipping alerts');
                        return;
                    }
                    
                    alerts.forEach(alert => {
                        this.queueAlert(alert);
                    });
                    this.processQueue();
                }
            }

            queueAlert(alert) {
                // Create unique ID for alert to prevent duplicates
                const alertId = `${alert.symbol}_${alert.type}_${alert.timestamp}`;
                
                if (!this.activeAlerts.has(alertId)) {
                    this.alertQueue.push({...alert, id: alertId});
                    this.activeAlerts.add(alertId);
                }
            }

            async processQueue() {
                if (this.isProcessing || this.alertQueue.length === 0) {
                    return;
                }

                this.isProcessing = true;
                
                // Process all alerts in queue
                while (this.alertQueue.length > 0) {
                    const alert = this.alertQueue.shift();
                    await this.showAlert(alert);
                    // Small delay between alerts - reduced for faster processing
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                this.isProcessing = false;
            }

            async showAlert(alert) {
                // Check if alerts are disabled
                if (!alertsVisible) {
                    console.log(' Alert System: Alerts disabled, skipping alert for', alert.symbol);
                    return;
                }
                
                console.log(' Alert System: Displaying alert for', alert.symbol, alert.type, '' + alert.price.toFixed(2));
                const alertElement = this.createAlertElement(alert);
                this.alertContainer.appendChild(alertElement);
                
                // Show container and trigger slide-in animation
                this.alertContainer.classList.add('show');
                
                // Auto-hide after 2 seconds for faster flow
                setTimeout(() => {
                    this.hideAlert(alertElement, alert.id);
                }, 2000);
            }

            createAlertElement(alert) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `price-alert ${alert.type}`;
                alertDiv.setAttribute('data-alert-id', alert.id);
                
                const isHigh = alert.type === 'high';
                const icon = isHigh ? 'fa-arrow-up' : 'fa-arrow-down';
                const priceKey = isHigh ? 'new_high' : 'new_low';
                const previousKey = isHigh ? 'previous_high' : 'previous_low';
                const priceClass = isHigh ? 'high-price' : 'low-price';
                
                alertDiv.innerHTML = `
                    <div class="alert-single-line">
                        <span class="alert-symbol-small"><i class="fas ${icon} icon ${alert.type}"></i> ${alert.symbol}</span>
                        <span class="alert-ltp">New ${isHigh ? 'High' : 'Low'}: <span class="${priceClass}">${alert.price.toFixed(2)}</span></span>
                    </div>
                `;

                // Click to dismiss
                alertDiv.addEventListener('click', () => {
                    this.hideAlert(alertDiv, alert.id);
                });

                return alertDiv;
            }

            hideAlert(alertElement, alertId) {
                alertElement.classList.add('fadeOut');
                
                setTimeout(() => {
                    if (alertElement.parentNode) {
                        alertElement.parentNode.removeChild(alertElement);
                    }
                    this.activeAlerts.delete(alertId);
                    
                    // Hide container if no more alerts
                    if (this.alertContainer.children.length === 0) {
                        this.alertContainer.classList.remove('show');
                    }
                }, 200);
            }
        }

        // Initialize alert system when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.alertSystem = new AlertSystem();
        });


    </script>
</body>
</html>
