<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MG F&O Stocks Dashboard</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N0J406PHQN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-N0J406PHQN');
    </script>
    
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
    <!-- Cache busting for immediate CSS changes -->
    <style>
        /* Theme Variables */
        :root[data-theme="dark"] {
            --bg-primary: #0a0f14;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #222;
            --bg-card: #111;
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.7);
            --text-muted: rgba(255,255,255,0.5);
            --border-color: #333;
            --scrollbar-track: #111;
            --scrollbar-thumb: #444;
            --scrollbar-thumb-hover: #555;
        }

        :root[data-theme="light"] {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e9ecef;
            --bg-card: #ffffff;
            --text-primary: #000000;
            --text-secondary: rgba(0,0,0,0.7);
            --text-muted: rgba(0,0,0,0.5);
            --border-color: #dee2e6;
            --scrollbar-track: #e9ecef;
            --scrollbar-thumb: #ced4da;
            --scrollbar-thumb-hover: #adb5bd;
        }

        /* Apply theme */
        body {
            background-color: var(--bg-primary) !important;
            color: var(--text-primary) !important;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Override body.text-white in light theme */
        :root[data-theme="light"] body,
        :root[data-theme="light"] body.text-white {
            background: #f5f5f5 !important;
            color: #000 !important;
        }

        :root[data-theme="light"] body[style*="background"] {
            background: #f5f5f5 !important;
        }

        .container-fluid, .container, .main-content {
            background-color: transparent !important;
        }

        .card {
            background-color: var(--bg-card) !important;
            border-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        .card-header {
            background-color: var(--bg-secondary) !important;
            border-bottom-color: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        .card-body {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }

        .navbar {
            background-color: var(--bg-secondary) !important;
        }

        .table {
            color: var(--text-primary) !important;
        }

        .table thead th {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
        }

        .table tbody tr {
            background-color: var(--bg-card) !important;
        }

        .table tbody tr:hover {
            background-color: var(--bg-tertiary) !important;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 4px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background-color: var(--bg-tertiary);
        }

        /* Modal styling for themes */
        .modal-content {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
        }

        .modal-header {
            background-color: var(--bg-secondary) !important;
            border-bottom-color: var(--border-color) !important;
        }

        .modal-body {
            background-color: var(--bg-card) !important;
        }

        .modal-footer {
            background-color: var(--bg-secondary) !important;
            border-top-color: var(--border-color) !important;
        }

        /* Badge and text colors for light theme */
        :root[data-theme="light"] .badge {
            color: #fff !important;
        }

        :root[data-theme="light"] .text-white {
            color: #000 !important;
        }

        :root[data-theme="light"] .text-muted {
            color: var(--text-muted) !important;
        }

        /* Ensure all text in light theme is visible */
        :root[data-theme="light"] .card-body,
        :root[data-theme="light"] .card-title,
        :root[data-theme="light"] .card-text,
        :root[data-theme="light"] h1, 
        :root[data-theme="light"] h2, 
        :root[data-theme="light"] h3, 
        :root[data-theme="light"] h4, 
        :root[data-theme="light"] h5, 
        :root[data-theme="light"] h6,
        :root[data-theme="light"] p,
        :root[data-theme="light"] span:not(.badge):not(.text-success):not(.text-danger):not(.text-warning):not(.text-info),
        :root[data-theme="light"] div:not(.badge):not(.text-success):not(.text-danger):not(.text-warning):not(.text-info) {
            color: #000 !important;
        }

        /* Section titles and headers outside cards */
        :root[data-theme="light"] .container h1,
        :root[data-theme="light"] .container h2,
        :root[data-theme="light"] .container h3,
        :root[data-theme="light"] .container h4,
        :root[data-theme="light"] .container h5,
        :root[data-theme="light"] .container h6,
        :root[data-theme="light"] .row h1,
        :root[data-theme="light"] .row h2,
        :root[data-theme="light"] .row h3,
        :root[data-theme="light"] .row h4,
        :root[data-theme="light"] .row h5,
        :root[data-theme="light"] .row h6 {
            color: #000 !important;
        }

        /* Override any white text classes outside cards */
        :root[data-theme="light"] .text-white:not(.card *):not(.card-header *):not(.badge) {
            color: #000 !important;
        }

        /* Make sure all page headings are visible */
        :root[data-theme="light"] h1.text-white,
        :root[data-theme="light"] h2.text-white,
        :root[data-theme="light"] h3.text-white,
        :root[data-theme="light"] h4.text-white,
        :root[data-theme="light"] h5.text-white,
        :root[data-theme="light"] h6.text-white {
            color: #000 !important;
        }

        /* Button icons and text */
        :root[data-theme="light"] .btn i,
        :root[data-theme="light"] button i {
            color: inherit !important;
        }

        /* Tab navigation and buttons */
        :root[data-theme="light"] .nav-tabs .nav-link {
            color: #000 !important;
            background-color: #f0f0f0 !important;
        }

        :root[data-theme="light"] .nav-tabs .nav-link.active {
            background-color: #fff !important;
            color: #000 !important;
            border-color: #dee2e6 #dee2e6 #fff !important;
        }

        /* All buttons in light theme - COMPREHENSIVE FIX */
        :root[data-theme="light"] .btn,
        :root[data-theme="light"] button {
            color: #000 !important;
        }

        /* Solid colored buttons get white text */
        :root[data-theme="light"] .btn-primary,
        :root[data-theme="light"] .btn-primary *,
        :root[data-theme="light"] button.btn-primary,
        :root[data-theme="light"] button.btn-primary * {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
            color: #fff !important;
        }

        :root[data-theme="light"] .btn-danger,
        :root[data-theme="light"] .btn-danger * {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: #fff !important;
        }

        :root[data-theme="light"] .btn-success,
        :root[data-theme="light"] .btn-success * {
            background-color: #198754 !important;
            border-color: #198754 !important;
            color: #fff !important;
        }

        :root[data-theme="light"] .btn-warning,
        :root[data-theme="light"] .btn-warning * {
            background-color: #ffc107 !important;
            border-color: #ffc107 !important;
            color: #000 !important;
        }

        :root[data-theme="light"] .btn-secondary,
        :root[data-theme="light"] .btn-secondary * {
            background-color: #6c757d !important;
            border-color: #6c757d !important;
            color: #fff !important;
        }

        :root[data-theme="light"] .btn-info,
        :root[data-theme="light"] .btn-info *,
        :root[data-theme="light"] button.btn-info,
        :root[data-theme="light"] button.btn-info * {
            background-color: #0dcaf0 !important;
            border-color: #0dcaf0 !important;
            color: #000 !important;
        }

        /* Outline buttons get dark borders and text */
        :root[data-theme="light"] .btn-outline-primary,
        :root[data-theme="light"] .btn-outline-primary *,
        :root[data-theme="light"] button.btn-outline-primary,
        :root[data-theme="light"] button.btn-outline-primary * {
            border: 2px solid #0d6efd !important;
            color: #0d6efd !important;
            background-color: transparent !important;
        }
        
        /* Remove borders ONLY from navbar buttons */
        :root[data-theme="light"] .navbar .btn-outline-primary {
            border: none !important;
        }

        :root[data-theme="light"] .btn-outline-primary:hover {
            background-color: #0d6efd !important;
            color: #fff !important;
        }

        :root[data-theme="light"] .btn-outline-secondary,
        :root[data-theme="light"] .btn-outline-secondary *,
        :root[data-theme="light"] button.btn-outline-secondary,
        :root[data-theme="light"] button.btn-outline-secondary * {
            border: 2px solid #6c757d !important;
            color: #000 !important;
            background-color: transparent !important;
        }
        
        /* Remove borders ONLY from navbar buttons */
        :root[data-theme="light"] .navbar .btn-outline-secondary {
            border: none !important;
        }

        :root[data-theme="light"] .btn-outline-secondary:hover {
            background-color: #6c757d !important;
            color: #fff !important;
        }

        :root[data-theme="light"] .btn-outline-danger,
        :root[data-theme="light"] .btn-outline-danger * {
            border: 2px solid #dc3545 !important;
            color: #dc3545 !important;
            background-color: transparent !important;
        }

        :root[data-theme="light"] .btn-outline-success,
        :root[data-theme="light"] .btn-outline-success * {
            border: 2px solid #198754 !important;
            color: #198754 !important;
            background-color: transparent !important;
        }

        :root[data-theme="light"] .btn-outline-warning,
        :root[data-theme="light"] .btn-outline-warning * {
            border: 2px solid #ffc107 !important;
            color: #000 !important;
            background-color: transparent !important;
        }

        :root[data-theme="light"] .btn-outline-info,
        :root[data-theme="light"] .btn-outline-info *,
        :root[data-theme="light"] button.btn-outline-info,
        :root[data-theme="light"] button.btn-outline-info * {
            border: 2px solid #0dcaf0 !important;
            color: #0dcaf0 !important;
            background-color: transparent !important;
        }
        
        /* Remove borders ONLY from navbar buttons */
        :root[data-theme="light"] .navbar .btn-outline-danger,
        :root[data-theme="light"] .navbar .btn-outline-success {
            border: none !important;
        }

        :root[data-theme="light"] .btn-outline-info:hover {
            background-color: #0dcaf0 !important;
            color: #000 !important;
        }

        /* Tab buttons specifically */
        :root[data-theme="light"] .nav-tabs .btn,
        :root[data-theme="light"] .nav-tabs button {
            color: #000 !important;
        }

        /* Navbar icon buttons in light theme - NO BORDERS */
        :root[data-theme="light"] .navbar .btn-outline-warning,
        :root[data-theme="light"] .navbar .btn-outline-info,
        :root[data-theme="light"] .navbar .btn-outline-light,
        :root[data-theme="light"] .navbar button.btn-outline-warning,
        :root[data-theme="light"] .navbar button.btn-outline-info,
        :root[data-theme="light"] .navbar button.btn-outline-light {
            border: none !important;
            color: #000 !important;
            background-color: transparent !important;
        }

        :root[data-theme="light"] .navbar .btn-outline-warning i,
        :root[data-theme="light"] .navbar .btn-outline-info i,
        :root[data-theme="light"] .navbar .btn-outline-light i,
        :root[data-theme="light"] .navbar .btn-outline-warning .fa-bell,
        :root[data-theme="light"] .navbar .btn-outline-info .fa-question-circle,
        :root[data-theme="light"] .navbar button i {
            color: #000 !important;
            opacity: 1 !important;
        }

        :root[data-theme="light"] .navbar .btn-outline-warning:hover,
        :root[data-theme="light"] .navbar .btn-outline-info:hover,
        :root[data-theme="light"] .navbar .btn-outline-light:hover {
            background-color: #f8f9fa !important;
            border: 2px solid #000 !important;
            color: #000 !important;
        }

        /* Theme toggle button in light theme - SUPER FORCEFUL */
        :root[data-theme="light"] .theme-toggle,
        :root[data-theme="light"] button.theme-toggle {
            border: 2px solid #000 !important;
            color: #000 !important;
            background-color: transparent !important;
        }

        :root[data-theme="light"] .theme-toggle i,
        :root[data-theme="light"] .theme-toggle .fa-sun,
        :root[data-theme="light"] .theme-toggle .fa-moon {
            color: #000 !important;
            opacity: 1 !important;
        }

        :root[data-theme="light"] .theme-toggle:hover {
            background-color: #f8f9fa !important;
        }

        /* Hamburger menu icon in light theme - SUPER FORCEFUL */
        :root[data-theme="light"] .hamburger-icon span {
            background-color: #000 !important;
            opacity: 1 !important;
        }

        :root[data-theme="light"] .navbar .btn-outline-light {
            border: 2px solid #000 !important;
        }

        /* Navbar itself in light theme */
        :root[data-theme="light"] .navbar,
        :root[data-theme="light"] .navbar.navbar-dark,
        :root[data-theme="light"] .navbar.bg-dark {
            background-color: #ffffff !important;
            border-bottom: 1px solid #dee2e6 !important;
        }

        :root[data-theme="light"] .navbar-brand,
        :root[data-theme="light"] .navbar-title {
            color: #000 !important;
        }

        /* Section titles and headings in light theme */
        :root[data-theme="light"] h1,
        :root[data-theme="light"] h2,
        :root[data-theme="light"] h3,
        :root[data-theme="light"] h4,
        :root[data-theme="light"] h5,
        :root[data-theme="light"] h6,
        :root[data-theme="light"] .text-white,
        :root[data-theme="light"] h1.text-white,
        :root[data-theme="light"] h2.text-white,
        :root[data-theme="light"] h3.text-white,
        :root[data-theme="light"] h4.text-white,
        :root[data-theme="light"] h5.text-white,
        :root[data-theme="light"] h6.text-white {
            color: #000 !important;
        }

        /* Icons in headings should also be visible */
        :root[data-theme="light"] h1 i,
        :root[data-theme="light"] h2 i,
        :root[data-theme="light"] h3 i,
        :root[data-theme="light"] h4 i,
        :root[data-theme="light"] h5 i,
        :root[data-theme="light"] h6 i {
            color: #000 !important;
        }

        /* Muted text in light theme */
        :root[data-theme="light"] .text-muted,
        :root[data-theme="light"] small.text-muted {
            color: #6c757d !important;
        }

        /* Force ALL text-white elements to be black in light theme */
        :root[data-theme="light"] *[class*="text-white"],
        :root[data-theme="light"] .text-white *,
        :root[data-theme="light"] h6[class*="text-white"],
        :root[data-theme="light"] h5[class*="text-white"],
        :root[data-theme="light"] h4[class*="text-white"] {
            color: #000 !important;
        }

        /* Parent divs of section titles */
        :root[data-theme="light"] .mb-2,
        :root[data-theme="light"] .mt-4 {
            background-color: transparent !important;
        }

        /* Table backgrounds and text visibility in light theme */
        :root[data-theme="light"] .table {
            background-color: #fff !important;
            color: #000 !important;
        }

        :root[data-theme="light"] .table td,
        :root[data-theme="light"] .table th {
            color: #000 !important;
            background-color: #fff !important;
        }

        :root[data-theme="light"] .table tbody tr {
            background-color: #fff !important;
        }

        :root[data-theme="light"] .table tbody tr:hover {
            background-color: #f5f5f5 !important;
        }

        /* Table headers should be visible */
        :root[data-theme="light"] .table thead,
        :root[data-theme="light"] .table thead th {
            background-color: #e5e7eb !important;
            color: #000 !important;
        }

        /* Override any text color classes in table headers */
        :root[data-theme="light"] .table thead th.text-white,
        :root[data-theme="light"] .table thead .text-white,
        :root[data-theme="light"] .table th.text-white {
            color: #000 !important;
        }

        /* Technical indicator tables - preserve color coding */
        :root[data-theme="light"] .table .text-success {
            color: #16a34a !important;
        }

        :root[data-theme="light"] .table .text-danger {
            color: #dc2626 !important;
        }

        /* Badge colors in tables should stay */
        :root[data-theme="light"] .table .badge {
            color: #fff !important;
        }

        /* Override any dark table backgrounds */
        :root[data-theme="light"] .table-dark,
        :root[data-theme="light"] .bg-dark,
        :root[data-theme="light"] .table.bg-dark,
        :root[data-theme="light"] .table-dark td,
        :root[data-theme="light"] .table-dark th {
            background-color: #fff !important;
            color: #000 !important;
        }

        /* Stock list text in light theme */
        :root[data-theme="light"] .stock-item,
        :root[data-theme="light"] .stock-name,
        :root[data-theme="light"] .stock-price,
        :root[data-theme="light"] .rvol-stock-row {
            color: #000 !important;
        }

        /* RVOL symbols and values visibility in light theme */
        :root[data-theme="light"] .rvol-symbol,
        :root[data-theme="light"] .rvol-value,
        :root[data-theme="light"] .rvol-data,
        :root[data-theme="light"] .rvol-data span {
            color: #000 !important;
        }


        /* Index cards text in light theme - only stock names, not values */
        :root[data-theme="light"] .index-card.text-white {
            color: #000 !important;
        }

        :root[data-theme="light"] .index-card h5,
        :root[data-theme="light"] .index-card h6 {
            color: #000 !important;
        }

        :root[data-theme="light"] .index-card small:not(.text-success):not(.text-danger) {
            color: #333 !important;
        }

        /* Price action cards - only card names, preserve value colors */
        :root[data-theme="light"] .price-action-container .card h5,
        :root[data-theme="light"] .price-action-container .card h6 {
            color: #000 !important;
        }

        :root[data-theme="light"] .price-action-container .card small:not(.text-success):not(.text-danger):not(.text-warning) {
            color: #333 !important;
        }

        /* Section titles and headings in light theme */
        :root[data-theme="light"] .card-header h1,
        :root[data-theme="light"] .card-header h2,
        :root[data-theme="light"] .card-header h3,
        :root[data-theme="light"] .card-header h4,
        :root[data-theme="light"] .card-header h5,
        :root[data-theme="light"] .card-header h6 {
            color: #000 !important;
        }

        /* Section cards with dark inline backgrounds - keep text light and visible */
        :root[data-theme="light"] .card-header[style*="background"] .text-info,
        :root[data-theme="light"] .card-header[style*="gradient"] .text-info,
        :root[data-theme="light"] .section-3d-border .card-header .text-info {
            color: #17a2b8 !important; /* Bright cyan for dark backgrounds */
        }

        :root[data-theme="light"] .card-header[style*="background"] .text-warning,
        :root[data-theme="light"] .section-3d-border .card-header .text-warning {
            color: #ffc107 !important; /* Bright yellow for dark backgrounds */
        }

        :root[data-theme="light"] .card-header[style*="background"] .text-primary,
        :root[data-theme="light"] .section-3d-border .card-header .text-primary {
            color: #60a5fa !important; /* Bright blue for dark backgrounds */
        }

        /* Card headers with dark backgrounds - all text should be light */
        :root[data-theme="light"] .card-header[style*="background"],
        :root[data-theme="light"] .card-header[style*="gradient"] {
            color: #fff !important;
        }

        /* Stocks in Action section titles */
        :root[data-theme="light"] .stocks-in-action-container h6 {
            color: #000 !important;
        }

        /* Chart labels and info text in light theme */
        :root[data-theme="light"] .text-muted,
        :root[data-theme="light"] #chartStatus,
        :root[data-theme="light"] #chartInfo,
        :root[data-theme="light"] #chartVolume,
        :root[data-theme="light"] [id^="chartStatus_"],
        :root[data-theme="light"] [id^="chartInfo_"],
        :root[data-theme="light"] [id^="chartVolume_"] {
            color: #666 !important;
        }

        /* Index bar chart labels in light theme */
        :root[data-theme="light"] canvas {
            color: #000 !important;
        }

        /* All text elements that might be using Bootstrap text utilities */
        :root[data-theme="light"] .text-light {
            color: #000 !important;
        }

        :root[data-theme="light"] .text-secondary {
            color: #666 !important;
        }

        /* Alert symbols and titles */
        :root[data-theme="light"] .alert-symbol-small,
        :root[data-theme="light"] .alert-ltp {
            color: #000 !important;
        }

        /* Alert containers and boxes in light theme */
        :root[data-theme="light"] .alert,
        :root[data-theme="light"] .alert-dismissible,
        :root[data-theme="light"] #alertsContainer,
        :root[data-theme="light"] #alertsContainer .alert {
            background-color: #fff !important;
            color: #000 !important;
            border: 1px solid #dee2e6 !important;
        }

        :root[data-theme="light"] .alert-success {
            background-color: #d1fae5 !important;
            color: #065f46 !important;
            border-color: #10b981 !important;
        }

        :root[data-theme="light"] .alert-danger {
            background-color: #fee2e2 !important;
            color: #991b1b !important;
            border-color: #ef4444 !important;
        }

        :root[data-theme="light"] .alert-warning {
            background-color: #fef3c7 !important;
            color: #92400e !important;
            border-color: #f59e0b !important;
        }

        :root[data-theme="light"] .alert-info {
            background-color: #dbeafe !important;
            color: #1e40af !important;
            border-color: #3b82f6 !important;
        }

        /* Specific text classes - maintain semantic colors in light theme */
        :root[data-theme="light"] .text-warning {
            color: #d97706 !important;
        }
        
        :root[data-theme="light"] .text-info {
            color: #0369a1 !important;
        }
        
        :root[data-theme="light"] .text-success {
            color: #16a34a !important; /* Keep green for positive values */
        }
        
        :root[data-theme="light"] .text-danger {
            color: #dc2626 !important; /* Keep red for negative values */
        }
        
        :root[data-theme="light"] .text-primary {
            color: #2563eb !important;
        }

        /* Preserve color logic for percentage changes - override the black text rule */
        :root[data-theme="light"] .text-success,
        :root[data-theme="light"] .index-card .text-success,
        :root[data-theme="light"] .price-action-container .text-success {
            color: #16a34a !important; /* Green stays green */
        }

        :root[data-theme="light"] .text-danger,
        :root[data-theme="light"] .index-card .text-danger,
        :root[data-theme="light"] .price-action-container .text-danger {
            color: #dc2626 !important; /* Red stays red */
        }

        /* Labels and small text in light theme */
        :root[data-theme="light"] label,
        :root[data-theme="light"] small,
        :root[data-theme="light"] .small,
        :root[data-theme="light"] .form-label,
        :root[data-theme="light"] .form-text {
            color: #333 !important;
        }

        /* List group items in light theme */
        :root[data-theme="light"] .list-group-item {
            background-color: var(--bg-card) !important;
            color: #000 !important;
            border-color: var(--border-color) !important;
        }

        /* Ensure dropdown menus are visible in light theme */
        :root[data-theme="light"] .dropdown-menu {
            background-color: #fff !important;
            color: #000 !important;
        }

        :root[data-theme="light"] .dropdown-item {
            color: #000 !important;
        }

        :root[data-theme="light"] .dropdown-item:hover {
            background-color: #f0f0f0 !important;
        }

        /* Form controls */
        .form-control, .form-select {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        .form-control:focus, .form-select:focus {
            background-color: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        /* RVOL Table Styling */
        .rvol-table-container {
            font-size: 0.65rem;
            color: var(--text-primary);
        }

        /* Progress Bar Style Scrollers for RVOL Tables */
        .card-body::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        .card-body::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 2px;
        }

        .card-body::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 2px;
        }

        .card-body::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        /* For different RVOL categories - different colored scrollers */
        .rvol-table-container::-webkit-scrollbar {
            width: 3px;
        }

        .rvol-table-container::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 2px;
        }

        .rvol-table-container::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 2px;
        }

        /* Mobile scrollbars - tiny with dark blue */
        @media (max-width: 767.98px) {
            *::-webkit-scrollbar {
                width: 3px !important;
                height: 3px !important;
            }

            *::-webkit-scrollbar-track {
                background: #0a0f14 !important;
                border-radius: 1px !important;
            }

            *::-webkit-scrollbar-thumb {
                background: #1e3a5f !important;
                border-radius: 1px !important;
            }

            *::-webkit-scrollbar-thumb:hover {
                background: #2a4d7f !important;
            }

            /* Firefox scrollbar for mobile */
            * {
                scrollbar-width: thin !important;
                scrollbar-color: #1e3a5f #0a0f14 !important;
            }
        }

        .rvol-stock-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 6px;
            margin-bottom: 2px;
            border-radius: 4px;
            background: var(--bg-secondary);
            border-left: 3px solid;
            transition: background 0.2s ease;
        }

        .rvol-stock-row:hover {
            background: var(--bg-tertiary);
        }

        /* Horizontal scrolling for levels scan cards - Mobile only */
        .levels-scroll-container {
            /* Default: allow normal flexbox behavior on desktop */
        }

        /* Mobile only: enable horizontal scrolling */
        @media (max-width: 767.98px) {
            .levels-scroll-container {
                overflow-x: auto;
                overflow-y: hidden;
                scrollbar-width: thin;
                scrollbar-color: #444 #111;
                padding-bottom: 8px;
            }
        }

        .levels-scroll-container::-webkit-scrollbar {
            height: 6px;
        }

        .levels-scroll-container::-webkit-scrollbar-track {
            background: #111;
            border-radius: 3px;
        }

        .levels-scroll-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .levels-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Levels cards - responsive behavior */
        .levels-card-item {
            /* Desktop: allow normal flex behavior */
        }

        /* Mobile only: fixed width for horizontal scrolling */
        @media (max-width: 767.98px) {
            .levels-card-item {
                min-width: 200px;
                flex-shrink: 0;
            }

            .levels-scroll-container .d-flex {
                flex-wrap: nowrap !important;
            }
        }

        /* Desktop: cards fill full width */
        @media (min-width: 768px) {
            .levels-scroll-container {
                display: flex !important;
                flex-wrap: nowrap !important;
                gap: 0.5rem;
                width: 100%;
            }

            .levels-scroll-container .levels-card-item {
                flex: 1 !important;
                min-width: 0 !important;
                flex-shrink: 1 !important;
            }

            /* Override inline styles - remove fixed widths on desktop */
            .levels-scroll-container .card {
                width: 100% !important;
                height: auto !important;
            }

            /* Ensure no flex-shrink-0 on desktop */
            .levels-scroll-container .flex-shrink-0 {
                flex-shrink: 1 !important;
            }
        }

        /* 3D border effect for section cards */
        .section-3d-border {
            border: 3px solid var(--bg-secondary) !important;
            box-shadow: 
                inset 2px 2px 4px rgba(255, 255, 255, 0.05),
                inset -2px -2px 4px rgba(0, 0, 0, 0.3),
                4px 4px 8px rgba(0, 0, 0, 0.2) !important;
        }
        
        :root[data-theme="dark"] .section-3d-border {
            box-shadow: 
                inset 2px 2px 4px rgba(255, 255, 255, 0.05),
                inset -2px -2px 4px rgba(0, 0, 0, 0.8),
                4px 4px 8px rgba(0, 0, 0, 0.6) !important;
        }

        /* Index Analysis Charts - Larger font for mobile */
        @media (max-width: 767.98px) {
            #indexChangeChart, #indexOpenChart, #indexHighChart, #indexLowChart {
                font-size: 14px !important;
            }
        }

        /* Score color classes - Green for positive, Red for negative */
        .score-15 { background: linear-gradient(135deg, #006400, #008000); color: #fff; }
        .score-14 { background: linear-gradient(135deg, #007000, #009000); color: #fff; }
        .score-13 { background: linear-gradient(135deg, #008000, #00a000); color: #fff; }
        .score-12 { background: linear-gradient(135deg, #009000, #00b000); color: #fff; }
        .score-11 { background: linear-gradient(135deg, #00a000, #00c000); color: #fff; }
        .score-10 { background: linear-gradient(135deg, #00b000, #00d000); color: #fff; }
        .score-9 { background: linear-gradient(135deg, #00c000, #00e000); color: #000; }
        .score-8 { background: linear-gradient(135deg, #00d000, #00f000); color: #000; }
        .score-7 { background: linear-gradient(135deg, #10e000, #20ff00); color: #000; }
        .score-6 { background: linear-gradient(135deg, #20f000, #40ff00); color: #000; }
        .score-5 { background: linear-gradient(135deg, #40ff00, #60ff00); color: #000; }
        .score-4 { background: linear-gradient(135deg, #60ff20, #80ff40); color: #000; }
        .score-3 { background: linear-gradient(135deg, #80ff40, #a0ff60); color: #000; }
        .score-2 { background: linear-gradient(135deg, #a0ff60, #c0ff80); color: #000; }
        .score-1 { background: linear-gradient(135deg, #c0ff80, #e0ffa0); color: #000; }
        .score-0 { background: linear-gradient(135deg, #666, #888); color: #fff; }
        .score-neg-1 { background: linear-gradient(135deg, #e0a0a0, #ffc0c0); color: #000; }
        .score-neg-2 { background: linear-gradient(135deg, #c08080, #ffa0a0); color: #000; }
        .score-neg-3 { background: linear-gradient(135deg, #a06060, #ff8080); color: #000; }
        .score-neg-4 { background: linear-gradient(135deg, #804040, #ff6060); color: #000; }
        .score-neg-5 { background: linear-gradient(135deg, #602020, #ff4040); color: #fff; }
        .score-neg-6 { background: linear-gradient(135deg, #400000, #ff2020); color: #fff; }
        .score-neg-7 { background: linear-gradient(135deg, #200000, #ff0000); color: #fff; }
        .score-neg-8 { background: linear-gradient(135deg, #000000, #f00000); color: #fff; }
        .score-neg-9 { background: linear-gradient(135deg, #000000, #e00000); color: #fff; }
        .score-neg-10 { background: linear-gradient(135deg, #000000, #d00000); color: #fff; }
        .score-neg-11 { background: linear-gradient(135deg, #000000, #c00000); color: #fff; }
        .score-neg-12 { background: linear-gradient(135deg, #000000, #b00000); color: #fff; }
        .score-neg-13 { background: linear-gradient(135deg, #000000, #a00000); color: #fff; }
        .score-neg-14 { background: linear-gradient(135deg, #000000, #900000); color: #fff; }
        .score-neg-15 { background: linear-gradient(135deg, #000000, #800000); color: #fff; }
        .score-na { background: linear-gradient(135deg, #333, #444); color: #888; }

        /* AI Scores Section - Top & Bottom Performers */
        .ai-scores-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
        }
        
        .ai-scores-scroll-container::-webkit-scrollbar {
            height: 6px;
        }
        
        .ai-scores-scroll-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .ai-scores-scroll-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        .ai-scores-scroll-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .ai-score-card {
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .ai-score-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .ai-score-card-bullish {
            background: linear-gradient(135deg, rgba(0, 100, 0, 0.3), rgba(0, 150, 0, 0.4));
            border-color: rgba(0, 255, 0, 0.3);
        }

        .ai-score-card-bullish:hover {
            background: linear-gradient(135deg, rgba(0, 120, 0, 0.4), rgba(0, 180, 0, 0.5));
            border-color: rgba(0, 255, 0, 0.5);
        }

        .ai-score-card-bearish {
            background: linear-gradient(135deg, rgba(150, 0, 0, 0.3), rgba(200, 0, 0, 0.4));
            border-color: rgba(255, 0, 0, 0.3);
        }

        .ai-score-card-bearish:hover {
            background: linear-gradient(135deg, rgba(180, 0, 0, 0.4), rgba(230, 0, 0, 0.5));
            border-color: rgba(255, 0, 0, 0.5);
        }

        .ai-score-symbol {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }

        .ai-score-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .ai-score-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .ai-score-badge-bullish {
            background: linear-gradient(135deg, #00ff00, #00cc00);
            color: #000;
        }

        .ai-score-badge-bearish {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            color: #fff;
        }

        .ai-score-details {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.7);
            margin-top: 6px;
            line-height: 1.3;
        }

        /* Desktop: show all 10 cards in a single scrollable row */
        @media (min-width: 768px) {
            /* Hide section headings on desktop */
            #aiScoresSectionContainer > div > h6 {
                display: none;
            }
            
            /* Make the card body a flex container to align both sections in one row */
            #aiScoresSectionContainer {
                display: flex;
                gap: 0;
            }
            
            #aiScoresSectionContainer > div {
                margin-bottom: 0 !important;
                flex: 1;
            }
            
            .ai-scores-scroll-container .d-flex {
                flex-wrap: nowrap;
                justify-content: flex-start;
                gap: 0.5rem !important;
            }
            
            .ai-score-card {
                flex: 0 0 auto;
                width: calc(7.14% - 0.5rem);
                min-width: 110px;
            }
            
            .ai-score-symbol {
                font-size: 0.65rem;
                font-weight: bold;
            }
            
            .ai-score-value {
                font-size: 0.9rem;
            }
            
            .ai-score-badge {
                font-size: 0.5rem;
                padding: 1px 4px;
            }
            
            .ai-score-details {
                font-size: 0.5rem;
                line-height: 1.2;
            }
        }

        /* Mobile: horizontal scrollable rows - one for bullish, one for bearish */
        @media (max-width: 767.98px) {
            .ai-scores-scroll-container .d-flex {
                flex-wrap: nowrap;
                justify-content: flex-start;
                gap: 0.5rem !important;
            }
            
            .ai-score-card {
                flex: 0 0 auto;
                width: 160px;
                min-width: 160px;
                padding: 8px;
            }
            
            .ai-score-symbol {
                font-size: 0.7rem;
                font-weight: bold;
            }
            
            .ai-score-value {
                font-size: 1rem;
            }
            
            .ai-score-badge {
                font-size: 0.6rem;
                padding: 2px 4px;
            }
            
            .ai-score-details {
                font-size: 0.65rem;
                line-height: 1.3;
            }
        }

        /* RVOL Section - Special mobile behavior: all 3 cards in one row */
        @media (max-width: 767.98px) {
            #rvol-analysis .levels-scroll-container {
                overflow-x: visible !important;
                display: flex !important;
                gap: 0.25rem !important;
            }

            #rvol-analysis .levels-card-item {
                flex: 1 !important;
                min-width: 0 !important;
                flex-shrink: 1 !important;
            }

            #rvol-analysis .levels-scroll-container .card {
                width: 100% !important;
            }

            #rvol-analysis .flex-shrink-0 {
                flex-shrink: 1 !important;
            }
        }

        /* LEVELS SCAN Section - Special mobile behavior: 4 cards in one row without scroll */
        @media (max-width: 767.98px) {
            #levels-scan .levels-scroll-container {
                overflow-x: visible !important;
                display: flex !important;
                gap: 0.25rem !important;
                flex-wrap: nowrap !important;
            }

            #levels-scan .levels-card-item {
                flex: 1 !important;
                min-width: 0 !important;
                flex-shrink: 1 !important;
            }

            #levels-scan .levels-scroll-container .card {
                width: 100% !important;
            }

            #levels-scan .flex-shrink-0 {
                flex-shrink: 1 !important;
            }

            /* Smaller fonts for LEVELS SCAN cards on mobile */
            #levels-scan .card-header h6 {
                font-size: 0.55rem !important;
            }

            #levels-scan .card-header small {
                font-size: 0.45rem !important;
            }

            #levels-scan h6.text-warning,
            #levels-scan h6.text-success,
            #levels-scan h6.text-primary {
                font-size: 0.6rem !important;
            }

            #levels-scan .rvol-symbol {
                font-size: 0.45rem !important;
            }

            #levels-scan .rvol-data span {
                font-size: 0.4rem !important;
            }
        }

        /* LEVELS SCAN Section - Desktop: all 12 cards in single row */
        @media (min-width: 768px) {
            /* Make parent container flex to hold all 3 rows inline */
            #levels-scan .card-body.py-2 {
                display: flex !important;
                gap: 0.5rem;
                flex-wrap: nowrap !important;
            }

            /* Each row (CPR, Camarilla, Fibonacci) becomes a flex container */
            #levels-scan .row.mb-3 {
                flex: 1 !important;
                margin-bottom: 0 !important;
                min-width: 0 !important;
                padding: 0.5rem;
                border-radius: 8px;
            }

            /* Border colors for each section */
            #levels-scan .row.mb-3:nth-child(1) {
                border: 2px solid #ffc107 !important; /* Yellow border for CPR */
            }

            #levels-scan .row.mb-3:nth-child(2) {
                border: 2px solid #28a745 !important; /* Green border for CAMARILLA */
            }

            #levels-scan .row.mb-3:nth-child(3) {
                border: 2px solid #17a2b8 !important; /* Cyan border for FIBONACCI */
            }

            #levels-scan .col-12 {
                padding: 0 !important;
            }

            /* Category titles styling - same size as card titles */
            #levels-scan h6.text-warning,
            #levels-scan h6.text-success,
            #levels-scan h6.text-primary {
                font-size: 0.7rem !important;
                margin-bottom: 0.25rem !important;
                text-align: center;
            }

            /* Card header titles - same size as category titles */
            #levels-scan .card-header h6 {
                font-size: 0.7rem !important;
            }

            #levels-scan .levels-scroll-container {
                display: flex !important;
                flex-wrap: nowrap !important;
                gap: 0.5rem;
                width: 100%;
                overflow-x: visible !important;
            }

            #levels-scan .levels-card-item {
                flex: 1 !important;
                min-width: 0 !important;
                flex-shrink: 1 !important;
            }

            #levels-scan .levels-scroll-container .card {
                width: 100% !important;
                height: auto !important;
            }

            #levels-scan .flex-shrink-0 {
                flex-shrink: 1 !important;
            }
        }

        /* Price Action Container - Responsive with mobile horizontal scroll */
        .price-action-container {
            /* Default: use normal Bootstrap grid layout */
        }

        /* Mobile only: enable horizontal scrolling */
        @media (max-width: 767.98px) {
            .price-action-container {
                overflow-x: auto;
                overflow-y: hidden;
                scrollbar-width: thin;
                scrollbar-color: #444 #111;
                padding-bottom: 8px;
            }

            .price-action-container .row {
                display: flex !important;
                flex-wrap: nowrap !important;
                gap: 0.5rem;
                min-width: fit-content;
            }

            .price-action-container .col-6,
            .price-action-container .col-md-4,
            .price-action-container .col-xl-2 {
                flex: 0 0 auto !important;
                min-width: 180px !important;
                width: 180px !important;
            }
        }

        /* Desktop: 5 cards per row */
        @media (min-width: 768px) {
            .price-action-container .row {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .price-action-container .col-6,
            .price-action-container .col-md-4,
            .price-action-container .col-xl-2 {
                flex: 0 0 calc(20% - 0.4rem);
                width: calc(20% - 0.4rem);
                max-width: calc(20% - 0.4rem);
            }
        }

        /* Stocks in Action - Responsive Grid Layout */
        .stocks-in-action-container {
            width: 100%;
        }

        /* Desktop: Grid layout - 5 cards per row */
        @media (min-width: 768px) {
            .stocks-in-action-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 0.75rem;
                width: 100%;
            }
        }
        
        /* Tablet: 3 cards per row */
        @media (min-width: 768px) and (max-width: 1199px) {
            .stocks-in-action-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Mobile: Horizontal scroll */
        @media (max-width: 767.98px) {
            .stocks-in-action-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
                scrollbar-color: #444 #111;
                padding-bottom: 8px;
            }

            .stocks-in-action-grid {
                display: flex;
                gap: 0.75rem;
                width: max-content;
            }

            .stock-action-card {
                flex-shrink: 0;
                min-width: 280px !important;
            }
        }

        .stocks-in-action-container::-webkit-scrollbar {
            height: 6px;
        }

        .stocks-in-action-container::-webkit-scrollbar-track {
            background: #111;
            border-radius: 10px;
        }

        .stocks-in-action-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 10px;
        }

        .stocks-in-action-container::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Stock Action Card Hover Effect */
        .stock-action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            border-color: rgba(77, 166, 255, 0.6) !important;
        }

        .price-action-container::-webkit-scrollbar {
            height: 6px;
        }

        .price-action-container::-webkit-scrollbar-track {
            background: #111;
            border-radius: 3px;
        }

        .price-action-container::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .price-action-container::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .levels-card-item {
                min-width: 180px;
            }

            .levels-card-item .card {
                width: 180px !important;
            }

            /* Price action cards adjustments for tablet */
            #foSummaryBody .levels-card-item .card {
                width: 120px !important;
            }
        }

        @media (max-width: 576px) {
            .levels-card-item {
                min-width: 160px;
            }

            .levels-card-item .card {
                width: 160px !important;
            }

            /* Price action cards adjustments for mobile */
            #foSummaryBody .levels-card-item .card {
                width: 110px !important;
            }

            #foSummaryBody .levels-card-item small {
                font-size: 0.6rem !important;
            }
        }

        .rvol-symbol {
            font-weight: bold;
            color: #4a90e2;
            cursor: pointer;
            min-width: 50px;
        }

        .rvol-data {
            display: flex;
            gap: 4px;
            font-size: 0.55rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .rvol-data {
                font-size: 0.5rem;
                gap: 3px;
            }

            .rvol-symbol {
                font-size: 0.6rem;
                min-width: 35px;
            }

            .rvol-stock-row {
                padding: 2px 4px;
                margin-bottom: 1px;
            }
        }

        .rvol-value {
            color: #f0ad4e;
            font-weight: bold;
        }

        .rvol-change-positive {
            color: #28a745;
        }

        .rvol-change-negative {
            color: #dc3545;
        }

        .rvol-from-open-positive {
            color: #28a745;
        }

        .rvol-from-open-negative {
            color: #dc3545;
        }

        /* Cache bust: {{ range(1000, 9999) | random }} */

        /* Rolling number animation - professional and subtle */
        .rolling-number {
            transition: all 0.2s ease-out;
            display: inline-block;
        }

        .rolling-number.updating {
            transform: translateY(-2px);
        }

        .price-pulse {
            animation: pulsePriceChange 0.3s ease-in-out;
        }

        /* Performance optimizations */
        .table-responsive {
            will-change: scroll-position;
        }

        .gauge-item {
            will-change: transform;
        }

        @keyframes flashGreen {
            0% { 
                background-color: rgba(40, 167, 69, 0.6); 
            }
            50% { 
                background-color: rgba(40, 167, 69, 0.3); 
            }
            100% { 
                background-color: transparent; 
            }
        }

        @keyframes flashRed {
            0% { 
                background-color: rgba(220, 53, 69, 0.6); 
            }
            50% { 
                background-color: rgba(220, 53, 69, 0.3); 
            }
            100% { 
                background-color: transparent; 
            }
        }

        @keyframes pulsePriceChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Smooth transition for all price elements */
        .price-cell {
            transition: background-color 0.2s ease;
            border-radius: 4px;
            padding: 0.3rem;
            will-change: background-color;
        }
    </style>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .level-broken {
            background-color: rgba(220, 53, 69, 0.1) !important;
            color: var(--bs-danger) !important;
            font-weight: bold;
        }

        .level-active {
            background-color: rgba(25, 135, 84, 0.1);
            color: var(--bs-success);
        }

        /* Immediate Support/Resistance Flash Animation */
        .immediate-level {
            position: relative;
        }

        .immediate-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: bold;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .immediate-tag.highlight {
            transform: scale(1.05);
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4);
        }

        .resistance-tag {
            background-color: rgba(220, 53, 69, 0.8);
            color: white;
        }

        .support-tag {
            background-color: rgba(25, 135, 84, 0.8);
            color: white;
        }


        .range-green {
            background-color: #28a745 !important;
            border-radius: 6px !important;
        }

        .range-red {
            background-color: #dc3545 !important;
            border-radius: 6px !important;
        }

        .range-yellow {
            background-color: #ffc107 !important;
            color: #000 !important;
            border-radius: 6px !important;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Mobile-First Responsive Typography */
        body {
            font-size: 0.8rem !important;
        }

        /* Headers */
        h1 { font-size: 1.1rem !important; }
        h2 { font-size: 1rem !important; }
        h3 { font-size: 0.95rem !important; }
        h4 { font-size: 0.9rem !important; }
        h5 { font-size: 0.85rem !important; }
        h6 { font-size: 0.8rem !important; }

        /* Navigation */
        .navbar-brand { font-size: 0.9rem !important; }
        .navbar-brand > div > div:first-child { font-size: 0.95rem !important; }
        .navbar-brand > div > div:last-child { font-size: 0.7rem !important; }
        .navbar-text { font-size: 0.75rem !important; }
        .nav-link { font-size: 0.75rem !important; }

        /* Tables */
        .table { font-size: 0.7rem !important; }
        .table th { 
            font-size: 0.65rem !important; 
            padding: 0.3rem !important;
            line-height: 1.2 !important;
        }
        .table td { 
            font-size: 0.7rem !important; 
            padding: 0.3rem !important;
            line-height: 1.2 !important;
        }

        /* Buttons */
        .btn { 
            font-size: 0.7rem !important; 
            padding: 0.25rem 0.5rem !important;
        }
        .btn-sm { 
            font-size: 0.65rem !important; 
            padding: 0.2rem 0.4rem !important;
        }
        .btn-lg { 
            font-size: 0.8rem !important; 
            padding: 0.4rem 0.8rem !important;
        }

        /* Cards */
        .card-body { 
            padding: 0.5rem !important; 
            font-size: 0.75rem !important;
        }
        .card-header { 
            font-size: 0.8rem !important; 
            padding: 0.4rem 0.8rem !important;
        }
        .card-title { font-size: 0.85rem !important; }

        /* Market Summary */
        .glow-card .card-body h5 { 
            font-size: 0.8rem !important; 
            margin-bottom: 0.2rem !important;
        }
        .glow-card .card-body small { 
            font-size: 0.65rem !important; 
        }

        /* Tabs */
        .nav-pills .nav-link { 
            font-size: 0.7rem !important; 
            padding: 0.3rem 0.6rem !important;
        }

        /* Form elements */
        .form-control { 
            font-size: 0.75rem !important; 
            padding: 0.25rem 0.5rem !important;
        }
        .form-label { font-size: 0.75rem !important; }







        /* Desktop Navigation Strip Styling */
        .desktop-nav-strip {
            position: relative;
            z-index: 1020;
            backdrop-filter: blur(10px);
        }
        
        .nav-strip-btn {
            border-radius: 20px;
            transition: all 0.3s ease;
            white-space: nowrap;
            border: 1px solid rgba(77, 166, 255, 0.3);
        }
        
        .nav-strip-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(77, 166, 255, 0.4);
            border-color: rgba(77, 166, 255, 0.6);
        }
        
        .nav-strip-btn.btn-outline-primary:hover {
            background-color: rgba(13, 110, 253, 0.15);
            color: #4da6ff;
        }
        
        .nav-strip-btn.btn-outline-success:hover {
            background-color: rgba(25, 135, 84, 0.15);
            color: #5cb85c;
        }
        
        .nav-strip-btn.btn-outline-warning:hover {
            background-color: rgba(255, 193, 7, 0.15);
            color: #ffc107;
        }
        
        .nav-strip-btn.btn-outline-danger:hover {
            background-color: rgba(220, 53, 69, 0.15);
            color: #dc3545;
        }
        
        /* Light Theme Navigation Strip */
        :root[data-theme="light"] .desktop-nav-strip {
            background: linear-gradient(135deg, rgba(248, 249, 250, 0.98), rgba(233, 236, 239, 0.95)) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
        }
        
        :root[data-theme="light"] .nav-strip-btn {
            border-color: rgba(13, 110, 253, 0.4) !important;
            color: #0d6efd !important;
        }
        
        :root[data-theme="light"] .nav-strip-btn.btn-outline-success {
            border-color: rgba(25, 135, 84, 0.4) !important;
            color: #198754 !important;
        }
        
        :root[data-theme="light"] .nav-strip-btn.btn-outline-warning {
            border-color: rgba(255, 193, 7, 0.6) !important;
            color: #f59e0b !important;
        }
        
        :root[data-theme="light"] .nav-strip-btn.btn-outline-warning.active {
            background-color: rgba(255, 193, 7, 0.3) !important;
        }
        
        :root[data-theme="light"] .nav-strip-btn.btn-outline-danger {
            border-color: rgba(220, 53, 69, 0.4) !important;
            color: #dc3545 !important;
        }
        
        :root[data-theme="light"] .nav-strip-btn:hover {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }
        
        :root[data-theme="light"] .nav-strip-btn.btn-outline-success:hover {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }
        
        :root[data-theme="light"] .nav-strip-btn.btn-outline-warning:hover {
            background-color: rgba(255, 193, 7, 0.2) !important;
        }
        
        :root[data-theme="light"] .nav-strip-btn.btn-outline-danger:hover {
            background-color: rgba(220, 53, 69, 0.1) !important;
        }
        
        /* Adjust main content top margin to account for INDEX bar */
        .main-content {
            margin-top: 60px;
        }




        /* Alerts and badges */
        .alert { 
            font-size: 0.75rem !important; 
            padding: 0.5rem !important;
        }
        .badge { font-size: 0.65rem !important; }

        /* Immediate tags */
        .immediate-tag {
            font-size: 0.6rem !important;
            padding: 1px 4px !important;
        }

        /* Range columns */
        .range-green, .range-red, .range-yellow {
            font-size: 0.65rem !important;
            padding: 0.15rem 0.3rem !important;
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .table { font-size: 0.65rem !important; }
            .table th { 
                font-size: 0.6rem !important; 
                padding: 0.2rem !important;
            }
            .table td { 
                font-size: 0.65rem !important; 
                padding: 0.2rem !important;
            }
            .btn { 
                font-size: 0.65rem !important; 
                padding: 0.2rem 0.4rem !important;
            }
            .glow-card .card-body h5 { font-size: 0.75rem !important; }
            .glow-card .card-body small { font-size: 0.6rem !important; }
            .navbar-brand > div > div:first-child { font-size: 0.85rem !important; }
            .navbar-brand > div > div:last-child { font-size: 0.65rem !important; }

            /* Price Action Cards - 2x2 Grid with Vertical Scroll */
            .price-action-scroll-container {
                height: 400px; /* Fixed height for 2x2 grid */
                overflow-y: auto;
                overflow-x: hidden;
                /* Hide scrollbars for cleaner look */
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }

            .price-action-scroll-container::-webkit-scrollbar {
                display: none;  /* Safari and Chrome */
            }

            .price-action-card {
                margin-bottom: 0.5rem;
            }

            /* Market Overview Cards - 3x3 Grid with Vertical Scroll */
            .market-overview-scroll-container {
                height: 350px; /* Fixed height for 3x3 grid */
                overflow-y: auto;
                overflow-x: hidden;
                /* Hide scrollbars for cleaner look */
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }

            .market-overview-scroll-container::-webkit-scrollbar {
                display: none;  /* Safari and Chrome */
            }
        }

        /* Desktop Market Overview - Two Row Layout (11 cards per row) */
        @media (min-width: 992px) {
            .market-overview-scroll-container {
                height: auto !important; /* Remove fixed height for desktop */
                overflow: visible !important; /* Remove scroll for desktop */
                display: flex !important;
                flex-wrap: wrap !important; /* Allow wrapping to 2 rows */
                gap: 0.2rem !important;
                align-content: flex-start !important;
            }

            .market-overview-scroll-container > div {
                flex: 0 0 calc(8.8% - 0.1rem) !important; /* Precisely 11 cards per row with gaps */
                min-width: calc(8.8% - 0.1rem) !important;
                max-width: calc(8.8% - 0.1rem) !important;
            }
        }

        /* Special styling for INDIAVIX card */
        .index-card[data-index-symbol="NSE:INDIAVIX-INDEX"] .card {
            background: linear-gradient(135deg, #1a365d 0%, #2d4a72 50%, #1e40af 100%) !important;
            border: 1px solid rgba(59, 130, 246, 0.3) !important;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2) !important;
        }

        .index-card[data-index-symbol="NSE:INDIAVIX-INDEX"] .card:hover {
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4) !important;
            border-color: rgba(59, 130, 246, 0.5) !important;
        }

        /* Navigation Bar Styling */
        .navbar-logo {
            height: 35px; 
            width: 35px;
        }

        .navbar-title {
            font-size: 0.9rem; 
            font-weight: bold; 
            line-height: 1.1;
            color: #4da6ff !important;
        }

        .navbar-subtitle {
            font-size: 0.7rem; 
            opacity: 0.9; 
            line-height: 1;
            color: #66b3ff !important;
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .navbar-logo {
                height: 24px; 
                width: 24px;
            }

            .navbar-title {
                font-size: 0.75rem !important;
            }

            .navbar-subtitle {
                font-size: 0.6rem !important;
                display: none;
            }

            .navbar-brand {
                margin-right: 0 !important;
                flex-shrink: 0;
            }
            
            /* Ensure navbar container doesn't wrap */
            .navbar .container {
                flex-wrap: nowrap !important;
            }
            
            /* Mobile navigation - compact spacing */
            .ms-auto.d-flex {
                gap: 4px !important;
                align-items: center;
                flex-wrap: nowrap !important;
            }
            
            /* All navbar items compact on mobile */
            .ms-auto.d-flex > * {
                flex-shrink: 0;
            }
            
            /* Connection indicator - very compact */
            .ms-auto.d-flex > div:has(#connectionIndicator) {
                margin: 0 0 0 8px !important;
                padding: 0 !important;
            }
            
            .ms-auto.d-flex #connectionIndicator {
                font-size: 8px !important;
            }
            
            /* Theme toggle button - compact */
            .ms-auto.d-flex .theme-toggle {
                padding: 2px 5px !important;
                border-radius: 10px !important;
                min-width: auto !important;
                border: none !important;
                background: transparent !important;
            }
            
            .ms-auto.d-flex .theme-toggle i {
                font-size: 0.7rem !important;
            }
            
            /* Alert and help buttons - compact */
            .ms-auto.d-flex .btn-outline-warning,
            .ms-auto.d-flex .btn-outline-info {
                padding: 2px 5px !important;
                min-width: auto !important;
                border: none !important;
                background: transparent !important;
            }
            
            .ms-auto.d-flex .btn-outline-warning i,
            .ms-auto.d-flex .btn-outline-info i {
                font-size: 0.7rem !important;
            }
            
            /* Profile image - smaller */
            .ms-auto.d-flex > div:has(.rounded-circle) {
                margin: 0 !important;
            }
            
            .ms-auto.d-flex .rounded-circle,
            .ms-auto.d-flex img.rounded-circle {
                width: 24px !important;
                height: 24px !important;
                border: none !important;
            }
            
            .ms-auto.d-flex .rounded-circle i {
                font-size: 12px !important;
            }
            
            /* Hamburger button - compact */
            .ms-auto.d-flex > div:has(#mobileMenuToggle) {
                margin: 0 !important;
            }
            
            .ms-auto.d-flex #mobileMenuToggle {
                padding: 2px 5px !important;
                border: none !important;
                background: transparent !important;
            }
            
            .ms-auto.d-flex .hamburger-icon {
                width: 16px !important;
            }
            
            .ms-auto.d-flex .hamburger-icon span {
                height: 2px !important;
                margin: 2px 0 !important;
            }
            
            /* Remove borders from buttons on mobile */
            .mobile-menu-item button,
            .mobile-menu-item .btn,
            .mobile-menu-dropdown button,
            .mobile-menu-dropdown .btn {
                border: none !important;
            }
            
            /* Remove border from tab navigation buttons */
            .nav-tabs .nav-link {
                border: none !important;
                background: transparent !important;
            }
            
            .nav-tabs .nav-link.active {
                border: none !important;
                border-bottom: 2px solid #007bff !important;
            }
            
            /* Remove borders ONLY from navbar icon buttons on mobile */
            .navbar .btn-outline-primary,
            .navbar .btn-outline-secondary,
            .navbar .btn-outline-success,
            .navbar .btn-outline-danger,
            .navbar .btn-outline-warning,
            .navbar .btn-outline-info,
            .navbar .btn-outline-light,
            .navbar .btn-outline-dark,
            .navbar .theme-toggle,
            .ms-auto .btn-outline-warning,
            .ms-auto .btn-outline-info {
                border: none !important;
                box-shadow: none !important;
            }
        }

        /* Ultra small devices */
        @media (max-width: 576px) {
            body { font-size: 0.75rem !important; }
            .table { font-size: 0.6rem !important; }
            .table th, .table td { 
                font-size: 0.55rem !important; 
                padding: 0.15rem !important;
            }
            .btn { 
                font-size: 0.6rem !important; 
                padding: 0.15rem 0.3rem !important;
            }
            .immediate-tag { font-size: 0.55rem !important; }
            .range-green, .range-red, .range-yellow { 
                font-size: 0.6rem !important; 
                padding: 0.1rem 0.2rem !important;
            }

            .navbar-logo {
                height: 25px; 
                width: 25px;
            }

            .navbar-title {
                font-size: 0.75rem !important;
            }

            .navbar-subtitle {
                font-size: 0.6rem !important;
            }

            .navbar {
                padding-top: 0.25rem !important;
                padding-bottom: 0.25rem !important;
            }
        }

        /* Mobile Menu Hamburger Styles */
        .hamburger-icon {
            width: 20px;
            height: 15px;
            position: relative;
            cursor: pointer;
        }

        .hamburger-icon span {
            display: block;
            position: absolute;
            height: 2px;
            width: 100%;
            background: #ffffff;
            border-radius: 1px;
            opacity: 1;
            left: 0;
            transition: .25s ease-in-out;
        }

        .hamburger-icon span:nth-child(1) {
            top: 0px;
        }

        .hamburger-icon span:nth-child(2) {
            top: 6px;
        }

        .hamburger-icon span:nth-child(3) {
            top: 12px;
        }

        /* Mobile Menu Dropdown */
        .mobile-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(20, 25, 35, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            min-width: 200px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .mobile-menu-dropdown.show {
            display: block;
        }

        .mobile-menu-item {
            display: block;
            padding: 12px 16px;
            color: #ffffff;
            text-decoration: none;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s ease;
        }

        .mobile-menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            text-decoration: none;
        }

        .mobile-menu-item:last-child {
            border-bottom: none;
        }

        .mobile-menu-divider {
            border-top: 1px solid #444;
            margin: 4px 0;
        }

        .mobile-menu-header {
            padding: 8px 16px;
            color: #6c757d;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Ensure mobile menu positioning */
        .d-lg-none {
            position: relative;
        }
        
        /* Hamburger menu visible on all devices */
        .ms-auto.me-2 {
            position: relative;
        }
        
        /* Premium badge styling */
        .mobile-menu-item .badge {
            float: right;
        }
        
        /* Light theme mobile menu */
        :root[data-theme="light"] .mobile-menu-dropdown {
            background: rgba(255, 255, 255, 0.98) !important;
            border: 1px solid #dee2e6 !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15) !important;
        }
        
        :root[data-theme="light"] .mobile-menu-item {
            color: #000 !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
        }
        
        :root[data-theme="light"] .mobile-menu-item:hover {
            background-color: rgba(0, 0, 0, 0.05) !important;
            color: #000 !important;
        }
        
        :root[data-theme="light"] .mobile-menu-header {
            color: #6c757d !important;
            background: rgba(0, 0, 0, 0.03) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
        }
        
        :root[data-theme="light"] .mobile-menu-divider {
            border-top: 1px solid #dee2e6 !important;
        }
        
        /* Light theme hamburger icon */
        :root[data-theme="light"] .hamburger-icon span {
            background: #000 !important;
        }
        
        /* Alert Container - Popup Notifications */
        .alert-container {
            position: fixed;
            top: 70px;
            left: 20px;
            z-index: 10000;
            display: none;
            flex-direction: column;
            gap: 8px;
            max-width: 350px;
            background: none !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            padding: 0 !important;
        }
        
        .alert-container.show {
            display: flex;
        }
        
        /* Price Alert Cards - Dark Theme */
        .price-alert {
            background: linear-gradient(135deg, #1a1a1a 0%, #0a0f14 100%);
            border: 2px solid;
            border-left: 5px solid;
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            animation: slideIn 0.3s ease;
        }
        
        .price-alert:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
        
        .price-alert.high {
            border-color: #28a745;
            border-left-width: 5px;
        }
        
        .price-alert.low {
            border-color: #dc3545;
            border-left-width: 5px;
        }
        
        .price-alert.fadeOut {
            animation: fadeOut 0.2s ease forwards;
        }
        
        .alert-single-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            color: #fff;
        }
        
        .alert-symbol-small {
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .alert-symbol-small .icon {
            font-size: 0.9rem;
        }
        
        .alert-symbol-small .icon.high {
            color: #28a745;
        }
        
        .alert-symbol-small .icon.low {
            color: #dc3545;
        }
        
        .alert-ltp {
            font-size: 0.8rem;
            color: #ccc;
        }
        
        .high-price {
            color: #28a745;
            font-weight: 700;
        }
        
        .low-price {
            color: #dc3545;
            font-weight: 700;
        }
        
        /* Light Theme for Alerts */
        :root[data-theme="light"] .price-alert {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
        }
        
        :root[data-theme="light"] .price-alert:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2) !important;
        }
        
        :root[data-theme="light"] .alert-single-line {
            color: #000 !important;
        }
        
        :root[data-theme="light"] .alert-symbol-small {
            color: #000 !important;
        }
        
        :root[data-theme="light"] .alert-ltp {
            color: #333 !important;
        }
        
        :root[data-theme="light"] .high-price {
            color: #28a745 !important;
        }
        
        :root[data-theme="light"] .low-price {
            color: #dc3545 !important;
        }
        
        /* Mobile View - Smaller Font Size for Alerts */
        @media (max-width: 768px) {
            .alert-symbol-small {
                font-size: 0.7rem !important;
            }
            
            .alert-symbol-small .icon {
                font-size: 0.75rem !important;
            }
            
            .alert-ltp {
                font-size: 0.65rem !important;
            }
            
            .high-price,
            .low-price {
                font-size: 0.7rem !important;
            }
            
            .price-alert {
                padding: 6px 10px !important;
            }
            
            .alert-container {
                max-width: 280px !important;
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(-20px);
            }
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 25%, #2a2d3e 50%, #1a1f2e 75%, #0f1419 100%); min-height: 100vh;" class="text-white">
    <!-- High/Low Alert Container -->
    <div id="alertContainer" class="alert-container">
        <!-- Dynamic alerts will be inserted here -->
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-1">
        <div class="container d-flex align-items-center">
            <!-- Logo + MG Dashboard Title -->
            <a class="navbar-brand d-flex align-items-center flex-grow-0" href="#" style="margin-right: 0;">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="MG Logo" class="navbar-logo me-2">
                <div class="navbar-title">MG Dashboard</div>
            </a>

            <div class="ms-auto d-flex align-items-center">
                <!-- WebSocket Connection Status Indicator (Signal) -->
                <div class="me-3 d-flex align-items-center" title="WebSocket Status">
                    <i id="connectionIndicator" class="fas fa-circle" style="font-size: 10px; color: #6c757d;"></i>
                </div>
                
                <!-- Theme Toggle -->
                <button class="theme-toggle me-3" onclick="toggleTheme()" title="Toggle Theme" id="themeToggleBtn">
                    <i class="fas fa-sun" id="themeIcon"></i>
                </button>
                
                <!-- Bell (Alerts) -->
                <button class="btn btn-sm btn-outline-warning me-3 d-flex align-items-center" onclick="toggleAlerts()" title="Toggle Alerts" id="alertToggleBtn">
                    <i class="fas fa-bell"></i>
                </button>
                
                <!-- User Guide Help Button -->
                <button class="btn btn-sm btn-outline-info me-3 d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#userGuideModal" title="User Guide">
                    <i class="fas fa-question-circle"></i>
                </button>
                
                <!-- User Profile Avatar (Google Icon) -->
                <div class="me-3">
                    {% if current_user.profile_image_url %}
                    <img src="{{ current_user.profile_image_url }}" alt="{{ current_user.username }}" class="rounded-circle" style="width: 32px; height: 32px; object-fit: cover; border: 2px solid #4da6ff;" onclick="window.location.href='{{ url_for('account') }}';" role="button">
                    {% else %}
                    <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px; background-color: #4da6ff; border: 2px solid #66b3ff; cursor: pointer;" onclick="window.location.href='{{ url_for('account') }}';" role="button">
                        <i class="fas fa-user" style="font-size: 16px; color: white;"></i>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Hamburger Menu - Mobile Only -->
                <div style="position: relative;" class="d-md-none">
                    <button class="btn btn-outline-light btn-sm" type="button" id="mobileMenuToggle" style="border: none; padding: 4px 8px;">
                        <div class="hamburger-icon">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </button>
                    <!-- Mobile Dropdown Menu -->
                    <div class="mobile-menu-dropdown" id="mobileMenuDropdown">
                        <!-- User Profile Header in Mobile Menu -->
                        <div class="mobile-menu-header d-flex align-items-center mb-2" style="padding: 12px; background: rgba(77, 166, 255, 0.1); border-bottom: 1px solid rgba(77, 166, 255, 0.3);">
                            {% if current_user.profile_image_url %}
                            <img src="{{ current_user.profile_image_url }}" alt="{{ current_user.username }}" class="rounded-circle me-2" style="width: 36px; height: 36px; object-fit: cover; border: 2px solid #4da6ff;">
                            {% else %}
                            <div class="rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 36px; height: 36px; background-color: #4da6ff; border: 2px solid #66b3ff;">
                                <i class="fas fa-user" style="font-size: 18px; color: white;"></i>
                            </div>
                            {% endif %}
                            <div>
                                <div style="font-weight: bold; font-size: 0.9rem;">{{ current_user.username }}</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;">{{ current_user.email }}</div>
                            </div>
                        </div>
                        <a href="{{ url_for('account') }}" class="mobile-menu-item">
                            <i class="fas fa-user-circle me-2"></i>Account
                        </a>
                        <div class="mobile-menu-divider"></div>
                        <a href="#" onclick="return scrollToSection(event, 'market-overview')" class="mobile-menu-item">
                            <i class="fas fa-chart-line me-2"></i>Market Overview
                        </a>
                        <a href="#" onclick="return scrollToSection(event, 'niftyTable')" class="mobile-menu-item">
                            <i class="fas fa-table me-2"></i>F&O Table
                        </a>
                        <div class="mobile-menu-divider"></div>
                        <div class="mobile-menu-header">Technical Analysis Tables</div>
                        <a href="#" onclick="return scrollToSection(event, 'camarillaTable')" class="mobile-menu-item">
                            <i class="fas fa-layer-group me-2"></i>Camarilla
                        </a>
                        <a href="#" onclick="return scrollToSection(event, 'cprTable')" class="mobile-menu-item">
                            <i class="fas fa-crosshairs me-2"></i>CPR
                            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">Premium</span>
                        </a>
                        <a href="#" onclick="return scrollToSection(event, 'fibonacciTable')" class="mobile-menu-item">
                            <i class="fas fa-chart-line me-2"></i>Fibonacci
                        </a>
                        <a href="#" onclick="return scrollToSection(event, 'levels-scan')" class="mobile-menu-item">
                            <i class="fas fa-search me-2"></i>Levels Scan
                        </a>
                        <a href="#" onclick="return scrollToSection(event, 'rvol-analysis')" class="mobile-menu-item">
                            <i class="fas fa-chart-bar me-2"></i>RVOL Analysis
                        </a>
                        <a href="#" onclick="return scrollToSection(event, 'price-action')" class="mobile-menu-item">
                            <i class="fas fa-arrows-alt me-2"></i>Price Action Cards
                            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">Premium</span>
                        </a>
                        <div class="mobile-menu-divider"></div>
                        <a href="{{ url_for('all_charts') }}" class="mobile-menu-item">
                            <i class="fas fa-chart-area me-2"></i>100D-Levels
                        </a>
                        <a href="{{ url_for('mgheatmap') }}" class="mobile-menu-item">
                            <i class="fas fa-th me-2"></i>MG Heatmap
                            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">Premium</span>
                        </a>
                        <a href="{{ url_for('mg_linecharts') }}" class="mobile-menu-item">
                            <i class="fas fa-chart-line me-2"></i>5D Line Charts
                            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">Premium</span>
                        </a>
                        <a href="{{ url_for('volume_profile') }}" class="mobile-menu-item">
                            <i class="fas fa-chart-area me-2"></i>Volume Profile
                        </a>
                        <a href="{{ url_for('technical_indicators_page') }}" class="mobile-menu-item">
                            <i class="fas fa-chart-line me-2"></i>Technical Indicators
                            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.65rem;">Premium</span>
                        </a>
                        {% if current_user.is_admin() %}
                        <div class="mobile-menu-divider"></div>
                        <a href="{{ url_for('live_chart') }}" class="mobile-menu-item">
                            <i class="fas fa-chart-candlestick me-2"></i>Live Chart
                            <span class="badge bg-danger ms-2" style="font-size: 0.65rem;">Admin</span>
                        </a>
                        <a href="{{ url_for('admin_panel') }}" class="mobile-menu-item">
                            <i class="fas fa-user-shield me-2"></i>Admin Panel
                            <span class="badge bg-danger ms-2" style="font-size: 0.65rem;">Admin</span>
                        </a>
                        {% endif %}
                        <div class="mobile-menu-divider"></div>
                        <a href="{{ url_for('logout') }}" class="mobile-menu-item">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Desktop Navigation Strip (Hidden on Mobile) -->
    <div class="desktop-nav-strip d-none d-md-block" style="background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(30, 41, 59, 0.9)); border-bottom: 1px solid rgba(77, 166, 255, 0.2); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
        <div class="container-fluid px-3 py-2">
            <div class="d-flex gap-2 flex-wrap align-items-center justify-content-center">
                <!-- On-Page Sections -->
                <button class="btn btn-sm btn-outline-primary nav-strip-btn" onclick="return scrollToSection(event, 'ai-scores')" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-brain me-1"></i>AI Scores
                </button>
                <button class="btn btn-sm btn-outline-primary nav-strip-btn" onclick="return scrollToSection(event, 'market-overview')" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-chart-line me-1"></i>Market
                </button>
                <button class="btn btn-sm btn-outline-primary nav-strip-btn" onclick="return scrollToSection(event, 'niftyTable')" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-table me-1"></i>F&O
                </button>
                <button class="btn btn-sm btn-outline-primary nav-strip-btn" onclick="return scrollToSection(event, 'camarillaTable')" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-layer-group me-1"></i>Camarilla
                </button>
                <button class="btn btn-sm btn-outline-warning nav-strip-btn" onclick="return scrollToSection(event, 'cprTable')" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-crosshairs me-1"></i>CPR
                    <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">Premium</span>
                </button>
                <button class="btn btn-sm btn-outline-primary nav-strip-btn" onclick="return scrollToSection(event, 'fibonacciTable')" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-chart-line me-1"></i>Fibonacci
                </button>
                <button class="btn btn-sm btn-outline-primary nav-strip-btn" onclick="return scrollToSection(event, 'levels-scan')" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-search me-1"></i>Levels
                </button>
                <button class="btn btn-sm btn-outline-primary nav-strip-btn" onclick="return scrollToSection(event, 'rvol-analysis')" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-chart-bar me-1"></i>RVOL
                </button>
                <button class="btn btn-sm btn-outline-warning nav-strip-btn" onclick="return scrollToSection(event, 'price-action')" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-arrows-alt me-1"></i>Price Action
                    <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">Premium</span>
                </button>
                
                <!-- Separator -->
                <div style="width: 1px; height: 24px; background: rgba(77, 166, 255, 0.3); margin: 0 0.5rem;"></div>
                
                <!-- Other Pages -->
                <button class="btn btn-sm btn-outline-success nav-strip-btn" onclick="window.location.href='{{ url_for('all_charts') }}'" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-chart-area me-1"></i>100D-Levels
                </button>
                <button class="btn btn-sm btn-outline-warning nav-strip-btn" onclick="window.location.href='{{ url_for('mgheatmap') }}'" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-th me-1"></i>MG Heatmap
                    <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">Premium</span>
                </button>
                <button class="btn btn-sm btn-outline-warning nav-strip-btn" onclick="window.location.href='{{ url_for('mg_linecharts') }}'" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-chart-line me-1"></i>5D Charts
                    <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">Premium</span>
                </button>
                <button class="btn btn-sm btn-outline-success nav-strip-btn" onclick="window.location.href='{{ url_for('volume_profile') }}'" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-chart-area me-1"></i>Volume
                </button>
                <button class="btn btn-sm btn-outline-warning nav-strip-btn" onclick="window.location.href='{{ url_for('technical_indicators_page') }}'" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-chart-line me-1"></i>Indicators
                    <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">Premium</span>
                </button>
                
                {% if current_user.is_admin() %}
                <!-- Separator -->
                <div style="width: 1px; height: 24px; background: rgba(220, 53, 69, 0.3); margin: 0 0.5rem;"></div>
                
                <button class="btn btn-sm btn-outline-danger nav-strip-btn" onclick="window.location.href='{{ url_for('live_chart') }}'" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-chart-candlestick me-1"></i>Live
                    <span class="badge bg-danger ms-1" style="font-size: 0.55rem;">Admin</span>
                </button>
                <button class="btn btn-sm btn-outline-danger nav-strip-btn" onclick="window.location.href='{{ url_for('admin_panel') }}'" style="font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas fa-user-shield me-1"></i>Admin
                    <span class="badge bg-danger ms-1" style="font-size: 0.55rem;">Admin</span>
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="d-flex" style="min-height: calc(100vh - 70px);">
        <!-- Main Dashboard Content -->
        <div class="flex-grow-1">
            <div class="container-fluid mt-4 main-content">
                <!-- Dashboard Content Column -->
                <div class="dashboard-column">




        <!-- Market Statistics Progress Bars -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card glow-card" style="background: rgba(20, 25, 35, 0.9) !important;">
                    <div class="card-body py-2">
                        <div class="row g-1">
                            <!-- Gainers Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-success fw-bold" id="gainersBarCount" style="font-size: 0.65rem;">26</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 52%" id="gainersBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Gainers</small>
                                </div>
                            </div>

                            <!-- Losers Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-danger fw-bold" id="losersBarCount" style="font-size: 0.65rem;">24</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: 48%" id="losersBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Losers</small>
                                </div>
                            </div>

                            <!-- Recovery Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-info fw-bold" id="recoveryBarCount" style="font-size: 0.65rem;">6</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 12%" id="recoveryBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Recovery</small>
                                </div>
                            </div>

                            <!-- Declining Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-warning fw-bold" id="decliningBarCount" style="font-size: 0.65rem;">10</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 20%" id="decliningBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Declining</small>
                                </div>
                            </div>

                            <!-- Turn+ Stocks Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-success fw-bold" id="turnPositiveBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="turnPositiveBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Turn+</small>
                                </div>
                            </div>

                            <!-- Turn- Stocks Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-danger fw-bold" id="turnNegativeBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="turnNegativeBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">Turn-</small>
                                </div>
                            </div>

                            <!-- +FromOpen Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-success fw-bold" id="positiveFromOpenBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="positiveFromOpenBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">+FromOpen</small>
                                </div>
                            </div>

                            <!-- -FromOpen Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-danger fw-bold" id="negativeFromOpenBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="negativeFromOpenBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">-FromOpen</small>
                                </div>
                            </div>

                            <!-- O=H Stocks Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-warning fw-bold" id="openHighBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 0%" id="openHighBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">O=H</small>
                                </div>
                            </div>

                            <!-- O=L Stocks Bar -->
                            <div class="progress-bar-mobile">
                                <div class="text-center">
                                    <h6 class="mb-1 text-info fw-bold" id="openLowBarCount" style="font-size: 0.65rem;">0</h6>
                                    <div class="progress mb-1" style="height: 5px;">
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 0%" id="openLowBar"></div>
                                    </div>
                                    <small class="text-white opacity-90" style="font-size: 0.55rem;">O=L</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Scores Section - Top 7 Bullish & Bottom 7 Bearish -->
        <div class="row mb-4" id="ai-scores">
            <div class="col-12">
                <div class="card glow-card section-3d-border" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0f14 100%) !important; padding: 8px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">
                                <i class="fas fa-brain me-2"></i>AI Scores - Top 7 Bullish & Bottom 7 Bearish
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" id="toggleAIScoresSection" style="font-size: 0.75rem; padding: 2px 6px;">
                                <i class="fas fa-eye" id="aiScoresToggleIcon"></i>
                            </button>
                        </div>
                        <div class="mt-1" style="font-size: 0.65rem; color: rgba(255,255,255,0.6);">
                            Top 7 Bullish & Bottom 7 Bearish stocks with % Change, AI Score, RSI, MACD, Stochastic, ADX statuses, and CPR/Camarilla/Fibonacci ranges. Hover for full details.
                        </div>
                    </div>
                    <div class="card-body py-2" id="aiScoresSectionContainer">
                        <!-- Top 5 Bullish Stocks -->
                        <div class="mb-3">
                            <h6 class="text-success mb-2" style="font-size: 0.7rem;"><i class="fas fa-arrow-trend-up me-1"></i>Top 7 Bullish Stocks</h6>
                            <div class="ai-scores-scroll-container">
                                <div class="d-flex gap-2" id="topBullishStocks">
                                    <!-- Will be populated by JavaScript -->
                                    <div class="text-center text-muted" style="width: 100%; padding: 20px; font-size: 0.7rem;">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading top bullish stocks...
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Bottom 5 Bearish Stocks -->
                        <div>
                            <h6 class="text-danger mb-2" style="font-size: 0.7rem;"><i class="fas fa-arrow-trend-down me-1"></i>Bottom 7 Bearish Stocks</h6>
                            <div class="ai-scores-scroll-container">
                                <div class="d-flex gap-2" id="bottomBearishStocks">
                                    <!-- Will be populated by JavaScript -->
                                    <div class="text-center text-muted" style="width: 100%; padding: 20px; font-size: 0.7rem;">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Loading bottom bearish stocks...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- INDEX Cards Row with Market Summary Styling -->
        <div class="row mb-4" id="market-overview">
            <div class="col-12">
                <div class="card glow-card section-3d-border" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0f14 100%) !important; padding: 2px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">Market Overview</div>
                            </div>
                            <div class="d-flex align-items-center gap-1">
                                <div class="btn-group" role="group" style="font-size: 0.65rem;">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="window.scrollTo(0,0)" style="padding: 1px 4px;">
                                        <i class="fas fa-home" style="font-size: 0.6rem;"></i>
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="scrollToTable('niftyTable')" style="padding: 1px 4px; font-size: 0.55rem;">
                                        F&O
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="scrollToTable('camarillaTable')" style="padding: 1px 4px; font-size: 0.55rem;">
                                        Camarilla
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="scrollToTable('cprTable')" style="padding: 1px 4px; font-size: 0.55rem;">
                                        CPR
                                    </button>
                                    <button class="btn btn-info btn-sm" onclick="scrollToTable('fibonacciTable')" style="padding: 1px 4px; font-size: 0.55rem;">
                                        Fibonacci
                                    </button>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" id="toggleIndexCards" style="font-size: 0.75rem; padding: 2px 6px;">
                                    <i class="fas fa-eye" id="indexToggleIcon"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body py-2" id="indexCardsContainer">
                        <div class="row g-1 market-overview-scroll-container">
                            <!-- NIFTY 50 -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTY50-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY 50</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- SENSEX -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="BSE:SENSEX-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">SENSEX</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- BANK NIFTY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYBANK-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">BANK NIFTY</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY IT -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYIT-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY IT</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- FINNIFTY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:FINNIFTY-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">FINNIFTY</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- MIDCAP NIFTY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:MIDCPNIFTY-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">MIDCAP SELECT</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY NEXT 50 -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYNXT50-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NEXT 50</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY FMCG -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYFMCG-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY FMCG</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY PHARMA -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYPHARMA-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY PHARMA</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY AUTO -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYAUTO-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY AUTO</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY METAL -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYMETAL-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY METAL</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY REALTY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYREALTY-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY REALTY</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY PSE -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYPSE-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY PSE</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY PVT BANK -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYPVTBANK-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">PVT BANK</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY MEDIA -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYMEDIA-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY MEDIA</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY INFRA -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYINFRA-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY INFRA</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY ENERGY -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYENERGY-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY ENERGY</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY COMMODITIES -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYCOMMODITIES-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">COMMODITIES</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY CPSE -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYCPSE-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">NIFTY CPSE</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY MIDCAP 50 -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYMIDCAP50-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">MIDCAP 50</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- NIFTY SMALLCAP 100 -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:NIFTYSMLCAP100-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">SMALLCAP 100</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- INDIA VIX -->
                            <div class="col-4 col-lg">
                                <div class="card glow-card glow-secondary text-white index-card" data-index-symbol="NSE:INDIAVIX-INDEX" 
                                     style="cursor: pointer; transition: all 0.2s ease;"
>
                                    <div class="card-body text-center p-1">
                                        <div class="index-name fw-bold" style="font-size: 0.65rem;">INDIA VIX</div>
                                        <div class="index-price h6 mb-0" style="font-size: 0.75rem;">--</div>
                                        <div class="index-change" style="font-size: 0.55rem;">--</div>
                                        <div class="index-open-percent" style="font-size: 0.5rem;">%O:--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                    <!-- Market Analysis Charts - 4 Bar Charts in Single Row -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card glow-card section-3d-border" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                                <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0f14 100%) !important; padding: 8px 12px;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">Index Analysis Charts</div>
                                        <button class="btn btn-sm btn-outline-secondary" id="toggleIndexCharts" style="font-size: 0.75rem; padding: 2px 6px;">
                                            <i class="fas fa-eye" id="indexChartsToggleIcon"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body py-2" id="indexChartsContainer">
                                    <div class="row g-2">
                                        <!-- Chart 1: % Change -->
                                        <div class="col-md-3 col-6">
                                            <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: 220px;">
                                                <div class="card-header bg-transparent border-0 py-1">
                                                    <h6 class="mb-0 text-center text-warning" style="font-size: 0.7rem;">% Change</h6>
                                                </div>
                                                <div class="card-body p-1" style="height: 180px;">
                                                    <canvas id="indexChangeChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Chart 2: % From Open -->
                                        <div class="col-md-3 col-6">
                                            <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: 220px;">
                                                <div class="card-header bg-transparent border-0 py-1">
                                                    <h6 class="mb-0 text-center text-info" style="font-size: 0.7rem;">% From Open</h6>
                                                </div>
                                                <div class="card-body p-1" style="height: 180px;">
                                                    <canvas id="indexOpenChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Chart 3: % From High -->
                                        <div class="col-md-3 col-6">
                                            <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: 220px;">
                                                <div class="card-header bg-transparent border-0 py-1">
                                                    <h6 class="mb-0 text-center text-success" style="font-size: 0.7rem;">% From High</h6>
                                                </div>
                                                <div class="card-body p-1" style="height: 180px;">
                                                    <canvas id="indexHighChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Chart 4: % From Low -->
                                        <div class="col-md-3 col-6">
                                            <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: 220px;">
                                                <div class="card-header bg-transparent border-0 py-1">
                                                    <h6 class="mb-0 text-center text-danger" style="font-size: 0.7rem;">% From Low</h6>
                                                </div>
                                                <div class="card-body p-1" style="height: 180px;">
                                                    <canvas id="indexLowChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

        <!-- F&O Stocks in Action -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card glow-card section-3d-border" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0f14 100%) !important; padding: 8px 12px;">
                        <div class="text-start text-warning fw-bold" style="font-size: 0.85rem;">
                            <i class="fas fa-fire me-2"></i>F&O Stocks in Action
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <!-- Responsive container: grid on desktop, horizontal scroll on mobile -->
                        <div class="stocks-in-action-container">
                            <div id="stocksInActionContainer" class="stocks-in-action-grid">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 10 Cards of Price Action -->
        <div class="row mb-4" id="price-action">
            <div class="col-12">
                <div class="card glow-card section-3d-border" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0f14 100%) !important; padding: 2px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">10 Cards of Price Action</div>
                            <button class="btn btn-sm btn-outline-secondary" id="togglePriceActionCards" style="font-size: 0.75rem; padding: 2px 6px;">
                                <i class="fas fa-eye" id="priceActionToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2" id="priceActionCardsContainer">
                        <!-- 10 Price Action Cards - Responsive Bootstrap grid with mobile horizontal scroll -->
                        <div class="price-action-container">
                            <div class="row g-2">
                                <!-- 1. INTRADAY RECOVERIES -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-info text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-info" style="font-size: 0.65rem;"><i class="fas fa-arrow-trend-up me-1"></i>INTRADAY RECOVERIES % Chg</h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topRecoveriesList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 2. INTRADAY FALL -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-warning text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-warning" style="font-size: 0.65rem;"><i class="fas fa-arrow-trend-down me-1"></i>INTRADAY FALL % Chg </h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topFallList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 3. TOP 5 GAP UP -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-primary text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-primary" style="font-size: 0.65rem;"><i class="fas fa-level-up-alt me-1"></i>TOP GAP UP % Chg </h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topGapUpList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 4. TOP 5 GAP DOWN -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-secondary text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-secondary" style="font-size: 0.65rem;"><i class="fas fa-level-down-alt me-1"></i>TOP GAP DOWN % Chg </h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topGapDownList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 5. TOP 5 GAINERS -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-success text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-success" style="font-size: 0.65rem;"><i class="fas fa-chart-line me-1"></i>TOP GAINERS % Chg</h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topGainersList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 6. TOP 5 LOSERS -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-danger text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-danger" style="font-size: 0.65rem;"><i class="fas fa-chart-line-down me-1"></i>TOP LOSERS % Chg</h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topLosersList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 7. TOP 5 TURN POSITIVE -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-success text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-success" style="font-size: 0.65rem;"><i class="fas fa-plus-circle me-1"></i>TOP TURN POSITIVE % Chg </h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topTurnPositiveList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 8. TOP 5 TURN NEGATIVE -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-danger text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-danger" style="font-size: 0.65rem;"><i class="fas fa-minus-circle me-1"></i>TOP TURN NEGATIVE % Chg </h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topTurnNegativeList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 9. TOP 5 HIGH VOLATILE -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-warning text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-warning" style="font-size: 0.65rem;"><i class="fas fa-bolt me-1"></i>TOP HIGH VOLATILE</h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topRangesList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 10. TOP 5 LESS ACTIVE -->
                                <div class="col-6 col-md-4 col-xl-2">
                                    <div class="card glow-card glow-info text-white">
                                        <div class="card-header bg-transparent border-0 py-1">
                                            <h6 class="mb-0 text-center text-info" style="font-size: 0.65rem;"><i class="fas fa-minus me-1"></i>TOP LESS ACTIVE</h6>
                                        </div>
                                        <div class="card-body p-1">
                                            <div class="list-group list-group-flush bg-transparent" id="topLessVolatileList">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Summary Cards with Glowing Effects -->
        <style>
            .glow-card {
                background: rgba(20, 25, 35, 0.9) !important;
                backdrop-filter: blur(10px);
                border: 2px solid transparent;
                border-radius: 12px;
                position: relative;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            .glow-card::before {
                content: '';
                position: absolute;
                top: -2px;
                left: -2px;
                right: -2px;
                bottom: -2px;
                border-radius: 12px;
                padding: 2px;
                background: linear-gradient(45deg, var(--glow-color), transparent, var(--glow-color));
                -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                -webkit-mask-composite: exclude;
                mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
                mask-composite: exclude;
                z-index: -1;
            }
            .glow-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(var(--glow-rgb), 0.3);
            }
            .glow-success { --glow-color: #28a745; --glow-rgb: 40, 167, 69; }
            .glow-danger { --glow-color: #dc3545; --glow-rgb: 220, 53, 69; }
            .glow-info { --glow-color: #17a2b8; --glow-rgb: 23, 162, 184; }
            .glow-warning { --glow-color: #ffc107; --glow-rgb: 255, 193, 7; }
            .glow-primary { --glow-color: #007bff; --glow-rgb: 0, 123, 255; }
            .glow-secondary { --glow-color: #6c757d; --glow-rgb: 108, 117, 125; }
            .glow-dark { --glow-color: #343a40; --glow-rgb: 52, 58, 64; }

            /* Custom column for 5 cards on mobile, 7 equal cards on desktop */
            .col-1_5 {
                flex: 0 0 20%;
                max-width: 20%;
            }

            @media (min-width: 992px) {
                .col-lg-1_7 {
                    flex: 0 0 14.2857%;
                    max-width: 14.2857%;
                }
                .col-lg-1_5 {
                    flex: 0 0 12.5%;
                    max-width: 12.5%;
                }
            }
        </style>

        <!-- LEVELS SCAN SECTION - Technical Levels Analysis -->
        <div class="row mb-3" id="levels-scan">
            <div class="col-12">
                <div class="card glow-card section-3d-border" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0f14 100%) !important; padding: 8px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">LEVELS SCAN  Technical Level Position Analysis</div>
                            <button class="btn btn-sm btn-outline-secondary" id="toggleLevelsScan" style="font-size: 0.75rem; padding: 2px 6px;">
                                <i class="fas fa-eye" id="levelsScanToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2" id="levelsScanContainer">
                        <!-- CPR LEVELS - 4 Sub-categories -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-warning mb-2" style="font-size: 0.8rem;">CPR LEVELS</h6>
                                <div class="d-flex gap-2 levels-scroll-container">
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-success" style="font-size: 0.7rem;">BREAKOUT</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="cprBreakoutCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-success" id="cprBreakoutProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="cprBreakoutTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-info" style="font-size: 0.7rem;">RESISTANCE</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="cprResistanceCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-info" id="cprResistanceProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="cprResistanceTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-warning" style="font-size: 0.7rem;">SUPPORT</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="cprSupportCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-warning" id="cprSupportProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="cprSupportTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-danger" style="font-size: 0.7rem;">BREAKDOWN</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="cprBreakdownCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-danger" id="cprBreakdownProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="cprBreakdownTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CAMARILLA LEVELS - 4 Sub-categories -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-success mb-2" style="font-size: 0.8rem;">CAMARILLA LEVELS</h6>
                                <div class="d-flex gap-2 levels-scroll-container">
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-success" style="font-size: 0.7rem;">BREAKOUT</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="camBreakoutCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-success" id="camBreakoutProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="camBreakoutTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-info" style="font-size: 0.7rem;">RESISTANCE</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="camResistanceCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-info" id="camResistanceProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="camResistanceTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-warning" style="font-size: 0.7rem;">SUPPORT</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="camSupportCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-warning" id="camSupportProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="camSupportTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-danger" style="font-size: 0.7rem;">BREAKDOWN</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="camBreakdownCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-danger" id="camBreakdownProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="camBreakdownTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FIBONACCI LEVELS - 4 Sub-categories -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-2" style="font-size: 0.8rem;">FIBONACCI LEVELS</h6>
                                <div class="d-flex gap-2 levels-scroll-container">
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-success" style="font-size: 0.7rem;">BREAKOUT</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="fibBreakoutCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-success" id="fibBreakoutProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="fibBreakoutTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-info" style="font-size: 0.7rem;">RESISTANCE</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="fibResistanceCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-info" id="fibResistanceProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="fibResistanceTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-warning" style="font-size: 0.7rem;">SUPPORT</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="fibSupportCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-warning" id="fibSupportProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="fibSupportTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-shrink-0 levels-card-item">
                                        <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 200px;">
                                            <div class="card-header bg-transparent border-0 py-1">
                                                <h6 class="mb-0 text-center text-danger" style="font-size: 0.7rem;">BREAKDOWN</h6>
                                                <small class="text-center d-block text-muted" style="font-size: 0.6rem;" id="fibBreakdownCount">0</small>
                                                <div class="progress mt-1" style="height: 4px; background-color: rgba(40, 50, 60, 0.5);">
                                                    <div class="progress-bar bg-danger" id="fibBreakdownProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </div>
                                            <div class="card-body p-1" style="height: 160px; overflow-y: auto;">
                                                <div id="fibBreakdownTable" class="rvol-table-container"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RVOL Pie Charts - 4 Charts in Single Row -->
        <div class="row mb-3" id="rvol-analysis">
            <div class="col-12">
                <div class="card glow-card section-3d-border" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0f14 100%) !important; padding: 8px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start text-warning fw-bold" style="font-size: 0.75rem;">Volume Buzzing Stocks (5day Avg Vol. Break)</div>
                            <button class="btn btn-sm btn-outline-secondary" id="toggleRvolChart" style="font-size: 0.75rem; padding: 2px 6px;">
                                <i class="fas fa-eye" id="rvolChartToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2" id="rvolChartContainer">
                        <!-- 3 RVOL Tables - Horizontal scrollable -->
                        <div class="d-flex gap-2 levels-scroll-container">
                            <div class="flex-shrink-0 levels-card-item">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 220px;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-danger" style="font-size: 0.75rem;">Above 2X Avg Vol.</h6>
                                        <small class="text-center d-block text-muted" style="font-size: 0.65rem;" id="above2xCount">0 stocks</small>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px; overflow-y: auto;">
                                        <div id="rvolTable1" class="rvol-table-container"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-shrink-0 levels-card-item">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 220px;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-success" style="font-size: 0.75rem;">2x to 1x Avg Vol.</h6>
                                        <small class="text-center d-block text-muted" style="font-size: 0.65rem;" id="range2x1xCount">0 stocks</small>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px; overflow-y: auto;">
                                        <div id="rvolTable2" class="rvol-table-container"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-shrink-0 levels-card-item">
                                <div class="card glow-card" style="background: rgba(20, 25, 30, 0.8); height: auto; width: 220px;">
                                    <div class="card-header bg-transparent border-0 py-1">
                                        <h6 class="mb-0 text-center text-info" style="font-size: 0.75rem;">Below 1X Avg Vol.</h6>
                                        <small class="text-center d-block text-muted" style="font-size: 0.65rem;" id="below1xCount">0 stocks</small>
                                    </div>
                                    <div class="card-body p-1" style="height: 180px; overflow-y: auto;">
                                        <div id="rvolTable3" class="rvol-table-container"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- All 9 Summary Cards in Single Row -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card glow-card" style="background: rgba(10, 15, 20, 0.95); border-radius: 12px;">
                    <div class="card-header bg-transparent border-0" style="background: linear-gradient(135deg, #1a1a1a 0%, #0a0f14 100%) !important; padding: 2px 12px;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start text-info fw-bold" style="font-size: 0.75rem;">F&O Stocks Summary</div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleFOSummary()" id="foToggleBtn" style="font-size: 0.75rem; padding: 2px 6px;">
                                <i class="fas fa-eye" id="foToggleIcon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body py-2" id="foSummaryBody">
                        <div class="row g-1">
                            <!-- Market Movement Cards -->
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-success">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-success" id="gainersCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Gainers</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-danger">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-danger" id="losersCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Losers</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-success">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-success" id="positiveFromOpenCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">+FromOpen</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-danger">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-danger" id="negativeFromOpenCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">-FromOpen</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-info">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-info" id="recoveryCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Recovery</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-warning">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-warning" id="decliningCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Declining</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Market Analytics Cards -->
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-primary">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-primary" id="gapUpCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Gap Up</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-secondary">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-secondary" id="gapDownCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Gap Down</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-success">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-success" id="turnPositiveCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Turn+</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-danger">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-danger" id="turnNegativeCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Turn-</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile" id="avgPercentageCard">
                                <div class="card glow-card glow-success">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-success" id="avgPercentage" style="font-size: 0.9rem;">0.00%</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">Avg %</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-warning">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-warning" id="openHighCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">O=H</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-info">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold text-info" id="openLowCount" style="font-size: 0.9rem;">0</h6>
                                            <small class="text-white" style="font-size: 0.7rem;">O=L</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summary-card-mobile">
                                <div class="card glow-card glow-info text-white">
                                    <div class="card-body text-center py-1 px-1">
                                        <div class="d-flex flex-column align-items-center">
                                            <h6 class="mb-0 fw-bold" id="volumeCount" style="font-size: 0.9rem;">0M</h6>
                                            <small style="font-size: 0.7rem;">Volume</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        

        <!-- My Watchlist Section -->
        <div class="card mb-4" id="watchlistSection">
            <div class="card-header d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #212529 0%, #000000 100%) !important;">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 text-white fw-bold">
                        <i class="fas fa-star me-2"></i>
                        My Analyse Stocks Watchlist
                    </h5>
                    <span class="badge bg-secondary ms-2" id="watchlistCount">0</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <!-- Control Buttons -->
                    <button class="btn btn-sm btn-outline-light" onclick="refreshWatchlist()" title="Refresh Watchlist">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light ms-1" onclick="toggleTable('watchlistTableBody', 'watchlistToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="watchlistToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th style="width: 150px;">Selection Method</th>
                                <th class="text-center" style="width: 70px;">
                                    <i class="fas fa-trash" title="Remove"></i>
                                </th>
                                <th class="text-center" style="width: 120px;">Virtual Trade</th>
                                <th class="text-center" style="width: 100px;">Position</th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">Live LTP ()</th>
                                <th class="text-end">Invest Amt</th>
                                <th class="text-end">Profit/Loss</th>
                                <th class="text-end">% Change</th>
                            </tr>
                        </thead>
                        <tbody id="watchlistTableBody">
                            <tr>
                                <td colspan="10" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-star fa-3x mb-3 d-block"></i>
                                        <h5>No Stocks in Watchlist</h5>
                                        <p>Add stocks to your watchlist by clicking the star button on any stock</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

       


                               
        <!-- F&O Stocks Live Data Title -->
        <h5 class="mb-3">
            <i class="fas fa-table me-2"></i>
            F&O Stocks Live Data
            {% if current_user.is_admin() %}
            <button class="btn btn-danger btn-sm ms-3" id="calculateAllTechnicalBtn" title="Calculate All Technical Levels (Camarilla + CPR + Fibonacci)">
                <i class="fas fa-calculator me-2"></i>Calculate All Technical Levels
            </button>
            {% endif %}
        </h5>

        <!-- Stock Data Table -->
        <div class="card" id="niftyTable">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="window.scrollTo(0,0)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="btn btn-primary btn-sm px-2 py-1" onclick="scrollToTable('niftyTable')">
                            F&O
                        </button>
                        <button class="btn btn-outline-success btn-sm px-2 py-1" onclick="scrollToTable('camarillaTable')">
                            Camarilla
                        </button>
                        <button class="btn btn-outline-warning btn-sm px-2 py-1" onclick="scrollToTable('cprTable')">
                            CPR
                        </button>
                        <button class="btn btn-outline-info btn-sm px-2 py-1" onclick="scrollToTable('fibonacciTable')">
                            Fibonacci
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                        <i class="fas fa-refresh"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleTable('stockTableBody', 'niftyToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="niftyToggleIcon"></i>
                    </button>
                </div>
            </div>


            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th class="text-center" style="width: 70px;">
                                    <i class="fas fa-star" title="Watchlist"></i>
                                </th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">High ()</th>
                                <th class="text-end">Low ()</th>
                                <th class="text-end">Change ()</th>
                                <th class="text-end">Change (%)</th>
                                <th class="text-end">% Open</th>
                                <th class="text-end">% High</th>
                                <th class="text-end">% Low</th>
                                <th class="text-end">% Range</th>
                                <th class="text-end">Prev Close ()</th>
                                <th class="text-end">Volume</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <tr>
                                <td colspan="13" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-chart-line fa-3x mb-3 d-block"></i>
                                        <h5>No Data Available</h5>
                                        <p>Connect to WebSocket to start receiving live market data</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Camarilla Pivot Levels Section -->
        <div class="mb-2 mt-4">
            <h6 class="text-white d-flex align-items-center" style="margin-bottom: 8px; padding-left: 4px;"><i class="fas fa-chart-area me-2"></i>Camarilla Pivot Levels</h6>
        </div>
        <div class="card mt-0" id="camarillaTable">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="window.scrollTo(0,0)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm px-2 py-1" onclick="scrollToTable('niftyTable')">
                            F&O
                        </button>
                        <button class="btn btn-success btn-sm px-2 py-1" onclick="scrollToTable('camarillaTable')">
                            Camarilla
                        </button>
                        <button class="btn btn-outline-warning btn-sm px-2 py-1" onclick="scrollToTable('cprTable')">
                            CPR
                        </button>
                        <button class="btn btn-outline-info btn-sm px-2 py-1" onclick="scrollToTable('fibonacciTable')">
                            Fibonacci
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    {% if current_user.is_admin() %}
                    <button class="btn btn-sm btn-success" id="calculateCamarillaBtn">
                        <i class="fas fa-calculator"></i>
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-primary ms-2" id="refreshCamarillaBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleTable('camarillaTableBody', 'camarillaToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="camarillaToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th>Range</th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">Pivot</th>
                                <th class="text-end">R5</th>
                                <th class="text-end">R4</th>
                                <th class="text-end">R3</th>
                                <th class="text-end">R2</th>
                                <th class="text-end">R1</th>
                                <th class="text-end">S1</th>
                                <th class="text-end">S2</th>
                                <th class="text-end">S3</th>
                                <th class="text-end">S4</th>
                                <th class="text-end">S5</th>

                            </tr>
                        </thead>
                        <tbody id="camarillaTableBody">
                            <tr>
                                <td colspan="15" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-calculator fa-3x mb-3 d-block"></i>
                                        <h5>No Camarilla Data Available</h5>
                                        <p>Click "Calc Levels" to generate Camarilla pivot levels for all stocks</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- CPR Pivot Levels Table -->
        <div class="mb-2 mt-4">
            <h6 class="text-white d-flex align-items-center" style="margin-bottom: 8px; padding-left: 4px;"><i class="fas fa-crosshairs me-2"></i>CPR (Central Pivot Range) Analysis <small class="text-muted ms-2" style="font-size: 0.75rem;">*N=Narrow, *W=Wide</small></h6>
        </div>
        <div class="card mt-0" id="cprTable">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="window.scrollTo(0,0)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm px-2 py-1" onclick="scrollToTable('niftyTable')">
                            F&O
                        </button>
                        <button class="btn btn-outline-success btn-sm px-2 py-1" onclick="scrollToTable('camarillaTable')">
                            Camarilla
                        </button>
                        <button class="btn btn-warning btn-sm px-2 py-1" onclick="scrollToTable('cprTable')">
                            CPR
                        </button>
                        <button class="btn btn-outline-info btn-sm px-2 py-1" onclick="scrollToTable('fibonacciTable')">
                            Fibonacci
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    {% if current_user.is_admin() %}
                    <button class="btn btn-sm btn-warning" id="calculateCprBtn">
                        <i class="fas fa-calculator"></i>
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-primary ms-2" id="refreshCprBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleTable('cprTableBody', 'cprToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="cprToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th>Range</th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">R3</th>
                                <th class="text-end">R2</th>
                                <th class="text-end">R1</th>
                                <th class="text-end">TC (Top Central)</th>
                                <th class="text-end">PP (Pivot)</th>
                                <th class="text-end">BC (Bottom Central)</th>
                                <th class="text-end">S1</th>
                                <th class="text-end">S2</th>
                                <th class="text-end">S3</th>
                                <th class="text-end">CPR Width</th>

                            </tr>
                        </thead>
                        <tbody id="cprTableBody">
                            <tr>
                                <td colspan="14" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-crosshairs fa-3x mb-3 d-block"></i>
                                        <h5>No CPR Data Available</h5>
                                        <p>Click "Calc CPR Levels" to generate Central Pivot Range levels for all stocks</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- Fibonacci Pivot Levels Table -->
        <div class="mb-2 mt-4">
            <h6 class="text-white d-flex align-items-center" style="margin-bottom: 8px; padding-left: 4px;"><i class="fas fa-chart-area me-2"></i>Fibonacci Pivot Analysis</h6>
        </div>
        <div class="card mt-0" id="fibonacciTable">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary btn-sm px-2 py-1" onclick="window.scrollTo(0,0)">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm px-2 py-1" onclick="scrollToTable('niftyTable')">
                            F&O
                        </button>
                        <button class="btn btn-outline-success btn-sm px-2 py-1" onclick="scrollToTable('camarillaTable')">
                            Camarilla
                        </button>
                        <button class="btn btn-outline-warning btn-sm px-2 py-1" onclick="scrollToTable('cprTable')">
                            CPR
                        </button>
                        <button class="btn btn-info btn-sm px-2 py-1" onclick="scrollToTable('fibonacciTable')">
                            Fibonacci
                        </button>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    {% if current_user.is_admin() %}
                    <button class="btn btn-sm btn-info" id="calculateFibBtn">
                        <i class="fas fa-calculator"></i>
                    </button>
                    {% endif %}
                    <button class="btn btn-sm btn-primary ms-2" id="refreshFibBtn">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="toggleTable('fibTableBody', 'fibToggleIcon')" style="font-size: 0.75rem; padding: 2px 6px;">
                        <i class="fas fa-eye" id="fibToggleIcon"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Symbol</th>
                                <th>Range</th>
                                <th class="text-end">LTP ()</th>
                                <th class="text-end">PP (Pivot)</th>
                                <th class="text-end">R3 (161.8%)</th>
                                <th class="text-end">R2 (123.6%)</th>
                                <th class="text-end">R1 (61.8%)</th>
                                <th class="text-end">S1 (61.8%)</th>
                                <th class="text-end">S2 (123.6%)</th>
                                <th class="text-end">S3 (161.8%)</th>
                                <th class="text-end">38.2% Level</th>
                                <th class="text-end">50% Level</th>

                            </tr>
                        </thead>
                        <tbody id="fibTableBody">
                            <tr>
                                <td colspan="13" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-chart-area fa-3x mb-3 d-block"></i>
                                        <h5>No Fibonacci Data Available</h5>
                                        <p>Click "Calc Fibonacci Levels" to generate Fibonacci pivot levels for all stocks</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>


                </div> <!-- Close dashboard-column -->
            </div> <!-- Close container-fluid -->
        </div> <!-- Close flex-grow-1 main content -->
    </div> <!-- Close d-flex layout -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/table-sorter.js') }}"></script>
    <script>
        // LTP Break Alert Window Function
        async function showBreakLevelsAlert() {
            try {
                // Fetch pre-calculated break levels from API
                const response = await fetch('/api/ltp-break-levels');
                const data = await response.json();

                if (data.status === 'success') {
                    const ltpBreakData = Object.values(data.levels);

                    // Sort by most significant breaks first
                    ltpBreakData.sort((a, b) => {
                        if (b.break_count !== a.break_count) {
                            return b.break_count - a.break_count;
                        }
                        return (b.ltp || 0) - (a.ltp || 0);
                    });

                    // Create alert content with only two signals
                    let alertContent = '<div style="height: 300px; overflow-y: auto; font-family: monospace; background: #212529; color: white; padding: 15px; border-radius: 8px;">';
                    alertContent += '<h5 style="color: #17a2b8; margin-bottom: 15px; text-align: center;"><i class="fas fa-chart-line"></i> Break Signals</h5>';

                    if (ltpBreakData.length === 0) {
                        alertContent += '<p style="text-align: center; color: #6c757d;">No break signals available</p>';
                    } else {
                        alertContent += '<table style="width: 100%; border-collapse: collapse; font-size: 14px; background: #2c3034;">';
                        alertContent += '<thead><tr style="background-color: #343a40; color: #17a2b8;">';
                        alertContent += '<th style="padding: 12px; border: 1px solid #495057; text-align: center; width: 40%;">Symbol</th>';
                        alertContent += '<th style="padding: 12px; border: 1px solid #495057; text-align: center; width: 60%;">Break Signal</th>';
                        alertContent += '</tr></thead><tbody>';

                        ltpBreakData.forEach(item => {
                            const breakText = item.breaks && item.breaks.length > 0 ? item.breaks.join(', ') : 'None';
                            const breakColor = item.breaks && item.breaks.length > 0 ? 
                                (item.breaks.some(b => b.includes('H')) ? '#28a745' : '#dc3545') : '#6c757d';

                            alertContent += '<tr style="border-bottom: 1px solid #495057;">';
                            alertContent += `<td style="padding: 10px; border: 1px solid #495057; color: #17a2b8; font-weight: bold; text-align: center; font-size: 16px;">${item.symbol}</td>`;
                            alertContent += `<td style="padding: 10px; border: 1px solid #495057; color: ${breakColor}; text-align: center; font-weight: bold; font-size: 14px;">${breakText}</td>`;
                            alertContent += '</tr>';
                        });

                        alertContent += '</tbody></table>';
                    }

                    // Add legend section
                    alertContent += '<div style="margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 6px; border-left: 4px solid #17a2b8;">';
                    alertContent += '<h6 style="color: #17a2b8; margin-bottom: 10px; font-size: 14px;"><i class="fas fa-info-circle"></i> Legend</h6>';
                    alertContent += '<div style="font-size: 12px; line-height: 1.4;">';
                    alertContent += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">';
                    alertContent += '<span><strong style="color: #ffc107;">PDH:</strong> Previous Day High</span>';
                    alertContent += '<span><strong style="color: #ffc107;">PDL:</strong> Previous Day Low</span>';
                    alertContent += '<span><strong style="color: #ffc107;">WKH:</strong> Weekly High</span>';
                    alertContent += '<span><strong style="color: #ffc107;">WKL:</strong> Weekly Low</span>';
                    alertContent += '</div>';
                    alertContent += '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #495057;">';
                    alertContent += '<span style="color: #28a745;"><strong>Green:</strong> Breakout above resistance levels</span><br>';
                    alertContent += '<span style="color: #dc3545;"><strong>Red:</strong> Breakdown below support levels</span>';
                    alertContent += '</div>';
                    alertContent += '</div>';
                    alertContent += '</div>';

                    alertContent += '</div>';

                    // Create custom alert modal
                    const alertModal = document.createElement('div');
                    alertModal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    `;

                    const alertBox = document.createElement('div');
                    alertBox.style.cssText = `
                        background: #212529;
                        border-radius: 12px;
                        width: 500px;
                        height: 400px;
                        position: relative;
                        border: 2px solid #17a2b8;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    `;

                    const closeBtn = document.createElement('button');
                    closeBtn.innerHTML = '&times;';
                    closeBtn.style.cssText = `
                        position: absolute;
                        top: 10px;
                        right: 15px;
                        background: transparent;
                        border: none;
                        color: #dc3545;
                        font-size: 24px;
                        cursor: pointer;
                        z-index: 10001;
                        padding: 5px;
                        border-radius: 50%;
                        width: 35px;
                        height: 35px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;

                    closeBtn.onclick = () => {
                        document.body.removeChild(alertModal);
                    };

                    // Close on background click
                    alertModal.onclick = (e) => {
                        if (e.target === alertModal) {
                            document.body.removeChild(alertModal);
                        }
                    };

                    alertBox.innerHTML = alertContent;
                    alertBox.appendChild(closeBtn);
                    alertModal.appendChild(alertBox);
                    document.body.appendChild(alertModal);

                } else {
                    alert('Error loading break data: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading LTP break data:', error);
                alert('Failed to load break levels data');
            }
        }

        // Theme Toggle Function
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            
            // Refresh charts with new theme colors
            if (typeof refreshChartsForTheme === 'function') {
                refreshChartsForTheme();
            }
            localStorage.setItem('theme', newTheme);
            
            // Update icon
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            console.log(` Theme switched to: ${newTheme}`);
        }

        // Initialize theme on page load
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Update icon
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        })();

        // Global state for alerts with persistent storage
        let alertsVisible = localStorage.getItem('alertsVisible') !== 'false'; // Default to true

        // Alert Toggle Function
        function toggleAlerts() {
            const alertContainer = document.getElementById('alertContainer');
            const button = document.getElementById('alertToggleBtn');

            if (!alertContainer) {
                console.error(' Alert container not found!');
                return;
            }

            // Toggle state
            alertsVisible = !alertsVisible;
            localStorage.setItem('alertsVisible', alertsVisible.toString());

            if (alertsVisible) {
                // Show alerts
                alertContainer.classList.add('show');

                if (button) {
                    button.classList.add('active');
                    button.style.backgroundColor = '#ffc107';
                    button.style.color = 'black';
                }

                console.log(' ALERTS SHOWN');
            } else {
                // Hide alerts
                alertContainer.classList.remove('show');

                if (button) {
                    button.classList.remove('active');
                    button.style.backgroundColor = '';
                    button.style.color = '';
                }

                console.log(' ALERTS HIDDEN');
            }
        }

        // Initialize alert visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            const alertContainer = document.getElementById('alertContainer');
            const button = document.getElementById('alertToggleBtn');

            if (alertContainer && alertsVisible) {
                alertContainer.classList.add('show');
                if (button) {
                    button.classList.add('active');
                    button.style.backgroundColor = '#ffc107';
                    button.style.color = 'black';
                }
            }
        });






    </script>
    <script>
        // Robust fetch utility with timeout, retries, and proper error handling
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            const delays = [500, 1000, 2000]; // Exponential backoff: 0.5s, 1s, 2s
            let lastError;

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout for heavy technical analysis

                try {
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    // Check if response is ok and content type is JSON
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Server returned non-JSON response');
                    }

                    return response;

                } catch (error) {
                    clearTimeout(timeoutId);
                    lastError = error;

                    // Log meaningful error info
                    console.error(`Fetch attempt ${attempt + 1}/${maxRetries} failed for ${url}:`, {
                        message: error.message,
                        name: error.name,
                        stack: error.stack
                    });

                    // Don't retry if it's a user abort or final attempt
                    if (error.name === 'AbortError' && attempt < maxRetries - 1) {
                        console.warn(`Request to ${url} timed out, retrying in ${delays[attempt]}ms...`);
                    } else if (attempt >= maxRetries - 1) {
                        break; // Final attempt failed
                    }

                    // Wait before retrying (exponential backoff)
                    if (attempt < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delays[attempt]));
                    }
                }
            }

            // All attempts failed, throw the last error with context
            throw new Error(`Failed to fetch ${url} after ${maxRetries} attempts: ${lastError.message}`);
        }

        class Dashboard {
            constructor() {
                this.eventSource = null;
                this.stockData = {};
                // Initialize global window stockData for enhanced alerts
                window.stockData = {};
                this.isConnected = false;
                // Sparkline buffers removed for performance optimization
                // Cache for CPR data to avoid multiple API calls for index cards
                this.cprDataCache = {};
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkWebSocketStatus();
                this.updateGlobalTimestamp();

                // Auto-start WebSocket connection only for admin users
                {% if is_admin %}
                setTimeout(() => this.connectWebSocket(), 2000); // Admin starts WebSocket after 2 seconds
                {% endif %}
                {% if is_admin %}
                this.loadFetchLogs(); // Load historical data logs on initialization (admin only)
                {% endif %}

                // All authenticated users can view technical analysis data calculated by admin
                this.loadCamarillaData(); // Load Camarilla data on initialization
                this.loadCprData(); // Load CPR data on initialization
                this.loadFibonacciData(); // Load Fibonacci data on initialization

                // CPR data caching removed - badges no longer needed

                // Start EventSource for live data streaming (original working method)
                this.startLiveDataPolling();
                this.refreshData(); // Load initial data

                setInterval(() => this.updateGlobalTimestamp(), 2000);

                // Immediate status check for users
                setTimeout(() => this.checkWebSocketStatus(), 3000); // Check status after 3 seconds
                setInterval(() => this.checkWebSocketStatus(), 15000); // Check status every 15 seconds

                // Initialize market statistics bars
                this.initializePercentageBars();

                // Load cached index data on startup
                this.loadCachedDataForAllIndexes();
            }

            initializePercentageBars() {
                console.log('Initializing market statistics bars...');

                // Delay initial update to ensure table is loaded
                setTimeout(() => {
                    // Performance: Removed hot-path logging
                    this.updateMarketStatsBars();
                }, 2000);
            }

            updateMarketStatsBars() {
                // Performance: Removed hot-path logging

                // Get counts from existing F&O summary cards  
                const gainersCount = document.getElementById('gainersCount')?.textContent || '0';
                const losersCount = document.getElementById('losersCount')?.textContent || '0';
                const recoveryCount = document.getElementById('recoveryCount')?.textContent || '0';
                const decliningCount = document.getElementById('decliningCount')?.textContent || '0';
                const turnPositiveCount = document.getElementById('turnPositiveCount')?.textContent || '0';
                const turnNegativeCount = document.getElementById('turnNegativeCount')?.textContent || '0';

                // Get individual O=H and O=L counts from separate cards
                const openHighCount = document.getElementById('openHighCount')?.textContent || '0';
                const openLowCount = document.getElementById('openLowCount')?.textContent || '0';

                // Get total stocks count
                const total = parseInt(document.getElementById('symbolCount')?.textContent || '50');

                // Update the progress bars using existing counts
                this.updateProgressBarFromCount('gainers', parseInt(gainersCount), total);
                this.updateProgressBarFromCount('losers', parseInt(losersCount), total);
                this.updateProgressBarFromCount('recovery', parseInt(recoveryCount), total);
                this.updateProgressBarFromCount('declining', parseInt(decliningCount), total);
                this.updateProgressBarFromCount('turnPositive', parseInt(turnPositiveCount), total);
                this.updateProgressBarFromCount('turnNegative', parseInt(turnNegativeCount), total);
                this.updateProgressBarFromCount('openHigh', parseInt(openHighCount), total);
                this.updateProgressBarFromCount('openLow', parseInt(openLowCount), total);

                // Performance: Removed hot-path logging - was impacting update speed
            }

            updateProgressBarFromCount(type, count, total) {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;

                const countElement = document.getElementById(`${type}BarCount`);
                const barElement = document.getElementById(`${type}Bar`);

                if (countElement) {
                    countElement.textContent = count;
                }

                if (barElement) {
                    barElement.style.width = percentage + '%';
                }
            }

            // Refresh functions for manual data reload
            async refreshCamarillaData() {
                const btn = document.getElementById('refreshCamarillaBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';

                    await this.loadCamarillaData();
                    this.showAlert('success', 'Camarilla data refreshed successfully');
                } catch (error) {
                    console.error('Error refreshing Camarilla data:', error);
                    this.showAlert('danger', 'Error refreshing Camarilla data');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async refreshCprData() {
                const btn = document.getElementById('refreshCprBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';

                    await this.loadCprData();
                    this.showAlert('success', 'CPR data refreshed successfully');
                } catch (error) {
                    console.error('Error refreshing CPR data:', error);
                    this.showAlert('danger', 'Error refreshing CPR data');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async refreshFibonacciData() {
                const btn = document.getElementById('refreshFibBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';

                    await this.loadFibonacciData();
                    this.showAlert('success', 'Fibonacci data refreshed successfully');
                } catch (error) {
                    console.error('Error refreshing Fibonacci data:', error);
                    this.showAlert('danger', 'Error refreshing Fibonacci data');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            bindEvents() {
                // Update the connect button to be historical data fetch
                // Removed connectBtn reference as button doesn't exist
                // Auto-connecting on page load - no manual connect button needed

                {
                    // Handle historical button if connect button doesn't exist
                    const historicalBtn = document.getElementById('fetchHistoricalBtn');
                    if (historicalBtn) {
                        historicalBtn.addEventListener('click', () => {
                            this.fetchHistoricalData();
                        });
                    }
                }

                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.refreshData();
                });

                const fetchHistoricalBtnNav = document.getElementById('fetchHistoricalBtnNav');
                if (fetchHistoricalBtnNav) {
                    fetchHistoricalBtnNav.addEventListener('click', () => {
                        this.fetchHistoricalData();
                    });
                }

                // Admin streaming control buttons
                const stopStreamingBtn = document.getElementById('stopStreamingBtn');
                if (stopStreamingBtn) {
                    stopStreamingBtn.addEventListener('click', () => {
                        this.stopStreaming();
                    });
                }

                const startStreamingBtn = document.getElementById('startStreamingBtn');
                if (startStreamingBtn) {
                    startStreamingBtn.addEventListener('click', () => {
                        this.startStreaming();
                    });
                }

                // Legacy support for existing historical buttons if they exist
                const fetchHistoricalBtn = document.getElementById('fetchHistoricalBtn');
                if (fetchHistoricalBtn) {
                    fetchHistoricalBtn.addEventListener('click', () => {
                        this.fetchHistoricalData();
                    });
                }

                const fetchAllHistoricalBtn = document.getElementById('fetchAllHistoricalBtn');
                if (fetchAllHistoricalBtn) {
                    fetchAllHistoricalBtn.addEventListener('click', () => {
                        this.fetchAllHistoricalData();
                    });
                }

                const calculateCamarillaBtn = document.getElementById('calculateCamarillaBtn');
                if (calculateCamarillaBtn) {
                    calculateCamarillaBtn.addEventListener('click', () => {
                        this.calculateCamarillaLevels();
                    });
                }

                const calculateCprBtn = document.getElementById('calculateCprBtn');
                if (calculateCprBtn) {
                    calculateCprBtn.addEventListener('click', () => {
                        this.calculateCprLevels();
                    });
                }

                const calculateFibBtn = document.getElementById('calculateFibBtn');
                if (calculateFibBtn) {
                    calculateFibBtn.addEventListener('click', () => {
                        this.calculateFibonacciLevels();
                    });
                }

                // Master Calculate All Technical Levels button
                const calculateAllTechnicalBtn = document.getElementById('calculateAllTechnicalBtn');
                if (calculateAllTechnicalBtn) {
                    calculateAllTechnicalBtn.addEventListener('click', () => {
                        this.calculateAllTechnicalLevels();
                    });
                }

                // Add refresh button event handlers
                const refreshCamarillaBtn = document.getElementById('refreshCamarillaBtn');
                if (refreshCamarillaBtn) {
                    refreshCamarillaBtn.addEventListener('click', () => {
                        this.refreshCamarillaData();
                    });
                }

                const refreshCprBtn = document.getElementById('refreshCprBtn');
                if (refreshCprBtn) {
                    refreshCprBtn.addEventListener('click', () => {
                        this.refreshCprData();
                    });
                }

                const refreshFibBtn = document.getElementById('refreshFibBtn');
                if (refreshFibBtn) {
                    refreshFibBtn.addEventListener('click', () => {
                        this.refreshFibonacciData();
                    });
                }
            }

            async connectWebSocket() {
                try {
                    const response = await fetch('/start_websocket');
                    const result = await response.json();

                    if (result.status === 'success') {
                        this.showAlert('success', 'Connected to live market data');
                        this.startLiveDataPolling();
                        // WebSocket connected
                    } else {
                        this.showAlert('danger', `Connection failed: ${result.message}`);
                    }
                } catch (error) {
                    this.showAlert('danger', `Connection error: ${error.message}`);
                }
            }

            startLiveDataPolling() {
                // Initialize batching variables
                this.pendingUpdates = new Set();
                this.lastDOMUpdate = 0;

                this.pollingInterval = setInterval(async () => {
                    try {
                        const response = await fetch('/stock_data');

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const result = await response.json();

                        if (result && result.data && typeof result.data === 'object') {
                            // Process stock data with batching
                            Object.values(result.data).forEach(data => {
                                if (data && data.symbol) {
                                    this.updateStockData(data);
                                    // Also update window.stockData for enhanced alerts
                                    window.stockData[data.full_symbol] = data;
                                    this.pendingUpdates.add(data.full_symbol);
                                }
                            });

                            // Process real-time alerts from the stream
                            if (result.alerts && window.alertSystem) {
                                window.alertSystem.processAlertsFromStream(result.alerts);
                            }

                            // Smooth DOM updates - optimized for fast streaming
                            const now = Date.now();
                            if (now - this.lastDOMUpdate >= 150) {
                                requestAnimationFrame(() => {
                                    this.batchedDOMUpdate();
                                });
                                this.lastDOMUpdate = now;
                            }
                        }

                        // Check WebSocket status separately (less frequent)
                        if (Date.now() - (this.lastStatusCheck || 0) >= 5000) {
                            this.checkWebSocketStatus();
                            this.lastStatusCheck = Date.now();
                        }

                    } catch (error) {
                        // Only log error if it's not a typical network error
                        if (error.message && !error.message.includes('NetworkError')) {
                            console.error('Polling error:', error.message);
                        }
                        this.updateConnectionStatus({ status: 'error', is_connected: false });
                    }
                }, 500); // Fast polling for real-time WebSocket streaming
            }

            batchedDOMUpdate() {
                if (this.pendingUpdates.size === 0) return;

                // Efficiently update only changed elements
                this.renderStockTable();
                this.updateMarketStatsBars();

                // Update technical analysis tables for pending symbols only
                this.pendingUpdates.forEach(symbol => {
                    const data = this.stockData[symbol];
                    if (data) {
                        this.updateCamarillaLTP(data);
                        if (this.updateCprLTP) this.updateCprLTP(data);
                        if (this.updateFibonacciLTP) this.updateFibonacciLTP(data);
                    }
                });

                // Clear pending updates
                this.pendingUpdates.clear();
            }

            stopLiveDataPolling() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                    this.pollingInterval = null;
                }
            }

            updateStockData(data) {
                if (!data || !data.full_symbol) {
                    return;
                }

                // Track previous price for animation
                const previousData = this.stockData[data.full_symbol];
                const previousPrice = previousData ? parseFloat(previousData.ltp) : null;
                const currentPrice = parseFloat(data.ltp);


                this.stockData[data.full_symbol] = data;
                // Also update window.stockData for enhanced alerts
                window.stockData[data.full_symbol] = data;

                // Simple rolling number animation for price changes
                if (previousPrice && currentPrice && !isNaN(previousPrice) && !isNaN(currentPrice) && Math.abs(previousPrice - currentPrice) > 0.001) {
                    this.rollNumber(data.symbol || data.full_symbol);
                }

                // Update INDEX SUMMARY cards if this is an INDEX symbol (immediate update for critical info)
                if (data.full_symbol && data.full_symbol.includes('-INDEX')) {
                    this.updateIndexCards(data);
                }
                
                // Update F&O Stocks in Action cards with real-time data
                this.updateStocksInActionCard(data);

                // Note: DOM table updates are now batched in batchedDOMUpdate()
                // Only update symbol count immediately for user feedback
                const symbolCountEl = document.getElementById('symbolCount');
                if (symbolCountEl) symbolCountEl.textContent = Object.keys(this.stockData).length;
            }
            
            updateStocksInActionCard(data) {
                // Only update if we have card metadata
                if (!this.stocksInActionMeta) return;
                
                // Safely extract symbol with fallback
                if (!data.symbol && !data.full_symbol) return;
                const symbol = (data.symbol ? data.symbol : data.full_symbol).replace('NSE:', '').replace('-EQ', '').replace('-INDEX', '');
                
                const card = document.querySelector(`.stock-action-card[data-action-symbol="${symbol}"]`);
                
                if (!card) return;
                
                // Update LTP
                const ltpEl = card.querySelector('.action-ltp');
                if (ltpEl && data.ltp) {
                    ltpEl.textContent = '' + this.formatNumber(data.ltp);
                }
                
                // Update change percent
                const changeEl = card.querySelector('.action-change');
                if (changeEl && data.change_percent !== undefined) {
                    const changePercent = data.change_percent || 0;
                    const changeColor = changePercent >= 0 ? 'text-success' : 'text-danger';
                    const changeSign = changePercent >= 0 ? '+' : '';
                    
                    changeEl.className = `${changeColor} fw-bold action-change`;
                    changeEl.style.fontSize = '0.8rem';
                    changeEl.textContent = `${changeSign}${this.formatNumber(changePercent)}%`;
                }
                
                // Update from open
                const fromOpenEl = card.querySelector('.action-from-open');
                if (fromOpenEl && data.open_price && data.ltp) {
                    const fromOpen = ((data.ltp - data.open_price) / data.open_price * 100);
                    const color = fromOpen >= 0 ? 'text-success' : 'text-danger';
                    fromOpenEl.className = `action-from-open ${color}`;
                    fromOpenEl.textContent = `${fromOpen >= 0 ? '+' : ''}${this.formatNumber(fromOpen)}%`;
                }
                
                // Update from low
                const fromLowEl = card.querySelector('.action-from-low');
                if (fromLowEl && data.low_price && data.ltp) {
                    const fromLow = ((data.ltp - data.low_price) / data.low_price * 100);
                    const color = fromLow >= 0 ? 'text-success' : 'text-danger';
                    fromLowEl.className = `action-from-low ${color}`;
                    fromLowEl.textContent = `${fromLow >= 0 ? '+' : ''}${this.formatNumber(fromLow)}%`;
                }
                
                // Update from high
                const fromHighEl = card.querySelector('.action-from-high');
                if (fromHighEl && data.high_price && data.ltp) {
                    const fromHigh = ((data.ltp - data.high_price) / data.high_price * 100);
                    const color = fromHigh >= 0 ? 'text-success' : 'text-danger';
                    fromHighEl.className = `action-from-high ${color}`;
                    fromHighEl.textContent = `${fromHigh >= 0 ? '+' : ''}${this.formatNumber(fromHigh)}%`;
                }
            }

            // Simple rolling number animation
            rollNumber(symbol) {
                const symbolCode = symbol.replace('NSE:', '').replace('-EQ', '').replace('-INDEX', '');

                // Find F&O table row
                const rows = document.querySelectorAll('#stockTableBody tr');
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const symbolCell = row.querySelector('td:first-child a');
                    if (symbolCell && symbolCell.textContent.trim() === symbolCode) {
                        const priceCell = row.querySelector('td:nth-child(3)');
                        if (priceCell) {
                            this.applyRollingAnimation(priceCell);
                        }
                        break;
                    }
                }
            }

            // Rolling animation for index cards
            rollNumberIndex(priceElement) {
                if (priceElement) {
                    this.applyRollingAnimation(priceElement);
                }
            }

            // Clean rolling animation
            applyRollingAnimation(element) {
                element.classList.add('rolling-number', 'updating');
                setTimeout(() => {
                    element.classList.remove('updating');
                }, 200);
            }

            // Index cache management
            cacheIndexData(symbol, data) {
                try {
                    const cacheKey = `index_cache_${symbol}`;
                    const cachedData = {
                        symbol: symbol,
                        data: data,
                        timestamp: Date.now(),
                        cached: true
                    };
                    localStorage.setItem(cacheKey, JSON.stringify(cachedData));
                } catch (e) {
                    console.warn('Failed to cache index data:', e);
                }
            }

            getCachedIndexData(symbol, maxAgeMinutes = 30) {
                try {
                    const cacheKey = `index_cache_${symbol}`;
                    const cached = localStorage.getItem(cacheKey);
                    if (!cached) return null;

                    const cachedData = JSON.parse(cached);
                    const ageMinutes = (Date.now() - cachedData.timestamp) / (1000 * 60);

                    if (ageMinutes <= maxAgeMinutes) {
                        return cachedData.data;
                    } else {
                        // Remove expired cache
                        localStorage.removeItem(cacheKey);
                        return null;
                    }
                } catch (e) {
                    console.warn('Failed to retrieve cached index data:', e);
                    return null;
                }
            }

            loadCachedDataForAllIndexes() {
                // Load cached data for all index cards on page load
                document.querySelectorAll('[data-index-symbol]').forEach(indexCard => {
                    const symbol = indexCard.getAttribute('data-index-symbol');
                    const cachedData = this.getCachedIndexData(symbol);
                    if (cachedData) {
                        this.updateIndexCardDisplay(indexCard, cachedData, true);
                    }
                });
            }

            updateIndexCards(data) {
                // Find INDEX card with matching symbol
                const indexCard = document.querySelector(`[data-index-symbol="${data.full_symbol}"]`);

                if (indexCard) {
                    if (data.ltp) {
                        // Cache valid data for future use
                        this.cacheIndexData(data.full_symbol, data);
                        this.updateIndexCardDisplay(indexCard, data, false);

                        // Update AI market comment based on index analysis
                        this.updateAIMarketComment();
                    } else {
                        // Try to use cached data as fallback
                        const cachedData = this.getCachedIndexData(data.full_symbol);
                        if (cachedData) {
                            console.log(`Using cached data for ${data.full_symbol}`);
                            this.updateIndexCardDisplay(indexCard, cachedData, true);
                        }
                    }
                }
            }

            updateIndexCardDisplay(indexCard, data, isCache) {
                if (indexCard && data.ltp) {
                    const priceEl = indexCard.querySelector('.index-price');
                    const changeEl = indexCard.querySelector('.index-change');
                    const ohlcEl = indexCard.querySelector('.index-ohlc');

                    if (priceEl) {
                        // Get previous price for animation
                        const currentPriceText = priceEl.textContent;
                        let previousPrice = null;

                        if (currentPriceText && currentPriceText !== '') {
                            // Parse the current displayed price (remove commas)
                            previousPrice = parseFloat(currentPriceText.replace(/,/g, ''));
                        }

                        const currentPrice = parseFloat(data.ltp);

                        // Simple rolling number for index price changes
                        if (!isCache && previousPrice && previousPrice !== currentPrice) {
                            this.rollNumberIndex(priceEl);
                        }

                        const priceText = currentPrice.toLocaleString('en-IN', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });

                        priceEl.textContent = priceText;
                    }

                    // Update %Open percentage (change from open to current LTP)
                    const openPercentEl = indexCard.querySelector('.index-open-percent');
                    if (openPercentEl && data.open_price && data.ltp) {
                        const open = parseFloat(data.open_price);
                        const ltp = parseFloat(data.ltp);

                        const openPercent = ((ltp - open) / open) * 100;
                        const openPercentFormatted = openPercent.toFixed(1);

                        openPercentEl.textContent = `%O:${openPercent >= 0 ? '+' : ''}${openPercentFormatted}`;

                        // Color the %Open based on positive/negative
                        if (openPercent > 0) {
                            openPercentEl.style.color = '#28a745'; // Green
                        } else if (openPercent < 0) {
                            openPercentEl.style.color = '#dc3545'; // Red
                        } else {
                            openPercentEl.style.color = '#ffffff'; // White for neutral
                        }
                    }

                    if (changeEl) {
                        // Try to get change data from various possible fields
                        let change = null;
                        let changePercent = null;

                        // Check for change data in different field names
                        if (data.ch !== undefined && data.chp !== undefined) {
                            change = parseFloat(data.ch);
                            changePercent = parseFloat(data.chp);
                        } else if (data.change !== undefined && data.change_percent !== undefined) {
                            change = parseFloat(data.change);
                            changePercent = parseFloat(data.change_percent);
                        } else if (data.ltp && data.prev_close_price) {
                            // Calculate change if we have current and previous prices
                            const currentPrice = parseFloat(data.ltp);
                            const prevPrice = parseFloat(data.prev_close_price);
                            change = currentPrice - prevPrice;
                            changePercent = (change / prevPrice) * 100;
                        }

                        if (change !== null && changePercent !== null && !isNaN(change) && !isNaN(changePercent)) {
                            const sign = change >= 0 ? '+' : '';
                            changeEl.textContent = `${sign}${change.toFixed(2)} (${sign}${changePercent.toFixed(2)}%)`;

                            // Update color and glow effect based on change
                            indexCard.className = indexCard.className.replace(/glow-(success|danger|secondary)/, '');
                            if (change > 0) {
                                indexCard.classList.add('glow-success');
                                changeEl.className = 'index-change text-success';
                                priceEl.className = 'index-price h6 mb-0 text-success';
                            } else if (change < 0) {
                                indexCard.classList.add('glow-danger'); 
                                changeEl.className = 'index-change text-danger';
                                priceEl.className = 'index-price h6 mb-0 text-danger';
                            } else {
                                indexCard.classList.add('glow-secondary');
                                changeEl.className = 'index-change text-white';
                                priceEl.className = 'index-price h6 mb-0 text-white';
                            }
                        } else {
                            // If no change data available, keep the card neutral
                            indexCard.className = indexCard.className.replace(/glow-(success|danger|secondary)/, '');
                            indexCard.classList.add('glow-secondary');
                            changeEl.className = 'index-change text-white';
                            priceEl.className = 'index-price h6 mb-0 text-white';
                        }
                    }

                    // Add O=H/O=L pattern tags and CPR range tags to index cards
                    this.updateIndexTags(indexCard, data);
                }
            }

            updateIndexTags(indexCard, data) {
                // Create or update tags container
                let tagsEl = indexCard.querySelector('.index-tags');
                if (!tagsEl) {
                    tagsEl = document.createElement('div');
                    tagsEl.className = 'index-tags d-flex justify-content-center flex-wrap gap-1 mt-1';
                    const cardBody = indexCard.querySelector('.card-body');
                    if (cardBody) {
                        cardBody.appendChild(tagsEl);
                    }
                }

                let tagsHtml = '';

                // Defensive checks for field name variations
                const open = this.getFieldValue(data, ['open_price', 'open']);
                const high = this.getFieldValue(data, ['high_price', 'high']);
                const low = this.getFieldValue(data, ['low_price', 'low']);
                const ltp = data.ltp;

                // O=H/O=L pattern tags (same logic as F&O stock table)
                if (open && high && low && ltp) {
                    const openVal = parseFloat(open);
                    const highVal = parseFloat(high);
                    const lowVal = parseFloat(low);

                    const isOpenHigh = Math.abs(openVal - highVal) <= (highVal * 0.001); // 0.1% tolerance
                    const isOpenLow = Math.abs(openVal - lowVal) <= (lowVal * 0.001); // 0.1% tolerance

                    if (isOpenHigh) {
                        tagsHtml += '<span class="badge bg-primary" style="font-size: 0.3rem; padding: 1px 3px;">O=H</span>';
                    } else if (isOpenLow) {
                        tagsHtml += '<span class="badge bg-warning" style="font-size: 0.3rem; padding: 1px 3px;">O=L</span>';
                    }
                }

                // CPR badges removed for cleaner display

                tagsEl.innerHTML = tagsHtml;
            }

            // CPR tag function removed - badges no longer displayed

            // Helper function to get field value with fallback names
            getFieldValue(data, fieldNames) {
                for (const fieldName of fieldNames) {
                    if (data[fieldName] !== undefined && data[fieldName] !== null) {
                        return data[fieldName];
                    }
                }
                return null;
            }

            // AI Market Comment Generator based on Index Analysis
            updateAIMarketComment() {
                try {
                    const mainIndices = [
                        'NSE:NIFTY50-INDEX',
                        'NSE:NIFTYBANK-INDEX', 
                        'NSE:FINNIFTY-INDEX',
                        'BSE:SENSEX-INDEX'
                    ];

                    const indexData = [];
                    let validDataCount = 0;

                    // Collect data for main 4 indices
                    mainIndices.forEach(symbol => {
                        const cachedData = this.getCachedIndexData(symbol);
                        if (cachedData) {
                            // Try to get percentage change with robust extraction
                            let changePercent = cachedData.change_percent ?? cachedData.ch_per ?? cachedData.chp;

                            // If no direct percentage field, calculate from available data
                            if (changePercent === undefined || changePercent === null) {
                                if (cachedData.ltp && cachedData.prev_close_price) {
                                    const ltp = Number(cachedData.ltp);
                                    const prevClose = Number(cachedData.prev_close_price);
                                    if (Number.isFinite(ltp) && Number.isFinite(prevClose) && prevClose > 0) {
                                        changePercent = ((ltp - prevClose) / prevClose) * 100;
                                    }
                                } else if (cachedData.ltp && cachedData.open_price) {
                                    const ltp = Number(cachedData.ltp);
                                    const open = Number(cachedData.open_price);
                                    if (Number.isFinite(ltp) && Number.isFinite(open) && open > 0) {
                                        changePercent = ((ltp - open) / open) * 100;
                                    }
                                }
                            }

                            // Ensure we have a valid numeric value (including 0)
                            const numericChange = Number(changePercent);
                            if (Number.isFinite(numericChange)) {
                                indexData.push({
                                    symbol: symbol,
                                    change: numericChange
                                });
                                validDataCount++;
                            }
                        }
                    });

                    // AI comment functionality removed per user request
                } catch (error) {
                    console.error('Error in market overview update:', error);
                }
            }

            // CPR data caching and badge functions removed for cleaner display

            updateCamarillaLTP(data) {
                // Update LTP in Camarilla table if symbol exists
                const symbol = data.symbol;
                const ltp = data.ltp;

                if (symbol && ltp) {
                    const ltpCell = document.querySelector(`#camarillaTableBody tr[data-symbol="${symbol}"] .ltp-value`);
                    if (ltpCell) {
                        const row = ltpCell.closest('tr');

                        // Get previous close from change percentage calculation
                        const changePercent = data.change_percent || data.chp;
                        let prevClose = null;

                        if (changePercent !== undefined && changePercent !== 0) {
                            prevClose = ltp / (1 + (changePercent / 100));
                        }

                        // Apply color based on change percentage
                        const colorClass = this.getLtpColorClass(ltp, prevClose);
                        ltpCell.className = `text-end ltp-value ${colorClass}`;
                        ltpCell.textContent = `${ltp.toFixed(2)}`;

                        // Update Range column and S/R tags with real-time calculation
                        if (row && row.cells[1]) {
                            // Extract Camarilla levels from data attributes (robust parsing)
                            const camarillaItem = {
                                pivot: parseFloat(row.cells[3]?.getAttribute('data-value') || '0'),
                                r5: parseFloat(row.cells[4]?.getAttribute('data-value') || '0'),
                                r4: parseFloat(row.cells[5]?.getAttribute('data-value') || '0'),
                                r3: parseFloat(row.cells[6]?.getAttribute('data-value') || '0'),
                                r2: parseFloat(row.cells[7]?.getAttribute('data-value') || '0'),
                                r1: parseFloat(row.cells[8]?.getAttribute('data-value') || '0'),
                                s1: parseFloat(row.cells[9]?.getAttribute('data-value') || '0'),
                                s2: parseFloat(row.cells[10]?.getAttribute('data-value') || '0'),
                                s3: parseFloat(row.cells[11]?.getAttribute('data-value') || '0'),
                                s4: parseFloat(row.cells[12]?.getAttribute('data-value') || '0'),
                                s5: parseFloat(row.cells[13]?.getAttribute('data-value') || '0'),
                                prev_close: prevClose
                            };

                            // Update range column with real-time calculation
                            row.cells[1].innerHTML = this.getCamarillaRange(ltp, camarillaItem);

                            // Recalculate immediate support/resistance levels
                            const levels = [
                                { name: 'R5', value: camarillaItem.r5 },
                                { name: 'R4', value: camarillaItem.r4 },
                                { name: 'R3', value: camarillaItem.r3 },
                                { name: 'R2', value: camarillaItem.r2 },
                                { name: 'R1', value: camarillaItem.r1 },
                                { name: 'S1', value: camarillaItem.s1 },
                                { name: 'S2', value: camarillaItem.s2 },
                                { name: 'S3', value: camarillaItem.s3 },
                                { name: 'S4', value: camarillaItem.s4 },
                                { name: 'S5', value: camarillaItem.s5 }
                            ];

                            const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);

                            // Update all level columns with new S/R indicators
                            const levelCells = [
                                { cell: row.cells[3], level: 'Pivot', value: camarillaItem.pivot },
                                { cell: row.cells[4], level: 'R5', value: camarillaItem.r5 },
                                { cell: row.cells[5], level: 'R4', value: camarillaItem.r4 },
                                { cell: row.cells[6], level: 'R3', value: camarillaItem.r3 },
                                { cell: row.cells[7], level: 'R2', value: camarillaItem.r2 },
                                { cell: row.cells[8], level: 'R1', value: camarillaItem.r1 },
                                { cell: row.cells[9], level: 'S1', value: camarillaItem.s1 },
                                { cell: row.cells[10], level: 'S2', value: camarillaItem.s2 },
                                { cell: row.cells[11], level: 'S3', value: camarillaItem.s3 },
                                { cell: row.cells[12], level: 'S4', value: camarillaItem.s4 },
                                { cell: row.cells[13], level: 'S5', value: camarillaItem.s5 }
                            ];

                            levelCells.forEach(({ cell, level, value }) => {
                                if (cell) {
                                    const srTag = this.getImmediateLevelTag(level, immediateResistance, immediateSupport);
                                    cell.innerHTML = `${srTag}${value.toFixed(2)}`;
                                }
                            });
                        }

                        // Update break status indicators
                        this.updateBreakStatus(symbol, ltp);
                    }
                }
            }

            formatPrice(price) {
                if (price === null || price === undefined) return '-';
                return parseFloat(price).toFixed(2);
            }

            updateBreakStatus(symbol, ltp) {
                // Find the row for this symbol
                const row = document.querySelector(`#camarillaTableBody tr[data-symbol="${symbol}"]`);
                if (!row) return;

                // Determine current break level (same logic as in renderCamarillaTable)
                let breakLevel = 'None';

                // Apply color coding to all levels based on level type
                row.querySelectorAll('.level-value').forEach(cell => {
                    const levelAttr = cell.getAttribute('data-level');
                    const colorClass = this.getLevelColorClass(levelAttr);
                    cell.className = `text-end level-value ${colorClass}`;
                });
            }

            updateConnectionStatus(status) {
                // Connection status display hidden per user request
                // Keeping wrapper hidden
                const wrapper = document.getElementById('connectionStatusWrapper');
                if (wrapper) wrapper.style.display = 'none';
                
                this.isConnected = status.is_connected;

                const symbolCountEl = document.getElementById('symbolCount');
                if (symbolCountEl) symbolCountEl.textContent = status.symbol_count || 0;

                // Update WebSocket status indicator dot
                const indicator = document.getElementById('connectionIndicator');
                if (indicator) {
                    if (status.is_connected) {
                        indicator.style.color = '#28a745'; // Green for connected
                        indicator.parentElement.title = 'WebSocket Connected';
                    } else {
                        indicator.style.color = '#dc3545'; // Red for disconnected
                        indicator.parentElement.title = 'WebSocket Disconnected';
                    }
                }
            }

            renderStockTable() {
                const tbody = document.getElementById('stockTableBody');

                if (Object.keys(this.stockData).length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="13" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-chart-line fa-3x mb-3 d-block"></i>
                                    <h5>No Data Available</h5>
                                    <p>Connect to WebSocket to start receiving live market data</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Check if table is currently sorted to preserve sort state
                const niftyTable = document.getElementById('niftyTable');
                let currentSortColumn = -1;
                let currentSortDirection = null;

                if (niftyTable) {
                    const headers = niftyTable.querySelectorAll('thead th');
                    headers.forEach((header, index) => {
                        const sortDirection = header.getAttribute('data-sort-direction');
                        if (sortDirection && (sortDirection === 'asc' || sortDirection === 'desc')) {
                            currentSortColumn = index;
                            currentSortDirection = sortDirection;
                        }
                    });
                }

                // Use data in the order received from backend (already properly ordered)
                const sortedData = Object.values(this.stockData);

                tbody.innerHTML = sortedData.map(stock => {
                    const changeClass = stock.change >= 0 ? 'text-success' : 'text-danger';
                    const changeIcon = stock.change >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                    const statusIcon = this.isDataFresh(stock.timestamp) ? 
                        '<i class="fas fa-circle text-success" title="Live"></i>' : 
                        '<i class="fas fa-circle text-warning" title="Stale"></i>';

                    // Use real OHLC values from stock data
                    const high = stock.high_price || 0;
                    const low = stock.low_price || 0; 
                    const open = stock.open_price || 0;
                    const ltp = stock.ltp;

                    const percentOpen = (open && ltp) ? ((ltp - open) / open * 100) : 0;
                    const percentHigh = (high && ltp) ? ((ltp - high) / high * 100) : 0;
                    const percentLow = (low && ltp) ? ((ltp - low) / low * 100) : 0;
                    const percentRange = (high && low && low > 0) ? ((high - low) / low * 100) : 0;

                    // Color classes for percentage columns
                    const openClass = percentOpen >= 0 ? 'text-success' : 'text-danger';
                    const highClass = percentHigh >= 0 ? 'text-success' : 'text-danger';
                    const lowClass = percentLow >= 0 ? 'text-success' : 'text-danger';

                    // Check for O=H and O=L patterns with color badges (consistent logic)
                    const isOpenHigh = Math.abs(open - high) <= (high * 0.001); // 0.1% tolerance
                    const isOpenLow = Math.abs(open - low) <= (low * 0.001); // 0.1% tolerance

                    let patternBadge = '';
                    if (isOpenHigh) {
                        patternBadge = ' <span class="text-primary ms-1" style="font-size: 0.7em;">O=H</span>';
                    } else if (isOpenLow) {
                        patternBadge = ' <span class="text-warning ms-1" style="font-size: 0.7em;">O=L</span>';
                    }

                    // Extract symbol for TradingView URL (like technical analysis tables)
                    const symbolCode = stock.symbol.replace('NSE:', '').replace('-EQ', '');
                    const chartSymbol = `NSE:${symbolCode}`;
                    const chartUrl = `https://in.tradingview.com/chart/?symbol=${chartSymbol}`;

                    return `
                        <tr>
                            <td class="fw-bold">
                                <a href="${chartUrl}" target="_blank" class="text-decoration-none text-white symbol-link" 
                                   style="transition: color 0.2s ease;"
                                   onmouseover="this.style.color='#007bff'" 
                                   onmouseout="this.style.color='white'" title="Open Chart">
                                    ${symbolCode}
                                </a>
                                ${patternBadge}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-warning watchlist-btn" 
                                        onclick="toggleWatchlist('${symbolCode}', '${stock.symbol}')" 
                                        data-symbol="${symbolCode}" 
                                        data-full-symbol="${stock.symbol}"
                                        title="Add to Watchlist"
                                        style="padding: 2px 6px; font-size: 0.7rem;">
                                    <i class="fas fa-star"></i>
                                </button>
                            </td>
                            <td class="fw-bold price-cell">${this.formatNumber(stock.ltp)}</td>
                            <td class="text-end">${this.formatNumber(stock.high_price || 0)}</td>
                            <td class="text-end">${this.formatNumber(stock.low_price || 0)}</td>
                            <td class="${changeClass}">
                                <i class="${changeIcon} me-1"></i>
                                ${this.formatNumber(stock.change)}
                            </td>
                            <td class="${changeClass} fw-bold">
                                ${this.formatNumber(stock.change_percent)}%
                            </td>
                            <td class="text-end ${openClass}">${this.formatNumber(percentOpen)}%</td>
                            <td class="text-end ${highClass}">${this.formatNumber(percentHigh)}%</td>
                            <td class="text-end ${lowClass}">${this.formatNumber(percentLow)}%</td>
                            <td class="text-end text-info">${this.formatNumber(percentRange)}%</td>
                            <td>${this.formatNumber(stock.prev_close_price || 0)}</td>
                            <td>${this.formatVolume(stock.volume)}</td>
                        </tr>
                    `;
                }).join('');

                // Reapply sorting if table was previously sorted
                if (currentSortColumn >= 0 && currentSortDirection && window.tableSorter) {
                    // Small delay to ensure table has been fully rendered
                    setTimeout(() => {
                        window.tableSorter.sortTable('niftyTable', currentSortColumn, true);
                    }, 10);
                }

                // Update market summary cards with live data
                this.updateMarketSummary(sortedData);

                // Update watchlist if it exists and has data
                const watchlistCount = document.getElementById('watchlistCount');
                if (watchlistCount && parseInt(watchlistCount.textContent) > 0) {
                    // Throttled watchlist refresh to prevent frequent re-renders
                    if (!window.watchlistUpdateTimer) {
                        window.watchlistUpdateTimer = setTimeout(() => {
                            refreshWatchlistDisplay();
                            window.watchlistUpdateTimer = null;
                        }, 2000); // Update every 2 seconds max
                    }
                }


                // Update category sections
                this.updateCategorySections(sortedData);
            }

            formatNumber(num) {
                if (num === 0) return '0.00';
                return parseFloat(num).toFixed(2);
            }

            // Generate chart link for symbol
            generateChartLink(symbol, displayText) {
                // Create TradingView URL for floating browser
                const cleanSymbol = symbol.replace('NSE:', '').replace('-EQ', '');
                const chartSymbol = `NSE:${cleanSymbol}`;
                const chartUrl = `https://in.tradingview.com/chart/?symbol=${chartSymbol}`;

                return `<a href="${chartUrl}" target="_blank" rel="noopener noreferrer" 
                          class="text-decoration-none fw-bold symbol-link" 
                          style="color: inherit; transition: all 0.2s ease;"
                          onmouseover="this.style.textDecoration='underline'; this.style.color='#58a6ff'"
                          onmouseout="this.style.textDecoration='none'; this.style.color='inherit'"
                          data-chart-url="${chartUrl}"
                          data-symbol="${displayText}"
                          title="Click to view ${displayText} chart">
                    <i class="fas fa-chart-line me-1" style="font-size: 0.7rem;"></i>${displayText}
                </a>`;
            }

            // Generate chart link for INDEX symbols
            generateIndexChartLink(indexSymbol) {
                // Convert INDEX symbol to TradingView format
                let chartSymbol = indexSymbol.replace('NSE:', '').replace('BSE:', '').replace('-INDEX', '');

                // Handle BSE symbols separately
                if (indexSymbol.startsWith('BSE:')) {
                    const bseSymbolMap = {
                        'SENSEX': 'SENSEX'
                    };
                    chartSymbol = bseSymbolMap[chartSymbol] || chartSymbol;
                    return `https://in.tradingview.com/chart/?symbol=BSE:${chartSymbol}`;
                }

                // Handle NSE INDEX symbols - correct mappings
                const symbolMap = {
                    'NIFTY50': 'NIFTY',
                    'NIFTYBANK': 'BANKNIFTY',
                    'NIFTYIT': 'CNXIT',
                    'FINNIFTY': 'FINNIFTY',
                    'MIDCPNIFTY': 'MIDCPNIFTY',
                    'NIFTYNEXT50': 'NIFTYNXT50',
                    'NIFTYAUTO': 'CNXAUTO',
                    'NIFTYPHARMA': 'CNXPHARMA',
                    'NIFTYREALTY': 'CNXREALTY',
                    'NIFTYMETAL': 'CNXMETAL',
                    'NIFTYFMCG': 'CNXFMCG',
                    'NIFTYENERGY': 'CNXENERGY',
                    'NIFTYPVTBANK': 'NIFTYPVTBANK',
                    'NIFTYPSUBANK': 'NIFTYPSUBANK',
                    'NIFTYCOMMODITIES': 'NIFTYCOMMODITIES',
                    'NIFTYMEDIA': 'CNXMEDIA',
                    'NIFTYINFRA': 'CNXINFRA',
                    'NIFTYPSE': 'CNXPSE',
                    'NIFTYCPSE': 'CNXCPSE',
                    'NIFTYMIDCAP50': 'NIFTYMIDCAP50',
                    'NIFTYSMLCAP100': 'NIFTYSMLCAP100'
                };

                chartSymbol = symbolMap[chartSymbol] || chartSymbol;
                return `https://in.tradingview.com/chart/?symbol=NSE:${chartSymbol}`;
            }

            // Generate clickable symbol link for market summary cards
            generateClickableSymbol(symbol, displayText, extraClasses = '', extraStyles = '') {
                const cleanSymbol = symbol.replace('NSE:', '').replace('-EQ', '');
                const chartSymbol = `NSE:${cleanSymbol}`;
                const chartUrl = `https://in.tradingview.com/chart/?symbol=${chartSymbol}`;

                return `<span class="symbol-clickable ${extraClasses}" 
                              style="cursor: pointer; transition: color 0.2s ease; ${extraStyles}"
                              data-chart-url="${chartUrl}"
                              data-symbol="${cleanSymbol}"
                              title="Click to view ${cleanSymbol} chart"
                              onmouseover="this.style.color='#58a6ff'"
                              onmouseout="this.style.color=''"
                              onclick="window.open('${chartUrl}', '_blank', 'noopener')">${displayText}</span>`;
            }

            // Generate legacy TradingView chart link for INDEX symbols (if needed)
            generateLegacyIndexChartLink(indexSymbol) {
                // Convert INDEX symbol to TradingView format
                let chartSymbol = indexSymbol.replace('NSE:', '').replace('-INDEX', '');

                // Handle special cases for TradingView INDEX symbols
                const symbolMap = {
                    'NIFTY50': 'NIFTY',
                    'NIFTYBANK': 'BANKNIFTY',
                    'NIFTYIT': 'CNXIT',
                    'FINNIFTY': 'FINNIFTY',
                    'MIDCPNIFTY': 'CNXMIDCAP',
                    'NIFTYNXT50': 'NIFTYNXT50',
                    'NIFTYFMCG': 'CNXFMCG',
                    'NIFTYPHARMA': 'CNXPHARMA',
                    'NIFTYAUTO': 'CNXAUTO',
                    'NIFTYMETAL': 'CNXMETAL',
                    'NIFTYREALTY': 'CNXREALTY',
                    'NIFTYPSE': 'CNXPSE',
                    'NIFTYPVTBANK': 'NIFTYPVTBANK',
                    'NIFTYMEDIA': 'CNXMEDIA',
                    'NIFTYINFRA': 'CNXINFRA',
                    'NIFTYENERGY': 'CNXENERGY',
                    'NIFTYCOMMODITIES': 'CNXCOMMODITIES',
                    'NIFTYCPSE': 'NIFTYCPSE',
                    'NIFTYMIDCAP50': 'CNXMIDCAP',
                    'NIFTYSMLCAP100': 'CNXSMLCAP'
                };

                chartSymbol = symbolMap[chartSymbol] || chartSymbol;
                const chartUrl = `https://in.tradingview.com/chart/?symbol=NSE:${chartSymbol}`;

                return chartUrl;
            }

            // Check for O=H/O=L pattern
            getPatternIndicator(stock) {
                if (!stock.ltp || !stock.open_price || !stock.high_price || !stock.low_price) {
                    return '';
                }

                const openEqualsHigh = Math.abs(stock.open_price - stock.high_price) <= (stock.high_price * 0.001); // 0.1% tolerance
                const openEqualsLow = Math.abs(stock.open_price - stock.low_price) <= (stock.low_price * 0.001);

                if (openEqualsHigh) {
                    return ' <span class="text-warning ms-1" style="font-size: 0.6em;">O=H</span>';
                } else if (openEqualsLow) {
                    return ' <span class="text-info ms-1" style="font-size: 0.6em;">O=L</span>';
                }

                return '';
            }

            formatVolume(num) {
                if (num === 0) return '0';
                if (Math.abs(num) >= 10000000) {
                    return (num / 10000000).toFixed(2) + 'Cr';
                }
                if (Math.abs(num) >= 100000) {
                    return (num / 100000).toFixed(2) + 'L';
                }
                if (Math.abs(num) >= 1000) {
                    return (num / 1000).toFixed(2) + 'K';
                }
                return num.toLocaleString();
            }

            isDataFresh(timestamp) {
                return timestamp && (Date.now() / 1000 - timestamp) < 60; // Fresh if less than 1 minute old
            }


            updateGlobalTimestamp() {
                const now = new Date();
                const timestamp = now.toLocaleTimeString();
                const globalTimestamp = document.getElementById('globalTimestamp');
                if (globalTimestamp) {
                    globalTimestamp.textContent = timestamp;
                }
            }

            async checkWebSocketStatus() {
                try {
                    const response = await fetch('/websocket_status');
                    const status = await response.json();
                    this.updateConnectionStatus(status);

                    // Additional debug logging for status issues
                    console.log('WebSocket status checked:', status);
                } catch (error) {
                    console.error('Error checking WebSocket status:', error);
                    // Set indicator to red on error
                    const indicator = document.getElementById('connectionIndicator');
                    if (indicator) {
                        indicator.style.color = '#dc3545'; // Red for error
                        indicator.parentElement.title = 'WebSocket Error';
                    }
                }
            }

            async refreshData() {
                try {
                    const response = await fetch('/stock_data');
                    const result = await response.json();

                    if (result && result.data && typeof result.data === 'object') {
                        // Clear existing data
                        this.stockData = {};
                        window.stockData = {};

                        // Process stock data
                        if (result.data && typeof result.data === 'object') {
                            Object.values(result.data).forEach(data => {
                                if (data && data.symbol) {
                                    this.stockData[data.full_symbol] = data;
                // Also update window.stockData for enhanced alerts
                window.stockData[data.full_symbol] = data;
                                }
                            });
                        }

                        // Update the table and counters
                        this.renderStockTable();

                        // Update market statistics bars when stock table is updated
                        setTimeout(() => this.updateMarketStatsBars(), 100);
                        const symbolCountEl = document.getElementById('symbolCount');
                if (symbolCountEl) symbolCountEl.textContent = Object.keys(this.stockData).length;
                    }
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    // Keep existing data visible - don't clear the table
                    // Only show empty table if there's truly no data
                    if (Object.keys(this.stockData).length === 0) {
                        this.renderEmptyTable();
                    }
                }
            }

            renderEmptyTable() {
                const tbody = document.getElementById('stockTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-chart-line fa-3x mb-3 d-block"></i>
                                <h5>No Live Data Available</h5>
                                <p>Waiting for WebSocket connection...</p>
                            </div>
                        </td>
                    </tr>
                `;
            }

            async fetchHistoricalData() {
                const resolutionSelect = document.getElementById('resolutionSelect');
                const resolution = resolutionSelect ? resolutionSelect.value : '1D';
                const btn = document.getElementById('fetchHistoricalBtnNav') || document.getElementById('fetchHistoricalBtn');
                const originalText = btn ? btn.innerHTML : 'Historical';

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Fetching...';

                    // Suppress progress alert messages during historical data fetch
                    const originalShowAlert = this.showAlert;
                    this.showAlert = () => {};

                    this.showProgress(0);

                    let startIndex = 0;
                    let totalProcessed = 0;
                    let totalSymbols = 0;
                    let allResults = {};

                    while (true) {
                        const response = await fetch('/historical/fetch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                resolution: resolution,
                                days_back: 30,
                                start_index: startIndex
                            })
                        });

                        const result = await response.json();

                        if (result.status !== 'success') {
                            // Restore alerts to show error message
                            this.showAlert = originalShowAlert;
                            this.showAlert('danger', 'Error: ' + result.message);
                            break;
                        }

                        // Handle case where data already exists
                        const missing_count = result.missing_symbols_count || result.missing_symbols || 0;
                        if (missing_count === 0) {
                            // Restore alerts to show final message
                            this.showAlert = originalShowAlert;
                            this.showAlert('success', result.message || 'All symbols already have historical data');
                            break;
                        }

                        // Accumulate results
                        Object.assign(allResults, result.results || {});
                        totalProcessed = result.total_processed || 0;
                        totalSymbols = result.missing_symbols || 0;

                        // Update progress and show individual symbol status
                        if (missing_count > 0) {
                            const progressPercent = Math.round((totalProcessed / missing_count) * 100);
                            this.showProgress(progressPercent);

                            // Show completion status for current batch symbols
                            if (result.current_symbols) {
                                for (const symbol of result.current_symbols) {
                                    this.showAlert('success', `Completed ${symbol}`, false);
                                }
                            }

                            // Show fetching status for next batch symbols (better timing)
                            if (result.next_batch_symbols) {
                                for (const symbol of result.next_batch_symbols) {
                                    this.showAlert('info', `Fetching ${symbol}...`, false);
                                }
                            }

                            this.showAlert('info', `Processing symbols: ${totalProcessed}/${missing_count} (${progressPercent}%)`);
                        }

                        // Check if more symbols to process
                        if (!result.next_start_index) {
                            // All done!
                            this.showAlert('success', `Historical data fetch completed! Processed ${Object.keys(allResults).length} symbols`);
                            this.showProgress(100);
                            break;
                        }

                        startIndex = result.next_start_index;

                        // Small delay between batches to prevent overwhelming the server
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    this.loadFetchLogs();

                } catch (error) {
                    this.showAlert('danger', 'Error fetching historical data: ' + error.message);
                } finally {
                    // Restore original showAlert function
                    if (typeof originalShowAlert !== 'undefined') {
                        this.showAlert = originalShowAlert;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                    setTimeout(() => this.hideProgress(), 3000);
                }
            }

            async stopStreaming() {
                const btn = document.getElementById('stopStreamingBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Stopping...';

                    const response = await fetch('/admin/stop-streaming', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        this.showAlert('success', result.message);
                        // Update connection status
                        const indicator = document.getElementById('connectionIndicator');
                        const status = document.getElementById('connectionStatus');
                        if (indicator) {
                            indicator.style.color = '#dc3545'; // Red for disconnected
                            indicator.parentElement.title = 'WebSocket Disconnected';
                        }
                        if (status) status.textContent = 'Disconnected';
                    } else {
                        this.showAlert('danger', 'Error: ' + result.message);
                    }
                } catch (error) {
                    this.showAlert('danger', 'Error stopping stream: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async startStreaming() {
                const btn = document.getElementById('startStreamingBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Starting...';

                    const response = await fetch('/admin/start-streaming', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        this.showAlert('success', result.message);
                        // Update connection status
                        const indicator = document.getElementById('connectionIndicator');
                        const status = document.getElementById('connectionStatus');
                        if (indicator) {
                            indicator.style.color = '#28a745'; // Green for connected
                            indicator.parentElement.title = 'WebSocket Connected';
                        }
                        if (status) status.textContent = 'Connected';
                    } else {
                        this.showAlert('danger', 'Error: ' + result.message);
                    }
                } catch (error) {
                    this.showAlert('danger', 'Error starting stream: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async fetchAllHistoricalData() {
                const resolutionSelect = document.getElementById('resolutionSelect');
                const resolution = resolutionSelect ? resolutionSelect.value : '1D';
                const btn = document.getElementById('fetchAllHistoricalBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Fetching...';

                    this.showAlert('info', 'Fetching historical data for all F&O symbols...');
                    this.showProgress(0);

                    let startIndex = 0;
                    let totalProcessed = 0;
                    let totalSymbols = 0;
                    let allResults = {};

                    while (true) {
                        const response = await fetch('/historical/fetch', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                resolution: resolution,
                                days_back: 30,
                                start_index: startIndex
                            })
                        });

                        const result = await response.json();

                        if (result.status !== 'success') {
                            this.showAlert('danger', 'Error: ' + result.message);
                            break;
                        }

                        // Accumulate results
                        Object.assign(allResults, result.results || {});
                        totalProcessed = result.total_processed || 0;
                        totalSymbols = result.missing_symbols || 0;

                        // Update progress and show individual symbol status
                        const missing_count = result.missing_symbols_count || result.missing_symbols || 0;
                        if (missing_count > 0) {
                            const progressPercent = Math.round((totalProcessed / missing_count) * 100);
                            this.showProgress(progressPercent);

                            // Show completion status for current batch symbols
                            if (result.current_symbols) {
                                for (const symbol of result.current_symbols) {
                                    this.showAlert('success', `Completed ${symbol}`, false);
                                }
                            }

                            // Show fetching status for next batch symbols (better timing)
                            if (result.next_batch_symbols) {
                                for (const symbol of result.next_batch_symbols) {
                                    this.showAlert('info', `Fetching ${symbol}...`, false);
                                }
                            }

                            this.showAlert('info', `Processing symbols: ${totalProcessed}/${missing_count} (${progressPercent}%)`);
                        }

                        // Check if more symbols to process
                        if (!result.next_start_index) {
                            // All done!
                            this.showAlert('success', `Historical data fetch completed! Processed ${Object.keys(allResults).length} symbols`);
                            this.showProgress(100);
                            break;
                        }

                        startIndex = result.next_start_index;

                        // Small delay between batches to prevent overwhelming the server
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    this.loadFetchLogs();

                } catch (error) {
                    this.showAlert('danger', 'Error fetching historical data: ' + error.message);
                } finally {
                    // Restore original showAlert function
                    if (typeof originalShowAlert !== 'undefined') {
                        this.showAlert = originalShowAlert;
                    }
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                    setTimeout(() => this.hideProgress(), 3000);
                }
            }

            async loadFetchLogs() {
                try {
                    const response = await fetch('/historical/logs');

                    if (!response.ok) {
                        console.warn(`Historical logs endpoint returned ${response.status}, skipping historical data display`);
                        return;
                    }

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        console.warn('Historical logs response is not JSON, skipping historical data display');
                        return;
                    }

                    const result = await response.json();

                    if (result.status === 'success' && result.logs.length > 0) {
                        const logsHtml = result.logs.map(log => {
                            const statusClass = log.status === 'success' ? 'text-success' : 
                                              log.status === 'error' ? 'text-danger' : 'text-warning';
                            const time = new Date(log.created_at).toLocaleTimeString();
                            return `
                                <div class="small mb-1">
                                    <span class="${statusClass}">
                                        <i class="fas fa-${log.status === 'success' ? 'check' : log.status === 'error' ? 'times' : 'clock'} me-1"></i>
                                        ${log.symbol} (${log.resolution})
                                    </span>
                                    <span class="text-muted">${time}</span>
                                    ${log.records_fetched ? `<span class="badge bg-secondary">${log.records_fetched} records</span>` : ''}
                                </div>
                            `;
                        }).join('');

                        document.getElementById('fetchLogs').innerHTML = logsHtml;
                    }
                } catch (error) {
                    console.error('Error loading fetch logs:', error);
                }
            }

            async calculateCamarillaLevels() {
                const btn = document.getElementById('calculateCamarillaBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

                    const response = await fetch('/camarilla/calculate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    });

                    const result = await response.json();

                    if (result.status === 'success') {
                        this.showAlert('success', result.message);
                        await this.loadCamarillaData();
                    } else {
                        this.showAlert('danger', 'Error: ' + result.message);
                    }
                } catch (error) {
                    this.showAlert('danger', 'Error calculating Camarilla levels: ' + error.message);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async loadCamarillaData() {
                try {
                    const response = await fetch('/camarilla/data');

                    // Check if response is ok and content type is JSON
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error('Server returned non-JSON response');
                    }

                    const result = await response.json();

                    if (result.success && result.data) {
                        this.renderCamarillaTable(result.data);
                    } else {
                        console.error('Camarilla data error:', result.message || 'API response format issue');
                        // Camarilla API response processed
                    }
                } catch (error) {
                    console.error('Error loading Camarilla data:', error);
                }
            }

            renderCamarillaTable(data) {
                const tbody = document.getElementById('camarillaTableBody');

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="14" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-calculator fa-3x mb-3 d-block"></i>
                                    <h5>No Camarilla Data Available</h5>
                                    <p>Click "Calc Levels" to generate Camarilla pivot levels for all stocks</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const rows = data.map(item => {
                    const breakLevelClass = this.getBreakLevelClass(item.break_level);
                    const trendClass = this.getTrendClass(item.trend_direction);
                    const symbol = item.symbol.replace('NSE:', '');
                    const chartLink = this.generateChartLink(item.symbol, symbol);
                    const ltp = item.current_ltp || 0;

                    // Find immediate support and resistance levels
                    const levels = [
                        { name: 'R5', value: item.r5 },
                        { name: 'R4', value: item.r4 },
                        { name: 'R3', value: item.r3 },
                        { name: 'R2', value: item.r2 },
                        { name: 'R1', value: item.r1 },
                        { name: 'S1', value: item.s1 },
                        { name: 'S2', value: item.s2 },
                        { name: 'S3', value: item.s3 },
                        { name: 'S4', value: item.s4 },
                        { name: 'S5', value: item.s5 }
                    ];

                    const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);

                    return `
                        <tr data-symbol="${item.symbol}">
                            <td>${chartLink}</td>
                            <td>${this.getCamarillaRange(ltp, item)}</td>
                            <td class="text-end ltp-value ${this.getLtpColorClass(ltp, item.prev_close)}">${ltp.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('Pivot')}" data-level="Pivot" data-value="${item.pivot}">${this.getImmediateLevelTag('Pivot', immediateResistance, immediateSupport)}${item.pivot.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R5')}" data-level="R5" data-value="${item.r5}">${this.getImmediateLevelTag('R5', immediateResistance, immediateSupport)}${item.r5.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R4')}" data-level="R4" data-value="${item.r4}">${this.getImmediateLevelTag('R4', immediateResistance, immediateSupport)}${item.r4.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R3')}" data-level="R3" data-value="${item.r3}">${this.getImmediateLevelTag('R3', immediateResistance, immediateSupport)}${item.r3.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R2')}" data-level="R2" data-value="${item.r2}">${this.getImmediateLevelTag('R2', immediateResistance, immediateSupport)}${item.r2.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R1')}" data-level="R1" data-value="${item.r1}">${this.getImmediateLevelTag('R1', immediateResistance, immediateSupport)}${item.r1.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S1')}" data-level="S1" data-value="${item.s1}">${this.getImmediateLevelTag('S1', immediateResistance, immediateSupport)}${item.s1.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S2')}" data-level="S2" data-value="${item.s2}">${this.getImmediateLevelTag('S2', immediateResistance, immediateSupport)}${item.s2.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S3')}" data-level="S3" data-value="${item.s3}">${this.getImmediateLevelTag('S3', immediateResistance, immediateSupport)}${item.s3.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S4')}" data-level="S4" data-value="${item.s4}">${this.getImmediateLevelTag('S4', immediateResistance, immediateSupport)}${item.s4.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S5')}" data-level="S5" data-value="${item.s5}">${this.getImmediateLevelTag('S5', immediateResistance, immediateSupport)}${item.s5.toFixed(2)}</td>

                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = rows;
            }

            getBreakLevelClass(breakLevel) {
                if (!breakLevel || breakLevel === 'None') return 'bg-secondary';
                if (breakLevel.startsWith('H')) return 'bg-success';
                if (breakLevel.startsWith('L')) return 'bg-danger';
                return 'bg-secondary';
            }

            getTrendClass(trend) {
                switch(trend) {
                    case 'bullish': return 'bg-success';
                    case 'bearish': return 'bg-danger';
                    case 'sideways': return 'bg-warning';
                    default: return 'bg-secondary';
                }
            }

            // Helper function to get color class based on level type
            getLevelColorClass(levelName) {
                // All levels use gray color text
                return 'text-muted';
            }

            // Helper function to get LTP color class based on change percentage
            getLtpColorClass(currentLtp, prevClose) {
                if (!currentLtp || !prevClose || prevClose === 0) {
                    return 'text-white'; // Default color if data is missing
                }

                const changePercent = ((currentLtp - prevClose) / prevClose) * 100;

                if (changePercent > 0) {
                    return 'price-up'; // Green with glow for positive
                } else if (changePercent < 0) {
                    return 'price-down'; // Red with glow for negative
                } else {
                    return 'text-white'; // Default for zero change
                }
            }

            // Helper function to find immediate support and resistance levels
            findImmediateLevels(ltp, levels) {
                const numericLevels = levels.filter(l => l.value && !isNaN(l.value));

                let immediateResistance = null;
                let immediateSupport = null;
                let minResistanceDistance = Infinity;
                let minSupportDistance = Infinity;

                // Find closest resistance level above LTP and closest support level below LTP
                for (const level of numericLevels) {
                    if (level.value > ltp) {
                        const distance = level.value - ltp;
                        if (distance < minResistanceDistance) {
                            minResistanceDistance = distance;
                            immediateResistance = level;
                        }
                    } else if (level.value < ltp) {
                        const distance = ltp - level.value;
                        if (distance < minSupportDistance) {
                            minSupportDistance = distance;
                            immediateSupport = level;
                        }
                    }
                }

                return { immediateResistance, immediateSupport };
            }

            // Helper function to add immediate level tag
            getImmediateLevelTag(levelName, immediateResistance, immediateSupport) {
                if (immediateResistance && levelName === immediateResistance.name) {
                    return '<span class="immediate-tag resistance-tag">R</span>';
                } else if (immediateSupport && levelName === immediateSupport.name) {
                    return '<span class="immediate-tag support-tag">S</span>';
                }
                return '';
            }

            // Helper function to determine current trading range for Camarilla with color coding
            getCamarillaRange(ltp, item) {
                if (!item) return '<span class="badge bg-secondary">No Data</span>';

                // Use previous close as fallback if LTP is missing
                const currentPrice = ltp || item.prev_close || 0;
                if (!currentPrice) return '<span class="badge bg-secondary">No Price</span>';

                let range = '';
                let bgClass = '';

                // Use same logic pattern as Fibonacci - strict > comparisons throughout
                // This ensures range matches S&R tag logic perfectly
                if (currentPrice > item.r5) { 
                    range = 'Above R5'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r4) { 
                    range = 'R4-R5'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r3) { 
                    range = 'R3-R4'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r2) { 
                    range = 'R2-R3'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.r1) { 
                    range = 'R1-R2'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s1) { 
                    range = 'S1-R1'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s2) { 
                    range = 'S2-S1'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s3) { 
                    range = 'S3-S2'; 
                    bgClass = 'range-red'; 
                } else if (currentPrice > item.s4) { 
                    range = 'S4-S3'; 
                    bgClass = 'range-red'; 
                } else if (currentPrice > item.s5) { 
                    range = 'S5-S4'; 
                    bgClass = 'range-red'; 
                } else { 
                    range = 'Below S5'; 
                    bgClass = 'range-red'; 
                }

                const textColor = bgClass === 'range-yellow' ? 'text-dark' : 'text-white';
                const priceIndicator = ltp ? '' : '*';
                return `<span class="${bgClass} ${textColor} fw-bold px-2 py-1 rounded">${range}${priceIndicator}</span>`;
            }

            // Helper function to determine current trading range for CPR with color coding
            getCprRange(ltp, item) {
                if (!item) return '<span class="badge bg-secondary">No Data</span>';

                // Use previous close as fallback if LTP is missing
                const currentPrice = ltp || item.prev_close || 0;
                if (!currentPrice) return '<span class="badge bg-secondary">No Price</span>';

                let range = '';
                let bgClass = '';

                // Use same logic pattern as Fibonacci - strict > comparisons throughout
                // This ensures range matches S&R tag logic perfectly
                if (currentPrice > item.r3) { 
                    range = 'Above R3'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r2) { 
                    range = 'R2-R3'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r1) { 
                    range = 'R1-R2'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.tc) { 
                    range = 'TC-R1'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.pp) { 
                    range = 'PP-TC'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.bc) { 
                    range = 'BC-PP'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s1) { 
                    range = 'S1-BC'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s2) { 
                    range = 'S2-S1'; 
                    bgClass = 'range-red'; 
                } else if (currentPrice > item.s3) { 
                    range = 'S3-S2'; 
                    bgClass = 'range-red'; 
                } else { 
                    range = 'Below S3'; 
                    bgClass = 'range-red'; 
                }

                const textColor = bgClass === 'range-yellow' ? 'text-dark' : 'text-white';
                const priceIndicator = ltp ? '' : '*';
                return `<span class="${bgClass} ${textColor} fw-bold px-2 py-1 rounded">${range}${priceIndicator}</span>`;
            }

            // Helper function to determine current trading range for Fibonacci with color coding
            getFibonacciRange(ltp, item) {
                if (!item) return '<span class="badge bg-secondary">No Data</span>';

                // Use previous close as fallback if LTP is missing
                const currentPrice = ltp || item.prev_close || 0;
                if (!currentPrice) return '<span class="badge bg-secondary">No Price</span>';

                let range = '';
                let bgClass = '';

                if (currentPrice > item.r3_161) { 
                    range = 'Above R3'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r2_123) { 
                    range = 'R2-R3'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.r1_61) { 
                    range = 'R1-R2'; 
                    bgClass = 'range-green'; 
                } else if (currentPrice > item.pp) { 
                    range = 'PP-R1'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s1_61) { 
                    range = 'S1-PP'; 
                    bgClass = 'range-yellow'; 
                } else if (currentPrice > item.s2_123) { 
                    range = 'S2-S1'; 
                    bgClass = 'range-red'; 
                } else if (currentPrice > item.s3_161) { 
                    range = 'S3-S2'; 
                    bgClass = 'range-red'; 
                } else { 
                    range = 'Below S3'; 
                    bgClass = 'range-red'; 
                }

                const textColor = bgClass === 'range-yellow' ? 'text-dark' : 'text-white';
                const priceIndicator = ltp ? '' : '*';
                return `<span class="${bgClass} ${textColor} fw-bold px-2 py-1 rounded">${range}${priceIndicator}</span>`;
            }


            async calculateCprLevels() {
                const btn = document.getElementById('calculateCprBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

                    const response = await fetch('/calculate_cpr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.showAlert('success', `CPR levels calculated successfully for ${result.count} symbols!`);
                            this.renderCprTable(result.data);
                            const statusBadge = document.getElementById('cprStatusBadge');
                            if (statusBadge) statusBadge.textContent = new Date().toLocaleTimeString();
                        } else {
                            this.showAlert('danger', result.message || 'Error calculating CPR levels');
                        }
                    } else {
                        throw new Error('Server error');
                    }
                } catch (error) {
                    console.error('Error calculating CPR levels:', error);
                    this.showAlert('danger', 'Error calculating CPR levels. Please try again.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async loadCprData() {
                try {
                    const response = await fetchWithRetry('/get_cpr_data', {
                        credentials: 'same-origin'
                    });

                    const result = await response.json();
                    if (result.success && result.data) {
                        this.renderCprTable(result.data);
                        if (result.data.length > 0) {
                            const statusBadge = document.getElementById('cprStatusBadge');
                            if (statusBadge) statusBadge.textContent = 'Loaded';
                        }
                    } else {
                        console.error('CPR data error:', result.message || 'Unknown server error');
                    }
                } catch (error) {
                    console.error('Error loading CPR data:', {
                        message: error.message,
                        url: '/get_cpr_data',
                        timestamp: new Date().toISOString()
                    });
                    // Graceful degradation - don't break the UI
                    const statusBadge = document.getElementById('cprStatusBadge');
                    if (statusBadge) {
                        statusBadge.textContent = 'Failed';
                        statusBadge.className = 'badge bg-warning';
                    }
                }
            }

            renderCprTable(data) {
                const tbody = document.getElementById('cprTableBody');

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="14" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-crosshairs fa-3x mb-3 d-block"></i>
                                    <h5>No CPR Data Available</h5>
                                    <p>Click "Calc CPR Levels" to generate Central Pivot Range levels for all stocks</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const rows = data.map(item => {
                    const breakLevelClass = this.getBreakLevelClass(item.break_level);
                    const trendClass = this.getTrendClass(item.trend_direction);
                    const cprWidthPercent = ((item.tc - item.bc) / item.pp * 100).toFixed(2);
                    const cprWidthIndicator = cprWidthPercent < 0.3 ? 'N' : 'W';
                    const cprWidthColor = cprWidthPercent < 0.3 ? 'text-success' : 'text-warning';
                    const symbol = item.symbol.replace('NSE:', '');
                    const chartLink = this.generateChartLink(item.symbol, symbol);
                    const ltp = item.current_ltp || 0;

                    // Find immediate support and resistance levels
                    const levels = [
                        { name: 'R3', value: item.r3 },
                        { name: 'R2', value: item.r2 },
                        { name: 'R1', value: item.r1 },
                        { name: 'TC', value: item.tc },
                        { name: 'BC', value: item.bc },
                        { name: 'S1', value: item.s1 },
                        { name: 'S2', value: item.s2 },
                        { name: 'S3', value: item.s3 }
                    ];

                    const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);

                    return `
                        <tr data-symbol="${item.symbol}">
                            <td>${chartLink}</td>
                            <td>${this.getCprRange(ltp, item)}</td>
                            <td class="text-end ltp-value ${this.getLtpColorClass(ltp, item.prev_close)}">${ltp.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R3')}" data-level="R3" data-value="${item.r3}">${this.getImmediateLevelTag('R3', immediateResistance, immediateSupport)}${item.r3.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R2')}" data-level="R2" data-value="${item.r2}">${this.getImmediateLevelTag('R2', immediateResistance, immediateSupport)}${item.r2.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R1')}" data-level="R1" data-value="${item.r1}">${this.getImmediateLevelTag('R1', immediateResistance, immediateSupport)}${item.r1.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('TC')}" data-level="TC" data-value="${item.tc}">${this.getImmediateLevelTag('TC', immediateResistance, immediateSupport)}${item.tc.toFixed(2)}</td>
                            <td class="text-end ${this.getLevelColorClass('PP')}">${item.pp.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('BC')}" data-level="BC" data-value="${item.bc}">${this.getImmediateLevelTag('BC', immediateResistance, immediateSupport)}${item.bc.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S1')}" data-level="S1" data-value="${item.s1}">${this.getImmediateLevelTag('S1', immediateResistance, immediateSupport)}${item.s1.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S2')}" data-level="S2" data-value="${item.s2}">${this.getImmediateLevelTag('S2', immediateResistance, immediateSupport)}${item.s2.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S3')}" data-level="S3" data-value="${item.s3}">${this.getImmediateLevelTag('S3', immediateResistance, immediateSupport)}${item.s3.toFixed(2)}</td>
                            <td class="text-end ${cprWidthColor}">${cprWidthIndicator}</td>

                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = rows;
            }

            async calculateFibonacciLevels() {
                const btn = document.getElementById('calculateFibBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

                    const response = await fetch('/calculate_fibonacci', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.showAlert('success', `Fibonacci levels calculated successfully for ${result.count} symbols!`);
                            this.renderFibonacciTable(result.data);
                            document.getElementById('fibStatusBadge').textContent = new Date().toLocaleTimeString();
                        } else {
                            this.showAlert('danger', result.message || 'Error calculating Fibonacci levels');
                        }
                    } else {
                        throw new Error('Server error');
                    }
                } catch (error) {
                    console.error('Error calculating Fibonacci levels:', error);
                    this.showAlert('danger', 'Error calculating Fibonacci levels. Please try again.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async calculateAllTechnicalLevels() {
                const btn = document.getElementById('calculateAllTechnicalBtn');
                const originalText = btn.innerHTML;

                try {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calculating All...';

                    let successCount = 0;
                    let totalCount = 3;

                    // Step 1: Calculate Camarilla levels
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calculating Camarilla...';
                    try {
                        await this.calculateCamarillaLevels();
                        successCount++;
                        this.showAlert('info', ' Camarilla levels calculated successfully');
                    } catch (error) {
                        console.error('Camarilla calculation failed:', error);
                        this.showAlert('warning', ' Camarilla calculation failed');
                    }

                    // Step 2: Calculate CPR levels
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calculating CPR...';
                    try {
                        await this.calculateCprLevels();
                        successCount++;
                        this.showAlert('info', ' CPR levels calculated successfully');
                    } catch (error) {
                        console.error('CPR calculation failed:', error);
                        this.showAlert('warning', ' CPR calculation failed');
                    }

                    // Step 3: Calculate Fibonacci levels
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calculating Fibonacci...';
                    try {
                        await this.calculateFibonacciLevels();
                        successCount++;
                        this.showAlert('info', ' Fibonacci levels calculated successfully');
                    } catch (error) {
                        console.error('Fibonacci calculation failed:', error);
                        this.showAlert('warning', ' Fibonacci calculation failed');
                    }

                    // Final success message
                    if (successCount === totalCount) {
                        this.showAlert('success', ` All technical levels calculated successfully! (${successCount}/${totalCount})`);
                    } else {
                        this.showAlert('warning', ` Partial success: ${successCount}/${totalCount} calculations completed`);
                    }

                } catch (error) {
                    console.error('Error calculating all technical levels:', error);
                    this.showAlert('danger', 'Error calculating technical levels. Please try again.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async loadFibonacciData() {
                try {
                    const response = await fetchWithRetry('/get_fibonacci_data', {
                        credentials: 'same-origin'
                    });

                    const result = await response.json();
                    if (result.success && result.data) {
                        this.renderFibonacciTable(result.data);
                        if (result.data.length > 0) {
                            const statusBadge = document.getElementById('fibStatusBadge');
                            if (statusBadge) statusBadge.textContent = 'Loaded';
                        }
                    } else {
                        console.error('Fibonacci data error:', result.message || 'Unknown server error');
                    }
                } catch (error) {
                    console.error('Error loading Fibonacci data:', {
                        message: error.message,
                        url: '/get_fibonacci_data',
                        timestamp: new Date().toISOString()
                    });
                    // Graceful degradation - don't break the UI
                    const statusBadge = document.getElementById('fibStatusBadge');
                    if (statusBadge) {
                        statusBadge.textContent = 'Failed';
                        statusBadge.className = 'badge bg-warning';
                    }
                }
            }

            renderFibonacciTable(data) {
                const tbody = document.getElementById('fibTableBody');

                if (!data || data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="13" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-chart-area fa-3x mb-3 d-block"></i>
                                    <h5>No Fibonacci Data Available</h5>
                                    <p>Click "Calc Fibonacci Levels" to generate Fibonacci pivot levels for all stocks</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                const rows = data.map(item => {
                    const breakLevelClass = this.getBreakLevelClass(item.break_level);
                    const trendClass = this.getTrendClass(item.trend_direction);
                    const symbol = item.symbol.replace('NSE:', '');
                    const chartLink = this.generateChartLink(item.symbol, symbol);
                    const ltp = item.current_ltp || 0;

                    // Find immediate support and resistance levels
                    const levels = [
                        { name: 'R3', value: item.r3_161 },
                        { name: 'R2', value: item.r2_123 },
                        { name: 'R1', value: item.r1_61 },
                        { name: 'S1', value: item.s1_61 },
                        { name: 'S2', value: item.s2_123 },
                        { name: 'S3', value: item.s3_161 },
                        { name: '38%', value: item.level_38 },
                        { name: '50%', value: item.level_50 }
                    ];

                    const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);

                    return `
                        <tr data-symbol="${item.symbol}">
                            <td>${chartLink}</td>
                            <td>${this.getFibonacciRange(ltp, item)}</td>
                            <td class="text-end ltp-value ${this.getLtpColorClass(ltp, item.prev_close)}">${ltp.toFixed(2)}</td>
                            <td class="text-end ${this.getLevelColorClass('PP')}">${item.pp.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R3')}" data-level="R3" data-value="${item.r3_161}">${this.getImmediateLevelTag('R3', immediateResistance, immediateSupport)}${item.r3_161.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R2')}" data-level="R2" data-value="${item.r2_123}">${this.getImmediateLevelTag('R2', immediateResistance, immediateSupport)}${item.r2_123.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('R1')}" data-level="R1" data-value="${item.r1_61}">${this.getImmediateLevelTag('R1', immediateResistance, immediateSupport)}${item.r1_61.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S1')}" data-level="S1" data-value="${item.s1_61}">${this.getImmediateLevelTag('S1', immediateResistance, immediateSupport)}${item.s1_61.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S2')}" data-level="S2" data-value="${item.s2_123}">${this.getImmediateLevelTag('S2', immediateResistance, immediateSupport)}${item.s2_123.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('S3')}" data-level="S3" data-value="${item.s3_161}">${this.getImmediateLevelTag('S3', immediateResistance, immediateSupport)}${item.s3_161.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('38%')}" data-level="38%" data-value="${item.level_38}">${this.getImmediateLevelTag('38%', immediateResistance, immediateSupport)}${item.level_38.toFixed(2)}</td>
                            <td class="text-end level-value ${this.getLevelColorClass('50%')}" data-level="50%" data-value="${item.level_50}">${this.getImmediateLevelTag('50%', immediateResistance, immediateSupport)}${item.level_50.toFixed(2)}</td>

                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = rows;
            }

            // Normalize WebSocket symbol to match CPR database symbol format
            normalizeSymbolForCpr(websocketSymbol) {
                if (!websocketSymbol) return websocketSymbol;

                // Handle index symbols: NSE:NIFTY50-INDEX -> NIFTY50
                if (websocketSymbol.includes('-INDEX')) {
                    let normalized = websocketSymbol.replace('-INDEX', '');
                    normalized = normalized.replace('NSE:', '').replace('BSE:', '');

                    // Special case: BSE:SENSEX-INDEX -> BSE:SENSEX (preserve BSE prefix)
                    if (websocketSymbol.startsWith('BSE:SENSEX')) {
                        return 'BSE:SENSEX';
                    }

                    return normalized;
                }

                // Handle regular stocks: NSE:SBIN-EQ -> SBIN
                return websocketSymbol.replace('NSE:', '').replace('BSE:', '').replace('-EQ', '');
            }

            updateCprLTP(data) {
                // Update LTP in CPR table if symbol exists
                const websocketSymbol = data.symbol;
                const ltp = data.ltp;

                if (websocketSymbol && ltp) {
                    // Normalize symbol to match CPR database format
                    const normalizedSymbol = this.normalizeSymbolForCpr(websocketSymbol);

                    // Try both the original symbol and normalized symbol for better matching
                    const ltpCell = document.querySelector(`#cprTableBody tr[data-symbol="${normalizedSymbol}"] .ltp-value`) ||
                                   document.querySelector(`#cprTableBody tr[data-symbol="${websocketSymbol}"] .ltp-value`);

                    if (ltpCell) {
                        const row = ltpCell.closest('tr');

                        // Get previous close from the database or calculate from change data
                        const changePercent = data.change_percent || data.chp;
                        let prevClose = null;

                        if (changePercent !== undefined && changePercent !== 0) {
                            prevClose = ltp / (1 + (changePercent / 100));
                        }

                        // Apply color based on change percentage
                        const colorClass = this.getLtpColorClass(ltp, prevClose);
                        ltpCell.className = `text-end ltp-value ${colorClass}`;
                        ltpCell.textContent = `${ltp.toFixed(2)}`;

                        // Update Range column and S/R tags with real-time calculation
                        if (row && row.cells[1]) {
                            // Extract CPR levels from data attributes (robust parsing)
                            const cprItem = {
                                r3: parseFloat(row.cells[3]?.getAttribute('data-value') || '0'),
                                r2: parseFloat(row.cells[4]?.getAttribute('data-value') || '0'),
                                r1: parseFloat(row.cells[5]?.getAttribute('data-value') || '0'),
                                tc: parseFloat(row.cells[6]?.getAttribute('data-value') || '0'),
                                pp: parseFloat(row.cells[7]?.textContent.replace(/[RS]/g, '') || '0'), // PP doesn't have S/R tags
                                bc: parseFloat(row.cells[8]?.getAttribute('data-value') || '0'),
                                s1: parseFloat(row.cells[9]?.getAttribute('data-value') || '0'),
                                s2: parseFloat(row.cells[10]?.getAttribute('data-value') || '0'),
                                s3: parseFloat(row.cells[11]?.getAttribute('data-value') || '0'),
                                prev_close: prevClose
                            };

                            // Update range column with real-time calculation
                            row.cells[1].innerHTML = this.getCprRange(ltp, cprItem);

                            // Recalculate immediate support/resistance levels
                            const levels = [
                                { name: 'R3', value: cprItem.r3 },
                                { name: 'R2', value: cprItem.r2 },
                                { name: 'R1', value: cprItem.r1 },
                                { name: 'TC', value: cprItem.tc },
                                { name: 'BC', value: cprItem.bc },
                                { name: 'S1', value: cprItem.s1 },
                                { name: 'S2', value: cprItem.s2 },
                                { name: 'S3', value: cprItem.s3 }
                            ];

                            const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);

                            // Update all level columns with new S/R indicators
                            const levelCells = [
                                { cell: row.cells[3], level: 'R3', value: cprItem.r3 },
                                { cell: row.cells[4], level: 'R2', value: cprItem.r2 },
                                { cell: row.cells[5], level: 'R1', value: cprItem.r1 },
                                { cell: row.cells[6], level: 'TC', value: cprItem.tc },
                                { cell: row.cells[8], level: 'BC', value: cprItem.bc },
                                { cell: row.cells[9], level: 'S1', value: cprItem.s1 },
                                { cell: row.cells[10], level: 'S2', value: cprItem.s2 },
                                { cell: row.cells[11], level: 'S3', value: cprItem.s3 }
                            ];

                            levelCells.forEach(({ cell, level, value }) => {
                                if (cell) {
                                    const srTag = this.getImmediateLevelTag(level, immediateResistance, immediateSupport);
                                    cell.innerHTML = `${srTag}${value.toFixed(2)}`;
                                }
                            });
                        }

                        // Update break status indicators
                        if (row) {
                            this.updateCprBreakStatus(row, normalizedSymbol, ltp);
                        }
                    }
                }
            }

            updateFibonacciLTP(data) {
                // Update LTP in Fibonacci table if symbol exists
                const symbol = data.symbol;
                const ltp = data.ltp;

                if (symbol && ltp) {
                    const ltpCell = document.querySelector(`#fibTableBody tr[data-symbol="${symbol}"] .ltp-value`);
                    if (ltpCell) {
                        const row = ltpCell.closest('tr');

                        // Get previous close from the database or calculate from change data
                        const changePercent = data.change_percent || data.chp;
                        let prevClose = null;

                        if (changePercent !== undefined && changePercent !== 0) {
                            prevClose = ltp / (1 + (changePercent / 100));
                        }

                        // Apply color based on change percentage
                        const colorClass = this.getLtpColorClass(ltp, prevClose);
                        ltpCell.className = `text-end ltp-value ${colorClass}`;
                        ltpCell.textContent = `${ltp.toFixed(2)}`;

                        // Update Range column and S/R tags with real-time calculation
                        if (row && row.cells[1]) {
                            // Extract Fibonacci levels from data attributes (robust parsing)
                            const fibItem = {
                                r3_161: parseFloat(row.cells[4]?.getAttribute('data-value') || '0'),
                                r2_123: parseFloat(row.cells[5]?.getAttribute('data-value') || '0'),
                                r1_61: parseFloat(row.cells[6]?.getAttribute('data-value') || '0'),
                                s1_61: parseFloat(row.cells[7]?.getAttribute('data-value') || '0'),
                                s2_123: parseFloat(row.cells[8]?.getAttribute('data-value') || '0'),
                                s3_161: parseFloat(row.cells[9]?.getAttribute('data-value') || '0'),
                                level_38: parseFloat(row.cells[10]?.getAttribute('data-value') || '0'),
                                level_50: parseFloat(row.cells[11]?.getAttribute('data-value') || '0'),
                                pp: parseFloat(row.cells[3]?.textContent.replace(/[RS]/g, '') || '0'), // PP doesn't have S/R tags
                                prev_close: prevClose
                            };

                            // Update range column with real-time calculation
                            row.cells[1].innerHTML = this.getFibonacciRange(ltp, fibItem);

                            // Recalculate immediate support/resistance levels
                            const levels = [
                                { name: 'R3', value: fibItem.r3_161 },
                                { name: 'R2', value: fibItem.r2_123 },
                                { name: 'R1', value: fibItem.r1_61 },
                                { name: 'S1', value: fibItem.s1_61 },
                                { name: 'S2', value: fibItem.s2_123 },
                                { name: 'S3', value: fibItem.s3_161 },
                                { name: '38%', value: fibItem.level_38 },
                                { name: '50%', value: fibItem.level_50 }
                            ];

                            const { immediateResistance, immediateSupport } = this.findImmediateLevels(ltp, levels);

                            // Update all level columns with new S/R indicators
                            const levelCells = [
                                { cell: row.cells[4], level: 'R3', value: fibItem.r3_161 },
                                { cell: row.cells[5], level: 'R2', value: fibItem.r2_123 },
                                { cell: row.cells[6], level: 'R1', value: fibItem.r1_61 },
                                { cell: row.cells[7], level: 'S1', value: fibItem.s1_61 },
                                { cell: row.cells[8], level: 'S2', value: fibItem.s2_123 },
                                { cell: row.cells[9], level: 'S3', value: fibItem.s3_161 },
                                { cell: row.cells[10], level: '38%', value: fibItem.level_38 },
                                { cell: row.cells[11], level: '50%', value: fibItem.level_50 }
                            ];

                            levelCells.forEach(({ cell, level, value }) => {
                                if (cell) {
                                    const srTag = this.getImmediateLevelTag(level, immediateResistance, immediateSupport);
                                    cell.innerHTML = `${srTag}${value.toFixed(2)}`;
                                }
                            });
                        }

                        // Update break status indicators
                        if (row) {
                            this.updateFibonacciBreakStatus(row, symbol, ltp);
                        }
                    }
                }
            }

            updateCprBreakStatus(row, symbol, ltp) {
                // Get CPR levels from the row
                const levels = {
                    tc: parseFloat(row.querySelector('[data-level="TC"]')?.textContent.replace('', '') || '0'),
                    bc: parseFloat(row.querySelector('[data-level="BC"]')?.textContent.replace('', '') || '0'),
                    r1: parseFloat(row.querySelector('[data-level="R1"]')?.textContent.replace('', '') || '0'),
                    r2: parseFloat(row.querySelector('[data-level="R2"]')?.textContent.replace('', '') || '0'),
                    r3: parseFloat(row.querySelector('[data-level="R3"]')?.textContent.replace('', '') || '0'),
                    s1: parseFloat(row.querySelector('[data-level="S1"]')?.textContent.replace('', '') || '0'),
                    s2: parseFloat(row.querySelector('[data-level="S2"]')?.textContent.replace('', '') || '0'),
                    s3: parseFloat(row.querySelector('[data-level="S3"]')?.textContent.replace('', '') || '0')
                };

                // Determine break level and trend
                let breakLevel = 'None';
                let trend = 'sideways';
                let trendClass = 'bg-warning';

                if (ltp > levels.r3) {
                    breakLevel = 'R3';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.r2) {
                    breakLevel = 'R2';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.r1) {
                    breakLevel = 'R1';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.tc) {
                    breakLevel = 'TC';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp < levels.s3) {
                    breakLevel = 'S3';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.s2) {
                    breakLevel = 'S2';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.s1) {
                    breakLevel = 'S1';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.bc) {
                    breakLevel = 'BC';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                }

                // Apply color coding to all levels based on level type
                row.querySelectorAll('.level-value').forEach(cell => {
                    const levelAttr = cell.getAttribute('data-level');
                    const colorClass = this.getLevelColorClass(levelAttr);
                    cell.className = `text-end level-value ${colorClass}`;
                });

                // Update badges
                const breakBadge = row.querySelector('.badge');
                const trendBadge = row.querySelectorAll('.badge')[1];

                if (breakBadge) {
                    breakBadge.textContent = breakLevel;
                    breakBadge.className = `badge ${this.getBreakLevelClass(breakLevel)}`;
                }

                if (trendBadge) {
                    trendBadge.textContent = trend.charAt(0).toUpperCase() + trend.slice(1);
                    trendBadge.className = `badge ${trendClass}`;
                }
            }

            updateFibonacciBreakStatus(row, symbol, ltp) {
                // Get Fibonacci levels from the row
                const levels = {
                    r3: parseFloat(row.querySelector('[data-level="R3"]')?.textContent.replace('', '') || '0'),
                    r2: parseFloat(row.querySelector('[data-level="R2"]')?.textContent.replace('', '') || '0'),
                    r1: parseFloat(row.querySelector('[data-level="R1"]')?.textContent.replace('', '') || '0'),
                    s1: parseFloat(row.querySelector('[data-level="S1"]')?.textContent.replace('', '') || '0'),
                    s2: parseFloat(row.querySelector('[data-level="S2"]')?.textContent.replace('', '') || '0'),
                    s3: parseFloat(row.querySelector('[data-level="S3"]')?.textContent.replace('', '') || '0')
                };

                // Determine break level and trend
                let breakLevel = 'None';
                let trend = 'sideways';
                let trendClass = 'bg-warning';

                if (ltp > levels.r3) {
                    breakLevel = 'R3';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.r2) {
                    breakLevel = 'R2';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp > levels.r1) {
                    breakLevel = 'R1';
                    trend = 'bullish';
                    trendClass = 'bg-success';
                } else if (ltp < levels.s3) {
                    breakLevel = 'S3';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.s2) {
                    breakLevel = 'S2';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                } else if (ltp < levels.s1) {
                    breakLevel = 'S1';
                    trend = 'bearish';
                    trendClass = 'bg-danger';
                }

                // Apply color coding to all levels based on level type
                row.querySelectorAll('.level-value').forEach(cell => {
                    const levelAttr = cell.getAttribute('data-level');
                    const colorClass = this.getLevelColorClass(levelAttr);
                    cell.className = `text-end level-value ${colorClass}`;
                });

                // Update badges
                const breakBadge = row.querySelector('.badge');
                const trendBadge = row.querySelectorAll('.badge')[1];

                if (breakBadge) {
                    breakBadge.textContent = breakLevel;
                    breakBadge.className = `badge ${this.getBreakLevelClass(breakLevel)}`;
                }

                if (trendBadge) {
                    trendBadge.textContent = trend.charAt(0).toUpperCase() + trend.slice(1);
                    trendBadge.className = `badge ${trendClass}`;
                }
            }

            showProgress(percent) {
                const progressDiv = document.getElementById('fetchProgress');
                const progressBar = progressDiv.querySelector('.progress-bar');
                progressDiv.style.display = 'block';
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
            }

            hideProgress() {
                document.getElementById('fetchProgress').style.display = 'none';
            }

            showAlert(type, message, autoHide = true) {
                const alertContainer = document.getElementById('alertContainer');

                // If alert container doesn't exist (alert system removed), just log to console
                if (!alertContainer) {
                    console.log(`Alert [${type}]: ${message}`);
                    return;
                }

                const alertId = 'alert_' + Date.now();

                const alertHtml = `
                    <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <i class="fas fa-${this.getAlertIcon(type)} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;

                alertContainer.insertAdjacentHTML('beforeend', alertHtml);

                if (autoHide) {
                    setTimeout(() => {
                        const alertElement = document.getElementById(alertId);
                        if (alertElement) {
                            alertElement.remove();
                        }
                    }, 5000);
                }
            }

            getAlertIcon(type) {
                const icons = {
                    'success': 'check-circle',
                    'danger': 'exclamation-triangle',
                    'warning': 'exclamation-circle',
                    'info': 'info-circle'
                };
                return icons[type] || 'info-circle';
            }

            updateCategorySections(stocks) {
                // Include only stocks (NO index symbols) with valid LTP and change data
                const validStocks = stocks.filter(stock => 
                    stock.ltp && 
                    stock.change_percent !== undefined &&
                    stock.full_symbol && 
                    !stock.full_symbol.includes('-INDEX')
                );

                // Top 5 Gainers (highest positive change %)
                const topGainers = validStocks
                    .filter(stock => stock.change_percent > 0)
                    .sort((a, b) => b.change_percent - a.change_percent)
                    .slice(0, 5);

                // Top 5 Losers (highest negative change %)
                const topLosers = validStocks
                    .filter(stock => stock.change_percent < 0)
                    .sort((a, b) => a.change_percent - b.change_percent)
                    .slice(0, 5);

                // Top 5 Intraday Recoveries (stocks that hit low 1% below prev close AND recovered back to prev close level)
                const topRecoveries = validStocks
                    .filter(stock => {
                        if (!stock.low_price || !stock.prev_close_price || !stock.ltp || stock.prev_close_price <= 0) return false;
                        // Must hit low 1% below prev close AND recovered back to prev close level
                        const hitLowBelowPrevClose = stock.low_price <= (stock.prev_close_price * 0.99);
                        const recoveredToPrevClose = stock.ltp >= stock.prev_close_price;
                        return hitLowBelowPrevClose && recoveredToPrevClose;
                    })
                    .map(stock => ({
                        ...stock,
                        gainFromLow: stock.low_price ? ((stock.ltp - stock.low_price) / stock.low_price) * 100 : 0
                    }))
                    .sort((a, b) => b.gainFromLow - a.gainFromLow)
                    .slice(0, 5);

                // Top 5 Intraday Fall (stocks that hit high 1% above prev close AND fallen back to prev close level)
                const topFall = validStocks
                    .filter(stock => {
                        if (!stock.high_price || !stock.prev_close_price || !stock.ltp || stock.prev_close_price <= 0) return false;
                        // Must hit high 1% above prev close AND fallen back to prev close level
                        const hitHighAbovePrevClose = stock.high_price >= (stock.prev_close_price * 1.01);
                        const fallenToPrevClose = stock.ltp <= stock.prev_close_price;
                        return hitHighAbovePrevClose && fallenToPrevClose;
                    })
                    .map(stock => ({
                        ...stock,
                        fallFromHigh: stock.high_price ? ((stock.high_price - stock.ltp) / stock.high_price) * 100 : 0
                    }))
                    .sort((a, b) => b.fallFromHigh - a.fallFromHigh)
                    .slice(0, 5);

                // Top 5 Gap Up (open significantly higher than prev close)
                const topGapUp = validStocks
                    .map(stock => ({
                        ...stock,
                        gapPercent: stock.prev_close_price && stock.open_price ? 
                            ((stock.open_price - stock.prev_close_price) / stock.prev_close_price) * 100 : 0
                    }))
                    .filter(stock => stock.gapPercent > 0)
                    .sort((a, b) => b.gapPercent - a.gapPercent)
                    .slice(0, 5);

                // Top 5 Gap Down (open significantly lower than prev close)
                const topGapDown = validStocks
                    .filter(stock => {
                        if (!stock.prev_close_price || !stock.open_price) return false;
                        const gapDown = ((stock.open_price - stock.prev_close_price) / stock.prev_close_price) * 100;
                        return gapDown < 0; // Must have gapped down
                    })
                    .map(stock => ({
                        ...stock,
                        gapPercent: stock.open_price && stock.ltp ? 
                            ((stock.ltp - stock.open_price) / stock.open_price) * 100 : 0
                    }))
                    .sort((a, b) => {
                        // Sort by gap down size (most negative gap first)
                        const gapA = ((a.open_price - a.prev_close_price) / a.prev_close_price) * 100;
                        const gapB = ((b.open_price - b.prev_close_price) / b.prev_close_price) * 100;
                        return gapA - gapB;
                    })
                    .slice(0, 5);

                // Top 5 High Volatile (highest high-low range % with change %)
                const topHighVolatile = validStocks
                    .map(stock => ({
                        ...stock,
                        rangePercent: stock.high_price && stock.low_price ? 
                            ((stock.high_price - stock.low_price) / stock.low_price) * 100 : 0
                    }))
                    .filter(stock => stock.rangePercent > 1) // Only stocks with range > 1%
                    .sort((a, b) => b.rangePercent - a.rangePercent)
                    .slice(0, 5);

                // Top 5 Less Volatile (lowest range % with change %)
                const topLessVolatile = validStocks
                    .map(stock => ({
                        ...stock,
                        rangePercent: stock.high_price && stock.low_price ? 
                            ((stock.high_price - stock.low_price) / stock.low_price) * 100 : 0
                    }))
                    .filter(stock => stock.rangePercent > 0 && stock.rangePercent < 1) // Only stocks with range < 1%
                    .sort((a, b) => a.rangePercent - b.rangePercent)
                    .slice(0, 5);

                // Update the UI with compact list style
                this.populateCategoryList('topGainersList', topGainers, 'change_percent', '%', 'success');
                this.populateCategoryList('topLosersList', topLosers, 'change_percent', '%', 'danger');
                this.populateCategoryList('topRecoveriesList', topRecoveries, 'gainFromLow', '%', 'info');
                this.populateCategoryList('topFallList', topFall, 'fallFromHigh', '%', 'danger');
                this.populateCategoryList('topGapUpList', topGapUp, 'change_percent', '%', 'primary');
                this.populateCategoryList('topGapDownList', topGapDown, 'gapPercent', '%', 'secondary');
                this.populateCategoryList('topRangesList', topHighVolatile, 'change_percent', '%', 'warning');
                this.populateCategoryList('topLessVolatileList', topLessVolatile, 'change_percent', '%', 'light');

                // Top 5 Turn Positive (opened negative but now trading positive)
                const topTurnPositive = validStocks
                    .filter(stock => {
                        if (!stock.open_price || !stock.prev_close_price || !stock.ltp) return false;
                        const openVsPrev = stock.open_price - stock.prev_close_price;
                        const ltpVsPrev = stock.ltp - stock.prev_close_price;
                        return openVsPrev < 0 && ltpVsPrev > 0; // opened negative, now positive
                    })
                    .map(stock => ({
                        ...stock,
                        turnMagnitude: stock.change_percent || 0
                    }))
                    .sort((a, b) => b.turnMagnitude - a.turnMagnitude) // highest positive change first
                    .slice(0, 5);

                // Top 5 Turn Negative (opened positive but now trading negative) 
                const topTurnNegative = validStocks
                    .filter(stock => {
                        if (!stock.open_price || !stock.prev_close_price || !stock.ltp) return false;
                        const openVsPrev = stock.open_price - stock.prev_close_price;
                        const ltpVsPrev = stock.ltp - stock.prev_close_price;
                        return openVsPrev > 0 && ltpVsPrev < 0; // opened positive, now negative
                    })
                    .map(stock => ({
                        ...stock,
                        turnMagnitude: Math.abs(stock.change_percent || 0)
                    }))
                    .sort((a, b) => b.turnMagnitude - a.turnMagnitude) // highest negative magnitude first
                    .slice(0, 5);

                this.populateCategoryList('topTurnPositiveList', topTurnPositive, 'change_percent', '%', 'success');
                this.populateCategoryList('topTurnNegativeList', topTurnNegative, 'change_percent', '%', 'danger');
                
                // Populate F&O Stocks in Action
                this.populateStocksInAction({
                    topRecoveries,
                    topFall,
                    topGapUp,
                    topGapDown,
                    topGainers,
                    topLosers,
                    topTurnPositive,
                    topTurnNegative,
                    topHighVolatile,
                    topLessVolatile
                });
            }
            
            async populateStocksInAction(data) {
                const container = document.getElementById('stocksInActionContainer');
                if (!container) return;
                
                // Define the 10 cards
                const cards = [
                    { name: 'INTRADAY RECOVERIES', data: data.topRecoveries, icon: 'fa-arrow-trend-up', color: '#17a2b8' },
                    { name: 'INTRADAY FALL', data: data.topFall, icon: 'fa-arrow-trend-down', color: '#ffc107' },
                    { name: 'TOP GAP UP', data: data.topGapUp, icon: 'fa-level-up-alt', color: '#007bff' },
                    { name: 'TOP GAP DOWN', data: data.topGapDown, icon: 'fa-level-down-alt', color: '#6c757d' },
                    { name: 'TOP GAINERS', data: data.topGainers, icon: 'fa-chart-line', color: '#28a745' },
                    { name: 'TOP LOSERS', data: data.topLosers, icon: 'fa-chart-line-down', color: '#dc3545' },
                    { name: 'TURN POSITIVE', data: data.topTurnPositive, icon: 'fa-plus-circle', color: '#28a745' },
                    { name: 'TURN NEGATIVE', data: data.topTurnNegative, icon: 'fa-minus-circle', color: '#dc3545' },
                    { name: 'HIGH VOLATILE', data: data.topHighVolatile, icon: 'fa-bolt', color: '#ffc107' },
                    { name: 'LESS ACTIVE', data: data.topLessVolatile, icon: 'fa-minus', color: '#17a2b8' }
                ];
                
                // Track used stocks to avoid duplicates
                const usedStocks = new Set();
                const selectedStocks = [];
                
                // Select top stock from each card, use 2nd if duplicate
                cards.forEach(card => {
                    if (!card.data || card.data.length === 0) return;
                    
                    let stock = null;
                    for (let i = 0; i < card.data.length; i++) {
                        const candidate = card.data[i];
                        const symbol = candidate.symbol.replace('NSE:', '');
                        
                        if (!usedStocks.has(symbol)) {
                            stock = candidate;
                            usedStocks.add(symbol);
                            break;
                        }
                    }
                    
                    if (stock) {
                        selectedStocks.push({
                            ...stock,
                            cardName: card.name,
                            cardIcon: card.icon,
                            cardColor: card.color
                        });
                    }
                });
                
                // Store card metadata for real-time updates
                this.stocksInActionMeta = selectedStocks.map(stock => ({
                    symbol: stock.symbol.replace('NSE:', ''),
                    cardName: stock.cardName,
                    cardIcon: stock.cardIcon,
                    cardColor: stock.cardColor
                }));
                
                // Generate HTML for stock cards (without sparklines)
                container.innerHTML = selectedStocks.map(stock => {
                    const symbol = stock.symbol.replace('NSE:', '');
                    const ltp = stock.ltp ? this.formatNumber(stock.ltp) : 'N/A';
                    const changePercent = stock.change_percent || 0;
                    const fromOpen = stock.open_price ? ((stock.ltp - stock.open_price) / stock.open_price * 100) : 0;
                    const fromLow = stock.low_price ? ((stock.ltp - stock.low_price) / stock.low_price * 100) : 0;
                    const fromHigh = stock.high_price ? ((stock.ltp - stock.high_price) / stock.high_price * 100) : 0;
                    
                    const changeColor = changePercent >= 0 ? 'text-success' : 'text-danger';
                    const changeSign = changePercent >= 0 ? '+' : '';
                    
                    // TradingView chart link
                    const tradingViewUrl = `https://www.tradingview.com/chart/?symbol=NSE:${symbol}`;
                    
                    return `
                        <a href="${tradingViewUrl}" target="_blank" class="text-decoration-none">
                            <div class="stock-action-card" data-action-symbol="${symbol}" style="
                                background: linear-gradient(145deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
                                border: 1px solid ${stock.cardColor}40;
                                border-radius: 12px;
                                padding: 12px;
                                transition: all 0.3s ease;
                                cursor: pointer;
                            ">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div style="flex: 1;">
                                    <div class="text-white fw-bold" style="font-size: 1rem;">${symbol}</div>
                                    <div style="color: ${stock.cardColor}; font-size: 0.65rem;">
                                        <i class="fas ${stock.cardIcon} me-1"></i>${stock.cardName}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="text-white fw-bold action-ltp" style="font-size: 0.95rem;">${ltp}</div>
                                    <div class="${changeColor} fw-bold action-change" style="font-size: 0.8rem;">
                                        ${changeSign}${this.formatNumber(changePercent)}%
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between" style="font-size: 0.7rem; margin-top: 8px;">
                                <div class="text-center" style="flex: 1;">
                                    <div class="text-muted">From Open</div>
                                    <div class="action-from-open ${fromOpen >= 0 ? 'text-success' : 'text-danger'}">
                                        ${fromOpen >= 0 ? '+' : ''}${this.formatNumber(fromOpen)}%
                                    </div>
                                </div>
                                <div class="text-center" style="flex: 1;">
                                    <div class="text-muted">From Low</div>
                                    <div class="action-from-low ${fromLow >= 0 ? 'text-success' : 'text-danger'}">
                                        ${fromLow >= 0 ? '+' : ''}${this.formatNumber(fromLow)}%
                                    </div>
                                </div>
                                <div class="text-center" style="flex: 1;">
                                    <div class="text-muted">From High</div>
                                    <div class="action-from-high ${fromHigh >= 0 ? 'text-success' : 'text-danger'}">
                                        ${fromHigh >= 0 ? '+' : ''}${this.formatNumber(fromHigh)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        </a>
                    `;
                }).join('');
            }

            populateCategoryList(elementId, stocks, valueField, suffix, colorClass) {
                const element = document.getElementById(elementId);
                if (!element || !stocks.length) {
                    if (element) {
                        element.innerHTML = '<div class="text-center text-muted py-2" style="font-size: 0.8em;">No data</div>';
                    }
                    return;
                }

                element.innerHTML = stocks.map((stock, index) => {
                    const value = stock[valueField];
                    const isPositive = value >= 0;

                    // Text color logic matching reference design
                    let textClass = '';
                    if (elementId.includes('Gainers') || elementId.includes('GapUp') || elementId.includes('TurnPositive')) {
                        textClass = 'text-success';
                    } else if (elementId.includes('Losers') || elementId.includes('Fall') || elementId.includes('TurnNegative')) {
                        textClass = 'text-danger';
                    } else if (elementId.includes('Recoveries')) {
                        textClass = 'text-success';
                    } else if (elementId.includes('Declining')) {
                        textClass = 'text-warning';
                    } else if (elementId.includes('GapDown')) {
                        // For Gap Down, color based on recovery: green for positive (recovery), red for negative (further decline)
                        textClass = isPositive ? 'text-success' : 'text-danger';
                    } else if (elementId.includes('Ranges')) {
                        // For High Volatile (Ranges), color based on sign: green for positive, red for negative
                        textClass = isPositive ? 'text-success' : 'text-danger';
                    } else if (elementId.includes('LessVolatile')) {
                        // For Less Volatile, color based on sign: green for positive, red for negative
                        textClass = isPositive ? 'text-success' : 'text-danger';
                    } else {
                        textClass = 'text-secondary';
                    }

                    const symbol = stock.symbol.replace('NSE:', '');
                    // Special handling for INTRADAY FALL card - always show negative sign
                    let formattedValue;
                    if (elementId.includes('Fall')) {
                        formattedValue = `-${this.formatNumber(Math.abs(value))}`;
                    } else {
                        formattedValue = isPositive ? `+${this.formatNumber(value)}` : this.formatNumber(value);
                    }

                    // Generate chart link and pattern indicator
                    const chartLink = this.generateChartLink(stock.symbol, symbol);
                    const patternIndicator = this.getPatternIndicator(stock);

                    return `
                        <div class="d-flex justify-content-between align-items-center py-1 px-2 border-bottom border-dark" style="font-size: 0.85em;">
                            <div class="d-flex align-items-center">
                                <span class="text-info fw-bold" style="cursor: pointer;" onclick="window.open('https://in.tradingview.com/chart/?symbol=NSE:${symbol}', '_blank')">${symbol}</span>${patternIndicator}
                                <small class="text-muted ms-2">${this.formatNumber(stock.ltp)}</small>
                            </div>
                            <span class="fw-bold ${textClass}" style="font-size: 0.95em;">${formattedValue}${suffix}</span>
                        </div>
                    `;
                }).join('');
            }

            updateMarketSummary(stocks) {
                // Filter out INDEX symbols from market summary calculations
                const nonIndexStocks = stocks ? stocks.filter(stock => !stock.full_symbol || !stock.full_symbol.includes('-INDEX')) : [];

                // If no data, set everything to 0 and return
                if (!nonIndexStocks || nonIndexStocks.length === 0) {
                    // Update all counters with 0 values - safely
                    const gainersCountEl = document.getElementById('gainersCount');
                    const losersCountEl = document.getElementById('losersCount');
                    const recoveryCountEl = document.getElementById('recoveryCount');
                    const decliningCountEl = document.getElementById('decliningCount');

                    if (gainersCountEl) gainersCountEl.textContent = 0;
                    if (losersCountEl) losersCountEl.textContent = 0;
                    if (recoveryCountEl) recoveryCountEl.textContent = 0;
                    if (decliningCountEl) decliningCountEl.textContent = 0;
                    const gapUpCountEl = document.getElementById('gapUpCount');
                    const gapDownCountEl = document.getElementById('gapDownCount');
                    const turnPositiveCountEl = document.getElementById('turnPositiveCount');
                    const turnNegativeCountEl = document.getElementById('turnNegativeCount');
                    const avgPercentageEl = document.getElementById('avgPercentage');
                    const volumeCountEl = document.getElementById('volumeCount');

                    if (gapUpCountEl) gapUpCountEl.textContent = 0;
                    if (gapDownCountEl) gapDownCountEl.textContent = 0;
                    if (turnPositiveCountEl) turnPositiveCountEl.textContent = 0;
                    if (turnNegativeCountEl) turnNegativeCountEl.textContent = 0;
                    
                    const positiveFromOpenCountEl = document.getElementById('positiveFromOpenCount');
                    const negativeFromOpenCountEl = document.getElementById('negativeFromOpenCount');
                    if (positiveFromOpenCountEl) positiveFromOpenCountEl.textContent = 0;
                    if (negativeFromOpenCountEl) negativeFromOpenCountEl.textContent = 0;
                    if (avgPercentageEl) avgPercentageEl.textContent = '0.00%';
                    const patternCountEl = document.getElementById('patternCount');
                    if (patternCountEl) patternCountEl.textContent = '0/0';
                    if (volumeCountEl) volumeCountEl.textContent = '0M';

                    // Reset progress bars
                    const gainersBarEl = document.getElementById('gainersBar');
                    const losersBarEl = document.getElementById('losersBar');
                    const recoveryBarEl = document.getElementById('recoveryBar');
                    const decliningBarEl = document.getElementById('decliningBar');

                    if (gainersBarEl) gainersBarEl.style.width = '0%';
                    if (losersBarEl) losersBarEl.style.width = '0%';
                    if (recoveryBarEl) recoveryBarEl.style.width = '0%';
                    if (decliningBarEl) decliningBarEl.style.width = '0%';

                    // Reset bar counts
                    const gainersBarCountEl = document.getElementById('gainersBarCount');
                    const losersBarCountEl = document.getElementById('losersBarCount');
                    const recoveryBarCountEl = document.getElementById('recoveryBarCount');
                    const decliningBarCountEl = document.getElementById('decliningBarCount');

                    if (gainersBarCountEl) gainersBarCountEl.textContent = 0;
                    if (losersBarCountEl) losersBarCountEl.textContent = 0;
                    if (recoveryBarCountEl) recoveryBarCountEl.textContent = 0;
                    if (decliningBarCountEl) decliningBarCountEl.textContent = 0;

                    // Set neutral card styles
                    const gainersCardEl = document.getElementById('gainersCount');
                    const losersCardEl = document.getElementById('losersCount');
                    const avgCardEl = document.getElementById('avgPercentage');

                    const gainersCard = gainersCardEl ? gainersCardEl.closest('.card') : null;
                    const losersCard = losersCardEl ? losersCardEl.closest('.card') : null;
                    const avgCard = avgCardEl ? avgCardEl.closest('.card') : null;

                    if (gainersCard) gainersCard.className = 'card glow-card glow-secondary text-white';
                    if (losersCard) losersCard.className = 'card glow-card glow-secondary text-white';
                    if (avgCard) avgCard.className = 'card glow-card glow-secondary';
                    if (avgCardEl) avgCardEl.className = 'mb-0 me-2 fw-bold text-secondary';

                    return;
                }

                let gainers = 0, losers = 0, recovery = 0, declining = 0;
                let gapUp = 0, gapDown = 0, turnPositive = 0, turnNegative = 0;
                let positiveFromOpen = 0, negativeFromOpen = 0;
                let totalChange = 0, totalVolume = 0;
                let oEqualH = 0, oEqualL = 0;

                // Enhanced volume calculation with better data handling
                let validVolumeStocks = 0;
                let zeroVolumeStocks = 0;

                nonIndexStocks.forEach(stock => {
                    const change = stock.change_percent || 0;

                    // Robust volume parsing - handle different data types
                    let volume = 0;
                    if (stock.volume !== undefined && stock.volume !== null) {
                        // Convert to number and ensure it's positive
                        volume = Math.max(0, parseInt(stock.volume) || 0);
                    }

                    // Debug volume data
                    if (volume > 0) {
                        validVolumeStocks++;
                    } else {
                        zeroVolumeStocks++;
                    }

                    // Count gainers and losers
                    if (change > 0) gainers++;
                    else if (change < 0) losers++;

                    // Count recovery and declining using correct logic based on previous day's close
                    // INTRADAY RECOVERY: stocks that hit low 1% below prev close AND recovered back to prev close level
                    if (stock.low_price && stock.prev_close_price && stock.ltp && stock.prev_close_price > 0) {
                        const isRecovery = (stock.low_price <= stock.prev_close_price * 0.99) && (stock.ltp >= stock.prev_close_price);
                        if (isRecovery) recovery++;
                    }

                    // INTRADAY FALL: stocks that hit high 1% above prev close AND fallen back to prev close level
                    if (stock.high_price && stock.prev_close_price && stock.ltp && stock.prev_close_price > 0) {
                        const isFall = (stock.high_price >= stock.prev_close_price * 1.01) && (stock.ltp <= stock.prev_close_price);
                        if (isFall) declining++;
                    }

                    // Count gap up/down based on opening vs previous close (constant throughout day)
                    if (stock.open_price && stock.prev_close_price) {
                        const gapPercent = ((stock.open_price - stock.prev_close_price) / stock.prev_close_price) * 100;
                        if (gapPercent > 0.5) gapUp++;
                        else if (gapPercent < -0.5) gapDown++;
                    }

                    // Count Turn+ and Turn- 
                    if (stock.open_price && stock.prev_close_price && stock.ltp) {
                        const openVsPrev = stock.open_price - stock.prev_close_price;
                        const ltpVsPrev = stock.ltp - stock.prev_close_price;

                        // Turn+: opened negative but now trading positive
                        if (openVsPrev < 0 && ltpVsPrev > 0) {
                            turnPositive++;
                        }
                        // Turn-: opened positive but now trading negative
                        if (openVsPrev > 0 && ltpVsPrev < 0) {
                            turnNegative++;
                        }
                    }

                    // Count +FromOpen and -FromOpen
                    if (stock.open_price && stock.ltp) {
                        const ltpVsOpen = stock.ltp - stock.open_price;
                        
                        // +FromOpen: current price is above opening price
                        if (ltpVsOpen > 0) {
                            positiveFromOpen++;
                        }
                        // -FromOpen: current price is below opening price
                        else if (ltpVsOpen < 0) {
                            negativeFromOpen++;
                        }
                    }

                    // Add to totals with type safety
                    totalChange += (typeof change === 'number' ? change : 0);
                    totalVolume += (typeof volume === 'number' && volume > 0 ? volume : 0);

                    // Correct O=H/O=L pattern counting
                    if (stock.open_price && stock.high_price && stock.low_price) {
                        const isOpenHigh = Math.abs(stock.open_price - stock.high_price) <= (stock.high_price * 0.001);
                        const isOpenLow = Math.abs(stock.open_price - stock.low_price) <= (stock.low_price * 0.001);

                        if (isOpenHigh) oEqualH++;
                        if (isOpenLow) oEqualL++;
                    }
                });

                // Update the cards with logic-based colors
                const gainersCountEl = document.getElementById('gainersCount');
                if (gainersCountEl) gainersCountEl.textContent = gainers;
                const gainersCard = gainersCountEl ? gainersCountEl.closest('.card') : null;
                if (gainersCard) gainersCard.className = gainers > losers ? 'card glow-card glow-success text-white' : 'card glow-card glow-secondary text-white';

                const losersCountEl = document.getElementById('losersCount');
                if (losersCountEl) losersCountEl.textContent = losers;
                const losersCard = losersCountEl ? losersCountEl.closest('.card') : null;
                if (losersCard) losersCard.className = losers > gainers ? 'card glow-card glow-danger text-white' : 'card glow-card glow-secondary text-white';

                const updateSafely = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };

                updateSafely('recoveryCount', recovery);
                updateSafely('decliningCount', declining);
                updateSafely('positiveFromOpenCount', positiveFromOpen);
                updateSafely('negativeFromOpenCount', negativeFromOpen);
                updateSafely('gapUpCount', gapUp);
                updateSafely('gapDownCount', gapDown);
                updateSafely('turnPositiveCount', turnPositive);
                updateSafely('turnNegativeCount', turnNegative);
                updateSafely('openHighCount', oEqualH);
                updateSafely('openLowCount', oEqualL);

                // Update bar charts
                const total = stocks.length;
                updateSafely('gainersBarCount', gainers);
                updateSafely('losersBarCount', losers);
                updateSafely('recoveryBarCount', recovery);
                updateSafely('decliningBarCount', declining);
                updateSafely('turnPositiveBarCount', turnPositive);
                updateSafely('turnNegativeBarCount', turnNegative);
                updateSafely('positiveFromOpenBarCount', positiveFromOpen);
                updateSafely('negativeFromOpenBarCount', negativeFromOpen);
                updateSafely('openHighBarCount', oEqualH);
                updateSafely('openLowBarCount', oEqualL);

                // Update progress bars with percentages
                const updateBarSafely = (id, percentage) => {
                    const el = document.getElementById(id);
                    if (el) el.style.width = `${percentage}%`;
                };

                updateBarSafely('gainersBar', Math.round((gainers / total) * 100));
                updateBarSafely('losersBar', Math.round((losers / total) * 100));
                updateBarSafely('recoveryBar', Math.round((recovery / total) * 100));
                updateBarSafely('decliningBar', Math.round((declining / total) * 100));
                updateBarSafely('turnPositiveBar', Math.round((turnPositive / total) * 100));
                updateBarSafely('turnNegativeBar', Math.round((turnNegative / total) * 100));
                updateBarSafely('positiveFromOpenBar', Math.round((positiveFromOpen / total) * 100));
                updateBarSafely('negativeFromOpenBar', Math.round((negativeFromOpen / total) * 100));
                updateBarSafely('openHighBar', Math.round((oEqualH / total) * 100));
                updateBarSafely('openLowBar', Math.round((oEqualL / total) * 100));

                // Calculate and display averages with color logic
                const avgPercent = (totalChange / stocks.length).toFixed(2);
                const avgElement = document.getElementById('avgPercentage');
                if (avgElement) avgElement.textContent = avgPercent + '%';
                const avgCard = avgElement ? avgElement.closest('.card') : null;
                const isPositive = parseFloat(avgPercent) >= 0;
                if (avgCard) avgCard.className = isPositive ? 'card glow-card glow-success' : 'card glow-card glow-danger';
                if (avgElement) avgElement.className = isPositive ? 'mb-0 me-2 fw-bold text-success' : 'mb-0 me-2 fw-bold text-danger';

                // Pattern ratio
                const patternCountEl2 = document.getElementById('patternCount');
                if (patternCountEl2) patternCountEl2.textContent = `${oEqualH}/${oEqualL}`;

                // Calculate volume in millions with fallback
                const volumeInM = totalVolume > 0 ? Math.round(totalVolume / 1000000) : 0;

                // Debug: Log volume calculation details (only if we have data)
                if (nonIndexStocks.length > 0) {
                    console.log(`F&O Volume Debug: Total stocks: ${nonIndexStocks.length}, Valid volume: ${validVolumeStocks}, Zero volume: ${zeroVolumeStocks}`);
                    console.log(`Total volume raw: ${totalVolume}, Total volume in millions: ${volumeInM}M`);
                }

                // Update volume display
                updateSafely('volumeCount', volumeInM + 'M');
            }

            getPercentClass(basePrice, currentPrice) {
                if (!basePrice || !currentPrice) return 'text-muted';
                const percent = ((currentPrice - basePrice) / basePrice) * 100;
                return percent >= 0 ? 'text-success' : 'text-danger';
            }

            formatPercent(basePrice, currentPrice) {
                if (!basePrice || !currentPrice) return '0.00';
                const percent = ((currentPrice - basePrice) / basePrice) * 100;
                return this.formatNumber(percent);
            }

            showLoading(show) {
                // Loading modal removed as requested
            }

            async loadInitialData() {
                try {
                    console.log('Loading initial data from historical records...');
                    const response = await fetch('/api/initial-data');
                    const data = await response.json();

                    if (data.status === 'success' && data.data.length > 0) {
                        console.log(`Loaded ${data.data.length} stocks from historical data`);

                        // Update the main table with historical data
                        this.updateMainTable(data.data);

                        // Update market summary with historical data
                        this.updateMarketSummary(data.data);

                        // Store this as initial data for comparison
                        this.initialDataLoaded = true;

                        // Show a notification that historical data is loaded
                        const notification = document.createElement('div');
                        notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
                        notification.style.cssText = 'top: 20px; right: 20px; z-index: 2000; max-width: 400px;';
                        notification.innerHTML = `
                            <i class="fas fa-info-circle me-2"></i>
                            Previous day data loaded. Live data will update automatically when market opens.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(notification);

                        // Auto-remove notification after 5 seconds
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        }, 5000);

                    } else {
                        console.log('No initial data available from historical records');
                    }
                } catch (error) {
                    console.error('Error loading initial data:', error);
                }
            }

            getCleanSymbol(fullSymbol) {
                if (!fullSymbol) return '';
                return fullSymbol.replace('NSE:', '').replace('-EQ', '');
            }


        }

        // Initialize dashboard when page loads - make it global for sidebar access
        let dashboard;
        let leftSidebarOpen = false;

        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new Dashboard();

            // INDEX Cards Hide/Show functionality
            const toggleBtn = document.getElementById('toggleIndexCards');
            const indexContainer = document.getElementById('indexCardsContainer');
            const toggleIcon = document.getElementById('indexToggleIcon');

            if (toggleBtn && indexContainer && toggleIcon) {
                toggleBtn.addEventListener('click', function() {
                    if (indexContainer.style.display === 'none') {
                        indexContainer.style.display = 'block';
                        toggleIcon.className = 'fas fa-eye';
                    } else {
                        indexContainer.style.display = 'none';
                        toggleIcon.className = 'fas fa-eye-slash';
                    }
                });
            }

            // Price Action Cards Hide/Show functionality
            const priceActionToggleBtn = document.getElementById('togglePriceActionCards');
            const priceActionContainer = document.getElementById('priceActionCardsContainer');
            const priceActionToggleIcon = document.getElementById('priceActionToggleIcon');

            if (priceActionToggleBtn && priceActionContainer && priceActionToggleIcon) {
                priceActionToggleBtn.addEventListener('click', function() {
                    if (priceActionContainer.style.display === 'none') {
                        priceActionContainer.style.display = 'block';
                        priceActionToggleIcon.className = 'fas fa-eye';
                    } else {
                        priceActionContainer.style.display = 'none';
                        priceActionToggleIcon.className = 'fas fa-eye-slash';
                    }
                });
            }

            // Add click event listeners to all index cards - open directly in new windows
            document.querySelectorAll('.index-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    e.preventDefault();
                    const indexSymbol = this.getAttribute('data-index-symbol');
                    if (indexSymbol) {
                        const chartUrl = dashboard.generateIndexChartLink(indexSymbol);
                        window.open(chartUrl, '_blank', 'noopener');
                    }
                });
            });

            // Add delegated click listener for chart links
            document.addEventListener('click', function(e) {
                if (e.target.closest('.chart-link')) {
                    e.preventDefault();
                    const link = e.target.closest('.chart-link');
                    const chartUrl = link.getAttribute('data-chart-url') || link.getAttribute('href');
                    const symbolName = link.getAttribute('data-symbol') || 'Chart';

                    // Try floating browser first, fallback to new tab
                    if (window.floatingBrowser && chartUrl) {
                        window.floatingBrowser.openChart(chartUrl, symbolName);
                    } else if (chartUrl) {
                        window.open(chartUrl, '_blank', 'noopener');
                    }
                }
            });

            // Load initial data first, then start live updates
            console.log(' INIT: Starting dashboard initialization');
            dashboard.loadInitialData().then(() => {
                console.log(' INIT: Initial data loaded, now loading watchlist');
                // Load user's watchlist after initial data is loaded
                loadUserWatchlistData();
            }).catch(error => {
                console.error(' INIT ERROR: Failed to load initial data:', error);
            });
        });


        function toggleFOSummary() {
            const summaryBody = document.getElementById('foSummaryBody');
            const toggleIcon = document.getElementById('foToggleIcon');

            if (summaryBody.style.display === 'none') {
                summaryBody.style.display = 'block';
                toggleIcon.className = 'fas fa-eye';
            } else {
                summaryBody.style.display = 'none';
                toggleIcon.className = 'fas fa-eye-slash';
            }
        }

        function toggleTable(tableBodyId, iconId) {
            const tableBody = document.getElementById(tableBodyId);
            const toggleIcon = document.getElementById(iconId);

            if (tableBody.style.display === 'none') {
                tableBody.style.display = '';
                toggleIcon.className = 'fas fa-eye';
            } else {
                tableBody.style.display = 'none';
                toggleIcon.className = 'fas fa-eye-slash';
            }
        }

        // Watchlist Management Functions
        let userWatchlist = new Set();

        async function toggleWatchlist(symbol, fullSymbol) {
            try {
                const button = document.querySelector(`[data-symbol="${symbol}"]`);
                const isCurrentlyInWatchlist = userWatchlist.has(symbol);

                // Show loading state
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;

                const url = isCurrentlyInWatchlist ? '/api/watchlist/remove' : '/api/watchlist/add';
                let requestBody;

                if (isCurrentlyInWatchlist) {
                    requestBody = { symbol: symbol };
                } else {
                    // Get current LTP from live data when adding - try multiple sources
                    let currentLtp = null;

                    // Try to get from global stockData first
                    if (window.stockData && window.stockData[fullSymbol]) {
                        currentLtp = window.stockData[fullSymbol].ltp;
                    }

                    // If not found, try to get from the table row directly
                    if (!currentLtp) {
                        const row = document.querySelector(`tr[data-symbol="${symbol}"]`);
                        if (row) {
                            const ltpCell = row.querySelector('.ltp-value');
                            if (ltpCell && ltpCell.textContent !== '--') {
                                const ltpText = ltpCell.textContent.replace('', '').replace(/,/g, '');
                                currentLtp = parseFloat(ltpText);
                            }
                        }
                    }

                    // Defensive guard against NaN
                    if (isNaN(currentLtp)) {
                        currentLtp = null;
                    }

                    // Log for debugging
                    console.log(`Adding ${symbol} to watchlist with LTP: ${currentLtp}`);

                    requestBody = { 
                        symbol: symbol, 
                        full_symbol: fullSymbol,
                        current_ltp: currentLtp
                        // No default investment amount - user must set manually
                    };
                }

                const response = await fetch(url, {
                    method: isCurrentlyInWatchlist ? 'DELETE' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    if (isCurrentlyInWatchlist) {
                        userWatchlist.delete(symbol);
                        updateWatchlistButton(symbol, false);
                    } else {
                        userWatchlist.add(symbol);
                        updateWatchlistButton(symbol, true);
                        // Immediately refresh watchlist display to show new stock
                        console.log(' Refreshing watchlist after adding:', symbol);
                        await loadUserWatchlistData(); // Use the correct function name
                    }

                    // Show success message briefly
                    showTemporaryMessage(
                        isCurrentlyInWatchlist ? 
                        `${symbol} removed from watchlist` : 
                        `${symbol} added to watchlist`,
                        'success'
                    );
                } else {
                    // Reset button on error
                    button.innerHTML = originalHtml;
                    button.disabled = false;
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Watchlist error:', error);
                showTemporaryMessage('Network error. Please try again.', 'error');
                // Reset button on error
                const button = document.querySelector(`[data-symbol="${symbol}"]`);
                if (button) {
                    button.innerHTML = '<i class="fas fa-star"></i>';
                    button.disabled = false;
                }
            }
        }

        function updateWatchlistButton(symbol, isInWatchlist) {
            const button = document.querySelector(`[data-symbol="${symbol}"]`);
            if (button) {
                button.disabled = false;
                if (isInWatchlist) {
                    button.innerHTML = '<i class="fas fa-star"></i>';
                    button.className = 'btn btn-sm btn-warning watchlist-btn';
                    button.title = 'Remove from Watchlist';
                } else {
                    button.innerHTML = '<i class="far fa-star"></i>';
                    button.className = 'btn btn-sm btn-outline-warning watchlist-btn';
                    button.title = 'Add to Watchlist';
                }
            }
        }

        async function loadUserWatchlist() {
            try {
                const response = await fetch('/api/watchlist');
                const result = await response.json();

                if (result.status === 'success') {
                    userWatchlist.clear();
                    result.watchlist.forEach(item => {
                        userWatchlist.add(item.symbol);
                        updateWatchlistButton(item.symbol, true);
                    });

                    // Update watchlist count and render table
                    updateWatchlistCount(result.watchlist.length);
                    renderWatchlistTable(result.watchlist);
                }
            } catch (error) {
                console.error('Failed to load watchlist:', error);
            }
        }

        async function refreshWatchlist() {
            const button = document.querySelector('[onclick="refreshWatchlist()"]');
            const originalHtml = button.innerHTML;

            try {
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;

                await loadUserWatchlist();

                // Show success message
                showTemporaryMessage('Watchlist refreshed', 'success');
            } catch (error) {
                showTemporaryMessage('Failed to refresh watchlist', 'error');
            } finally {
                button.innerHTML = originalHtml;
                button.disabled = false;
            }
        }

        function updateWatchlistCount(count) {
            const countElement = document.getElementById('watchlistCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        function renderWatchlistTable(watchlistItems) {
            console.log(' RENDER WATCHLIST: Starting to render watchlist table with', watchlistItems?.length || 0, 'items');
            const tbody = document.getElementById('watchlistTableBody');

            if (!watchlistItems || watchlistItems.length === 0) {
                console.log(' RENDER WATCHLIST: No items to render');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-star fa-3x mb-3 d-block"></i>
                                <h5>No Stocks in Watchlist</h5>
                                <p>Add stocks to your watchlist by clicking the star button on any stock</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            console.log(' RENDER WATCHLIST: Rendering', watchlistItems.length, 'watchlist items');
            tbody.innerHTML = watchlistItems.map(item => {
                console.log(' RENDER WATCHLIST: Processing item:', item.symbol);
                // Get live stock data if available - try multiple formats
                let liveData = null;
                if (window.stockData) {
                    // Try full_symbol first
                    liveData = window.stockData[item.full_symbol];
                    // If not found, try looking for the symbol with NSE: prefix
                    if (!liveData && !item.full_symbol.startsWith('NSE:')) {
                        liveData = window.stockData[`NSE:${item.symbol}-EQ`];
                    }
                    // Try just the symbol
                    if (!liveData) {
                        liveData = window.stockData[item.symbol];
                    }
                }

                // Get values
                const addedLtp = parseFloat(item.added_ltp) || 0;
                const liveLtp = liveData ? parseFloat(liveData.ltp) || 0 : 0;
                const investmentAmount = item.investment_amount ? parseInt(item.investment_amount) : null;
                const positionType = item.position_type || null;

                // Calculate percentage change from added LTP to live LTP
                let percentChange = 0;
                let gainLoss = 0;
                let changeClass = 'text-muted';
                let changeIcon = '';

                if (addedLtp > 0 && liveLtp > 0 && investmentAmount && positionType) {
                    percentChange = ((liveLtp - addedLtp) / addedLtp) * 100;

                    // Calculate actual gain/loss based on investment amount
                    const shares = investmentAmount / addedLtp;
                    gainLoss = (liveLtp - addedLtp) * shares;

                    // Reverse gain/loss for Short positions
                    if (positionType === 'Short') {
                        gainLoss = -gainLoss;
                        percentChange = -percentChange;
                    }

                    changeClass = gainLoss >= 0 ? 'text-success' : 'text-danger';
                    changeIcon = gainLoss >= 0 ? 'fas fa-arrow-up' : 'fas fa-arrow-down';
                }

                // Virtual Trade amount button options
                const investmentOptions = [25000, 50000, 100000, 200000];
                const investmentButtons = `
                    <div class="btn-group btn-group-sm" role="group" style="font-size: 0.65rem;">
                        ${investmentOptions.map(amount => `
                            <button type="button" 
                                    class="btn ${amount === investmentAmount ? 'btn-primary' : (investmentAmount ? 'btn-outline-primary' : 'btn-outline-warning')}"
                                    onclick="updateInvestmentAmount('${item.symbol}', ${amount})"
                                    style="padding: 2px 6px; font-size: 0.6rem; border-width: 1px;">
                                ${amount >= 100000 ? (amount/100000) + 'L' : (amount/1000) + 'k'}
                            </button>
                        `).join('')}
                    </div>
                    ${!investmentAmount ? '<small class="text-warning d-block" style="font-size: 0.6rem;"> Set amount</small>' : ''}
                `;

                // Position type toggle buttons
                const positionButtons = `
                    <div class="btn-group btn-group-sm" role="group" style="font-size: 0.7rem;">
                        <button type="button" 
                                class="btn ${positionType === 'Long' ? 'btn-success' : (positionType ? 'btn-outline-success' : 'btn-outline-warning')}"
                                onclick="updatePositionType('${item.symbol}', 'Long')"
                                style="padding: 2px 8px; font-size: 0.65rem; border-width: 1px;">
                            Long
                        </button>
                        <button type="button" 
                                class="btn ${positionType === 'Short' ? 'btn-danger' : (positionType ? 'btn-outline-danger' : 'btn-outline-warning')}"
                                onclick="updatePositionType('${item.symbol}', 'Short')"
                                style="padding: 2px 8px; font-size: 0.65rem; border-width: 1px;">
                            Short
                        </button>
                    </div>
                    ${!positionType ? '<small class="text-warning d-block" style="font-size: 0.6rem;"> Set position</small>' : ''}
                `;


                // Create chart URL
                const chartSymbol = `NSE:${item.symbol}`;
                const chartUrl = `https://in.tradingview.com/chart/?symbol=${chartSymbol}`;

                return `
                    <tr>
                        <td class="fw-bold">
                            <a href="${chartUrl}" target="_blank" class="text-decoration-none text-white symbol-link" 
                               style="transition: color 0.2s ease;"
                               onmouseover="this.style.color='#007bff'" 
                               onmouseout="this.style.color='white'" title="Open Chart">
                                ${item.symbol}
                            </a>
                            ${positionType ? `<span class="badge ${positionType === 'Long' ? 'bg-success' : 'bg-danger'} ms-1" style="font-size: 0.6rem;">
                                ${positionType}
                            </span>` : '<span class="badge bg-warning text-dark ms-1" style="font-size: 0.6rem;"> SET</span>'}
                        </td>
                        <td>
                            <select class="form-select form-select-sm" 
                                    onchange="updateSelectionMethod('${item.symbol}', this.value)"
                                    style="font-size: 0.7rem; padding: 2px 6px;">
                                <option value="">-- Select Method --</option>
                                <option value="Price Action" ${item.selection_method === 'Price Action' ? 'selected' : ''}>1. 10cards of Price action</option>
                                <option value="Camarilla" ${item.selection_method === 'Camarilla' ? 'selected' : ''}>2. Camarilla Levels</option>
                                <option value="CPR" ${item.selection_method === 'CPR' ? 'selected' : ''}>3. CPR Levels</option>
                                <option value="Fibonacci" ${item.selection_method === 'Fibonacci' ? 'selected' : ''}>4. Fibonacci Levels</option>
                                <option value="RVOL" ${item.selection_method === 'RVOL' ? 'selected' : ''}>5. RVOL</option>
                                <option value="Sector Top" ${item.selection_method === 'Sector Top' ? 'selected' : ''}>6. Sector Top from Index Charts</option>
                            </select>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="removeFromWatchlist('${item.symbol}')" 
                                    title="Remove from Watchlist"
                                    style="padding: 2px 6px; font-size: 0.7rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                        <td class="text-center">
                            ${investmentButtons}
                        </td>
                        <td class="text-center">
                            ${positionButtons}
                        </td>
                        <td class="text-end">${addedLtp > 0 ? dashboard.formatNumber(addedLtp) : '--'}</td>
                        <td class="text-end fw-bold">${liveLtp > 0 ? dashboard.formatNumber(liveLtp) : '--'}</td>
                        <td class="text-end fw-bold" style="color: ${investmentAmount ? '#00e5ff' : '#ffc107'};">
                            ${investmentAmount ? '' + dashboard.formatNumber(investmentAmount) : ' SET AMT'}
                        </td>
                        <td class="${changeClass} text-end fw-bold">
                            ${addedLtp > 0 && liveLtp > 0 && investmentAmount && positionType ? `<i class="${changeIcon} me-1"></i>${dashboard.formatNumber(Math.abs(gainLoss))}` : (investmentAmount && positionType ? '--' : ' SET')}
                        </td>
                        <td class="${changeClass} text-end fw-bold">
                            ${addedLtp > 0 && liveLtp > 0 && investmentAmount && positionType ? `<i class="${changeIcon} me-1"></i>${dashboard.formatNumber(percentChange)}%` : (investmentAmount && positionType ? '--' : ' SET')}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function removeFromWatchlist(symbol) {
            if (!confirm(`Remove ${symbol} from your watchlist?`)) {
                return;
            }

            try {
                const response = await fetch('/api/watchlist/remove', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    userWatchlist.delete(symbol);
                    updateWatchlistButton(symbol, false);
                    showTemporaryMessage(`${symbol} removed from watchlist`, 'success');

                    // Refresh the watchlist display
                    loadUserWatchlist();
                    updateInvestmentSummary(currentWatchlistData);
                } else {
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Remove from watchlist error:', error);
                showTemporaryMessage('Network error. Please try again.', 'error');
            }
        }

        // Store current watchlist data for quick refresh
        let currentWatchlistData = [];

        async function refreshWatchlistDisplay() {
            if (currentWatchlistData && currentWatchlistData.length > 0) {
                renderWatchlistTable(currentWatchlistData);
                updateInvestmentSummary(currentWatchlistData);
            }
        }

        // Update loadUserWatchlist to store the data
        async function loadUserWatchlistData() {
            try {
                console.log(' LOAD WATCHLIST: Starting to load user watchlist data');
                const response = await fetch('/api/watchlist');
                console.log(' LOAD WATCHLIST: Fetch response status:', response.status);
                const result = await response.json();
                console.log(' LOAD WATCHLIST: API result:', result);

                if (result.status === 'success') {
                    currentWatchlistData = result.watchlist;
                    userWatchlist.clear();
                    result.watchlist.forEach(item => {
                        userWatchlist.add(item.symbol);
                        updateWatchlistButton(item.symbol, true);
                    });

                    // Update watchlist count and render table
                    updateWatchlistCount(result.watchlist.length);
                    renderWatchlistTable(result.watchlist);
                    updateInvestmentSummary(result.watchlist);
                }
            } catch (error) {
                console.error('Failed to load watchlist:', error);
            }
        }

        async function updateInvestmentAmount(symbol, newAmount) {
            try {
                console.log(`Updating investment amount for ${symbol} to ${newAmount}`);
                console.log('Current watchlist data:', currentWatchlistData);

                // Check if currentWatchlistData is available
                if (!currentWatchlistData || currentWatchlistData.length === 0) {
                    console.log('No watchlist data available, reloading...');
                    await loadUserWatchlistData();
                }

                // Find and style the clicked button
                const clickedButton = document.querySelector(`[onclick*="updateInvestmentAmount('${symbol}', ${newAmount})"]`);
                if (clickedButton) {
                    // Change to bright orange/gold locked color
                    clickedButton.className = 'btn btn-warning';
                    clickedButton.style.cssText = 'padding: 2px 6px; font-size: 0.6rem; border-width: 2px; background-color: #ff8c00 !important; border-color: #ff8c00 !important; color: white !important; opacity: 0.8 !important;';
                    clickedButton.disabled = true;
                    clickedButton.innerHTML = ' ' + clickedButton.innerHTML;
                }

                // Lock all other investment buttons for this symbol
                const buttonGroup = document.querySelector(`[onclick*="updateInvestmentAmount('${symbol}'"]`);
                if (buttonGroup && buttonGroup.parentElement) {
                    const allButtons = buttonGroup.parentElement.querySelectorAll('button');
                    allButtons.forEach(btn => {
                        if (btn !== clickedButton) {
                            btn.disabled = true;
                            btn.style.opacity = '0.4';
                        }
                    });
                }

                const response = await fetch('/api/watchlist/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        investment_amount: parseInt(newAmount)
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Update investment response:', result);

                if (result.status === 'success') {
                    // Update the stored data
                    const itemIndex = currentWatchlistData.findIndex(item => item.symbol === symbol);
                    if (itemIndex !== -1) {
                        currentWatchlistData[itemIndex].investment_amount = parseInt(newAmount);
                    }

                    // Re-render the table to update gain/loss calculations
                    renderWatchlistTable(currentWatchlistData);
                    updateInvestmentSummary(currentWatchlistData);

                    showTemporaryMessage(`Virtual Trade updated: ${symbol} (${parseInt(newAmount) >= 100000 ? (parseInt(newAmount)/100000) + 'L' : (parseInt(newAmount)/1000) + 'k'})`, 'success');
                } else {
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                    // Note: Button state will be reset by table re-render
                }
            } catch (error) {
                console.error('Update investment amount error:', error);
                showTemporaryMessage('Failed to update investment amount. Please try again.', 'error');

                // Note: Button state will be reset by table re-render
            } finally {
                // Keep buttons locked - do not re-enable them
                console.log('Investment amount update completed - buttons remain locked');
            }
        }

        async function updatePositionType(symbol, newPositionType) {
            try {
                console.log(`Updating position type for ${symbol} to ${newPositionType}`);
                console.log('Current watchlist data:', currentWatchlistData);

                // Check if currentWatchlistData is available
                if (!currentWatchlistData || currentWatchlistData.length === 0) {
                    console.log('No watchlist data available, reloading...');
                    await loadUserWatchlistData();
                }

                // Find and style the clicked button
                const clickedButton = document.querySelector(`[onclick*="updatePositionType('${symbol}', '${newPositionType}')"]`);
                if (clickedButton) {
                    // Change to bright purple locked color
                    const lockColor = newPositionType === 'Long' ? '#8b00ff' : '#dc143c'; // Purple for Long, Crimson for Short
                    clickedButton.className = 'btn';
                    clickedButton.style.cssText = `padding: 2px 8px; font-size: 0.65rem; border-width: 2px; background-color: ${lockColor} !important; border-color: ${lockColor} !important; color: white !important; opacity: 0.9 !important;`;
                    clickedButton.disabled = true;
                    clickedButton.innerHTML = ' ' + newPositionType;
                }

                // Lock all other position buttons for this symbol
                const buttonGroup = document.querySelector(`[onclick*="updatePositionType('${symbol}'"]`);
                if (buttonGroup && buttonGroup.parentElement) {
                    const allButtons = buttonGroup.parentElement.querySelectorAll('button');
                    allButtons.forEach(btn => {
                        if (btn !== clickedButton) {
                            btn.disabled = true;
                            btn.style.opacity = '0.4';
                        }
                    });
                }

                const response = await fetch('/api/watchlist/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        position_type: newPositionType
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Update position type response:', result);

                if (result.status === 'success') {
                    // Update the stored data
                    const itemIndex = currentWatchlistData.findIndex(item => item.symbol === symbol);
                    if (itemIndex !== -1) {
                        currentWatchlistData[itemIndex].position_type = newPositionType;
                    }

                    // Re-render the table to update gain/loss calculations
                    renderWatchlistTable(currentWatchlistData);
                    updateInvestmentSummary(currentWatchlistData);

                    showTemporaryMessage(`Position updated: ${symbol} (${newPositionType})`, 'success');
                } else {
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                    // Reset dropdown to previous value
                    if (dropdown) {
                        dropdown.value = currentWatchlistData.find(item => item.symbol === symbol)?.position_type || 'Long';
                    }
                }
            } catch (error) {
                console.error('Update position type error:', error);
                showTemporaryMessage('Failed to update position type. Please try again.', 'error');

                // Note: Button state will be reset by table re-render
            } finally {
                // Keep buttons locked - do not re-enable them  
                console.log('Position type update completed - buttons remain locked');
            }
        }

        async function updateSelectionMethod(symbol, newSelectionMethod) {
            try {
                console.log(` UPDATE SELECTION: Updating selection method for ${symbol} to ${newSelectionMethod}`);
                console.log(' Current watchlist data:', currentWatchlistData);

                // Check if currentWatchlistData is available
                if (!currentWatchlistData || currentWatchlistData.length === 0) {
                    console.log(' No watchlist data available, reloading...');
                    await loadUserWatchlistData();
                }

                const response = await fetch('/api/watchlist/update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        selection_method: newSelectionMethod
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('Update selection method response:', result);

                if (result.status === 'success') {
                    // Update the stored data
                    const itemIndex = currentWatchlistData.findIndex(item => item.symbol === symbol);
                    if (itemIndex !== -1) {
                        currentWatchlistData[itemIndex].selection_method = newSelectionMethod;
                    }

                    showTemporaryMessage(`Selection method updated: ${symbol} (${newSelectionMethod || 'Not set'})`, 'success');
                } else {
                    showTemporaryMessage(`Error: ${result.message}`, 'error');
                    // Reset dropdown to previous value
                    const dropdown = document.querySelector(`select[onchange*="updateSelectionMethod('${symbol}'"]`);
                    if (dropdown) {
                        dropdown.value = currentWatchlistData.find(item => item.symbol === symbol)?.selection_method || '';
                    }
                }
            } catch (error) {
                console.error('Update selection method error:', error);
                showTemporaryMessage('Failed to update selection method. Please try again.', 'error');

                // Reset dropdown to previous value on error
                const dropdown = document.querySelector(`select[onchange*="updateSelectionMethod('${symbol}'"]`);
                if (dropdown) {
                    dropdown.value = currentWatchlistData.find(item => item.symbol === symbol)?.selection_method || '';
                }
            }
        }

        function showTemporaryMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            messageDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
            messageDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(messageDiv);

            // Auto remove after 3 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 3000);
        }

        function updateInvestmentSummary(watchlistData) {
            // Summary section removed - no longer displaying investment summary
            return;
        }





        function clearAllAlerts() {
            // Clear all alert containers
            document.getElementById('topMovers').innerHTML = '<div class="loading-placeholder"><i class="fas fa-check-circle"></i> No alerts</div>';
            document.getElementById('hotAlerts').innerHTML = '<div class="loading-placeholder"><i class="fas fa-check-circle"></i> No alerts</div>';
            document.getElementById('volumeSurge').innerHTML = '<div class="loading-placeholder"><i class="fas fa-check-circle"></i> No alerts</div>';
            document.getElementById('activityFeed').innerHTML = '<div class="loading-placeholder"><i class="fas fa-check-circle"></i> Feed cleared</div>';

            // Reset counters
            updateAlertBadge(0);
            updateStatCounts(0, 0, 0, 0);
        }

        function exportAlerts() {
            const alerts = [];
            const alertItems = document.querySelectorAll('.alert-item-enhanced');

            alertItems.forEach(item => {
                alerts.push({
                    text: item.textContent,
                    type: item.className.includes('gain') ? 'gain' : item.className.includes('loss') ? 'loss' : 'info',
                    timestamp: new Date().toISOString()
                });
            });

            const blob = new Blob([JSON.stringify(alerts, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `market-alerts-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function refreshAllAlerts() {
            if (!window.stockData) {
                console.log('refreshAllAlerts: No window.stockData available');
                return;
            }

            const stocks = Object.values(window.stockData);
            console.log('refreshAllAlerts: Processing', stocks.length, 'stocks');

            if (stocks.length === 0) {
                console.log('refreshAllAlerts: No stocks in data');
                return;
            }

            updateTopMovers(stocks);
            updateHotAlerts(stocks);
            updateVolumeSurge(stocks);
            updateActivityFeed(stocks);
            updateMarketPulse(stocks);

            console.log('refreshAllAlerts: Updated all alert sections');
        }

        function updateStatCounts(gainers, losers, active, alerts) {
            const updateStat = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            updateStat('gainersCount', gainers);
            updateStat('losersCount', losers);
            updateStat('activeCount', active);
            updateStat('alertsCount', alerts);
        }

        // Advanced Alert Calculation Functions
        function calculateMomentumScore(stock) {
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;
            const priceVelocity = Math.abs(changePercent);
            const volumeNormalized = Math.min(volume / 10000000, 1); // Normalize to 0-1

            // Momentum score: combines price movement with volume
            return (priceVelocity * 0.7) + (volumeNormalized * 100 * 0.3);
        }

        function detectPricePattern(stock) {
            const open = stock.open_price || 0;
            const close = stock.ltp || 0;
            const high = stock.high_price || 0;
            const low = stock.low_price || 0;
            const prevClose = stock.prev_close_price || 0;

            if (!open || !close || !high || !low || !prevClose) return 'unknown';

            // Gap analysis
            const gapPercent = ((open - prevClose) / prevClose) * 100;
            const bodyPercent = ((close - open) / open) * 100;

            if (gapPercent > 2) return 'gap_up';
            if (gapPercent < -2) return 'gap_down';
            if (Math.abs(bodyPercent) > 3) return bodyPercent > 0 ? 'strong_bullish' : 'strong_bearish';
            if (close > high * 0.98) return 'near_high';
            if (close < low * 1.02) return 'near_low';

            return 'consolidation';
        }

        function calculateRSI(stock, period = 14) {
            // Simplified RSI calculation using current price action
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;

            // Approximate RSI based on current momentum and volume
            let rsi = 50; // Neutral starting point

            if (changePercent > 0) {
                rsi += Math.min(changePercent * 2, 30);
            } else {
                rsi += Math.max(changePercent * 2, -30);
            }

            // Volume influence
            if (volume > 5000000) rsi += changePercent > 0 ? 5 : -5;

            return Math.max(0, Math.min(100, rsi));
        }

        function isVolumeSpike(stock) {
            const volume = stock.vol_traded_today || 0;
            const avgVolume = 2000000; // Approximate average for NIFTY 50 stocks

            return volume > avgVolume * 2; // 2x average volume
        }

        function detectBreakoutPattern(stock) {
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;
            const rsi = calculateRSI(stock);

            // Strong breakout: high price movement + high volume + RSI confirmation
            if (Math.abs(changePercent) > 3 && volume > 3000000) {
                if (changePercent > 0 && rsi > 60) return 'bullish_breakout';
                if (changePercent < 0 && rsi < 40) return 'bearish_breakout';
            }

            // Volume breakout without extreme price movement
            if (isVolumeSpike(stock) && Math.abs(changePercent) > 1) {
                return 'volume_breakout';
            }

            return null;
        }

        function updateTopMovers(stocks) {
            const container = document.getElementById('topMovers');
            if (!container) return;

            // Calculate momentum scores and filter significant moves
            const stocksWithMomentum = stocks.map(stock => ({
                ...stock,
                momentumScore: calculateMomentumScore(stock),
                pattern: detectPricePattern(stock),
                rsi: calculateRSI(stock)
            })).filter(stock => 
                Math.abs(stock.change_percent || 0) > 0.5 || // At least 0.5% movement
                stock.momentumScore > 2 // Or high momentum score
            );

            // Sort by momentum score
            const sorted = stocksWithMomentum.sort((a, b) => b.momentumScore - a.momentumScore);
            const topMovers = sorted.slice(0, 6);

            const html = topMovers.map(stock => {
                const changePercent = stock.change_percent || 0;
                const isGain = changePercent >= 0;
                const symbol = stock.symbol ? stock.symbol.replace('NSE:', '').replace('-EQ', '') : 'Unknown';
                const momentumIcon = stock.momentumScore > 5 ? '' : stock.momentumScore > 3 ? '' : '';
                const patternText = getPatternDisplayText(stock.pattern);

                return `
                    <div class="alert-item-enhanced ${isGain ? 'gain' : 'loss'}" data-momentum="${stock.momentumScore.toFixed(1)}">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">${symbol} ${momentumIcon}</span>
                            <span class="${isGain ? 'text-success' : 'text-danger'}">${changePercent.toFixed(2)}%</span>
                        </div>
                        <div class="d-flex justify-content-between small opacity-75">
                            <span>${(stock.ltp || 0).toFixed(2)}</span>
                            <span class="text-warning">${patternText}</span>
                        </div>
                        <div class="small opacity-50">Momentum: ${stock.momentumScore.toFixed(1)} | RSI: ${stock.rsi.toFixed(0)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<div class="loading-placeholder">No significant movers</div>';
            const countEl = document.getElementById('moversCount');
            if (countEl) countEl.textContent = topMovers.length;
        }

        function getPatternDisplayText(pattern) {
            const patterns = {
                'gap_up': 'Gap Up',
                'gap_down': 'Gap Down', 
                'strong_bullish': 'Strong Bull',
                'strong_bearish': 'Strong Bear',
                'near_high': 'Near High',
                'near_low': 'Near Low',
                'consolidation': 'Range',
                'unknown': 'N/A'
            };
            return patterns[pattern] || 'N/A';
        }

        function updateHotAlerts(stocks) {
            const container = document.getElementById('hotAlerts');
            if (!container) return;

            // Advanced hot alert detection
            const hotStocks = stocks.filter(stock => {
                const changePercent = Math.abs(stock.change_percent || 0);
                const volume = stock.vol_traded_today || 0;
                const breakout = detectBreakoutPattern(stock);
                const rsi = calculateRSI(stock);

                // Multiple criteria for hot alerts
                return (
                    changePercent >= 2 || // Significant price movement
                    breakout !== null || // Technical breakout
                    isVolumeSpike(stock) || // Volume spike
                    rsi > 80 || rsi < 20 // Extreme RSI levels
                );
            }).map(stock => ({
                ...stock,
                breakout: detectBreakoutPattern(stock),
                alertReason: getAlertReason(stock),
                urgency: calculateUrgency(stock)
            })).sort((a, b) => b.urgency - a.urgency).slice(0, 6);

            const html = hotStocks.map(stock => {
                const changePercent = stock.change_percent || 0;
                const isGain = changePercent >= 0;
                const symbol = stock.symbol ? stock.symbol.replace('NSE:', '').replace('-EQ', '') : 'Unknown';
                const urgencyIcon = getUrgencyIcon(stock.urgency);

                return `
                    <div class="alert-item-enhanced breakout" data-urgency="${stock.urgency}">
                        <div class="d-flex justify-content-between align-items-center">
                            ${dashboard.generateClickableSymbol(stock.symbol, `${symbol} ${urgencyIcon}`, 'fw-bold')}
                            <span class="${isGain ? 'text-success' : 'text-danger'}">${Math.abs(changePercent).toFixed(2)}%</span>
                        </div>
                        <div class="small text-warning">${stock.alertReason}</div>
                        <div class="small opacity-50">Vol: ${((stock.vol_traded_today || 0) / 1000000).toFixed(1)}M | RSI: ${calculateRSI(stock).toFixed(0)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<div class="loading-placeholder">No hot alerts detected</div>';
            const countEl = document.getElementById('hotAlertsCount');
            if (countEl) countEl.textContent = hotStocks.length;
        }

        function getAlertReason(stock) {
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;
            const breakout = detectBreakoutPattern(stock);
            const rsi = calculateRSI(stock);

            if (breakout === 'bullish_breakout') return 'Bullish Breakout';
            if (breakout === 'bearish_breakout') return 'Bearish Breakout';
            if (breakout === 'volume_breakout') return 'Volume Breakout';
            if (Math.abs(changePercent) > 4) return 'Extreme Move';
            if (isVolumeSpike(stock)) return 'Volume Spike';
            if (rsi > 80) return 'Overbought (RSI 80+)';
            if (rsi < 20) return 'Oversold (RSI 20-)';
            if (Math.abs(changePercent) > 2) return 'Strong Movement';

            return 'Market Alert';
        }

        function calculateUrgency(stock) {
            const changePercent = Math.abs(stock.change_percent || 0);
            const volume = stock.vol_traded_today || 0;
            const rsi = calculateRSI(stock);
            const breakout = detectBreakoutPattern(stock);

            let urgency = 0;

            // Price movement factor
            urgency += changePercent * 10;

            // Volume factor
            if (isVolumeSpike(stock)) urgency += 20;

            // RSI extreme levels
            if (rsi > 80 || rsi < 20) urgency += 15;

            // Breakout patterns
            if (breakout === 'bullish_breakout' || breakout === 'bearish_breakout') urgency += 25;
            if (breakout === 'volume_breakout') urgency += 15;

            // Pattern recognition
            const pattern = detectPricePattern(stock);
            if (pattern === 'gap_up' || pattern === 'gap_down') urgency += 10;

            return Math.min(100, urgency);
        }

        function getUrgencyIcon(urgency) {
            if (urgency > 70) return '';
            if (urgency > 50) return '';
            if (urgency > 30) return '';
            return '';
        }

        function updateVolumeSurge(stocks) {
            const container = document.getElementById('volumeSurge');
            if (!container) return;

            // Advanced volume analysis
            const volumeAlerts = stocks.map(stock => {
                const volume = stock.vol_traded_today || 0;
                const changePercent = stock.change_percent || 0;
                const avgVolume = estimateAverageVolume(stock);
                const volumeRatio = avgVolume > 0 ? volume / avgVolume : 0;

                return {
                    ...stock,
                    volumeRatio,
                    volumeScore: calculateVolumeScore(stock, volumeRatio),
                    volumePattern: analyzeVolumePattern(stock, volumeRatio)
                };
            }).filter(stock => 
                stock.volumeRatio > 1.5 || // 1.5x average volume
                stock.volumeScore > 30 || // High volume score
                (stock.vol_traded_today || 0) > 5000000 // Absolute high volume
            ).sort((a, b) => b.volumeScore - a.volumeScore).slice(0, 6);

            const html = volumeAlerts.map(stock => {
                const volume = stock.vol_traded_today || 0;
                const symbol = stock.symbol ? stock.symbol.replace('NSE:', '').replace('-EQ', '') : 'Unknown';
                const changePercent = stock.change_percent || 0;
                const volumeIcon = getVolumeIcon(stock.volumeRatio);

                return `
                    <div class="alert-item-enhanced volume" data-volume-ratio="${stock.volumeRatio.toFixed(1)}">
                        <div class="d-flex justify-content-between align-items-center">
                            ${dashboard.generateClickableSymbol(stock.symbol, `${symbol} ${volumeIcon}`, 'fw-bold')}
                            <span class="text-info">${(volume / 1000000).toFixed(1)}M</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span class="${changePercent >= 0 ? 'text-success' : 'text-danger'}">${changePercent.toFixed(2)}%</span>
                            <span class="text-warning">${stock.volumePattern}</span>
                        </div>
                        <div class="small opacity-50">${stock.volumeRatio.toFixed(1)}x Avg Vol | Score: ${stock.volumeScore.toFixed(0)}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<div class="loading-placeholder">No volume surges detected</div>';
            const countEl = document.getElementById('volumeSurgeCount');
            if (countEl) countEl.textContent = volumeAlerts.length;
        }

        function estimateAverageVolume(stock) {
            // Estimate based on market cap and typical trading patterns
            const price = stock.ltp || 1;
            const currentVolume = stock.vol_traded_today || 0;

            // Base estimate on price range (rough approximation)
            if (price > 5000) return 500000; // High-priced stocks
            if (price > 1000) return 2000000; // Mid-priced stocks
            if (price > 100) return 5000000; // Low-priced stocks
            return 10000000; // Very low-priced stocks
        }

        function calculateVolumeScore(stock, volumeRatio) {
            const changePercent = Math.abs(stock.change_percent || 0);
            const volume = stock.vol_traded_today || 0;

            let score = 0;

            // Volume ratio contribution
            score += Math.min(volumeRatio * 20, 50);

            // Price movement contribution
            score += changePercent * 5;

            // Absolute volume contribution
            score += Math.min((volume / 1000000) * 2, 30);

            // Pattern bonus
            if (changePercent > 2 && volumeRatio > 2) score += 20;

            return Math.min(100, score);
        }

        function analyzeVolumePattern(stock, volumeRatio) {
            const changePercent = stock.change_percent || 0;

            if (volumeRatio > 5) return 'Massive Surge';
            if (volumeRatio > 3) return 'High Surge';
            if (volumeRatio > 2) return 'Volume Spike';
            if (volumeRatio > 1.5 && Math.abs(changePercent) > 2) return 'Active Trading';
            if (volumeRatio > 1.5) return 'Above Average';

            return 'Normal Activity';
        }

        function getVolumeIcon(volumeRatio) {
            if (volumeRatio > 5) return '';
            if (volumeRatio > 3) return '';
            if (volumeRatio > 2) return '';
            return '';
        }

        function updateActivityFeed(stocks) {
            const container = document.getElementById('activityFeed');
            if (!container) return;

            // Calculate activity scores and prioritize meaningful moves
            const activeStocks = stocks.map(stock => {
                const changePercent = stock.change_percent || 0;
                const volume = stock.vol_traded_today || 0;
                const activityScore = calculateActivityScore(stock);

                return {
                    ...stock,
                    activityScore,
                    activityType: getActivityType(stock),
                    timestamp: Date.now()
                };
            }).filter(stock => 
                stock.activityScore > 10 || // Meaningful activity
                Math.abs(stock.change_percent || 0) > 0.3 // At least 0.3% movement
            ).sort((a, b) => b.activityScore - a.activityScore).slice(0, 10);

            const html = activeStocks.map(stock => {
                const changePercent = stock.change_percent || 0;
                const isGain = changePercent >= 0;
                const symbol = stock.symbol ? stock.symbol.replace('NSE:', '').replace('-EQ', '') : 'Unknown';
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                const activityIcon = getActivityIcon(stock.activityType);

                return `
                    <div class="alert-item-enhanced ${isGain ? 'gain' : 'loss'}" style="margin-bottom: 3px; padding: 6px;">
                        <div class="d-flex justify-content-between align-items-center">
                            ${dashboard.generateClickableSymbol(stock.symbol, `${symbol} ${activityIcon}`, '', 'font-size: 0.75rem; font-weight: 600;')}
                            <span class="${isGain ? 'text-success' : 'text-danger'}" style="font-size: 0.7rem;">${changePercent.toFixed(2)}%</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-warning" style="font-size: 0.65rem;">${stock.activityType}</span>
                            <span class="opacity-50" style="font-size: 0.75rem;">${time}</span>
                        </div>
                        <div class="small opacity-30" style="font-size: 0.55rem;">Score: ${stock.activityScore.toFixed(0)} | Vol: ${((stock.vol_traded_today || 0) / 1000000).toFixed(1)}M</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html || '<div class="loading-placeholder" style="padding: 10px; text-align: center;">No significant activity</div>';
            const countEl = document.getElementById('feedCount');
            if (countEl) countEl.textContent = activeStocks.length;
        }

        function calculateActivityScore(stock) {
            const changePercent = Math.abs(stock.change_percent || 0);
            const volume = stock.vol_traded_today || 0;
            const momentum = calculateMomentumScore(stock);
            const rsi = calculateRSI(stock);

            let score = 0;

            // Price movement contribution (0-40 points)
            score += changePercent * 15;

            // Volume contribution (0-30 points)
            score += Math.min((volume / 1000000) * 3, 30);

            // Momentum contribution (0-20 points)
            score += Math.min(momentum * 2, 20);

            // RSI extreme levels (0-15 points)
            if (rsi > 75 || rsi < 25) score += 15;
            else if (rsi > 65 || rsi < 35) score += 10;

            // Pattern recognition bonus (0-10 points)
            const pattern = detectPricePattern(stock);
            if (pattern === 'gap_up' || pattern === 'gap_down') score += 10;
            else if (pattern === 'strong_bullish' || pattern === 'strong_bearish') score += 8;

            // Volume spike bonus (0-15 points)
            if (isVolumeSpike(stock)) score += 15;

            return Math.min(100, score);
        }

        function getActivityType(stock) {
            const changePercent = stock.change_percent || 0;
            const volume = stock.vol_traded_today || 0;
            const breakout = detectBreakoutPattern(stock);
            const pattern = detectPricePattern(stock);
            const rsi = calculateRSI(stock);

            // Priority order for activity types
            if (breakout === 'bullish_breakout') return 'Bull Breakout';
            if (breakout === 'bearish_breakout') return 'Bear Breakout';
            if (breakout === 'volume_breakout') return 'Vol Breakout';
            if (pattern === 'gap_up') return 'Gap Up';
            if (pattern === 'gap_down') return 'Gap Down';
            if (Math.abs(changePercent) > 3) return 'Big Move';
            if (isVolumeSpike(stock)) return 'Vol Surge';
            if (rsi > 80) return 'Overbought';
            if (rsi < 20) return 'Oversold';
            if (pattern === 'strong_bullish') return 'Strong Bull';
            if (pattern === 'strong_bearish') return 'Strong Bear';
            if (Math.abs(changePercent) > 1.5) return 'Active';
            if (volume > 3000000) return 'High Vol';

            return 'Moving';
        }

        function getActivityIcon(activityType) {
            const icons = {
                'Bull Breakout': '',
                'Bear Breakout': '',
                'Vol Breakout': '',
                'Gap Up': '',
                'Gap Down': '',
                'Big Move': '',
                'Vol Surge': '',
                'Overbought': '',
                'Oversold': '',
                'Strong Bull': '',
                'Strong Bear': '',
                'Active': '',
                'High Vol': '',
                'Moving': ''
            };
            return icons[activityType] || '';
        }

        function updateMarketPulse(stocks = []) {
            if (!stocks.length) return;

            // Advanced market sentiment analysis
            const marketMetrics = calculateMarketMetrics(stocks);

            const updatePulseValue = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            updatePulseValue('bullishMomentum', marketMetrics.bullishMomentum + '%');
            updatePulseValue('bearishMomentum', marketMetrics.bearishMomentum + '%');
            updatePulseValue('volumeSpike', marketMetrics.volumeSpikes);
            updatePulseValue('marketActivity', marketMetrics.activityIndex + '%');

            // Update alert badge with sophisticated counting
            const totalAlerts = marketMetrics.significantAlerts;
            updateAlertBadge(totalAlerts);
            updateStatCounts(
                marketMetrics.strongGainers, 
                marketMetrics.strongLosers, 
                marketMetrics.activeStocks, 
                totalAlerts
            );
        }

        function calculateMarketMetrics(stocks) {
            let strongGainers = 0, strongLosers = 0, volumeSpikes = 0;
            let totalMomentum = 0, totalVolume = 0, activeStocks = 0;
            let bullishStrength = 0, bearishStrength = 0;

            stocks.forEach(stock => {
                const changePercent = stock.change_percent || 0;
                const volume = stock.vol_traded_today || 0;
                const momentum = calculateMomentumScore(stock);
                const rsi = calculateRSI(stock);

                // Count significant moves
                if (changePercent > 1) {
                    strongGainers++;
                    bullishStrength += changePercent * (volume / 1000000);
                }
                if (changePercent < -1) {
                    strongLosers++;
                    bearishStrength += Math.abs(changePercent) * (volume / 1000000);
                }

                // Volume analysis
                if (isVolumeSpike(stock)) volumeSpikes++;

                // Activity measurement
                if (Math.abs(changePercent) > 0.5 || volume > 1000000) activeStocks++;

                totalMomentum += momentum;
                totalVolume += volume;
            });

            const total = stocks.length;
            const bullishMomentum = total > 0 ? Math.round((strongGainers / total) * 100) : 0;
            const bearishMomentum = total > 0 ? Math.round((strongLosers / total) * 100) : 0;
            const activityIndex = total > 0 ? Math.round((activeStocks / total) * 100) : 0;

            // Calculate significant alerts using multiple criteria
            const breakoutStocks = stocks.filter(s => detectBreakoutPattern(s) !== null).length;
            const extremeRSI = stocks.filter(s => {
                const rsi = calculateRSI(s);
                return rsi > 80 || rsi < 20;
            }).length;
            const significantAlerts = strongGainers + strongLosers + volumeSpikes + breakoutStocks + extremeRSI;

            return {
                bullishMomentum,
                bearishMomentum,
                volumeSpikes,
                activityIndex,
                strongGainers,
                strongLosers,
                activeStocks,
                significantAlerts,
                marketSentiment: bullishStrength > bearishStrength ? 'bullish' : 'bearish',
                sentimentStrength: Math.abs(bullishStrength - bearishStrength)
            };
        }


    </script>

    <!-- Add global scroll function -->
    <script>
        function scrollToTable(tableId) {
            const element = document.getElementById(tableId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    </script>

    <!-- Index Analysis Charts JavaScript -->
    <script>
        // Chart variables
        let indexChangeChart = null;
        let indexOpenChart = null;
        let indexHighChart = null;
        let indexLowChart = null;

        // Get chart colors based on current theme
        function getChartColors() {
            const theme = document.documentElement.getAttribute('data-theme') || 'dark';
            if (theme === 'light') {
                return {
                    textColor: '#000000',
                    gridColor: 'rgba(0, 0, 0, 0.1)',
                    tooltipBg: 'rgba(255, 255, 255, 0.95)',
                    tooltipText: '#000000'
                };
            } else {
                return {
                    textColor: '#ffffff',
                    gridColor: 'rgba(255, 255, 255, 0.1)',
                    tooltipBg: 'rgba(0, 0, 0, 0.8)',
                    tooltipText: '#ffffff'
                };
            }
        }

        // Chart configuration
        function getChartConfig() {
            const colors = getChartColors();
            return {
                type: 'bar',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: colors.tooltipBg,
                            titleColor: colors.tooltipText,
                            bodyColor: colors.tooltipText,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: window.innerWidth < 768 ? 3 : 9
                                },
                                maxRotation: window.innerWidth < 768 ? 90 : 45,
                                minRotation: window.innerWidth < 768 ? 90 : 45
                            },
                            grid: {
                                color: colors.gridColor
                            }
                        },
                        y: {
                            ticks: {
                                color: colors.textColor,
                                font: {
                                    size: window.innerWidth < 768 ? 8 : 9
                                },
                                callback: function(value) {
                                    return value.toFixed(1) + '%';
                                }
                            },
                            grid: {
                                color: colors.gridColor
                            }
                        }
                    }
                }
            };
        }

        // Initialize charts when page loads
        function initializeIndexCharts() {
            try {
                const chartConfig = getChartConfig();
                // Chart 1: % Change
                const changeCtx = document.getElementById('indexChangeChart');
                if (changeCtx) {
                    indexChangeChart = new Chart(changeCtx, {
                        ...chartConfig,
                        data: {
                            labels: ['Loading...'],
                            datasets: [{
                                data: [0],
                                backgroundColor: ['rgba(128, 128, 128, 0.5)'],
                                borderColor: ['rgba(128, 128, 128, 0.8)'],
                                borderWidth: 1
                            }]
                        }
                    });
                }

                // Chart 2: % From Open
                const openCtx = document.getElementById('indexOpenChart');
                if (openCtx) {
                    indexOpenChart = new Chart(openCtx, {
                        ...chartConfig,
                        data: {
                            labels: ['Loading...'],
                            datasets: [{
                                data: [0],
                                backgroundColor: ['rgba(128, 128, 128, 0.5)'],
                                borderColor: ['rgba(128, 128, 128, 0.8)'],
                                borderWidth: 1
                            }]
                        }
                    });
                }

                // Chart 3: % From High
                const highCtx = document.getElementById('indexHighChart');
                if (highCtx) {
                    indexHighChart = new Chart(highCtx, {
                        ...chartConfig,
                        data: {
                            labels: ['Loading...'],
                            datasets: [{
                                data: [0],
                                backgroundColor: ['rgba(128, 128, 128, 0.5)'],
                                borderColor: ['rgba(128, 128, 128, 0.8)'],
                                borderWidth: 1
                            }]
                        }
                    });
                }

                // Chart 4: % From Low
                const lowCtx = document.getElementById('indexLowChart');
                if (lowCtx) {
                    indexLowChart = new Chart(lowCtx, {
                        ...chartConfig,
                        data: {
                            labels: ['Loading...'],
                            datasets: [{
                                data: [0],
                                backgroundColor: ['rgba(128, 128, 128, 0.5)'],
                                borderColor: ['rgba(128, 128, 128, 0.8)'],
                                borderWidth: 1
                            }]
                        }
                    });
                }

                console.log('Index analysis charts initialized successfully');

                // Load initial data after a short delay
                setTimeout(updateIndexCharts, 2000);

            } catch (error) {
                console.error('Error initializing index charts:', error);
            }
        }

        // Refresh charts when theme changes
        function refreshChartsForTheme() {
            try {
                const colors = getChartColors();
                
                // Update all chart color configs
                const charts = [indexChangeChart, indexOpenChart, indexHighChart, indexLowChart];
                charts.forEach(chart => {
                    if (chart) {
                        chart.options.scales.x.ticks.color = colors.textColor;
                        chart.options.scales.y.ticks.color = colors.textColor;
                        chart.options.scales.x.grid.color = colors.gridColor;
                        chart.options.scales.y.grid.color = colors.gridColor;
                        chart.options.plugins.tooltip.backgroundColor = colors.tooltipBg;
                        chart.options.plugins.tooltip.titleColor = colors.tooltipText;
                        chart.options.plugins.tooltip.bodyColor = colors.tooltipText;
                        chart.update();
                    }
                });
                
                console.log('Charts refreshed for theme change');
            } catch (error) {
                console.error('Error refreshing charts for theme:', error);
            }
        }

        // Update charts with current index data
        function updateIndexCharts() {
            try {
                // Get data from all index symbols, not just visible cards
                const indexSymbols = [
                    "NSE:NIFTY50-INDEX", "BSE:SENSEX-INDEX", "NSE:NIFTYBANK-INDEX",
                    "NSE:NIFTYIT-INDEX", "NSE:FINNIFTY-INDEX", "NSE:MIDCPNIFTY-INDEX",
                    "NSE:NIFTYNXT50-INDEX", "NSE:NIFTYFMCG-INDEX", "NSE:NIFTYPHARMA-INDEX",
                    "NSE:NIFTYAUTO-INDEX", "NSE:NIFTYMETAL-INDEX", "NSE:NIFTYREALTY-INDEX",
                    "NSE:NIFTYPSE-INDEX", "NSE:NIFTYPVTBANK-INDEX", "NSE:NIFTYMEDIA-INDEX",
                    "NSE:NIFTYINFRA-INDEX", "NSE:NIFTYENERGY-INDEX", "NSE:NIFTYCOMMODITIES-INDEX",
                    "NSE:NIFTYCPSE-INDEX", "NSE:NIFTYMIDCAP50-INDEX", "NSE:NIFTYSMLCAP100-INDEX"
                ];

                const labels = [];
                const changeData = [];
                const openData = [];
                const highData = [];
                const lowData = [];

                // Try to get data from both index cards and WebSocket data
                indexSymbols.forEach(symbol => {
                    // First try to get from index cards
                    const card = document.querySelector(`[data-index-symbol="${symbol}"]`);
                    let stockData = null;
                    let name = '';
                    let currentPrice = 0;
                    let changePercent = 0;
                    let openPercent = 0;

                    if (card) {
                        const nameEl = card.querySelector('.index-name');
                        const priceEl = card.querySelector('.index-price');
                        const changeEl = card.querySelector('.index-change');
                        const openPercentEl = card.querySelector('.index-open-percent');

                        if (nameEl && priceEl && changeEl) {
                            name = nameEl.textContent.trim();
                            const priceText = priceEl.textContent.trim();
                            const changeText = changeEl.textContent.trim();
                            const openPercentText = openPercentEl ? openPercentEl.textContent.trim() : '%O:--';

                            currentPrice = parseFloat(priceText.replace(/[^\d.-]/g, ''));

                            const changeMatch = changeText.match(/([-+]?\d+\.?\d*)%/);
                            changePercent = changeMatch ? parseFloat(changeMatch[1]) : 0;

                            const openMatch = openPercentText.match(/%O:([-+]?\d+\.?\d*)/);
                            openPercent = openMatch ? parseFloat(openMatch[1]) : 0;
                        }
                    }

                    // Try to get more detailed data from WebSocket
                    stockData = getIndexStockData(symbol);

                    if (stockData && stockData.ltp > 0) {
                        currentPrice = stockData.ltp;
                        changePercent = stockData.change_percent || 0;

                        // Calculate % from open
                        if (stockData.open_price > 0) {
                            openPercent = ((currentPrice - stockData.open_price) / stockData.open_price) * 100;
                        }
                    }

                    // Get display name
                    if (!name && symbol) {
                        name = symbol.replace('NSE:', '').replace('BSE:', '').replace('-INDEX', '').replace('NIFTY', '');
                        if (name === '50') name = 'NIFTY 50';
                        if (name === 'SENSEX') name = 'SENSEX';
                    }

                    // Only include if we have valid data
                    if (currentPrice > 0 && name && name !== '--') {
                        labels.push(name);
                        changeData.push(changePercent);
                        openData.push(openPercent);

                        // Calculate proper % from high and % from low
                        let fromHigh = 0;
                        let fromLow = 0;

                        if (stockData && stockData.high_price > 0 && stockData.low_price > 0) {
                            // % from high = ((current - high) / high) * 100 (usually negative)
                            fromHigh = ((currentPrice - stockData.high_price) / stockData.high_price) * 100;
                            // % from low = ((current - low) / low) * 100 (usually positive)
                            fromLow = ((currentPrice - stockData.low_price) / stockData.low_price) * 100;
                        } else {
                            // Fallback: calculate based on change percent (rough approximation)
                            fromHigh = changePercent <= 0 ? changePercent : changePercent - 2; // Assume high is above current
                            fromLow = changePercent >= 0 ? changePercent : changePercent + 2; // Assume low is below current
                        }

                        highData.push(fromHigh);
                        lowData.push(fromLow);
                    }
                });

                // Update all charts
                if (indexChangeChart && labels.length > 0) {
                    indexChangeChart.data.labels = labels;
                    indexChangeChart.data.datasets[0].data = changeData;
                    indexChangeChart.data.datasets[0].backgroundColor = changeData.map(value => 
                        value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
                    );
                    indexChangeChart.data.datasets[0].borderColor = changeData.map(value => 
                        value >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'
                    );
                    indexChangeChart.update('none');
                }

                if (indexOpenChart && labels.length > 0) {
                    indexOpenChart.data.labels = labels;
                    indexOpenChart.data.datasets[0].data = openData;
                    indexOpenChart.data.datasets[0].backgroundColor = openData.map(value => 
                        value >= 0 ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)'
                    );
                    indexOpenChart.data.datasets[0].borderColor = openData.map(value => 
                        value >= 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'
                    );
                    indexOpenChart.update('none');
                }

                if (indexHighChart && labels.length > 0) {
                    indexHighChart.data.labels = labels;
                    indexHighChart.data.datasets[0].data = highData;
                    indexHighChart.data.datasets[0].backgroundColor = highData.map(() => 'rgba(220, 53, 69, 0.8)');
                    indexHighChart.data.datasets[0].borderColor = highData.map(() => 'rgba(220, 53, 69, 1)');
                    indexHighChart.update('none');
                }

                if (indexLowChart && labels.length > 0) {
                    indexLowChart.data.labels = labels;
                    indexLowChart.data.datasets[0].data = lowData;
                    indexLowChart.data.datasets[0].backgroundColor = lowData.map(() => 'rgba(25, 135, 84, 0.8)');
                    indexLowChart.data.datasets[0].borderColor = lowData.map(() => 'rgba(25, 135, 84, 1)');
                    indexLowChart.update('none');
                }

            } catch (error) {
                console.error('Error updating index charts:', error);
            }
        }

        // Get stock data for index symbols
        function getIndexStockData(symbol) {
            // Try to get data from the global stockData variable if available
            if (window.stockData && symbol) {
                return window.stockData[symbol];
            }
            return null;
        }

        // Toggle charts visibility
        function toggleIndexCharts() {
            const container = document.getElementById('indexChartsContainer');
            const icon = document.getElementById('indexChartsToggleIcon');

            if (container && icon) {
                const isVisible = container.style.display !== 'none';
                container.style.display = isVisible ? 'none' : 'block';
                icon.className = isVisible ? 'fas fa-eye-slash' : 'fas fa-eye';
            }
        }

        // AI Score Gauges Functions
        function getScoreClass(score) {
            if (score === null || score === undefined) return 'score-na';
            const roundedScore = Math.round(score);
            if (roundedScore >= 15) return 'score-15';
            if (roundedScore >= 14) return 'score-14';
            if (roundedScore >= 13) return 'score-13';
            if (roundedScore >= 12) return 'score-12';
            if (roundedScore >= 11) return 'score-11';
            if (roundedScore >= 10) return 'score-10';
            if (roundedScore >= 9) return 'score-9';
            if (roundedScore >= 8) return 'score-8';
            if (roundedScore >= 7) return 'score-7';
            if (roundedScore >= 6) return 'score-6';
            if (roundedScore >= 5) return 'score-5';
            if (roundedScore >= 4) return 'score-4';
            if (roundedScore >= 3) return 'score-3';
            if (roundedScore >= 2) return 'score-2';
            if (roundedScore >= 1) return 'score-1';
            if (roundedScore === 0) return 'score-0';
            if (roundedScore >= -1) return 'score-neg-1';
            if (roundedScore >= -2) return 'score-neg-2';
            if (roundedScore >= -3) return 'score-neg-3';
            if (roundedScore >= -4) return 'score-neg-4';
            if (roundedScore >= -5) return 'score-neg-5';
            if (roundedScore >= -6) return 'score-neg-6';
            if (roundedScore >= -7) return 'score-neg-7';
            if (roundedScore >= -8) return 'score-neg-8';
            if (roundedScore >= -9) return 'score-neg-9';
            if (roundedScore >= -10) return 'score-neg-10';
            if (roundedScore >= -11) return 'score-neg-11';
            if (roundedScore >= -12) return 'score-neg-12';
            if (roundedScore >= -13) return 'score-neg-13';
            if (roundedScore >= -14) return 'score-neg-14';
            return 'score-neg-15';
        }

        // AI Scores Section - Top & Bottom Performers Functions
        let aiScoresInterval = null;
        let aiScoresTechnicalLevels = {}; // Cache for CPR, Camarilla, Fibonacci data

        async function loadAIScoresSection() {
            try {
                // PERFORMANCE FIX: Fetch CPR/Camarilla/Fibonacci ONCE (they don't change during trading day)
                // Only fetch technical indicators in real-time polling
                const [cprData, camarillaData, fibonacciData] = await Promise.all([
                    fetch('/get_cpr_data').then(r => r.json()),
                    fetch('/camarilla/data').then(r => r.json()),
                    fetch('/get_fibonacci_data').then(r => r.json())
                ]);

                // Cache technical levels data by symbol (ONCE per session)
                if (cprData.data) {
                    cprData.data.forEach(item => {
                        if (!aiScoresTechnicalLevels[item.symbol]) aiScoresTechnicalLevels[item.symbol] = {};
                        aiScoresTechnicalLevels[item.symbol].cpr = item;
                    });
                }
                if (camarillaData.data) {
                    camarillaData.data.forEach(item => {
                        if (!aiScoresTechnicalLevels[item.symbol]) aiScoresTechnicalLevels[item.symbol] = {};
                        aiScoresTechnicalLevels[item.symbol].camarilla = item;
                    });
                }
                if (fibonacciData.data) {
                    fibonacciData.data.forEach(item => {
                        if (!aiScoresTechnicalLevels[item.symbol]) aiScoresTechnicalLevels[item.symbol] = {};
                        aiScoresTechnicalLevels[item.symbol].fibonacci = item;
                    });
                }

                // Initial load of technical indicators data
                const techIndicators = await fetch('/api/technical-indicators-data').then(r => r.json());
                if (techIndicators.status === 'success' && techIndicators.all_data) {
                    populateAIScores(techIndicators.all_data);
                    // Start real-time updates (only for technical indicators)
                    startAIScoresPolling();
                }
            } catch (error) {
                console.error('Error loading AI scores:', error);
            }
        }

        function startAIScoresPolling() {
            // Clear any existing interval
            if (aiScoresInterval) {
                clearInterval(aiScoresInterval);
            }

            // Poll WebSocket data at 500ms intervals (same as technical indicators)
            aiScoresInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/technical-indicators-data');
                    if (!response.ok) return;

                    const data = await response.json();
                    if (data.status === 'success' && data.all_data) {
                        populateAIScores(data.all_data);
                    }
                } catch (error) {
                    // Silently handle errors to prevent console spam
                }
            }, 500); // 500ms polling - synchronized with WebSocket speed
        }

        function populateAIScores(allData) {
            const topBullishContainer = document.getElementById('topBullishStocks');
            const bottomBearishContainer = document.getElementById('bottomBearishStocks');
            
            if (!topBullishContainer || !bottomBearishContainer || !allData || allData.length === 0) return;

            // Filter stocks with valid rank_score
            const validStocks = allData.filter(stock => stock.rank_score !== null && stock.rank_score !== undefined);
            
            if (validStocks.length === 0) return;

            // Sort by rank_score descending
            const sortedData = [...validStocks].sort((a, b) => b.rank_score - a.rank_score);

            // Get top 7 bullish (highest scores)
            const topBullish = sortedData.slice(0, 7);

            // Get bottom 7 bearish (lowest scores)
            const bottomBearish = sortedData.slice(-7).reverse();

            // Populate top bullish stocks
            topBullishContainer.innerHTML = '';
            topBullish.forEach(stock => {
                const card = createAIScoreCard(stock, 'bullish');
                topBullishContainer.appendChild(card);
            });

            // Populate bottom bearish stocks
            bottomBearishContainer.innerHTML = '';
            bottomBearish.forEach(stock => {
                const card = createAIScoreCard(stock, 'bearish');
                bottomBearishContainer.appendChild(card);
            });
        }

        function createAIScoreCard(stock, type) {
            const scoreValue = stock.rank_score !== null ? stock.rank_score : 'N/A';
            const scoreDisplay = scoreValue !== 'N/A' ? 
                (scoreValue > 0 ? `+${scoreValue}` : scoreValue) : 'N/A';
            
            const card = document.createElement('div');
            card.className = `ai-score-card ai-score-card-${type}`;
            
            // Format LTP and % change
            const ltp = stock.ltp !== null && stock.ltp !== undefined ? stock.ltp.toFixed(2) : 'N/A';
            const changePct = stock.change_percent !== null && stock.change_percent !== undefined ? 
                `${stock.change_percent > 0 ? '+' : ''}${stock.change_percent.toFixed(2)}%` : 'N/A';
            const changeColor = stock.change_percent > 0 ? 'text-success' : stock.change_percent < 0 ? 'text-danger' : 'text-muted';
            
            // Format all technical indicators with CORRECT field names from API
            const rsi = stock.rsi !== null && stock.rsi !== undefined ? stock.rsi.toFixed(1) : 'N/A';
            const rsiStatus = stock.rsi_status || 'N/A';
            
            const macd = stock.macd !== null && stock.macd !== undefined ? stock.macd.toFixed(2) : 'N/A';
            const macdStatus = stock.macd_status || 'N/A';
            
            // FIX: Use correct field name stoch_k (not stochastic_k)
            const stochK = stock.stoch_k !== null && stock.stoch_k !== undefined ? stock.stoch_k.toFixed(1) : 'N/A';
            const stochD = stock.stoch_d !== null && stock.stoch_d !== undefined ? stock.stoch_d.toFixed(1) : 'N/A';
            const stochStatus = stock.stoch_status || 'N/A';
            
            const adx = stock.adx !== null && stock.adx !== undefined ? stock.adx.toFixed(1) : 'N/A';
            const diPlus = stock.di_plus !== null && stock.di_plus !== undefined ? stock.di_plus.toFixed(1) : 'N/A';
            const diMinus = stock.di_minus !== null && stock.di_minus !== undefined ? stock.di_minus.toFixed(1) : 'N/A';
            const adxStatus = stock.adx_status || 'N/A';
            
            // Use the range data from API
            const cprRange = stock.cpr_range || 'N/A';
            const camRange = stock.camarilla_range || 'N/A';
            const fibRange = stock.fibonacci_range || 'N/A';
            
            const tooltipText = `${stock.symbol}: LTP ${ltp} (${changePct}) | RSI: ${rsi} | MACD: ${macdStatus} | Stoch: %K=${stochK} %D=${stochD} | ADX: ${adx} DI+=${diPlus} DI-=${diMinus}`;
            
            card.title = tooltipText;
            
            // Format MACD components
            const macdSignal = stock.macd_signal !== null && stock.macd_signal !== undefined ? stock.macd_signal.toFixed(2) : 'N/A';
            const macdHist = stock.macd_histogram !== null && stock.macd_histogram !== undefined ? stock.macd_histogram.toFixed(2) : 'N/A';
            
            card.innerHTML = `
                <div class="ai-score-symbol">${stock.symbol} <span class="${changeColor}">${changePct}</span></div>
                <div class="ai-score-value text-${type === 'bullish' ? 'success' : 'danger'}">${scoreDisplay}</div>
                <span class="ai-score-badge ai-score-badge-${type}">${stock.rank_status || 'N/A'}</span>
                <div class="ai-score-details">
                    LTP: ${ltp}<br>
                    RSI: ${rsi} (${rsiStatus})<br>
                    MACD: ${macd}/${macdSignal}/${macdHist}<br>
                    ${macdStatus}<br>
                    Stoch: K${stochK} D${stochD} (${stochStatus})<br>
                    ADX: ${adx} +${diPlus} -${diMinus}<br>
                    ${adxStatus}<br>
                    CPR: ${cprRange}<br>
                    CAM: ${camRange}<br>
                    FIB: ${fibRange}
                </div>
            `;
            
            return card;
        }

        // Initialize charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for other scripts to load
            setTimeout(initializeIndexCharts, 1000);

            // Load AI Scores Section
            setTimeout(loadAIScoresSection, 2000);

            // Add toggle functionality for Index Charts
            const toggleBtn = document.getElementById('toggleIndexCharts');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleIndexCharts);
            }

            // Add toggle functionality for AI Scores Section
            const aiScoresToggleBtn = document.getElementById('toggleAIScoresSection');
            if (aiScoresToggleBtn) {
                aiScoresToggleBtn.addEventListener('click', function() {
                    const container = document.getElementById('aiScoresSectionContainer');
                    const icon = document.getElementById('aiScoresToggleIcon');
                    if (container && icon) {
                        const isVisible = container.style.display !== 'none';
                        container.style.display = isVisible ? 'none' : 'block';
                        icon.className = isVisible ? 'fas fa-eye' : 'fas fa-eye-slash';
                    }
                });
            }
        });

        // Update charts when stock data updates (hook into existing update functions)
        const originalUpdateIndexCards = window.updateIndexCards;
        if (originalUpdateIndexCards) {
            window.updateIndexCards = function(...args) {
                originalUpdateIndexCards.apply(this, args);
                // Update charts after index cards are updated
                setTimeout(updateIndexCharts, 100);
            };
        }

        // Fallback: Update charts every 10 seconds
        setInterval(updateIndexCharts, 10000); // Optimized for smooth performance
    </script>

        </div>
    </div>
    <!-- End Main Container -->

    <!-- Create Alert Modal -->
    <div class="modal fade" id="createAlertModal" tabindex="-1" aria-labelledby="createAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="createAlertModalLabel">
                        <i class="fas fa-bell me-2"></i>Create New Alert
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createAlertForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="alertType" class="form-label">Alert Type</label>
                                <select class="form-select bg-dark text-light border-secondary" id="alertType" required>
                                    <option value="">Select Alert Type</option>
                                    <option value="price_action">Price Action Alert</option>
                                    <option value="index_analysis">Index Analysis Alert</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="alertCategory" class="form-label">Category</label>
                                <select class="form-select bg-dark text-light border-secondary" id="alertCategory" required>
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="alertTitle" class="form-label">Alert Title</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="alertTitle" required>
                            </div>
                            <div class="col-md-6 mb-3" id="symbolGroup" style="display: none;">
                                <label for="alertSymbol" class="form-label">Symbol (Optional)</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary" id="alertSymbol" placeholder="e.g., RELIANCE">
                            </div>
                        </div>

                        <div class="row" id="thresholdGroup" style="display: none;">
                            <div class="col-md-6 mb-3">
                                <label for="thresholdValue" class="form-label">Threshold Value (%)</label>
                                <input type="number" step="0.01" class="form-control bg-dark text-light border-secondary" id="thresholdValue">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="condition" class="form-label">Condition</label>
                                <select class="form-select bg-dark text-light border-secondary" id="condition">
                                    <option value="above">Above</option>
                                    <option value="below">Below</option>
                                    <option value="equals">Equals</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="alertMessage" class="form-label">Alert Message</label>
                            <textarea class="form-control bg-dark text-light border-secondary" id="alertMessage" rows="3" required></textarea>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isActive" checked>
                            <label class="form-check-label" for="isActive">
                                Active Alert
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="saveAlertBtn">
                        <i class="fas fa-save me-1"></i>Save Alert
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Browser Modal -->
    <div class="modal fade" id="floatingBrowserModal" tabindex="-1" aria-labelledby="floatingBrowserModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="floatingBrowserModalLabel">
                        <i class="fas fa-chart-line me-2"></i>Chart Browser
                    </h5>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" id="refreshChart">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div class="position-relative" style="height: 80vh;">
                        <div class="loading-overlay position-absolute w-100 h-100 d-flex align-items-center justify-content-center bg-dark" id="chartLoadingOverlay" style="z-index: 1000;">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #58a6ff;"></i>
                                <div class="mt-3">Loading chart...</div>
                            </div>
                        </div>
                        <div id="tradingview-widget-container" class="w-100 h-100"></div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <small class="text-muted me-auto">
                        <i class="fas fa-info-circle me-1"></i>
                        Powered by TradingView - Real-time market data
                    </small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Manual Modal -->
    <div class="modal fade" id="userManualModal" tabindex="-1" aria-labelledby="userManualModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="userManualModalLabel">
                        <i class="fas fa-book me-2 text-primary"></i>User Manual - MG F&O Dashboard
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <div class="accordion" id="userManualAccordion">
                        <!-- Getting Started -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="gettingStartedHeading">
                                <button class="accordion-button bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#gettingStarted" aria-expanded="true" aria-controls="gettingStarted">
                                    <i class="fas fa-rocket me-2 text-success"></i>Getting Started
                                </button>
                            </h2>
                            <div id="gettingStarted" class="accordion-collapse collapse show" aria-labelledby="gettingStartedHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <h6 class="text-info mb-3">Welcome to MG F&O Stocks Dashboard!</h6>
                                    <p>This professional data analytical dashboard provides real-time market analysis for F&O (Futures & Options) stocks with advanced technical indicators.</p>
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-check text-success me-2"></i>Real-time streaming data for 200+ F&O stocks</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Advanced technical analysis (RVOL, Camarilla, CPR, Fibonacci)</li>
                                        <li><i class="fas fa-check text-success me-2"></i>One-click TradingView chart integration</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Mobile-responsive design</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Dashboard Overview -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="dashboardOverviewHeading">
                                <button class="accordion-button collapsed bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#dashboardOverview" aria-expanded="false" aria-controls="dashboardOverview">
                                    <i class="fas fa-chart-bar me-2 text-warning"></i>Dashboard Overview
                                </button>
                            </h2>
                            <div id="dashboardOverview" class="accordion-collapse collapse" aria-labelledby="dashboardOverviewHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <h6 class="text-info mb-3">Main Components:</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-warning">Market Overview</h6>
                                            <p class="small">Real-time index data including NIFTY, BANKNIFTY, and FINNIFTY with live price updates.</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-warning">Price Action Analysis</h6>
                                            <p class="small">Live stock data with percentage changes, volume analysis, and price movements.</p>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-warning">RVOL Analysis</h6>
                                            <p class="small">Relative Volume analysis categorized by volume levels: Super High (>5x), High (2-5x), Normal (1-2x), Low (<1x).</p>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-warning">Technical Indicators</h6>
                                            <p class="small">Advanced calculations including Camarilla Pivot Points, CPR (Central Pivot Range), and Fibonacci Retracements.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Analysis -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="technicalAnalysisHeading">
                                <button class="accordion-button collapsed bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#technicalAnalysis" aria-expanded="false" aria-controls="technicalAnalysis">
                                    <i class="fas fa-chart-line me-2 text-info"></i>Technical Analysis Features
                                </button>
                            </h2>
                            <div id="technicalAnalysis" class="accordion-collapse collapse" aria-labelledby="technicalAnalysisHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <div class="mb-4">
                                        <h6 class="text-info"> Camarilla Pivot Points</h6>
                                        <p class="small">Advanced pivot calculation system providing 5 resistance (R1-R5) and 5 support (S1-S5) levels based on previous day's high, low, and close.</p>
                                        <ul class="small">
                                            <li><strong>R5/S5:</strong> Extreme levels for breakout trading</li>
                                            <li><strong>R3/S3:</strong> Primary reversal levels</li>
                                            <li><strong>R1/S1:</strong> Intraday support/resistance</li>
                                        </ul>
                                    </div>
                                    <div class="mb-4">
                                        <h6 class="text-info"> CPR (Central Pivot Range)</h6>
                                        <p class="small">Determines market sentiment based on the relationship between Pivot Point (PP), Bottom Central Pivot (BC), and Top Central Pivot (TC).</p>
                                        <ul class="small">
                                            <li><strong>Narrow CPR:</strong> Strong trending day expected</li>
                                            <li><strong>Wide CPR:</strong> Sideways movement likely</li>
                                        </ul>
                                    </div>
                                    <div class="mb-4">
                                        <h6 class="text-info"> Fibonacci Retracements</h6>
                                        <p class="small">Key retracement levels (23.6%, 38.2%, 50%, 61.8%, 78.6%) calculated from recent swing high and low to identify potential reversal zones.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- How to Use -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="howToUseHeading">
                                <button class="accordion-button collapsed bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#howToUse" aria-expanded="false" aria-controls="howToUse">
                                    <i class="fas fa-mouse-pointer me-2 text-success"></i>How to Use the Dashboard
                                </button>
                            </h2>
                            <div id="howToUse" class="accordion-collapse collapse" aria-labelledby="howToUseHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <div class="mb-3">
                                        <h6 class="text-warning"> Viewing Stock Data</h6>
                                        <ul class="small">
                                            <li>Click on any stock symbol to view detailed TradingView chart</li>
                                            <li>Tables are sortable - click column headers to sort</li>
                                            <li>Use search filters to find specific stocks</li>
                                            <li>Color-coded values indicate positive (green) or negative (red) changes</li>
                                        </ul>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="text-warning"> RVOL Analysis</h6>
                                        <ul class="small">
                                            <li><strong>Super High RVOL (>5x):</strong> Exceptional volume activity</li>
                                            <li><strong>High RVOL (2-5x):</strong> Above-normal volume</li>
                                            <li><strong>Normal RVOL (1-2x):</strong> Typical volume range</li>
                                            <li><strong>Low RVOL (<1x):</strong> Below-average volume</li>
                                        </ul>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="text-warning"> Quick Actions</h6>
                                        <ul class="small">
                                            <li>Connection status indicator shows real-time data connectivity</li>
                                            <li>Timestamp displays last data update time</li>
                                            <li>Auto-refresh ensures latest market data</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Support -->
                        <div class="accordion-item bg-dark border-secondary">
                            <h2 class="accordion-header" id="supportHeading">
                                <button class="accordion-button collapsed bg-dark text-light border-0" type="button" data-bs-toggle="collapse" data-bs-target="#support" aria-expanded="false" aria-controls="support">
                                    <i class="fas fa-life-ring me-2 text-danger"></i>Support & Contact
                                </button>
                            </h2>
                            <div id="support" class="accordion-collapse collapse" aria-labelledby="supportHeading" data-bs-parent="#userManualAccordion">
                                <div class="accordion-body text-light">
                                    <div class="text-center">
                                        <h6 class="text-info mb-3">Need Help?</h6>
                                        <p class="mb-3">Our support team is here to assist you with any questions or technical issues.</p>
                                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                                            <a href="mailto:marketguldasta@gmail.com" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-envelope me-1"></i>Email Support
                                            </a>
                                            <a href="tel:+919049536966" class="btn btn-outline-success btn-sm">
                                                <i class="fas fa-phone me-1"></i>Call Support
                                            </a>
                                            <a href="https://wa.me/919049536966" target="_blank" class="btn btn-outline-success btn-sm">
                                                <i class="fab fa-whatsapp me-1"></i>WhatsApp
                                            </a>
                                        </div>
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>Support Hours: 9:00 AM - 6:00 PM (IST)
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <div class="me-auto">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Version 2.0 - Professional Data Analytical Dashboard
                        </small>
                    </div>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="fas fa-check me-1"></i>Got it!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- RVOL Chart JavaScript -->
    <script>
        // RVOL Chart functionality
        let rvolChartData = [];
        let rvolChartVisible = true;
        let rvol50ChartInstance = null;

        // Toggle RVOL Chart visibility
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggleRvolChart');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const container = document.getElementById('rvolChartContainer');
                    const icon = document.getElementById('rvolChartToggleIcon');

                    if (rvolChartVisible) {
                        container.style.display = 'none';
                        icon.className = 'fas fa-eye-slash';
                        rvolChartVisible = false;
                    } else {
                        container.style.display = 'block';
                        icon.className = 'fas fa-eye';
                        rvolChartVisible = true;
                        if (rvolChartData.length === 0) {
                            loadRvolChartData();
                        }
                    }
                });
            }
        });

        function loadRvolChartData() {
            // Remove loading/error states as they've been removed from HTML

            fetch('/api/rvol-data')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        rvolChartData = data.data;
                        renderRvolPieCharts(rvolChartData);
                    } else {
                        console.error('RVOL data error:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading RVOL data:', error);
                });
        }

        // Add throttling to prevent performance issues
        let rvolUpdateTimeout = null;

        // Helper function to get stock data from main table for RVOL percentage calculations
        function getStockDataFromMainTable(symbol) {
            // Access the live stock data from the main dashboard
            if (window.dashboard && window.dashboard.lastStockData) {
                const stockData = window.dashboard.lastStockData;

                // Find stock by symbol (try different symbol formats)
                let foundStock = stockData.find(stock => 
                    stock.symbol === symbol || 
                    stock.symbol === symbol.replace('NSE:', '') ||
                    stock.symbol === symbol.replace('-EQ', '')
                );

                return foundStock || null;
            }

            return null;
        }

        function renderRvolPieCharts(data) {
            // Clear any existing timeout to prevent multiple rapid updates
            if (rvolUpdateTimeout) {
                clearTimeout(rvolUpdateTimeout);
            }

            // Throttle updates to prevent performance issues (optimized to 500ms)
            rvolUpdateTimeout = setTimeout(() => {
                // Filter and deduplicate stocks with valid RVOL data
                const stocksMap = new Map();
                data.forEach(stock => {
                    if (stock.rvol_ratio && stock.rvol_ratio > 0 && stock.current_volume > 0) {
                        const normalizedSymbol = stock.symbol.replace('NSE:', '').replace('-EQ', '').toUpperCase();
                        // Keep the latest data for each symbol
                        stocksMap.set(normalizedSymbol, stock);
                    }
                });

                const stocksWithRvol = Array.from(stocksMap.values());

                if (stocksWithRvol.length === 0) {
                    console.log('No stocks with valid RVOL data');
                    return;
                }

                // Categorize stocks by RVOL ratio - 3 categories
                const volumeCategories = {
                    above2x: [],     // >2x (Above 2X Avg Vol.)
                    range2x1x: [],   // 2x-1x (2x to 1x Avg Vol.)
                    below1x: []      // <1x (Below 1X Avg Vol.)
                };

                // Categorize with ordered else-if to prevent gaps/overlaps
                stocksWithRvol.forEach(stock => {
                    const rvol = stock.rvol_ratio;
                    if (rvol > 2) {
                        volumeCategories.above2x.push(stock);
                    } else if (rvol >= 1) { // 2 >= rvol >= 1
                        volumeCategories.range2x1x.push(stock);
                    } else {                // rvol < 1
                        volumeCategories.below1x.push(stock);
                    }
                });

                // Update counters
                const above2xEl = document.getElementById('above2xCount');
                const range2x1xEl = document.getElementById('range2x1xCount');
                const below1xEl = document.getElementById('below1xCount');

                // Update counters and log distribution for verification
                if (above2xEl) above2xEl.textContent = `${volumeCategories.above2x.length} stocks`;
                if (range2x1xEl) range2x1xEl.textContent = `${volumeCategories.range2x1x.length} stocks`;
                if (below1xEl) below1xEl.textContent = `${volumeCategories.below1x.length} stocks`;

                // RVOL distribution calculated (debug logging removed for performance)

                // Process categories (debug logging removed for performance)

                // Create 3 separate RVOL tables
                createRvolTable('rvolTable1', volumeCategories.above2x, '#dc3545');
                createRvolTable('rvolTable2', volumeCategories.range2x1x, '#28a745');
                createRvolTable('rvolTable3', volumeCategories.below1x, '#17a2b8');
            }, 500); // 500ms throttle optimized for smooth performance
        }

        function createRvolTable(tableId, stocks, primaryColor) {
            const tableContainer = document.getElementById(tableId);

            if (!tableContainer) return;

            if (!stocks || stocks.length === 0) {
                tableContainer.innerHTML = `
                    <div style="text-align: center; color: #888; padding: 20px; font-size: 0.7rem;">
                        <i class="fas fa-chart-line"></i><br>
                        No stocks in this category
                    </div>
                `;
                return;
            }

            // Sort stocks by RVOL descending
            const sortedStocks = stocks.sort((a, b) => (b.rvol_ratio || 0) - (a.rvol_ratio || 0));

            let tableHTML = '';

            sortedStocks.forEach(stock => {
                const symbol = stock.symbol || 'N/A';
                const rvol = stock.rvol_ratio || 0;

                // No percentage calculations needed - removed per user request

                // Debug log for first item in each category
                // RVOL debug logging removed for performance

                // No color coding needed - removed percentage columns

                tableHTML += `
                    <div class="rvol-stock-row" style="border-left-color: ${primaryColor};">
                        <div class="rvol-symbol" onclick="window.open('https://in.tradingview.com/chart/?symbol=NSE:${symbol.replace('-', '_')}', '_blank')">
                            ${symbol}
                        </div>
                        <div class="rvol-data">
                            <span class="rvol-value">${rvol.toFixed(1)}x</span>
                        </div>
                    </div>
                `;
            });

            tableContainer.innerHTML = tableHTML;
        }

        // Auto-load RVOL chart data on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Delay loading by 3 seconds to let other data load first
            setTimeout(() => {
                if (rvolChartVisible) {
                    loadRvolChartData();
                }
            }, 3000);

            // Refresh RVOL data every 3 minutes (reduced frequency)
            setInterval(() => {
                if (rvolChartVisible && rvolChartData.length > 0) {
                    loadRvolChartData();
                }
            }, 60000);
        });
    </script>

    <!-- LEVELS SCAN JavaScript -->
    <script>
        // LEVELS SCAN functionality
        let levelsScanData = [];
        let levelsScanVisible = true;

        // Toggle LEVELS SCAN visibility
        document.getElementById('toggleLevelsScan').addEventListener('click', function() {
            try {
                const container = document.getElementById('levelsScanContainer');
                const icon = document.getElementById('levelsScanToggleIcon');

                if (levelsScanVisible) {
                    container.style.display = 'none';
                    icon.className = 'fas fa-eye-slash';
                    levelsScanVisible = false;
                } else {
                    container.style.display = 'block';
                    icon.className = 'fas fa-eye';
                    levelsScanVisible = true;
                    if (levelsScanData.length === 0) {
                        loadLevelsScanData();
                    }
                }
            } catch (error) {
                console.error('Error toggling levels scan:', error);
            }
        });

        // Load LEVELS SCAN data from technical analysis APIs
        function loadLevelsScanData() {
            // Helper function to add timeout to fetch
            function fetchWithTimeout(url, timeout = 60000) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);

                return fetch(url, { signal: controller.signal }).finally(() => {
                    clearTimeout(timeoutId);
                });
            }

            // Load data from all three technical analysis APIs with 60s timeout
            Promise.all([
                fetchWithTimeout('/get_cpr_data'),
                fetchWithTimeout('/camarilla/data'),  
                fetchWithTimeout('/get_fibonacci_data')
            ])
            .then(responses => {
                console.log(' LEVELS SCAN: API responses received, processing...');
                // Check each response status
                responses.forEach((response, index) => {
                    const apis = ['CPR', 'Camarilla', 'Fibonacci'];
                    console.log(` LEVELS SCAN: ${apis[index]} API - Status: ${response.status}, OK: ${response.ok}`);
                });
                return Promise.all(responses.map(r => r.json()));
            })
            .then(([cprResult, camarillaResult, fibonacciResult]) => {
                console.log(' LEVELS SCAN: JSON parsing complete, processing data...');

                // Process and categorize the data into 4 sub-categories each
                const levelCategories = {
                    cpr: { breakout: [], resistance: [], support: [], breakdown: [] },
                    camarilla: { breakout: [], resistance: [], support: [], breakdown: [] },
                    fibonacci: { breakout: [], resistance: [], support: [], breakdown: [] }
                };

                // Process CPR data into 4 categories
                if (cprResult.success && cprResult.data) {
                    cprResult.data.forEach(stock => {
                        const ltp = parseFloat(stock.current_ltp) || 0;
                        if (ltp === 0) return; // Skip stocks without LTP

                        const tc = parseFloat(stock.tc) || 0;
                        const bc = parseFloat(stock.bc) || 0;
                        const r1 = parseFloat(stock.r1) || 0;
                        const r2 = parseFloat(stock.r2) || 0;
                        const r3 = parseFloat(stock.r3) || 0;
                        const s1 = parseFloat(stock.s1) || 0;
                        const s2 = parseFloat(stock.s2) || 0;
                        const s3 = parseFloat(stock.s3) || 0;

                        const prevClose = parseFloat(stock.prev_close) || ltp;
                        const changePercent = prevClose > 0 ? ((ltp - prevClose) / prevClose) * 100 : 0;

                        let category = '';
                        let status = '';
                        let color = '#ffc107';

                        // Categorize based on CPR levels
                        if (ltp > r1) {
                            category = 'breakout';
                            status = ltp > r3 ? 'Above R3' : ltp > r2 ? 'Above R2' : 'Above R1';
                            color = '#28a745'; // Green for breakout
                        } else if (ltp > tc && ltp <= r1) {
                            category = 'resistance';
                            status = 'Near R1';
                            color = '#17a2b8'; // Blue for resistance range
                        } else if (ltp >= bc && ltp <= tc) {
                            // Within CPR - assign to support/resistance based on position
                            if (ltp > ((tc + bc) / 2)) {
                                category = 'resistance';
                                status = 'Upper CPR';
                                color = '#ffc107';
                            } else {
                                category = 'support';
                                status = 'Lower CPR';
                                color = '#ffc107';
                            }
                        } else if (ltp < bc && ltp >= s1) {
                            category = 'support';
                            status = 'Near S1';
                            color = '#fd7e14'; // Orange for support range
                        } else if (ltp < s1) {
                            category = 'breakdown';
                            status = ltp < s3 ? 'Below S3' : ltp < s2 ? 'Below S2' : 'Below S1';
                            color = '#dc3545'; // Red for breakdown
                        }

                        if (!levelCategories.cpr[category]) {
                            levelCategories.cpr[category] = [];
                        }

                        levelCategories.cpr[category].push({
                            symbol: stock.symbol,
                            ltp: ltp,
                            status: status,
                            color: color,
                            changePercent: changePercent
                        });
                    });
                }

                // Process CAMARILLA data into 4 categories
                if (camarillaResult.success && camarillaResult.data) {
                    // Processing Camarilla data for all stocks

                    camarillaResult.data.forEach(stock => {
                        const ltp = parseFloat(stock.current_ltp);
                        if (!ltp || isNaN(ltp) || ltp <= 0) {
                            // Filtered invalid LTP data
                            return;
                        }

                        const r1 = parseFloat(stock.r1) || 0;
                        const r2 = parseFloat(stock.r2) || 0;
                        const r3 = parseFloat(stock.r3) || 0;
                        const r4 = parseFloat(stock.r4) || 0;
                        const s1 = parseFloat(stock.s1) || 0;
                        const s2 = parseFloat(stock.s2) || 0;
                        const s3 = parseFloat(stock.s3) || 0;
                        const s4 = parseFloat(stock.s4) || 0;

                        const prevClose = parseFloat(stock.prev_close) || ltp;
                        const changePercent = prevClose > 0 ? ((ltp - prevClose) / prevClose) * 100 : 0;

                        let category = '';
                        let status = '';
                        let color = '#ffc107';

                        // Categorize based on CAMARILLA levels with precise detection
                        if (ltp > r3) {
                            category = 'breakout';
                            status = ltp > r4 ? 'Above R4' : 'Above R3';
                            color = '#28a745'; // Green for breakout
                        } else if (ltp > r2) {
                            category = 'resistance';
                            status = 'Near R3';
                            color = '#17a2b8'; // Blue for resistance range
                        } else if (ltp > r1) {
                            category = 'resistance';
                            status = 'Near R2';
                            color = '#17a2b8'; // Blue for resistance range
                        } else if (ltp >= prevClose) {
                            category = 'resistance';
                            status = 'Near R1';
                            color = '#17a2b8'; // Blue for resistance range
                        } else if (ltp < s3) {
                            category = 'breakdown';
                            status = ltp < s4 ? 'Below S4' : 'Below S3';
                            color = '#dc3545'; // Red for breakdown
                        } else if (ltp < s2) {
                            category = 'support';
                            status = 'Near S3';
                            color = '#fd7e14'; // Orange for support range
                        } else if (ltp < s1) {
                            category = 'support';
                            status = 'Near S2';
                            color = '#fd7e14'; // Orange for support range
                        } else {
                            // Between S1 and prevClose
                            category = 'support';
                            status = 'Near S1';
                            color = '#fd7e14'; // Orange for support range
                        }

                        levelCategories.camarilla[category].push({
                            symbol: stock.symbol,
                            ltp: ltp,
                            status: status,
                            color: color,
                            changePercent: changePercent
                        });
                    });
                }

                // Process FIBONACCI data into 4 categories
                if (fibonacciResult.success && fibonacciResult.data) {
                    // Fibonacci processing (debug logging removed for performance)

                    fibonacciResult.data.forEach(stock => {
                        const ltp = parseFloat(stock.current_ltp) || 0;
                        if (ltp === 0) return;

                        const fib_pp = parseFloat(stock.pp) || 0;
                        const fib_r1 = parseFloat(stock.r1_61) || 0;
                        const fib_r2 = parseFloat(stock.r2_123) || 0;
                        const fib_s1 = parseFloat(stock.s1_61) || 0;
                        const fib_s2 = parseFloat(stock.s2_123) || 0;

                        // Fibonacci levels calculated (debug logging removed for performance)

                        const prevClose = parseFloat(stock.prev_close) || ltp;
                        const changePercent = prevClose > 0 ? ((ltp - prevClose) / prevClose) * 100 : 0;

                        let category = '';
                        let status = '';
                        let color = '#ffc107';

                        // Categorize based on FIBONACCI levels
                        if (ltp > fib_r1) {
                            category = 'breakout';
                            status = ltp > fib_r2 ? 'Above R2' : 'Above R1';
                            color = '#28a745'; // Green for breakout
                        } else if (ltp > fib_pp && ltp <= fib_r1) {
                            category = 'resistance';
                            status = 'Near R1';
                            color = '#17a2b8'; // Blue for resistance range
                        } else if (ltp < fib_pp && ltp >= fib_s1) {
                            category = 'support';
                            status = 'Near S1';
                            color = '#fd7e14'; // Orange for support range
                        } else if (ltp < fib_s1) {
                            category = 'breakdown';
                            status = ltp < fib_s2 ? 'Below S2' : 'Below S1';
                            color = '#dc3545'; // Red for breakdown
                        } else {
                            // Around pivot point
                            category = ltp >= fib_pp ? 'resistance' : 'support';
                            status = 'Near PP';
                            color = '#20c997';
                        }

                        levelCategories.fibonacci[category].push({
                            symbol: stock.symbol,
                            ltp: ltp,
                            status: status,
                            color: color,
                            changePercent: changePercent
                        });
                    });
                }

                // Sort each category by most interesting positions first (highest absolute change %)
                Object.keys(levelCategories).forEach(levelType => {
                    Object.keys(levelCategories[levelType]).forEach(category => {
                        levelCategories[levelType][category].sort((a, b) => Math.abs(b.changePercent) - Math.abs(a.changePercent));
                    });
                });

                // Update count displays for 12 sub-tables
                document.getElementById('cprBreakoutCount').textContent = levelCategories.cpr.breakout.length;
                document.getElementById('cprResistanceCount').textContent = levelCategories.cpr.resistance.length;
                document.getElementById('cprSupportCount').textContent = levelCategories.cpr.support.length;
                document.getElementById('cprBreakdownCount').textContent = levelCategories.cpr.breakdown.length;

                document.getElementById('camBreakoutCount').textContent = levelCategories.camarilla.breakout.length;
                document.getElementById('camResistanceCount').textContent = levelCategories.camarilla.resistance.length;
                document.getElementById('camSupportCount').textContent = levelCategories.camarilla.support.length;
                document.getElementById('camBreakdownCount').textContent = levelCategories.camarilla.breakdown.length;

                document.getElementById('fibBreakoutCount').textContent = levelCategories.fibonacci.breakout.length;
                document.getElementById('fibResistanceCount').textContent = levelCategories.fibonacci.resistance.length;
                document.getElementById('fibSupportCount').textContent = levelCategories.fibonacci.support.length;
                document.getElementById('fibBreakdownCount').textContent = levelCategories.fibonacci.breakdown.length;

                // Update progress bars for visual representation
                const allCounts = [
                    levelCategories.cpr.breakout.length, levelCategories.cpr.resistance.length, 
                    levelCategories.cpr.support.length, levelCategories.cpr.breakdown.length,
                    levelCategories.camarilla.breakout.length, levelCategories.camarilla.resistance.length,
                    levelCategories.camarilla.support.length, levelCategories.camarilla.breakdown.length,
                    levelCategories.fibonacci.breakout.length, levelCategories.fibonacci.resistance.length,
                    levelCategories.fibonacci.support.length, levelCategories.fibonacci.breakdown.length
                ];
                const maxCount = Math.max(...allCounts, 1); // Avoid division by zero

                // Update CPR progress bars
                const updateProgress = (id, count) => {
                    const progressBar = document.getElementById(id);
                    const percentage = Math.round((count / maxCount) * 100);
                    progressBar.style.width = percentage + '%';
                    progressBar.setAttribute('aria-valuenow', percentage);
                };

                updateProgress('cprBreakoutProgress', levelCategories.cpr.breakout.length);
                updateProgress('cprResistanceProgress', levelCategories.cpr.resistance.length);
                updateProgress('cprSupportProgress', levelCategories.cpr.support.length);
                updateProgress('cprBreakdownProgress', levelCategories.cpr.breakdown.length);

                updateProgress('camBreakoutProgress', levelCategories.camarilla.breakout.length);
                updateProgress('camResistanceProgress', levelCategories.camarilla.resistance.length);
                updateProgress('camSupportProgress', levelCategories.camarilla.support.length);
                updateProgress('camBreakdownProgress', levelCategories.camarilla.breakdown.length);

                updateProgress('fibBreakoutProgress', levelCategories.fibonacci.breakout.length);
                updateProgress('fibResistanceProgress', levelCategories.fibonacci.resistance.length);
                updateProgress('fibSupportProgress', levelCategories.fibonacci.support.length);
                updateProgress('fibBreakdownProgress', levelCategories.fibonacci.breakdown.length);

                // Render 12 tables (4 categories x 3 levels)
                createLevelsTable('cprBreakoutTable', levelCategories.cpr.breakout, 'CPR');
                createLevelsTable('cprResistanceTable', levelCategories.cpr.resistance, 'CPR');
                createLevelsTable('cprSupportTable', levelCategories.cpr.support, 'CPR');
                createLevelsTable('cprBreakdownTable', levelCategories.cpr.breakdown, 'CPR');

                createLevelsTable('camBreakoutTable', levelCategories.camarilla.breakout, 'CAMARILLA');
                createLevelsTable('camResistanceTable', levelCategories.camarilla.resistance, 'CAMARILLA');
                createLevelsTable('camSupportTable', levelCategories.camarilla.support, 'CAMARILLA');
                createLevelsTable('camBreakdownTable', levelCategories.camarilla.breakdown, 'CAMARILLA');

                createLevelsTable('fibBreakoutTable', levelCategories.fibonacci.breakout, 'FIBONACCI');
                createLevelsTable('fibResistanceTable', levelCategories.fibonacci.resistance, 'FIBONACCI');
                createLevelsTable('fibSupportTable', levelCategories.fibonacci.support, 'FIBONACCI');
                createLevelsTable('fibBreakdownTable', levelCategories.fibonacci.breakdown, 'FIBONACCI');

                const cprTotal = levelCategories.cpr.breakout.length + levelCategories.cpr.resistance.length + levelCategories.cpr.support.length + levelCategories.cpr.breakdown.length;
                const camTotal = levelCategories.camarilla.breakout.length + levelCategories.camarilla.resistance.length + levelCategories.camarilla.support.length + levelCategories.camarilla.breakdown.length;
                const fibTotal = levelCategories.fibonacci.breakout.length + levelCategories.fibonacci.resistance.length + levelCategories.fibonacci.support.length + levelCategories.fibonacci.breakdown.length;

                console.log(` LEVELS SCAN: Rendered CPR: ${cprTotal}, Camarilla: ${camTotal}, Fibonacci: ${fibTotal}`);
            })
            .catch(error => {
                console.error(' LEVELS SCAN ERROR: Failed to load data:', error);
                if (error.name === 'AbortError') {
                    console.error(' LEVELS SCAN: Request timed out after 60 seconds');
                } else {
                    console.error(' LEVELS SCAN: Network or parsing error:', error.message);
                }
            });
        }

        // Create levels table for each technical analysis type
        function createLevelsTable(tableId, stocks, type) {
            const tableContainer = document.getElementById(tableId);
            if (!tableContainer) return;

            // Show all stocks (no limit)
            let tableHTML = '';
            stocks.forEach(stock => {
                tableHTML += `
                    <div class="rvol-stock-row" style="border-left-color: ${stock.color};">
                        <div class="rvol-symbol" onclick="window.open('https://in.tradingview.com/chart/?symbol=NSE:${stock.symbol.replace('-', '_')}', '_blank')">
                            ${stock.symbol}
                        </div>
                        <div class="rvol-data">
                            <span style="color: ${stock.color}; font-weight: bold; font-size: 0.5rem;">${stock.status}</span>
                        </div>
                    </div>
                `;
            });

            tableContainer.innerHTML = tableHTML;
        }

        // Auto-load LEVELS SCAN data on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' LEVELS SCAN: DOM loaded, will load data in 3 seconds...');
            // Delay loading by 3 seconds to let technical analysis data load first
            setTimeout(() => {
                console.log(' LEVELS SCAN: 3-second delay complete, levelsScanVisible:', levelsScanVisible);
                if (levelsScanVisible) {
                    console.log(' LEVELS SCAN: Auto-loading data now...');
                    loadLevelsScanData();
                } else {
                    console.log(' LEVELS SCAN: Skipped auto-load, levels scan not visible');
                }
            }, 3000);

            // Refresh LEVELS SCAN data every 30 seconds
            setInterval(() => {
                if (levelsScanVisible) {
                    console.log(' LEVELS SCAN: 30s interval refresh...');
                    loadLevelsScanData();
                }
            }, 30000);
        });
    </script>

    <!-- Floating Browser JavaScript -->
    <script>
        class FloatingBrowser {
            constructor() {
                this.modal = new bootstrap.Modal(document.getElementById('floatingBrowserModal'));
                this.widgetContainer = document.getElementById('tradingview-widget-container');
                this.loadingOverlay = document.getElementById('chartLoadingOverlay');
                this.modalTitle = document.getElementById('floatingBrowserModalLabel');
                this.currentSymbol = '';
                this.init();
            }

            init() {
                // Refresh button functionality
                const refreshBtn = document.getElementById('refreshChart');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        this.refreshChart();
                    });
                }

                // Clear widget when modal closes
                const modalElement = document.getElementById('floatingBrowserModal');
                if (modalElement) {
                    modalElement.addEventListener('hidden.bs.modal', () => {
                        this.widgetContainer.innerHTML = '';
                        this.currentSymbol = '';
                    });
                }
            }

            openChart(chartUrl, symbolName = 'Chart') {
                // Extract symbol from TradingView URL
                const urlMatch = chartUrl.match(/symbol=([^&]+)/);
                const symbol = urlMatch ? urlMatch[1] : `NSE:${symbolName}`;

                this.currentSymbol = symbol;
                this.modalTitle.innerHTML = `<i class="fas fa-chart-line me-2"></i>${symbolName} Chart`;
                this.showLoading();
                this.modal.show();

                // Create TradingView widget
                this.loadTradingViewWidget(symbol);
            }

            loadTradingViewWidget(symbol) {
                // Clear previous widget
                this.widgetContainer.innerHTML = '';

                // Create widget script
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
                script.async = true;
                script.innerHTML = JSON.stringify({
                    "autosize": true,
                    "symbol": symbol,
                    "timezone": "Asia/Kolkata",
                    "theme": "dark",
                    "style": "1",
                    "locale": "en",
                    "enable_publishing": false,
                    "withdateranges": true,
                    "range": "YTD",
                    "hide_side_toolbar": false,
                    "allow_symbol_change": true,
                    "save_image": false,
                    "calendar": false,
                    "support_host": "https://www.tradingview.com"
                });

                // Add the script to widget container
                this.widgetContainer.appendChild(script);

                // Hide loading after widget loads
                setTimeout(() => {
                    this.hideLoading();
                }, 3000);
            }

            refreshChart() {
                if (this.currentSymbol) {
                    this.showLoading();
                    this.loadTradingViewWidget(this.currentSymbol);
                }
            }

            showLoading() {
                this.loadingOverlay.style.display = 'flex';
            }

            hideLoading() {
                this.loadingOverlay.style.display = 'none';
            }
        }

        // Column header sorting functionality
        if (!window.TableHeaderSorter) {
        class TableHeaderSorter {
            constructor() {
                this.sortStates = {};
                this.initializeHeaders();
            }

            // Parse range text to key and rank for sorting/filtering (based on actual Range column formats)
            parseRangeToKeyAndRank(rangeText) {
                if (!rangeText || rangeText === '-' || rangeText.trim() === '') return { key: 'unknown', rank: 1 };

                // Clean text: remove HTML tags, extra spaces, and indicators like *
                const text = rangeText.replace(/<[^>]*>/g, '').replace(/\*/g, '').trim().toLowerCase();

                // Handle "No Data" or "No Price" cases
                if (text.includes('no data') || text.includes('no price')) return { key: 'no_data', rank: 1 };

                // Exact matches based on actual Range column output patterns

                // Camarilla patterns: "Above R5", "R4-R5", "R3-R4", etc.
                if (text === 'above r5') return { key: 'above_r5', rank: 100 };
                if (text === 'r4-r5') return { key: 'r4_to_r5', rank: 98 };
                if (text === 'r3-r4') return { key: 'r3_to_r4', rank: 96 };
                if (text === 'r2-r3') return { key: 'r2_to_r3', rank: 94 };
                if (text === 'r1-r2') return { key: 'r1_to_r2', rank: 92 };
                if (text === 's1-r1') return { key: 's1_to_r1', rank: 90 };
                if (text === 's2-s1') return { key: 's2_to_s1', rank: 88 };
                if (text === 's3-s2') return { key: 's3_to_s2', rank: 86 };
                if (text === 's4-s3') return { key: 's4_to_s3', rank: 84 };
                if (text === 's5-s4') return { key: 's5_to_s4', rank: 82 };
                if (text === 'below s5') return { key: 'below_s5', rank: 80 };

                // CPR patterns: "Above R3", "R2-R3", "R1-R2", "TC-R1", "PP-TC", "BC-PP", "S1-BC", etc.
                if (text === 'above r3') return { key: 'above_r3', rank: 78 };
                if (text === 'tc-r1') return { key: 'tc_to_r1', rank: 76 };
                if (text === 'pp-tc') return { key: 'pp_to_tc', rank: 74 };
                if (text === 'bc-pp') return { key: 'bc_to_pp', rank: 72 };
                if (text === 's1-bc') return { key: 's1_to_bc', rank: 70 };
                if (text === 'below s3') return { key: 'below_s3', rank: 68 };

                // Fibonacci patterns: "PP-R1", "S1-PP", etc.
                if (text === 'pp-r1') return { key: 'pp_to_r1', rank: 66 };
                if (text === 's1-pp') return { key: 's1_to_pp', rank: 64 };

                // Generic patterns using regex for variations and edge cases

                // Above patterns
                if (/^above\s+r5/i.test(text)) return { key: 'above_r5', rank: 100 };
                if (/^above\s+r4/i.test(text)) return { key: 'above_r4', rank: 97 };
                if (/^above\s+r3/i.test(text)) return { key: 'above_r3', rank: 78 };
                if (/^above\s+r2/i.test(text)) return { key: 'above_r2', rank: 95 };
                if (/^above\s+r1/i.test(text)) return { key: 'above_r1', rank: 93 };

                // Between level patterns (dash format: R4-R5, R3-R4, etc.)
                if (/r4\s*-\s*r5/i.test(text)) return { key: 'r4_to_r5', rank: 98 };
                if (/r3\s*-\s*r4/i.test(text)) return { key: 'r3_to_r4', rank: 96 };
                if (/r2\s*-\s*r3/i.test(text)) return { key: 'r2_to_r3', rank: 94 };
                if (/r1\s*-\s*r2/i.test(text)) return { key: 'r1_to_r2', rank: 92 };

                // Resistance to support transitions
                if (/s1\s*-\s*r1/i.test(text)) return { key: 's1_to_r1', rank: 90 };

                // Support level ranges
                if (/s2\s*-\s*s1/i.test(text)) return { key: 's2_to_s1', rank: 88 };
                if (/s3\s*-\s*s2/i.test(text)) return { key: 's3_to_s2', rank: 86 };
                if (/s4\s*-\s*s3/i.test(text)) return { key: 's4_to_s3', rank: 84 };
                if (/s5\s*-\s*s4/i.test(text)) return { key: 's5_to_s4', rank: 82 };

                // CPR specific patterns
                if (/tc\s*-\s*r1/i.test(text)) return { key: 'tc_to_r1', rank: 76 };
                if (/pp\s*-\s*tc/i.test(text)) return { key: 'pp_to_tc', rank: 74 };
                if (/bc\s*-\s*pp/i.test(text)) return { key: 'bc_to_pp', rank: 72 };
                if (/s1\s*-\s*bc/i.test(text)) return { key: 's1_to_bc', rank: 70 };

                // Fibonacci specific patterns
                if (/pp\s*-\s*r1/i.test(text)) return { key: 'pp_to_r1', rank: 66 };
                if (/s1\s*-\s*pp/i.test(text)) return { key: 's1_to_pp', rank: 64 };

                // Below patterns
                if (/^below\s+s5/i.test(text)) return { key: 'below_s5', rank: 80 };
                if (/^below\s+s4/i.test(text)) return { key: 'below_s4', rank: 83 };
                if (/^below\s+s3/i.test(text)) return { key: 'below_s3', rank: 68 };
                if (/^below\s+s2/i.test(text)) return { key: 'below_s2', rank: 87 };
                if (/^below\s+s1/i.test(text)) return { key: 'below_s1', rank: 89 };

                // Exact level matches (at specific levels)
                if (/\bat\s+r5\b|\br5\b/i.test(text)) return { key: 'at_r5', rank: 99 };
                if (/\bat\s+r4\b|\br4\b/i.test(text)) return { key: 'at_r4', rank: 97 };
                if (/\bat\s+r3\b|\br3\b/i.test(text)) return { key: 'at_r3', rank: 79 };
                if (/\bat\s+r2\b|\br2\b/i.test(text)) return { key: 'at_r2', rank: 95 };
                if (/\bat\s+r1\b|\br1\b/i.test(text)) return { key: 'at_r1', rank: 93 };
                if (/\bat\s+tc\b|\btc\b/i.test(text)) return { key: 'at_tc', rank: 77 };
                if (/\bat\s+pp\b|\bpp\b/i.test(text)) return { key: 'at_pp', rank: 75 };
                if (/\bat\s+bc\b|\bbc\b/i.test(text)) return { key: 'at_bc', rank: 73 };
                if (/\bat\s+s1\b|\bs1\b/i.test(text)) return { key: 'at_s1', rank: 71 };
                if (/\bat\s+s2\b|\bs2\b/i.test(text)) return { key: 'at_s2', rank: 87 };
                if (/\bat\s+s3\b|\bs3\b/i.test(text)) return { key: 'at_s3', rank: 69 };
                if (/\bat\s+s4\b|\bs4\b/i.test(text)) return { key: 'at_s4', rank: 83 };
                if (/\bat\s+s5\b|\bs5\b/i.test(text)) return { key: 'at_s5', rank: 81 };

                return { key: 'unknown', rank: 1 };
            }

            // Set range attributes on table row with consistent data attribute naming
            setRowRangeAttrs(row) {
                const rangeCell = row.querySelector('td:nth-child(2)'); // Range is 2nd column
                if (!rangeCell) return;

                const rangeText = rangeCell.textContent || rangeCell.innerText || '';
                const { key, rank } = this.parseRangeToKeyAndRank(rangeText);

                // Use consistent data attribute names
                row.setAttribute('data-range-key', key);
                row.setAttribute('data-range-rank', rank.toString());
                row.dataset.rangeKey = key;
                row.dataset.rangeRank = rank;
            }

            // Get available range categories for a table (with table-specific options)
            getRangeCategories(tableType) {
                const baseCategories = [
                    { key: 'all', label: 'All Ranges', rank: null },
                    { key: 'above_r3', label: 'Above R3+', rank: 90 },
                    { key: 'between_r1_r3', label: 'R1 to R3', rank: 80 },
                    { key: 'around_pivot', label: 'Around Pivot', rank: 50 },
                    { key: 'between_s1_pivot', label: 'S1 to Pivot', rank: 45 },
                    { key: 'below_s1', label: 'Below S1-', rank: 40 },
                    { key: 'unknown', label: 'Unknown/Other', rank: 1 }
                ];

                // Add Fibonacci-specific categories for fibonacci table
                if (tableType === 'fibonacci') {
                    return [
                        ...baseCategories.slice(0, 1), // Keep 'all'
                        { key: 'above_fib_61', label: 'Above 61.8%+', rank: 82 },
                        { key: 'between_fib_38_61', label: '38.2% to 61.8%', rank: 65 },
                        { key: 'around_pivot', label: 'Around Pivot', rank: 50 },
                        { key: 'below_fib_38', label: 'Below 38.2%-', rank: 58 },
                        ...baseCategories.slice(-1) // Keep 'unknown'
                    ];
                }

                // Add CPR-specific categories for cpr table
                if (tableType === 'cpr') {
                    return [
                        ...baseCategories.slice(0, 1), // Keep 'all'
                        { key: 'above_r2', label: 'Above R2+', rank: 86 },
                        { key: 'between_r1_r2', label: 'R1 to R2', rank: 83 },
                        { key: 'in_cpr', label: 'In CPR Zone', rank: 50 },
                        { key: 'between_s1_pivot', label: 'S1 to Pivot', rank: 46 },
                        { key: 'below_s2', label: 'Below S2-', rank: 32 },
                        ...baseCategories.slice(-1) // Keep 'unknown'
                    ];
                }

                return baseCategories;
            }

            // Apply filter and sort to table
            applyFilterAndSort(tableId) {
                const tbody = document.getElementById(tableId + 'Body');
                if (!tbody) return;

                const tableType = tableId.replace('Table', '').toLowerCase();
                const state = this.filterStates[tableType];
                if (!state) return;

                const rows = Array.from(tbody.querySelectorAll('tr'));

                // Set range attributes for all rows
                rows.forEach(row => this.setRowRangeAttrs(row));

                // Filter rows
                rows.forEach(row => {
                    const shouldShow = this.shouldShowRow(row, state.activeRange);
                    row.style.display = shouldShow ? '' : 'none';
                });

                // Sort if enabled
                if (state.sortEnabled) {
                    const visibleRows = rows.filter(row => row.style.display !== 'none');
                    visibleRows.sort((a, b) => {
                        const rankA = parseInt(a.dataset.rangeRank || '0');
                        const rankB = parseInt(b.dataset.rangeRank || '0');

                        // Primary sort by range rank (descending - higher resistance first)
                        if (rankA !== rankB) {
                            return rankB - rankA;
                        }

                        // Secondary sort by symbol (ascending alphabetical)
                        const symbolA = a.querySelector('td:first-child')?.textContent?.trim() || '';
                        const symbolB = b.querySelector('td:first-child')?.textContent?.trim() || '';
                        return symbolA.localeCompare(symbolB);
                    });

                    // Reorder in DOM
                    visibleRows.forEach(row => tbody.appendChild(row));
                }

                this.saveState();
            }

            // Check if row should be shown based on filter
            shouldShowRow(row, activeRange) {
                if (activeRange === 'all') return true;

                const rowRangeKey = row.dataset.rangeKey;
                const rowRank = parseInt(row.dataset.rangeRank || '0');

                switch (activeRange) {
                    case 'above_r3':
                        return rowRank >= 90;
                    case 'between_r1_r3':
                        return rowRank >= 78 && rowRank < 90;
                    case 'around_pivot':
                        return rowRank >= 45 && rowRank <= 55;
                    case 'between_s1_pivot':
                        return rowRank >= 40 && rowRank < 50;
                    case 'below_s1':
                        return rowRank < 40;
                    default:
                        return rowRangeKey === activeRange;
                }
            }

            // Throttled apply function using requestAnimationFrame for better performance
            throttledApply(tableId) {
                if (this.throttleTimeouts[tableId]) {
                    cancelAnimationFrame(this.throttleTimeouts[tableId]);
                }

                this.throttleTimeouts[tableId] = requestAnimationFrame(() => {
                    // Add small delay to batch multiple updates
                    setTimeout(() => {
                        this.applyFilterAndSort(tableId);
                        delete this.throttleTimeouts[tableId];
                    }, 25); // Reduced from 50ms to 25ms for faster DOM updates
                });
            }

            // Update filter for a table
            setFilter(tableType, rangeKey) {
                if (this.filterStates[tableType]) {
                    this.filterStates[tableType].activeRange = rangeKey;
                    this.applyFilterAndSort(tableType + 'Table');
                    this.updateButtonState(tableType);
                }
            }

            // Toggle sort for a table
            toggleSort(tableType) {
                if (this.filterStates[tableType]) {
                    this.filterStates[tableType].sortEnabled = !this.filterStates[tableType].sortEnabled;
                    this.applyFilterAndSort(tableType + 'Table');
                    this.updateButtonState(tableType);
                }
            }

            // Update button visual state
            updateButtonState(tableType) {
                const button = document.getElementById(`${tableType}RangeFilterBtn`);
                const sortBtn = document.getElementById(`${tableType}RangeSortBtn`);

                if (button) {
                    const state = this.filterStates[tableType];
                    const isFiltered = state.activeRange !== 'all';

                    button.className = `btn btn-sm ${isFiltered ? 'btn-warning' : 'btn-outline-warning'}`;

                    // Update button text
                    const activeLabel = state.activeRange === 'all' ? 'Range' : 
                        this.getRangeCategories().find(cat => cat.key === state.activeRange)?.label || 'Filter';
                    button.innerHTML = `<i class="fas fa-filter me-1"></i>${activeLabel}`;
                }

                if (sortBtn) {
                    const state = this.filterStates[tableType];
                    sortBtn.className = `btn btn-sm ms-1 ${state.sortEnabled ? 'btn-info' : 'btn-outline-info'}`;
                }
            }

            // Save state to localStorage
            saveState() {
                try {
                    localStorage.setItem('rangeFilterStates', JSON.stringify(this.filterStates));
                } catch (e) {
                    console.warn('Failed to save range filter state:', e);
                }
            }

            // Load state from localStorage
            loadState() {
                try {
                    const saved = localStorage.getItem('rangeFilterStates');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        this.filterStates = { ...this.filterStates, ...parsed };
                    }
                } catch (e) {
                    console.warn('Failed to load range filter state:', e);
                }
            }

            // Initialize filter for a table type
            initializeTable(tableType) {
                this.updateButtonState(tableType);
                // Apply saved state
                this.throttledApply(tableType + 'Table');
            }
        }
        window.TableHeaderSorter = TableHeaderSorter;
        }

        // Initialize floating browser when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.floatingBrowser = new FloatingBrowser();
        });

        // High/Low Alert System - Real-time only (no queue)
        class AlertSystem {
            constructor() {
                this.alertContainer = document.getElementById('alertContainer');
                this.activeAlerts = new Set();
                console.log(' Alert System: Initializing for real-time websocket alerts...', this.alertContainer ? 'Found alert container' : 'Alert container NOT found');
                this.init();
            }

            init() {
                if (!this.alertContainer) {
                    console.error(' Alert System: Alert container not found! Cannot start alert system.');
                    return;
                }
                console.log(' Alert System: Ready for REAL-TIME alerts (no queue) - all users see same alerts simultaneously');
            }

            // Check if market is open (9:15 AM to 3:30 PM IST)
            isMarketOpen() {
                const now = new Date();
                const istTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
                const hours = istTime.getHours();
                const minutes = istTime.getMinutes();

                // Market opens at 9:15 AM and closes at 3:30 PM IST
                const marketOpen = 9 * 60 + 15; // 9:15 AM in minutes
                const marketClose = 15 * 60 + 30; // 3:30 PM in minutes
                const currentTime = hours * 60 + minutes;

                return currentTime >= marketOpen && currentTime <= marketClose;
            }

            // Process alerts from the main data stream - REAL-TIME ONLY
            processAlertsFromStream(alerts) {
                if (!alerts || alerts.length === 0) return;
                
                // Skip if tab is not active - don't queue, just skip
                if (document.hidden || document.visibilityState === 'hidden') {
                    console.log(' Alert System: Tab not active, skipping', alerts.length, 'real-time alerts (not queued)');
                    return;
                }

                // Skip if alerts are disabled
                if (!alertsVisible) {
                    console.log(' Alert System: Alerts disabled, skipping', alerts.length, 'real-time alerts (not queued)');
                    return;
                }

                // Skip if market is closed
                if (!this.isMarketOpen()) {
                    console.log(' Alert System: Market closed, skipping', alerts.length, 'real-time alerts (not queued)');
                    return;
                }

                console.log(' Alert System: Showing', alerts.length, 'real-time alerts immediately');
                
                // Show alerts immediately (no queue)
                alerts.forEach(alert => {
                    this.showAlertImmediately(alert);
                });
            }

            showAlertImmediately(alert) {
                // Server broadcasts each alert for only 2 seconds
                // All users poll at 500ms intervals, so everyone sees it
                // No client-side deduplication needed - server controls visibility window
                const alertId = `${alert.symbol}_${alert.type}_${alert.cache_timestamp || alert.timestamp}`;

                console.log(' Alert System: Displaying', alert.symbol, alert.type, '' + alert.price.toFixed(2));
                
                const alertElement = this.createAlertElement(alert, alertId);
                this.alertContainer.appendChild(alertElement);
                this.activeAlerts.add(alertId);

                // Show container
                this.alertContainer.classList.add('show');

                // Auto-hide after 2 seconds
                setTimeout(() => {
                    this.hideAlert(alertElement, alertId);
                }, 2000);
            }

            createAlertElement(alert, alertId) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `price-alert ${alert.type}`;
                alertDiv.setAttribute('data-alert-id', alertId);

                const isHigh = alert.type === 'high';
                const icon = isHigh ? 'fa-arrow-up' : 'fa-arrow-down';
                const priceKey = isHigh ? 'new_high' : 'new_low';
                const previousKey = isHigh ? 'previous_high' : 'previous_low';
                const priceClass = isHigh ? 'high-price' : 'low-price';

                alertDiv.innerHTML = `
                    <div class="alert-single-line">
                        <span class="alert-symbol-small"><i class="fas ${icon} icon ${alert.type}"></i> ${alert.symbol}</span>
                        <span class="alert-ltp">New ${isHigh ? 'High' : 'Low'}: <span class="${priceClass}">${alert.price.toFixed(2)}</span></span>
                    </div>
                `;

                // Click to dismiss
                alertDiv.addEventListener('click', () => {
                    this.hideAlert(alertDiv, alertId);
                });

                return alertDiv;
            }

            hideAlert(alertElement, alertId) {
                alertElement.classList.add('fadeOut');

                setTimeout(() => {
                    if (alertElement.parentNode) {
                        alertElement.parentNode.removeChild(alertElement);
                    }
                    this.activeAlerts.delete(alertId);

                    // Hide container if no more alerts
                    if (this.alertContainer.children.length === 0) {
                        this.alertContainer.classList.remove('show');
                    }
                }, 200);
            }
        }

        // Initialize alert system when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.alertSystem = new AlertSystem();
        });

        // Volume Profile Manager - Single Chart Interactive 5-Day Volume Analysis
        class VolumeProfileManager {
            constructor() {
                this.activeChart = null; // Single chart instance
                this.currentSymbol = null;
                this.availableStocks = [];
                this.volumeProfileVisible = true;
                this.init();
            }

            init() {
                console.log(' Volume Profile: Initializing single chart manager...');
                this.loadAvailableStocks();
                this.setupEventListeners();
                this.setupToggleVisibility();

                // Start live LTP updates every 15 seconds (optimized)
                setInterval(() => this.updateLiveLTP(), 15000); // Optimized volume profile LTP updates
            }

            async loadAvailableStocks() {
                try {
                    const response = await fetch('/api/volume-profile/stocks');
                    const result = await response.json();

                    if (result.status === 'success') {
                        this.availableStocks = result.stocks;
                        this.populateStockSelector();
                        console.log(` Volume Profile: Loaded ${result.count} available stocks`);
                    } else {
                        console.error(' Volume Profile: Failed to load stocks:', result.message);
                    }
                } catch (error) {
                    console.error(' Volume Profile: Error loading stocks:', error);
                }
            }

            populateStockSelector() {
                const selector = document.getElementById('volumeProfileStockSelector');
                if (!selector) return;

                // Clear existing options except first one
                selector.innerHTML = '<option value="">Select Stock...</option>';

                // Add stock options
                this.availableStocks.forEach(stock => {
                    const option = document.createElement('option');
                    option.value = stock.symbol;
                    option.textContent = stock.symbol;
                    selector.appendChild(option);
                });

                // Set first symbol as default and auto-load
                if (this.availableStocks.length > 0) {
                    const firstSymbol = this.availableStocks[0].symbol;
                    selector.value = firstSymbol;
                    console.log(` Volume Profile: Auto-loading default symbol: ${firstSymbol}`);
                    // Auto-load the default symbol
                    this.loadVolumeProfile(firstSymbol);
                }
            }

            setupEventListeners() {
                // Stock selection
                const selector = document.getElementById('volumeProfileStockSelector');
                if (selector) {
                    selector.addEventListener('change', (e) => {
                        if (e.target.value) {
                            this.loadVolumeProfile(e.target.value);
                        } else {
                            this.clearChart();
                        }
                    });
                }

                // Clear chart button
                const clearBtn = document.getElementById('clearChart');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearChart());
                }
            }

            setupToggleVisibility() {
                const toggleBtn = document.getElementById('toggleVolumeProfile');
                const container = document.getElementById('volumeProfileContainer');
                const icon = document.getElementById('volumeProfileToggleIcon');

                if (toggleBtn && container && icon) {
                    toggleBtn.addEventListener('click', () => {
                        if (this.volumeProfileVisible) {
                            container.style.display = 'none';
                            icon.className = 'fas fa-eye-slash';
                            this.volumeProfileVisible = false;
                        } else {
                            container.style.display = 'block';
                            icon.className = 'fas fa-eye';
                            this.volumeProfileVisible = true;
                        }
                    });
                }
            }

            async loadVolumeProfile(symbol) {
                try {
                    console.log(` Volume Profile: Loading data for ${symbol}...`);

                    const response = await fetch(`/api/volume-profile/${symbol}`);
                    const result = await response.json();

                    if (result.status === 'success') {
                        this.createVolumeChart(symbol, result);
                        console.log(` Volume Profile: Created chart for ${symbol}`);
                    } else {
                        console.error(` Volume Profile: Error loading ${symbol}:`, result.message);
                        alert(`Failed to load volume profile for ${symbol}: ${result.message}`);
                    }
                } catch (error) {
                    console.error(` Volume Profile: Network error for ${symbol}:`, error);
                    alert(`Network error loading ${symbol}. Please try again.`);
                }
            }

            createVolumeChart(symbol, data) {
                const canvas = document.getElementById('volumeChart');

                if (!canvas) {
                    console.error(' Volume Profile: Chart canvas not found');
                    return;
                }

                // Clear existing chart if any
                if (this.activeChart) {
                    this.activeChart.destroy();
                }

                // Show chart container and hide message
                this.showChart();

                // Update chart title and info
                this.updateChartInfo(symbol, data);

                // Create Chart.js horizontal bar chart with enhanced styling
                this.activeChart = this.createChartJS(canvas, symbol, data);
                this.currentSymbol = symbol;

                console.log(` Volume Profile: Chart created for ${symbol}`);
            }

            createChartJS(canvas, symbol, data) {
                const ctx = canvas.getContext('2d');

                // Prepare data for volume profile (horizontal bars only)
                const volumeProfile = data.volume_profile || [];
                const priceLabels = volumeProfile.map(item => `${item.price}`);
                const volumes = volumeProfile.map(item => item.volume);
                const vpocPrice = data.important_levels?.vpoc || 0;
                const valueAreaHigh = data.important_levels?.value_area_high || 0;
                const valueAreaLow = data.important_levels?.value_area_low || 0;
                const currentLTP = data.current_ltp || 0;

                // Enhanced color and width styling for volume levels
                const backgroundColors = [];
                const borderColors = [];
                const barThickness = [];

                volumeProfile.forEach(item => {
                    const price = item.price;
                    if (Math.abs(price - vpocPrice) < 0.01) {
                        // VPOC - Gold with thick bar
                        backgroundColors.push('rgba(255, 206, 84, 0.9)');
                        borderColors.push('rgba(255, 206, 84, 1)');
                        barThickness.push(8);
                    } else if (price >= valueAreaLow && price <= valueAreaHigh) {
                        // Value Area - Teal with medium thick bar
                        backgroundColors.push('rgba(75, 192, 192, 0.8)');
                        borderColors.push('rgba(75, 192, 192, 1)');
                        barThickness.push(6);
                    } else {
                        // Normal levels - Blue with normal bar
                        backgroundColors.push('rgba(54, 162, 235, 0.5)');
                        borderColors.push('rgba(54, 162, 235, 0.8)');
                        barThickness.push(3);
                    }
                });

                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: priceLabels,
                        datasets: [{
                            label: 'Volume',
                            data: volumes,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: barThickness,
                            barThickness: 'flex',
                            maxBarThickness: 15,
                            minBarLength: 2
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal bars
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { 
                                    color: 'rgba(255,255,255,0.1)',
                                    lineWidth: 1
                                },
                                ticks: { 
                                    color: '#ffffff',
                                    font: { size: 11 },
                                    callback: function(value) {
                                        return value >= 1000000 ? (value/1000000).toFixed(1) + 'M' : 
                                               value >= 1000 ? (value/1000).toFixed(1) + 'K' : value;
                                    }
                                }
                            },
                            y: {
                                reverse: false, // Ensure lowest price at bottom, highest at top
                                grid: { 
                                    color: 'rgba(255,255,255,0.1)',
                                    lineWidth: 1
                                },
                                ticks: { 
                                    color: '#ffffff',
                                    font: { size: 10 }
                                }
                            }
                        },
                        plugins: {
                            legend: { 
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#ffffff',
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: { size: 11 }
                                },
                                onClick: function(e, legendItem, legend) {
                                    const index = legendItem.datasetIndex;
                                    const chart = legend.chart;
                                    const meta = chart.getDatasetMeta(index);
                                    meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                                    chart.update();
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255,255,255,0.3)',
                                borderWidth: 1,
                                callbacks: {
                                    label: function(context) {
                                        const volume = context.parsed.x;
                                        const percent = ((volume / data.total_volume) * 100).toFixed(2);
                                        const price = context.label;

                                        let levelType = 'Normal';
                                        if (Math.abs(parseFloat(price.replace('', '')) - vpocPrice) < 0.01) {
                                            levelType = 'VPOC (Volume Point of Control)';
                                        } else if (parseFloat(price.replace('', '')) >= valueAreaLow && parseFloat(price.replace('', '')) <= valueAreaHigh) {
                                            levelType = 'Value Area';
                                        }

                                        return [
                                            `${levelType}`,
                                            `Volume: ${volume.toLocaleString()} (${percent}%)`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });

                // Add LTP and volume profile level lines
                this.addLTPIndicator(chart, currentLTP, volumeProfile);
                this.addVolumeProfileLevels(chart, vpocPrice, valueAreaHigh, valueAreaLow, volumeProfile);

                return chart;
            }


            addLTPIndicator(chart, ltp, volumeProfile) {
                if (!ltp || ltp === 0) return;

                // Find closest price level to LTP
                let closestIndex = 0;
                let minDiff = Math.abs(volumeProfile[0].price - ltp);

                for (let i = 1; i < volumeProfile.length; i++) {
                    const diff = Math.abs(volumeProfile[i].price - ltp);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                }

                // Add LTP line annotation using Chart.js annotation plugin
                if (!chart.options.plugins.annotation) {
                    chart.options.plugins.annotation = { annotations: {} };
                }

                chart.options.plugins.annotation.annotations.ltpLine = {
                    type: 'line',
                    yMin: closestIndex,
                    yMax: closestIndex,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 4,
                    borderDash: [10, 5],
                    label: {
                        display: true,
                        content: `LTP: ${ltp.toFixed(2)}`,
                        position: 'end',
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        color: '#ffffff',
                        font: {
                            size: 11,
                            weight: 'bold'
                        },
                        padding: 4,
                        borderRadius: 4
                    }
                };

                // Also add a simple visual line overlay as backup
                this.drawLTPLine(chart, ltp, volumeProfile, closestIndex);
            }

            drawLTPLine(chart, ltp, volumeProfile, closestIndex) {
                // Calculate volume statistics
                const volumeStats = this.calculateVolumeStats(volumeProfile);

                // Add a custom draw function to draw all reference lines
                const originalDraw = chart.draw;
                chart.draw = function() {
                    originalDraw.apply(this, arguments);

                    const ctx = this.ctx;
                    const chartArea = this.chartArea;
                    const yScale = this.scales.y;

                    // Draw LTP line
                    const yPosLTP = yScale.getPixelForValue(closestIndex);
                    ctx.save();
                    ctx.strokeStyle = 'rgba(255, 99, 132, 0.9)';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([8, 4]);
                    ctx.beginPath();
                    ctx.moveTo(chartArea.left, yPosLTP);
                    ctx.lineTo(chartArea.right, yPosLTP);
                    ctx.stroke();

                    // Draw LTP label
                    ctx.fillStyle = 'rgba(255, 99, 132, 0.9)';
                    ctx.fillRect(chartArea.right - 80, yPosLTP - 10, 75, 20);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`LTP: ${ltp.toFixed(2)}`, chartArea.right - 42, yPosLTP + 3);

                    // Draw Highest Volume Price line (HVOL)
                    const yPosHVOL = yScale.getPixelForValue(volumeStats.highestVolumeIndex);
                    ctx.strokeStyle = 'rgba(255, 206, 84, 0.8)'; // Gold
                    ctx.lineWidth = 2;
                    ctx.setLineDash([4, 4]);
                    ctx.beginPath();
                    ctx.moveTo(chartArea.left, yPosHVOL);
                    ctx.lineTo(chartArea.right, yPosHVOL);
                    ctx.stroke();

                    // HVOL label
                    ctx.fillStyle = 'rgba(255, 206, 84, 0.8)';
                    ctx.fillRect(chartArea.left + 5, yPosHVOL - 10, 65, 20);
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 9px Arial';
                    ctx.fillText(`HVOL: ${volumeStats.highestVolumePrice.toFixed(2)}`, chartArea.left + 37, yPosHVOL + 3);

                    // Draw Average Volume Price line (AVOL)
                    const yPosAVOL = yScale.getPixelForValue(volumeStats.avgVolumeIndex);
                    ctx.strokeStyle = 'rgba(75, 192, 192, 0.8)'; // Teal
                    ctx.lineWidth = 2;
                    ctx.setLineDash([6, 3]);
                    ctx.beginPath();
                    ctx.moveTo(chartArea.left, yPosAVOL);
                    ctx.lineTo(chartArea.right, yPosAVOL);
                    ctx.stroke();

                    // AVOL label
                    ctx.fillStyle = 'rgba(75, 192, 192, 0.8)';
                    ctx.fillRect(chartArea.left + 5, yPosAVOL - 10, 65, 20);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 9px Arial';
                    ctx.fillText(`AVOL: ${volumeStats.avgVolumePrice.toFixed(2)}`, chartArea.left + 37, yPosAVOL + 3);

                    // Draw Lowest Volume Price line (LVOL)
                    const yPosLVOL = yScale.getPixelForValue(volumeStats.lowestVolumeIndex);
                    ctx.strokeStyle = 'rgba(128, 128, 128, 0.8)'; // Gray
                    ctx.lineWidth = 2;
                    ctx.setLineDash([2, 6]);
                    ctx.beginPath();
                    ctx.moveTo(chartArea.left, yPosLVOL);
                    ctx.lineTo(chartArea.right, yPosLVOL);
                    ctx.stroke();

                    // LVOL label
                    ctx.fillStyle = 'rgba(128, 128, 128, 0.8)';
                    ctx.fillRect(chartArea.left + 5, yPosLVOL - 10, 65, 20);
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 9px Arial';
                    ctx.fillText(`LVOL: ${volumeStats.lowestVolumePrice.toFixed(2)}`, chartArea.left + 37, yPosLVOL + 3);

                    ctx.restore();
                };
            }

            calculateVolumeStats(volumeProfile) {
                if (!volumeProfile || volumeProfile.length === 0) {
                    return {
                        highestVolumePrice: 0,
                        highestVolumeIndex: 0,
                        avgVolumePrice: 0,
                        avgVolumeIndex: 0,
                        lowestVolumePrice: 0,
                        lowestVolumeIndex: 0
                    };
                }

                // Find highest volume price (VPOC)
                let maxVolume = 0;
                let maxVolumeIndex = 0;
                let maxVolumePrice = 0;

                // Find lowest volume price
                let minVolume = Infinity;
                let minVolumeIndex = 0;
                let minVolumePrice = 0;

                // Calculate volume-weighted average price
                let totalVolumeWeightedPrice = 0;
                let totalVolume = 0;

                volumeProfile.forEach((item, index) => {
                    const volume = item.volume;
                    const price = item.price;

                    // Track highest volume
                    if (volume > maxVolume) {
                        maxVolume = volume;
                        maxVolumeIndex = index;
                        maxVolumePrice = price;
                    }

                    // Track lowest volume
                    if (volume < minVolume) {
                        minVolume = volume;
                        minVolumeIndex = index;
                        minVolumePrice = price;
                    }

                    // Add to volume-weighted calculation
                    totalVolumeWeightedPrice += (price * volume);
                    totalVolume += volume;
                });

                // Calculate volume-weighted average price
                const avgVolumePrice = totalVolume > 0 ? totalVolumeWeightedPrice / totalVolume : 0;

                // Find closest index to average volume price
                let avgVolumeIndex = 0;
                let minDiff = Math.abs(volumeProfile[0].price - avgVolumePrice);

                for (let i = 1; i < volumeProfile.length; i++) {
                    const diff = Math.abs(volumeProfile[i].price - avgVolumePrice);
                    if (diff < minDiff) {
                        minDiff = diff;
                        avgVolumeIndex = i;
                    }
                }

                return {
                    highestVolumePrice: maxVolumePrice,
                    highestVolumeIndex: maxVolumeIndex,
                    avgVolumePrice: avgVolumePrice,
                    avgVolumeIndex: avgVolumeIndex,
                    lowestVolumePrice: minVolumePrice,
                    lowestVolumeIndex: minVolumeIndex
                };
            }

            addVolumeProfileLevels(chart, vpocPrice, valueAreaHigh, valueAreaLow, volumeProfile) {
                if (!volumeProfile || volumeProfile.length === 0) return;

                // Find indices for VPOC, VAH, and VAL
                let vpocIndex = this.findPriceIndex(vpocPrice, volumeProfile);
                let vahIndex = this.findPriceIndex(valueAreaHigh, volumeProfile);
                let valIndex = this.findPriceIndex(valueAreaLow, volumeProfile);

                // Store level indices for custom drawing
                chart._volumeLevels = {
                    vpocIndex: vpocIndex,
                    vpocPrice: vpocPrice,
                    vahIndex: vahIndex,
                    vahPrice: valueAreaHigh,
                    valIndex: valIndex,
                    valPrice: valueAreaLow
                };

                // Add custom draw function for VPOC, VAH, VAL lines
                this.addVolumeProfileLinesDrawing(chart);
            }

            findPriceIndex(targetPrice, volumeProfile) {
                if (!volumeProfile || volumeProfile.length === 0) return 0;

                let closestIndex = 0;
                let minDiff = Math.abs(volumeProfile[0].price - targetPrice);

                for (let i = 1; i < volumeProfile.length; i++) {
                    const diff = Math.abs(volumeProfile[i].price - targetPrice);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                }

                return closestIndex;
            }

            addVolumeProfileLinesDrawing(chart) {
                // Extend the existing chart draw function to include VPOC, VAH, VAL lines
                const originalDraw = chart.draw;
                
                chart.draw = function() {
                    originalDraw.apply(this, arguments);

                    if (!this._volumeLevels) return;

                    const ctx = this.ctx;
                    const chartArea = this.chartArea;
                    const yScale = this.scales.y;
                    const levels = this._volumeLevels;

                    ctx.save();

                    // Draw VPOC line (Volume Point of Control) - Gold dotted
                    if (levels.vpocIndex !== undefined) {
                        const yPosVPOC = yScale.getPixelForValue(levels.vpocIndex);
                        ctx.strokeStyle = 'rgba(255, 206, 84, 1)'; // Gold
                        ctx.lineWidth = 6; // Much thicker line
                        ctx.setLineDash([12, 8]); // Larger dotted pattern
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, yPosVPOC);
                        ctx.lineTo(chartArea.right, yPosVPOC);
                        ctx.stroke();

                        // VPOC label
                        ctx.fillStyle = 'rgba(255, 206, 84, 0.9)';
                        ctx.fillRect(chartArea.right - 85, yPosVPOC - 12, 80, 24);
                        ctx.fillStyle = '#000000';
                        ctx.font = 'bold 10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`VPOC: ${levels.vpocPrice.toFixed(2)}`, chartArea.right - 45, yPosVPOC + 4);
                    }

                    // Draw VAH line (Value Area High) - Teal dotted
                    if (levels.vahIndex !== undefined) {
                        const yPosVAH = yScale.getPixelForValue(levels.vahIndex);
                        ctx.strokeStyle = 'rgba(75, 192, 192, 1)'; // Teal
                        ctx.lineWidth = 4; // Much thicker line
                        ctx.setLineDash([10, 6]); // Larger dotted pattern
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, yPosVAH);
                        ctx.lineTo(chartArea.right, yPosVAH);
                        ctx.stroke();

                        // VAH label
                        ctx.fillStyle = 'rgba(75, 192, 192, 0.9)';
                        ctx.fillRect(chartArea.left + 5, yPosVAH - 12, 80, 24);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 9px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`VAH: ${levels.vahPrice.toFixed(2)}`, chartArea.left + 45, yPosVAH + 4);
                    }

                    // Draw VAL line (Value Area Low) - Teal dotted
                    if (levels.valIndex !== undefined) {
                        const yPosVAL = yScale.getPixelForValue(levels.valIndex);
                        ctx.strokeStyle = 'rgba(75, 192, 192, 1)'; // Teal
                        ctx.lineWidth = 4; // Much thicker line
                        ctx.setLineDash([10, 6]); // Larger dotted pattern
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, yPosVAL);
                        ctx.lineTo(chartArea.right, yPosVAL);
                        ctx.stroke();

                        // VAL label
                        ctx.fillStyle = 'rgba(75, 192, 192, 0.9)';
                        ctx.fillRect(chartArea.left + 5, yPosVAL - 12, 80, 24);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 9px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`VAL: ${levels.valPrice.toFixed(2)}`, chartArea.left + 45, yPosVAL + 4);
                    }

                    ctx.restore();
                };
            }

            updateChartInfo(symbol, data) {
                const titleElement = document.getElementById('chartTitle');
                const infoElement = document.getElementById('chartInfo');
                const volumeElement = document.getElementById('chartVolume');

                if (titleElement) titleElement.textContent = `${symbol} - Volume Profile`;

                if (infoElement) {
                    const vpoc = data.important_levels?.vpoc || 0;
                    const vaHigh = data.important_levels?.value_area_high || 0;
                    const vaLow = data.important_levels?.value_area_low || 0;
                    const ltp = data.current_ltp || 0;

                    infoElement.innerHTML = `VPOC: ${vpoc.toFixed(2)} | Value Area: ${vaLow.toFixed(2)}-${vaHigh.toFixed(2)} | LTP: ${ltp.toFixed(2)}`;
                }

                if (volumeElement) {
                    const totalVol = data.total_volume || 0;
                    const volText = totalVol >= 1000000 ? `${(totalVol/1000000).toFixed(1)}M` : 
                                   totalVol >= 1000 ? `${(totalVol/1000).toFixed(1)}K` : totalVol;
                    volumeElement.textContent = `Total Volume: ${volText}`;
                }
            }

            async updateLiveLTP() {
                // Update LTP for current active chart
                if (!this.currentSymbol) return;

                try {
                    const response = await fetch(`/api/volume-profile/${this.currentSymbol}`);
                    const result = await response.json();

                    if (result.status === 'success' && result.current_ltp) {
                        // Update LTP display
                        const infoElement = document.getElementById('chartInfo');
                        if (infoElement) {
                            const vpoc = result.important_levels?.vpoc || 0;
                            const vaHigh = result.important_levels?.value_area_high || 0;
                            const vaLow = result.important_levels?.value_area_low || 0;
                            const ltp = result.current_ltp || 0;

                            infoElement.innerHTML = `VPOC: ${vpoc.toFixed(2)} | Value Area: ${vaLow.toFixed(2)}-${vaHigh.toFixed(2)} | LTP: ${ltp.toFixed(2)}`;
                        }
                    }
                } catch (error) {
                    console.error(` Volume Profile: Error updating LTP for ${this.currentSymbol}:`, error);
                }
            }

            showChart() {
                const message = document.getElementById('volumeProfileMessage');
                const chart = document.getElementById('volumeProfileChart');

                if (message) message.style.display = 'none';
                if (chart) chart.style.display = 'block';
            }

            hideChart() {
                const message = document.getElementById('volumeProfileMessage');
                const chart = document.getElementById('volumeProfileChart');

                if (message) message.style.display = 'block';
                if (chart) chart.style.display = 'none';
            }

            clearChart() {
                // Destroy Chart.js instance
                if (this.activeChart) {
                    this.activeChart.destroy();
                    this.activeChart = null;
                }

                // Reset current symbol
                this.currentSymbol = null;

                // Reset chart info
                const titleElement = document.getElementById('chartTitle');
                const infoElement = document.getElementById('chartInfo');
                const volumeElement = document.getElementById('chartVolume');

                if (titleElement) titleElement.textContent = 'Volume Profile';
                if (infoElement) infoElement.textContent = 'VPOC: - | Value Area: - | LTP: -';
                if (volumeElement) volumeElement.textContent = 'Total Volume: -';

                // Hide chart and show message
                this.hideChart();

                // Reset stock selector
                const selector = document.getElementById('volumeProfileStockSelector');
                if (selector) selector.value = '';

                console.log(' Volume Profile: Chart cleared');
            }
        }

        // Initialize Volume Profile Manager (Multi-Chart) when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            window.volumeProfileManager = new VolumeProfileMultiChartManager();
        });

        // Volume Profile Manager - Multi-Chart Paginated 5-Day Volume Analysis
        class VolumeProfileMultiChartManager {
            constructor() {
                this.activeCharts = new Map(); // Multiple chart instances
                this.availableStocks = [];
                this.filteredStocks = []; // For search functionality
                this.volumeProfileVisible = true;
                this.loadingCount = 0;
                this.chartsPerPage = this.getChartsPerPage(); // Responsive charts per page
                this.currentPage = 0;
                this.totalPages = 0;
                this.init();
                
                // Handle window resize for responsive pagination
                window.addEventListener('resize', () => {
                    const newChartsPerPage = this.getChartsPerPage();
                    if (newChartsPerPage !== this.chartsPerPage) {
                        this.chartsPerPage = newChartsPerPage;
                        this.updatePagination();
                    }
                });
            }

            getChartsPerPage() {
                // Mobile: 1 chart per page, Desktop: 6 charts per page (3x2 grid)
                return window.innerWidth <= 768 ? 1 : 6;
            }

            init() {
                console.log(' Volume Profile: Initializing multi-chart paginated manager...');
                this.setupToggleVisibility();
                this.setupSearch();
                this.loadAllVolumeProfiles();

                // Start live LTP updates every 60 seconds (optimized)
                setInterval(() => this.updateAllLiveLTP(), 60000); // Optimized global LTP updates
            }

            setupSearch() {
                const searchInput = document.getElementById('volumeProfileSearch');
                if (!searchInput) return;

                // Add search functionality
                searchInput.addEventListener('input', (e) => {
                    this.handleSearch(e.target.value);
                });

                // Handle Enter key to jump to stock
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.jumpToStock(e.target.value);
                    }
                });
            }

            handleSearch(query) {
                if (!query || query.length < 1) {
                    // Reset to show all stocks if search is cleared
                    this.filteredStocks = [...this.availableStocks];
                } else {
                    // Filter stocks based on search query
                    const searchTerm = query.toUpperCase();
                    this.filteredStocks = this.availableStocks.filter(stock => 
                        stock.symbol.includes(searchTerm)
                    );
                }

                // Update pagination for filtered results
                this.updatePaginationForSearch();
            }

            jumpToStock(query) {
                if (!query) return;

                const searchTerm = query.toUpperCase();
                const stockIndex = this.availableStocks.findIndex(stock => 
                    stock.symbol === searchTerm
                );

                if (stockIndex !== -1) {
                    // Calculate which page this stock is on
                    const targetPage = Math.floor(stockIndex / this.chartsPerPage);
                    this.goToPage(targetPage);
                    
                    // Clear search and show success
                    const searchInput = document.getElementById('volumeProfileSearch');
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.style.borderColor = '#28a745';
                        setTimeout(() => {
                            searchInput.style.borderColor = '';
                        }, 1500);
                    }
                } else {
                    // Show not found
                    const searchInput = document.getElementById('volumeProfileSearch');
                    if (searchInput) {
                        searchInput.style.borderColor = '#dc3545';
                        setTimeout(() => {
                            searchInput.style.borderColor = '';
                        }, 1500);
                    }
                }
            }

            updatePaginationForSearch() {
                // Update total pages based on filtered results
                const stocksToShow = this.filteredStocks || this.availableStocks;
                this.totalPages = Math.ceil(stocksToShow.length / this.chartsPerPage);
                
                // Reset to first page
                this.currentPage = 0;
                
                // Refresh pagination and display
                this.setupPagination();
                this.showCurrentPage();
            }

            async loadAllVolumeProfiles() {
                try {
                    this.showLoadingMessage();
                    
                    // Load available stocks
                    const response = await fetch('/api/volume-profile/stocks');
                    const result = await response.json();

                    if (result.status === 'success') {
                        this.availableStocks = result.stocks;
                        this.filteredStocks = [...result.stocks]; // Initialize filtered stocks
                        this.updateStockCount(result.count);
                        console.log(` Volume Profile: Loaded ${result.count} available stocks`);
                        
                        // Create chart containers for all stocks
                        this.createAllChartContainers();
                        
                        // Load volume profile data for all stocks
                        await this.loadAllStockData();
                        
                    } else {
                        console.error(' Volume Profile: Failed to load stocks:', result.message);
                        this.showErrorMessage('Failed to load stock data');
                    }
                } catch (error) {
                    console.error(' Volume Profile: Error loading stocks:', error);
                    this.showErrorMessage('Network error loading stock data');
                }
            }

            createAllChartContainers() {
                const chartsGrid = document.getElementById('volumeProfileChartsGrid');
                if (!chartsGrid) return;

                // Clear existing content
                chartsGrid.innerHTML = '';

                // Calculate pagination
                this.totalPages = Math.ceil(this.availableStocks.length / this.chartsPerPage);
                
                // Create chart container for each stock
                this.availableStocks.forEach(stock => {
                    const chartCard = this.createChartCard(stock.symbol);
                    chartsGrid.appendChild(chartCard);
                });

                // Initialize pagination
                this.setupPagination();
                this.showCurrentPage();
                
                // Show the paginated container
                this.showChartsContainer();
            }

            createChartCard(symbol) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card glow-card volume-profile-chart-card';
                cardDiv.id = `volumeChart_${symbol}`;

                cardDiv.innerHTML = `
                    <div class="card-header bg-transparent border-0 py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 text-warning" style="font-size: 0.85rem;">${symbol}</h6>
                            <span class="text-muted" style="font-size: 0.65rem;" id="chartStatus_${symbol}">Loading...</span>
                        </div>
                        <div class="mt-2">
                            <div class="text-muted" style="font-size: 0.65rem;" id="chartInfo_${symbol}">VPOC: - | Value Area: - | LTP: -</div>
                            <div class="text-info" style="font-size: 0.65rem;" id="chartVolume_${symbol}">Total Volume: -</div>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="volumeCanvas_${symbol}" style="width: 100%; height: 100%;"></canvas>
                        
                        <!-- Highlighted Levels Sidebar -->
                        <div class="volume-chart-levels" id="chartLevels_${symbol}" style="display: none;">
                            <div class="level-item vpoc-level" id="vpocLevel_${symbol}">VPOC<br>-</div>
                            <div class="level-item vah-level" id="vahLevel_${symbol}">VAH<br>-</div>
                            <div class="level-item val-level" id="valLevel_${symbol}">VAL<br>-</div>
                        </div>
                    </div>
                `;

                return cardDiv;
            }

            updatePagination() {
                // Recalculate pagination with new charts per page
                this.totalPages = Math.ceil(this.availableStocks.length / this.chartsPerPage);
                
                // Adjust current page if needed
                if (this.currentPage >= this.totalPages) {
                    this.currentPage = Math.max(0, this.totalPages - 1);
                }
                
                // Refresh pagination UI
                this.setupPagination();
                this.showCurrentPage();
            }

            setupPagination() {
                const prevBtn = document.getElementById('volumeProfilePrevBtn');
                const nextBtn = document.getElementById('volumeProfileNextBtn');
                
                if (!prevBtn || !nextBtn) return;

                // Remove existing event listeners to prevent duplicates
                prevBtn.onclick = null;
                nextBtn.onclick = null;

                // Add event listeners for arrow navigation
                prevBtn.onclick = () => this.goToPreviousPage();
                nextBtn.onclick = () => this.goToNextPage();

                // Update button states and page info
                this.updatePaginationState();
            }

            goToPreviousPage() {
                if (this.currentPage > 0) {
                    this.goToPage(this.currentPage - 1);
                }
            }

            goToNextPage() {
                if (this.currentPage < this.totalPages - 1) {
                    this.goToPage(this.currentPage + 1);
                }
            }

            updatePaginationState() {
                const prevBtn = document.getElementById('volumeProfilePrevBtn');
                const nextBtn = document.getElementById('volumeProfileNextBtn');
                
                if (prevBtn && nextBtn) {
                    // Enable/disable buttons based on current page
                    prevBtn.disabled = (this.currentPage === 0);
                    nextBtn.disabled = (this.currentPage === this.totalPages - 1);
                    
                    // Update button styles
                    prevBtn.className = `btn btn-sm ${this.currentPage === 0 ? 'btn-secondary' : 'btn-outline-primary'} me-3`;
                    nextBtn.className = `btn btn-sm ${this.currentPage === this.totalPages - 1 ? 'btn-secondary' : 'btn-outline-primary'} ms-3`;
                }

                // Update pagination info
                this.updatePaginationInfo();
            }

            showCurrentPage() {
                const chartsGrid = document.getElementById('volumeProfileChartsGrid');
                if (!chartsGrid) return;

                // Use filtered stocks or all stocks if no search
                const stocksToShow = this.filteredStocks.length > 0 ? this.filteredStocks : this.availableStocks;
                const startIndex = this.currentPage * this.chartsPerPage;
                const endIndex = Math.min(startIndex + this.chartsPerPage, stocksToShow.length);

                // Hide all charts first
                const allCharts = Array.from(chartsGrid.children);
                allCharts.forEach(chart => {
                    chart.style.display = 'none';
                });

                // Show charts for current page based on filtered stocks
                for (let i = startIndex; i < endIndex; i++) {
                    const stock = stocksToShow[i];
                    if (stock) {
                        const chartElement = document.getElementById(`volumeChart_${stock.symbol}`);
                        if (chartElement) {
                            chartElement.style.display = 'block';
                        }
                    }
                }
            }

            goToPage(pageIndex) {
                if (pageIndex >= 0 && pageIndex < this.totalPages) {
                    this.currentPage = pageIndex;
                    this.showCurrentPage();
                    this.updatePaginationDots();
                    this.updatePaginationInfo();
                }
            }

            updatePaginationDots() {
                const dots = document.querySelectorAll('.pagination-dot');
                dots.forEach((dot, index) => {
                    dot.classList.toggle('active', index === this.currentPage);
                });
            }

            updatePaginationInfo() {
                const currentPageSpan = document.getElementById('currentPageNum');
                const totalPagesSpan = document.getElementById('totalPagesNum');
                const chartsPerPageSpan = document.getElementById('chartsPerPageInfo');

                if (currentPageSpan) currentPageSpan.textContent = this.currentPage + 1;
                if (totalPagesSpan) totalPagesSpan.textContent = this.totalPages;
                if (chartsPerPageSpan) chartsPerPageSpan.textContent = `${this.chartsPerPage} charts per page`;
            }

            async loadAllStockData() {
                const maxConcurrent = 5; // Limit concurrent requests
                const stocks = [...this.availableStocks];
                
                for (let i = 0; i < stocks.length; i += maxConcurrent) {
                    const batch = stocks.slice(i, i + maxConcurrent);
                    const promises = batch.map(stock => this.loadSingleVolumeProfile(stock.symbol));
                    
                    await Promise.allSettled(promises);
                    
                    // Small delay between batches to prevent overwhelming the server
                    if (i + maxConcurrent < stocks.length) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
                
                console.log(' Volume Profile: All stock data loading completed');
            }

            async loadSingleVolumeProfile(symbol) {
                try {
                    this.updateChartStatus(symbol, 'Loading...');
                    
                    const response = await fetch(`/api/volume-profile/${symbol}`);
                    const result = await response.json();

                    if (result.status === 'success') {
                        this.createVolumeChart(symbol, result);
                        this.updateChartStatus(symbol, 'Ready');
                        console.log(` Volume Profile: Created chart for ${symbol}`);
                    } else {
                        console.error(` Volume Profile: Error loading ${symbol}:`, result.message);
                        this.updateChartStatus(symbol, 'Error');
                    }
                } catch (error) {
                    console.error(` Volume Profile: Network error for ${symbol}:`, error);
                    this.updateChartStatus(symbol, 'Failed');
                }
            }

            createVolumeChart(symbol, data) {
                const canvas = document.getElementById(`volumeCanvas_${symbol}`);
                if (!canvas) {
                    console.error(` Volume Profile: Chart canvas not found for ${symbol}`);
                    return;
                }

                // Clear existing chart if any
                if (this.activeCharts.has(symbol)) {
                    this.activeCharts.get(symbol).destroy();
                }

                // Update chart info
                this.updateChartInfo(symbol, data);

                // Create Chart.js horizontal bar chart
                const chart = this.createChartJS(canvas, symbol, data);
                this.activeCharts.set(symbol, chart);
            }

            createChartJS(canvas, symbol, data) {
                const ctx = canvas.getContext('2d');

                // Prepare data for volume profile (horizontal bars only)
                const volumeProfile = data.volume_profile || [];
                const priceLabels = volumeProfile.map(item => `${item.price}`);
                const volumes = volumeProfile.map(item => item.volume);
                const vpocPrice = data.important_levels?.vpoc || 0;
                const valueAreaHigh = data.important_levels?.value_area_high || 0;
                const valueAreaLow = data.important_levels?.value_area_low || 0;

                // Enhanced color styling for volume levels
                const backgroundColors = [];
                const borderColors = [];

                volumeProfile.forEach(item => {
                    const price = item.price;
                    if (Math.abs(price - vpocPrice) < 0.01) {
                        // VPOC - Gold
                        backgroundColors.push('rgba(255, 206, 84, 0.9)');
                        borderColors.push('rgba(255, 206, 84, 1)');
                    } else if (price >= valueAreaLow && price <= valueAreaHigh) {
                        // Value Area - Teal
                        backgroundColors.push('rgba(75, 192, 192, 0.8)');
                        borderColors.push('rgba(75, 192, 192, 1)');
                    } else {
                        // Normal levels - Blue
                        backgroundColors.push('rgba(54, 162, 235, 0.5)');
                        borderColors.push('rgba(54, 162, 235, 0.8)');
                    }
                });

                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: priceLabels,
                        datasets: [{
                            label: 'Volume',
                            data: volumes,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1,
                            barThickness: 'flex',
                            maxBarThickness: 12,
                            minBarLength: 2
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal bars
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { 
                                    color: 'rgba(255,255,255,0.1)',
                                    lineWidth: 1
                                },
                                ticks: { 
                                    color: '#ffffff',
                                    font: { size: 9 },
                                    callback: function(value) {
                                        return value >= 1000000 ? (value/1000000).toFixed(1) + 'M' : 
                                               value >= 1000 ? (value/1000).toFixed(1) + 'K' : value;
                                    }
                                }
                            },
                            y: {
                                reverse: false, // Ensure lowest price at bottom, highest at top
                                grid: { 
                                    color: 'rgba(255,255,255,0.1)',
                                    lineWidth: 1
                                },
                                ticks: { 
                                    color: '#ffffff',
                                    font: { size: 8 }
                                }
                            }
                        },
                        plugins: {
                            legend: { 
                                display: false // Hide legend for compact view
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(255,255,255,0.3)',
                                borderWidth: 1,
                                titleFont: { size: 11 },
                                bodyFont: { size: 10 },
                                callbacks: {
                                    title: function(context) {
                                        return `${symbol} - ${context[0].label}`;
                                    },
                                    label: function(context) {
                                        const volume = context.parsed.x;
                                        const percent = ((volume / data.total_volume) * 100).toFixed(2);
                                        const price = context.label;

                                        let levelType = 'Normal';
                                        if (Math.abs(parseFloat(price.replace('', '')) - vpocPrice) < 0.01) {
                                            levelType = 'VPOC';
                                        } else if (parseFloat(price.replace('', '')) >= valueAreaLow && parseFloat(price.replace('', '')) <= valueAreaHigh) {
                                            levelType = 'Value Area';
                                        }

                                        return [
                                            `${levelType}`,
                                            `Volume: ${volume.toLocaleString()} (${percent}%)`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });

                // Add VPOC, VAH, and VAL dotted lines to paginated charts
                this.addVolumeProfileLevels(chart, vpocPrice, valueAreaHigh, valueAreaLow, volumeProfile);

                return chart;
            }

            updateChartInfo(symbol, data) {
                const infoElement = document.getElementById(`chartInfo_${symbol}`);
                const volumeElement = document.getElementById(`chartVolume_${symbol}`);

                if (infoElement && data.important_levels) {
                    const vpoc = data.important_levels.vpoc || 0;
                    const vaHigh = data.important_levels.value_area_high || 0;
                    const vaLow = data.important_levels.value_area_low || 0;
                    const ltp = data.current_ltp || 0;

                    infoElement.textContent = `VPOC: ${vpoc.toFixed(2)} | VA: ${vaLow.toFixed(2)}-${vaHigh.toFixed(2)} | LTP: ${ltp.toFixed(2)}`;
                    
                    // Update highlighted levels sidebar
                    this.updateChartLevels(symbol, data.important_levels);
                }

                if (volumeElement) {
                    const totalVolume = data.total_volume || 0;
                    const formattedVolume = totalVolume >= 1000000 ? 
                        (totalVolume / 1000000).toFixed(2) + 'M' : 
                        totalVolume >= 1000 ? (totalVolume / 1000).toFixed(0) + 'K' : totalVolume.toLocaleString();
                    volumeElement.textContent = `Total Volume: ${formattedVolume}`;
                }
            }

            updateChartLevels(symbol, levels) {
                const levelsContainer = document.getElementById(`chartLevels_${symbol}`);
                const vpocElement = document.getElementById(`vpocLevel_${symbol}`);
                const vahElement = document.getElementById(`vahLevel_${symbol}`);
                const valElement = document.getElementById(`valLevel_${symbol}`);

                if (levels && vpocElement && vahElement && valElement) {
                    vpocElement.innerHTML = `VPOC<br>${levels.vpoc?.toFixed(1) || '-'}`;
                    vahElement.innerHTML = `VAH<br>${levels.value_area_high?.toFixed(1) || '-'}`;
                    valElement.innerHTML = `VAL<br>${levels.value_area_low?.toFixed(1) || '-'}`;
                    
                    // Show the levels container
                    if (levelsContainer) {
                        levelsContainer.style.display = 'block';
                    }
                }
            }

            updateChartStatus(symbol, status) {
                // Status display disabled - no more "Failed" text shown to user
                return;
            }

            updateStockCount(count) {
                const countElement = document.getElementById('volumeProfileCount');
                if (countElement) {
                    countElement.textContent = `${count} stocks loaded`;
                }
            }

            async updateAllLiveLTP() {
                console.log(' Volume Profile: Updating LTP for all charts...');
                let updateCount = 0;
                
                for (const stock of this.availableStocks) {
                    try {
                        const response = await fetch(`/api/volume-profile/${stock.symbol}`);
                        const result = await response.json();

                        if (result.status === 'success' && result.current_ltp) {
                            const infoElement = document.getElementById(`chartInfo_${stock.symbol}`);
                            if (infoElement) {
                                const vpoc = result.important_levels?.vpoc || 0;
                                const vaHigh = result.important_levels?.value_area_high || 0;
                                const vaLow = result.important_levels?.value_area_low || 0;
                                const ltp = result.current_ltp || 0;

                                infoElement.textContent = `VPOC: ${vpoc.toFixed(2)} | VA: ${vaLow.toFixed(2)}-${vaHigh.toFixed(2)} | LTP: ${ltp.toFixed(2)}`;
                                updateCount++;
                            }
                        }
                    } catch (error) {
                        // Silently continue for failed updates
                    }
                }
                
                console.log(` Volume Profile: Updated LTP for ${updateCount} charts`);
            }

            setupToggleVisibility() {
                const toggleBtn = document.getElementById('toggleVolumeProfile');
                const container = document.getElementById('volumeProfileContainer');
                const icon = document.getElementById('volumeProfileToggleIcon');

                if (toggleBtn && container && icon) {
                    toggleBtn.addEventListener('click', () => {
                        if (this.volumeProfileVisible) {
                            container.style.display = 'none';
                            icon.className = 'fas fa-eye-slash';
                            this.volumeProfileVisible = false;
                        } else {
                            container.style.display = 'block';
                            icon.className = 'fas fa-eye';
                            this.volumeProfileVisible = true;
                        }
                    });
                }
            }

            showLoadingMessage() {
                const message = document.getElementById('volumeProfileMessage');
                const scrollContainer = document.getElementById('volumeProfileScrollContainer');
                
                if (message) message.style.display = 'block';
                if (scrollContainer) scrollContainer.style.display = 'none';
            }

            showChartsContainer() {
                const message = document.getElementById('volumeProfileMessage');
                const paginatedContainer = document.getElementById('volumeProfilePaginatedContainer');
                
                if (message) message.style.display = 'none';
                if (paginatedContainer) paginatedContainer.style.display = 'block';
            }

            showErrorMessage(errorText) {
                const message = document.getElementById('volumeProfileMessage');
                if (message) {
                    message.innerHTML = `
                        <i class="fas fa-exclamation-triangle fa-2x mb-2 text-danger"></i>
                        <div>${errorText}</div>
                        <small class="text-muted">Please try refreshing the page</small>
                    `;
                    message.style.display = 'block';
                }
            }

            addVolumeProfileLevels(chart, vpocPrice, valueAreaHigh, valueAreaLow, volumeProfile) {
                if (!volumeProfile || volumeProfile.length === 0) return;

                // Find indices for VPOC, VAH, and VAL
                let vpocIndex = this.findPriceIndex(vpocPrice, volumeProfile);
                let vahIndex = this.findPriceIndex(valueAreaHigh, volumeProfile);
                let valIndex = this.findPriceIndex(valueAreaLow, volumeProfile);

                // Store level indices for custom drawing
                chart._volumeLevels = {
                    vpocIndex: vpocIndex,
                    vpocPrice: vpocPrice,
                    vahIndex: vahIndex,
                    vahPrice: valueAreaHigh,
                    valIndex: valIndex,
                    valPrice: valueAreaLow
                };

                // Add custom draw function for VPOC, VAH, VAL lines
                this.addVolumeProfileLinesDrawing(chart);
            }

            findPriceIndex(targetPrice, volumeProfile) {
                if (!volumeProfile || volumeProfile.length === 0) return 0;

                let closestIndex = 0;
                let minDiff = Math.abs(volumeProfile[0].price - targetPrice);

                for (let i = 1; i < volumeProfile.length; i++) {
                    const diff = Math.abs(volumeProfile[i].price - targetPrice);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                }

                return closestIndex;
            }

            addVolumeProfileLinesDrawing(chart) {
                // Extend the existing chart draw function to include VPOC, VAH, VAL lines
                const originalDraw = chart.draw;
                
                chart.draw = function() {
                    originalDraw.apply(this, arguments);

                    if (!this._volumeLevels) return;

                    const ctx = this.ctx;
                    const chartArea = this.chartArea;
                    const yScale = this.scales.y;
                    const levels = this._volumeLevels;

                    ctx.save();

                    // Draw VPOC line (Volume Point of Control) - Gold dotted
                    if (levels.vpocIndex !== undefined) {
                        const yPosVPOC = yScale.getPixelForValue(levels.vpocIndex);
                        ctx.strokeStyle = 'rgba(255, 206, 84, 1)'; // Gold
                        ctx.lineWidth = 6; // Much thicker line
                        ctx.setLineDash([12, 8]); // Larger dotted pattern
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, yPosVPOC);
                        ctx.lineTo(chartArea.right, yPosVPOC);
                        ctx.stroke();

                        // VPOC label
                        ctx.fillStyle = 'rgba(255, 206, 84, 0.9)';
                        ctx.fillRect(chartArea.right - 85, yPosVPOC - 12, 80, 24);
                        ctx.fillStyle = '#000000';
                        ctx.font = 'bold 10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`VPOC: ${levels.vpocPrice.toFixed(2)}`, chartArea.right - 45, yPosVPOC + 4);
                    }

                    // Draw VAH line (Value Area High) - Green dotted
                    if (levels.vahIndex !== undefined) {
                        const yPosVAH = yScale.getPixelForValue(levels.vahIndex);
                        ctx.strokeStyle = 'rgba(76, 175, 80, 1)'; // Green
                        ctx.lineWidth = 4; // Thicker line
                        ctx.setLineDash([10, 6]); // Dotted pattern
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, yPosVAH);
                        ctx.lineTo(chartArea.right, yPosVAH);
                        ctx.stroke();

                        // VAH label
                        ctx.fillStyle = 'rgba(76, 175, 80, 0.9)';
                        ctx.fillRect(chartArea.left + 5, yPosVAH - 12, 80, 24);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 9px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`VAH: ${levels.vahPrice.toFixed(2)}`, chartArea.left + 45, yPosVAH + 4);
                    }

                    // Draw VAL line (Value Area Low) - Red dotted
                    if (levels.valIndex !== undefined) {
                        const yPosVAL = yScale.getPixelForValue(levels.valIndex);
                        ctx.strokeStyle = 'rgba(244, 67, 54, 1)'; // Red
                        ctx.lineWidth = 4; // Thicker line
                        ctx.setLineDash([10, 6]); // Dotted pattern
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, yPosVAL);
                        ctx.lineTo(chartArea.right, yPosVAL);
                        ctx.stroke();

                        // VAL label
                        ctx.fillStyle = 'rgba(244, 67, 54, 0.9)';
                        ctx.fillRect(chartArea.left + 5, yPosVAL - 12, 80, 24);
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 9px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`VAL: ${levels.valPrice.toFixed(2)}`, chartArea.left + 45, yPosVAL + 4);
                    }

                    ctx.restore();
                };
            }
        }

        // Mobile Menu Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');

            if (mobileMenuToggle && mobileMenuDropdown) {
                mobileMenuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    mobileMenuDropdown.classList.toggle('show');
                });

                // Close menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (!mobileMenuToggle.contains(e.target) && !mobileMenuDropdown.contains(e.target)) {
                        mobileMenuDropdown.classList.remove('show');
                    }
                });
            }
        });

        // Function to scroll to sections
        function scrollToSection(event, sectionId) {
            // Prevent default link behavior
            if (event) {
                event.preventDefault();
            }

            const section = document.getElementById(sectionId);
            const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');

            if (section) {
                // Close mobile menu
                if (mobileMenuDropdown) {
                    mobileMenuDropdown.classList.remove('show');
                }

                // Scroll to section with offset for navbar
                const navbarHeight = 60;
                const elementPosition = section.offsetTop;
                const offsetPosition = elementPosition - navbarHeight;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
            }

            return false; // Prevent default behavior
        }


    </script>

    <!-- User Guide Modal -->
    <div class="modal fade" id="userGuideModal" tabindex="-1" aria-labelledby="userGuideModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content" style="background: linear-gradient(135deg, #1a1f2e 0%, #2a2d3e 100%); color: #ffffff; border: 1px solid rgba(77, 166, 255, 0.3);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(77, 166, 255, 0.3);">
                    <h5 class="modal-title" id="userGuideModalLabel"><i class="fas fa-book-open me-2 text-info"></i>Dashboard User Guide</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 class="text-info"><i class="fas fa-info-circle me-2"></i>Overview</h6>
                    <p>The MG Dashboard provides real-time F&O stock analysis with technical indicators, live price updates, and comprehensive market analytics.</p>
                    
                    <h6 class="text-info mt-3"><i class="fas fa-star me-2"></i>Key Features</h6>
                    <ul>
                        <li><strong>Live Market Data:</strong> Real-time price updates via WebSocket (signal indicator top-left)</li>
                        <li><strong>Technical Analysis:</strong> Camarilla, CPR, and Fibonacci levels with live breaking alerts</li>
                        <li><strong>Price Action Cards:</strong> 10 cards showing top gainers, losers, gap ups/downs, and volatility</li>
                        <li><strong>Volume Analysis:</strong> RVOL-based volume distribution (Above 2X, 2x-1x, Below 1X)</li>
                        <li><strong>Levels Scan:</strong> Real-time stock scanning for level breakouts</li>
                        <li><strong>5-Day Volume Profile:</strong> Intraday volume distribution with VPOC, VAH, VAL</li>
                    </ul>
                    
                    <h6 class="text-info mt-3"><i class="fas fa-mouse-pointer me-2"></i>How to Interact</h6>
                    <ul>
                        <li><strong>Click Stock Symbols:</strong> Opens TradingView chart in new tab</li>
                        <li><strong>Tables & Cards:</strong> Click toggle eye icons to show/hide sections</li>
                        <li><strong>Alerts:</strong> Click bell icon to enable/disable price alerts</li>
                        <li><strong>Watchlist:</strong> Add stocks to watchlist for quick monitoring</li>
                        <li><strong>Scroll:</strong> Horizontal scroll for RVOL cards and levels scan</li>
                    </ul>
                    
                    <h6 class="text-info mt-3"><i class="fas fa-lightbulb me-2"></i>Tips & Shortcuts</h6>
                    <ul>
                        <li>Monitor WebSocket status (top-left signal) - Green = Connected, Red = Disconnected</li>
                        <li>Use hamburger menu (top-right) to jump to specific sections</li>
                        <li>Gap Down percentages show recovery from opening price to current LTP</li>
                        <li>RVOL Above 2X indicates strong volume activity - potential breakouts</li>
                        <li>Pattern badges (G, G, R, F) show Gap Up, Gap Down, Recovery, Fall patterns</li>
                    </ul>
                    
                    <h6 class="text-info mt-3"><i class="fas fa-link me-2"></i>Quick Navigation</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('all_charts') }}" class="btn btn-sm btn-outline-info"><i class="fas fa-chart-area me-1"></i>100D Levels</a>
                        <a href="{{ url_for('mgheatmap') }}" class="btn btn-sm btn-outline-info"><i class="fas fa-th me-1"></i>MG Heatmap</a>
                        <a href="{{ url_for('mg_linecharts') }}" class="btn btn-sm btn-outline-info"><i class="fas fa-chart-line me-1"></i>5D Line Charts</a>
                        <a href="{{ url_for('volume_profile') }}" class="btn btn-sm btn-outline-info"><i class="fas fa-chart-area me-1"></i>Volume Profile</a>
                        <a href="{{ url_for('weekly_dashboard') }}" class="btn btn-sm btn-outline-info"><i class="fas fa-calendar-week me-1"></i>Weekly Dashboard</a>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(77, 166, 255, 0.3);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
