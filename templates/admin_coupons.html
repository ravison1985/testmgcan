<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupon Codes Management - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('admin_panel') }}">
                <i class="fas fa-arrow-left me-2"></i>Back to Admin Panel
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    Welcome, {{ current_user.username }}
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0"><i class="fas fa-ticket-alt me-2"></i>Coupon Codes</h3>
                            <p class="text-muted mb-0">Manage discount coupons</p>
                        </div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCouponModal">
                            <i class="fas fa-plus me-2"></i>Add New Coupon
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coupons Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        {% if coupons %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Discount</th>
                                        <th>Type</th>
                                        <th>Usage</th>
                                        <th>Expiry</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for coupon in coupons %}
                                    <tr>
                                        <td><strong class="text-primary">{{ coupon.code }}</strong></td>
                                        <td>
                                            {% if coupon.discount_type == 'percentage' %}
                                                {{ coupon.discount_percent }}%
                                            {% else %}
                                                ₹{{ coupon.discount_amount }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'info' if coupon.discount_type == 'percentage' else 'success' }}">
                                                {{ coupon.discount_type.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            {{ coupon.uses_count }} / {{ coupon.max_uses if coupon.max_uses else '∞' }}
                                        </td>
                                        <td>
                                            {% if coupon.valid_until %}
                                                {{ coupon.valid_until.strftime('%Y-%m-%d') }}
                                            {% else %}
                                                No expiry
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if coupon.is_active else 'secondary' }}">
                                                {{ 'Active' if coupon.is_active else 'Inactive' }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary btn-edit-coupon" 
                                                    data-id="{{ coupon.id }}"
                                                    data-code="{{ coupon.code }}"
                                                    data-type="{{ coupon.discount_type }}"
                                                    data-value="{{ coupon.discount_percent if coupon.discount_type == 'percentage' else coupon.discount_amount }}"
                                                    data-max-usage="{{ coupon.max_uses or '' }}"
                                                    data-expiry="{{ coupon.valid_until.strftime('%Y-%m-%d') if coupon.valid_until else '' }}"
                                                    data-active="{{ 'true' if coupon.is_active else 'false' }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger btn-delete-coupon" data-id="{{ coupon.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                            <h5>No coupon codes found</h5>
                            <p class="text-muted">Click "Add New Coupon" to create your first discount coupon</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Coupon Modal -->
    <div class="modal fade" id="addCouponModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add New Coupon</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addCouponForm" method="POST" action="{{ url_for('admin_add_coupon') }}">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="couponCode" class="form-label">Coupon Code *</label>
                            <input type="text" class="form-control text-uppercase" id="couponCode" name="code" required placeholder="e.g., SAVE20">
                        </div>
                        <div class="mb-3">
                            <label for="discountType" class="form-label">Discount Type *</label>
                            <select class="form-select" id="discountType" name="discount_type" required>
                                <option value="percentage">Percentage</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="discountValue" class="form-label">Discount Value * <span id="discountUnit">(%)</span></label>
                            <input type="number" class="form-control" id="discountValue" name="discount_value" required min="0" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="maxUsage" class="form-label">Maximum Usage (optional)</label>
                            <input type="number" class="form-control" id="maxUsage" name="max_usage" min="1" placeholder="Leave empty for unlimited">
                        </div>
                        <div class="mb-3">
                            <label for="expiryDate" class="form-label">Expiry Date (optional)</label>
                            <input type="date" class="form-control" id="expiryDate" name="expiry_date">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="couponActive" name="is_active" checked>
                            <label class="form-check-label" for="couponActive">Active</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Coupon</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Coupon Modal -->
    <div class="modal fade" id="editCouponModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Coupon</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editCouponForm" method="POST" action="{{ url_for('admin_update_coupon') }}">
                    <input type="hidden" id="editCouponId" name="coupon_id">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editCouponCode" class="form-label">Coupon Code *</label>
                            <input type="text" class="form-control text-uppercase" id="editCouponCode" name="code" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDiscountType" class="form-label">Discount Type *</label>
                            <select class="form-select" id="editDiscountType" name="discount_type" required>
                                <option value="percentage">Percentage</option>
                                <option value="fixed">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editDiscountValue" class="form-label">Discount Value * <span id="editDiscountUnit">(%)</span></label>
                            <input type="number" class="form-control" id="editDiscountValue" name="discount_value" required min="0" step="0.01">
                        </div>
                        <div class="mb-3">
                            <label for="editMaxUsage" class="form-label">Maximum Usage (optional)</label>
                            <input type="number" class="form-control" id="editMaxUsage" name="max_usage" min="1" placeholder="Leave empty for unlimited">
                        </div>
                        <div class="mb-3">
                            <label for="editExpiryDate" class="form-label">Expiry Date (optional)</label>
                            <input type="date" class="form-control" id="editExpiryDate" name="expiry_date">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="editCouponActive" name="is_active">
                            <label class="form-check-label" for="editCouponActive">Active</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Update discount label functions
            const discountTypeSelect = document.getElementById('discountType');
            const editDiscountTypeSelect = document.getElementById('editDiscountType');
            
            if (discountTypeSelect) {
                discountTypeSelect.addEventListener('change', function() {
                    const type = this.value;
                    document.getElementById('discountUnit').textContent = type === 'percentage' ? '(%)' : '(₹)';
                });
            }
            
            if (editDiscountTypeSelect) {
                editDiscountTypeSelect.addEventListener('change', function() {
                    const type = this.value;
                    document.getElementById('editDiscountUnit').textContent = type === 'percentage' ? '(%)' : '(₹)';
                });
            }
            // Edit coupon button handler
            document.querySelectorAll('.btn-edit-coupon').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    const code = this.dataset.code;
                    const type = this.dataset.type;
                    const value = this.dataset.value;
                    const maxUsage = this.dataset.maxUsage;
                    const expiry = this.dataset.expiry;
                    const isActive = this.dataset.active === 'true';
                    
                    document.getElementById('editCouponId').value = id;
                    document.getElementById('editCouponCode').value = code;
                    document.getElementById('editDiscountType').value = type;
                    document.getElementById('editDiscountValue').value = value;
                    document.getElementById('editMaxUsage').value = maxUsage || '';
                    document.getElementById('editExpiryDate').value = expiry;
                    document.getElementById('editCouponActive').checked = isActive;
                    
                    // Update discount unit label based on type
                    document.getElementById('editDiscountUnit').textContent = type === 'percentage' ? '(%)' : '(₹)';
                    
                    new bootstrap.Modal(document.getElementById('editCouponModal')).show();
                });
            });

            // Delete coupon button handler
            document.querySelectorAll('.btn-delete-coupon').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.dataset.id;
                    if (confirm('Are you sure you want to delete this coupon? This action cannot be undone.')) {
                        fetch('{{ url_for("admin_delete_coupon") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ coupon_id: id })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                location.reload();
                            } else {
                                alert('Error: ' + data.message);
                            }
                        })
                        .catch(error => {
                            alert('Error deleting coupon: ' + error);
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>
